<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seeding Productivity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --border: #1f2937;
      --border-subtle: #374151;
      --text: #e5e7eb;
      --sub: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #4ade80;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1320px;
      border-radius: 24px;
      padding: 20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.09), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block { flex: 1 1 200px; min-width: 0; }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 4px;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
    }

    .title-pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #34d399, #22c55e 55%, #16a34a 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9), 0 12px 30px rgba(16, 185, 129, 0.6);
    }

    .title-pill span {
      font-size: 15px;
      font-weight: 700;
      color: #022c22;
    }

    .title-text {
      font-weight: 620;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .title-sub {
      font-size: 0.8rem;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .header-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--sub);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 55%);
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
    }

    .chip-danger-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4);
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 2.2fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 960px) {
      .container { border-radius: 18px; padding: 14px 12px 14px; }
      .layout-main { grid-template-columns: minmax(0, 1fr); }
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
      margin-top: 10px;
    }

    @media (max-width: 960px) {
      .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    }

    .kpi-card {
      position: relative;
      border-radius: 16px;
      padding: 10px 12px 11px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(51, 65, 85, 0.9);
      box-shadow:
        0 14px 30px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .kpi-label {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--sub);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kpi-value {
      font-size: 1.15rem;
      font-weight: 650;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-unit {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
    }

    .kpi-trend {
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-trend.bad { color: #f97373; }

    .kpi-glow {
      position: absolute;
      inset: 0;
      opacity: 0.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34, 197, 94, 0.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.4), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(14px);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .panel-title {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sub);
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .panel-title-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.45);
    }

    .panel-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--sub);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.55), rgba(15, 23, 42, 0.95));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
    }

    .badge-soft span {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(226, 232, 240, 0.95);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.48);
    }

    .chart-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
      flex: 1 1 auto;
    }

    .chart-row { position: relative; width: 100%; }

    .chart-canvas-main { width: 100%; height: 230px; }
    .chart-canvas-secondary { width: 100%; height: 200px; }

    @media (max-width: 960px) {
      .chart-canvas-main { height: 210px; }
      .chart-canvas-secondary { height: 180px; }
    }

    .table-wrapper {
      margin-top: 4px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background:
        linear-gradient(135deg, rgba(17, 24, 39, 0.96), rgba(15, 23, 42, 0.99)),
        radial-gradient(circle at top left, rgba(51, 65, 85, 0.65), rgba(15, 23, 42, 0.96));
      overflow: hidden;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .table-scroll {
      max-height: 430px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15, 23, 42, 0.2);
      flex: 1 1 auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 680px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background:
        linear-gradient(to bottom, #020617, #020617),
        radial-gradient(circle at top left, rgba(55, 65, 81, 0.5), rgba(15, 23, 42, 0.95));
      box-shadow: 0 1px 0 rgba(31, 41, 55, 0.9);
    }

    th, td {
      text-align: right;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; padding-left: 14px; }
    th:last-child, td:last-child { padding-right: 12px; }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--sub);
      background: transparent;
    }

    tbody tr:nth-child(odd) td { background: rgba(15, 23, 42, 0.85); }
    tbody tr:nth-child(even) td { background: rgba(17, 24, 39, 0.92); }

    tfoot td {
      background:
        radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.12), rgba(15, 23, 42, 0.98));
      font-weight: 600;
      border-top: 1px solid rgba(55, 65, 81, 0.95);
      border-bottom: none;
    }

    .cell-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-variant-numeric: tabular-nums;
    }

    .cell-percent-good {
      color: #bbf7d0;
      border-color: rgba(74, 222, 128, 0.7);
      background: radial-gradient(circle at 0 0, rgba(22, 163, 74, 0.25), rgba(15, 23, 42, 0.96));
    }

    .cell-percent-warn {
      color: #fed7aa;
      border-color: rgba(249, 115, 22, 0.8);
      background: radial-gradient(circle at 0 0, rgba(251, 146, 60, 0.25), rgba(15, 23, 42, 0.96));
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-note span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-box {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .legend-box.flats { background: rgba(59, 130, 246, 0.5); }
    .legend-box.fpph { background: rgba(34, 197, 94, 0.7); }

    .view-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 1px;
      font-size: 0.7rem;
    }

    .view-toggle-btn {
      border: none;
      background: transparent;
      color: var(--sub);
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.7rem;
      font-family: inherit;
    }

    .view-toggle-btn.active {
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }

    .trend-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--sub);
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .trend-toggle input { margin: 0; }

    .hint-empty {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>Î£</span></div>
            <div class="title-text">
              <span>Seeding Productivity Dashboard</span>
              <span class="title-sub">LIVE FROM DATA INPUT</span>
            </div>
          </div>
          <p class="subtitle">Daily seeding output, labor utilization, and speed (flats per person per hour).</p>
        </div>

        <div class="header-tags">
          <div class="chip"><span class="chip-dot"></span><span id="chip-ok">Waiting for Master Growâ€¦</span></div>
          <div class="chip"><span class="chip-danger-dot"></span><span id="chip-warn">â€“</span></div>
        </div>
      </header>

      <section class="kpi-grid">
        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Total flats seeded</div>
          <div class="kpi-value"><span id="kpi-total-flats">â€“</span></div>
          <div class="kpi-trend"><span>Across all recorded days</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Distinct varieties seeded</div>
          <div class="kpi-value"><span id="kpi-distinct-varieties">â€“</span></div>
          <div class="kpi-trend"><span id="kpi-variety-note">â€“</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average flats / person / hour</div>
          <div class="kpi-value"><span id="kpi-avg-fpph">â€“</span><span class="kpi-unit">FPPH</span></div>
          <div class="kpi-trend"><span id="kpi-best-day">Top day: â€“</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average seed crew size</div>
          <div class="kpi-value"><span id="kpi-avg-workers">â€“</span><span class="kpi-unit">Workers</span></div>
          <div class="kpi-trend"><span id="kpi-workers-note">â€“</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Overall completion</div>
          <div class="kpi-value"><span id="kpi-overall-pct">â€“</span><span class="kpi-unit">of target</span></div>
          <div class="kpi-trend"><span id="kpi-below-target">Below target days: â€“</span></div>
        </article>
      </section>

      <section class="layout-main">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span>Performance over time</span></div>
              <div class="panel-subtitle">Top: Flats seeded + target line Â· Bottom: Flats / person / hour. View by date or seed week.</div>
            </div>
            <div class="panel-header-right">
              <div class="badge-soft"><span class="badge-dot"></span><span>Live from Master Grow</span></div>
              <div class="view-toggle">
                <button id="view-by-date" class="view-toggle-btn active" type="button">By date</button>
                <button id="view-by-week" class="view-toggle-btn" type="button">By seed week</button>
              </div>
              <label class="trend-toggle">
                <input type="checkbox" id="trend-toggle-input" />
                <span>Trend line</span>
              </label>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-row"><canvas id="chart-flats" class="chart-canvas-main"></canvas></div>
            <div class="chart-row"><canvas id="chart-fpph" class="chart-canvas-secondary"></canvas></div>
          </div>

          <div class="footer-note">
            <span><span class="legend-box flats"></span> Top chart: Flats seeded (bars) + Target flats (line)</span>
            <span><span class="legend-box fpph"></span> Bottom chart: Flats / person / hour (line + optional trend)</span>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span id="table-title-text">Daily seeding log</span></div>
              <div class="panel-subtitle" id="table-subtitle-text">Built from Master Grow (batch rows aggregated into daily totals).</div>
            </div>
            <div class="panel-header-right">
              <span id="table-view-label">Daily view</span>
              <div class="view-toggle">
                <button id="table-view-daily" class="view-toggle-btn active" type="button">Daily</button>
                <button id="table-view-weekly" class="view-toggle-btn" type="button">Weekly</button>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <div class="table-scroll" id="daily-table-wrapper">
              <table id="data-table">
                <thead>
                  <tr>
                    <th>Seed Date</th>
                    <th>Seed Week</th>
                    <th>Avg # of Workers</th>
                    <th>Hours Elapsed</th>
                    <th>Flats Seeded</th>
                    <th>Target Flats</th>
                    <th>% Complete</th>
                    <th>Flats / Person / Hour</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Grand Total</td>
                    <td>â€“</td>
                    <td>0.0</td>
                    <td>0.0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0%</td>
                    <td>0.0</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="table-scroll" id="weekly-table-wrapper" style="display:none;">
              <table id="weekly-table">
                <thead>
                  <tr>
                    <th>Seed Week</th>
                    <th>Days Seeded</th>
                    <th>Total Flats Seeded</th>
                    <th>Total Target Flats</th>
                    <th>% Complete</th>
                    <th>Avg # of Workers</th>
                    <th>Total Hours</th>
                    <th>FPPH (Week)</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Grand Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0%</td>
                    <td>0.0</td>
                    <td>0.0</td>
                    <td>0.0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div id="empty-hint" class="hint-empty"></div>
        </section>
      </section>
    </div>
  </div>

  <script>
    // =========================================================
    // STORAGE CONTRACT
    // =========================================================
    const MASTER_GROW_KEY = "campo_master_grow_v1";
    const MASTER_GROW_PING_KEY = "campo_master_grow_push_ping_v1";
    const MASTER_GROW_SHEET_NAME = "Master Grow";

    // Parent/index message types
    const MSG_GROW = "MASTER_GROW_UPDATED";

    // BroadcastChannel (same-origin only; harmless if unsupported)
    const BC_NAME = "campo_master_bus_v1";
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null;

    // Canonical (meaning) column names expected (but we allow aliases)
    const SEED = Object.freeze({
      DATE: "Seed Date",
      WEEK: "Seed Week",
      VARIETY: "Variety",
      FLATS: "Flats Seeded",
      TARGET: "Target Flats to Seed",
      WORKERS: "Seed # of Workers",
      HOURS: "Semilla Tiempo Transcurido"
    });

    // =========================================================
    // STATE
    // =========================================================
    let flatsChart = null;
    let fpphChart = null;
    let viewMode = "daily";  // "daily" or "weekly"
    let showTrendLine = false;

    // =========================================================
    // UI HELPERS
    // =========================================================
    function setEmpty(msg) {
      const el = document.getElementById("empty-hint");
      if (el) el.textContent = msg || "";
    }

    function setChip(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function chipWarn(msg) { setChip("chip-warn", msg || "â€“"); }

    // =========================================================
    // TOLERANT PARSERS
    // =========================================================
    function normHeader(s){
      return String(s ?? "").replace(/\s+/g, " ").trim().toLowerCase();
    }

    // Header aliases: tolerate typos/case/spacing/Spanish variants.
    // NOTE: keep "meaning" stable by mapping to canonical names.
    const HEADER_ALIASES = new Map([
      ["seed date", SEED.DATE],
      ["seeddate", SEED.DATE],
      ["fecha de semilla", SEED.DATE],
      ["fecha semilla", SEED.DATE],

      ["seed week", SEED.WEEK],
      ["seedweek", SEED.WEEK],

      ["veriaty", SEED.VARIETY],  // common typo
      ["variety", SEED.VARIETY],
      ["variedad", SEED.VARIETY],

      ["flats seeded", SEED.FLATS],
      ["flats", SEED.FLATS],

      ["target flats to seed", SEED.TARGET],
      ["target flats", SEED.TARGET],
      ["target", SEED.TARGET],

      ["seed # of workers", SEED.WORKERS],
      ["seed # workers", SEED.WORKERS],
      ["seed workers", SEED.WORKERS],
      ["workers", SEED.WORKERS],
      ["# of workers", SEED.WORKERS],

      ["semilla tiempo transcurido", SEED.HOURS],
      ["tiempo transcurido", SEED.HOURS],
      ["hours elapsed", SEED.HOURS],
      ["hours", SEED.HOURS]
    ]);

    function canonicalizeHeaders(headersRaw){
      const canonHeaders = [];
      const canonIndexByName = new Map();

      headersRaw.forEach((h, idx) => {
        const raw = String(h ?? "");
        const key = normHeader(raw);
        const canon = HEADER_ALIASES.get(key) || raw.trim();
        canonHeaders[idx] = canon;
        if (canon && !canonIndexByName.has(canon)) canonIndexByName.set(canon, idx);
      });

      return { canonHeaders, canonIndexByName };
    }

    function parseNumber(v) {
      if (v === null || v === undefined) return 0;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const cleaned = s.replace(/,/g, "");
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    // Handles: Date obj, MM/DD/YYYY, ISO, long-form, Excel serial number
    function parseAnyDate(v){
      if (v === null || v === undefined) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return v;

      // Excel serial (as number)
      if (typeof v === "number" && Number.isFinite(v) && v > 20000 && v < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + v * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      const s0 = String(v).trim();
      if (!s0) return null;

      // Excel serial (as string)
      const n = Number(s0);
      if (Number.isFinite(n) && n > 20000 && n < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + n * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      // Strip weekday prefix: "Wednesday, October 1, 2025"
      let s = s0;
      const parts = s.split(",");
      if (parts.length >= 2 && /[a-z]/i.test(parts[0])) s = parts.slice(1).join(",").trim();

      // ISO
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }

      // US MM/DD/YYYY
      if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) {
        const [mm, dd, yy] = s.split("/").map(Number);
        const yyyy = yy < 100 ? 2000 + yy : yy;
        const d = new Date(yyyy, mm - 1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      // Fallback
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatDateMMDDYYYY(date) {
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      const yyyy = date.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    function computeTrendLine(values) {
      const n = values.length;
      if (!n || n < 2) return [];
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (let i = 0; i < n; i++) {
        const x = i + 1;
        const y = Number(values[i]) || 0;
        sumX += x; sumY += y; sumXY += x * y; sumXX += x * x;
      }
      const denom = n * sumXX - sumX * sumX;
      if (denom === 0) return Array(n).fill(values[0] || 0);
      const slope = (n * sumXY - sumX * sumY) / denom;
      const intercept = (sumY - slope * sumX) / n;
      return Array.from({ length: n }, (_, i) => slope * (i + 1) + intercept);
    }

    // =========================================================
    // PAYLOAD LOADING
    // =========================================================
    function loadMasterGrowPayload() {
      const raw = (localStorage.getItem(MASTER_GROW_KEY) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToRowObjects(sheetObj) {
      const headersRaw = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];

      const { canonHeaders } = canonicalizeHeaders(headersRaw);

      const out = [];
      for (const r of rows) {
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i = 0; i < canonHeaders.length; i++) {
          const key = String(canonHeaders[i] ?? "").trim();
          if (!key) continue;
          obj[key] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    // =========================================================
    // BUILD DAILY + WEEKLY
    // =========================================================
    function buildFromMasterGrow() {
      const payload = loadMasterGrowPayload();
      const sheet = payload?.sheets?.[MASTER_GROW_SHEET_NAME];

      const tbody = document.querySelector("#data-table tbody");
      const weeklyBody = document.querySelector("#weekly-table tbody");
      if (tbody) tbody.innerHTML = "";
      if (weeklyBody) weeklyBody.innerHTML = "";

      if (!sheet) {
        setEmpty("No Master Grow sheet found.\n\nFix: Upload Master Grow in Data Input.\nAlso verify Data Input writes sheets[\"Master Grow\"].");
        setChip("chip-ok", "Master Grow missing");
        chipWarn("Upload Master Grow CSV/XLSX");
        return { daily: [], weekly: [] };
      }

      const headersRaw = Array.isArray(sheet.headers) ? sheet.headers : [];
      const { canonHeaders } = canonicalizeHeaders(headersRaw);

      const rows = sheetToRowObjects(sheet);
      if (!rows.length) {
        setEmpty("Master Grow loaded, but the sheet has no rows.");
        setChip("chip-ok", "Master Grow loaded (0 rows)");
        chipWarn("No seeding rows found");
        return { daily: [], weekly: [] };
      }

      // Required canonical headers (tolerant input via alias mapping)
      const headerSet = new Set(canonHeaders.map(h => String(h || "").trim()).filter(Boolean));
      const required = [SEED.DATE, SEED.WEEK, SEED.FLATS, SEED.TARGET, SEED.WORKERS, SEED.HOURS];
      const missing = required.filter(h => !headerSet.has(h));

      if (missing.length) {
        setEmpty(
          "Master Grow loaded, but Seeding headers are missing (bulletproof mode).\n\n" +
          "Missing:\n- " + missing.join("\n- ") + "\n\n" +
          "Found headers (canonicalized):\n- " + Array.from(headerSet).slice(0, 60).join("\n- ") +
          (headerSet.size > 60 ? "\n- â€¦" : "")
        );
        setChip("chip-ok", "Master Grow loaded (missing headers)");
        chipWarn("Fix header names (or add alias)");
        return { daily: [], weekly: [] };
      }

      // Aggregate DAILY from batch rows
      const dailyMap = new Map();

      let droppedNoDate = 0;
      let droppedBlank = 0;

      for (const r of rows) {
        if (!r || typeof r !== "object") continue;

        const seedDateRaw = r[SEED.DATE];
        const seedWeekRaw = String(r[SEED.WEEK] ?? "").trim();

        const flats  = parseNumber(r[SEED.FLATS]);
        const target = parseNumber(r[SEED.TARGET]);
        const workers = parseNumber(r[SEED.WORKERS]);
        const hours = parseNumber(r[SEED.HOURS]);

        const varietyRaw = String(r[SEED.VARIETY] ?? "").trim();
        const varietyKey = varietyRaw ? varietyRaw.toLowerCase() : "";

        const allBlank =
          !String(seedDateRaw ?? "").trim() && !seedWeekRaw &&
          flats === 0 && target === 0 && workers === 0 && hours === 0 && !varietyKey;

        if (allBlank) { droppedBlank++; continue; }

        const dateObj = parseAnyDate(seedDateRaw);
        if (!dateObj) { droppedNoDate++; continue; }

        const dateKey = formatDateMMDDYYYY(dateObj);
        const workerHours = (workers > 0 && hours > 0) ? (workers * hours) : 0;

        if (!dailyMap.has(dateKey)) {
          dailyMap.set(dateKey, {
            dateKey,
            dateObj,
            seedWeek: seedWeekRaw || "",
            totalFlats: 0,
            totalTarget: 0,
            totalHours: 0,
            totalWorkerHours: 0,
            varieties: new Set(),
          });
        }

        const d = dailyMap.get(dateKey);
        d.totalFlats += flats;
        d.totalTarget += target;
        d.totalHours += (hours > 0 ? hours : 0);
        d.totalWorkerHours += workerHours;
        if (varietyKey) d.varieties.add(varietyKey);
        if (!d.seedWeek && seedWeekRaw) d.seedWeek = seedWeekRaw;
      }

      const dailyRows = Array.from(dailyMap.values()).sort((a, b) => a.dateObj - b.dateObj);

      // Populate DAILY table
      const pctClass = (pct) => (pct >= 100 ? "cell-percent-good" : "cell-percent-warn");

      if (tbody) {
        dailyRows.forEach((d) => {
          const avgWorkers = d.totalHours > 0 ? (d.totalWorkerHours / d.totalHours) : 0;
          const fpph = d.totalWorkerHours > 0 ? (d.totalFlats / d.totalWorkerHours) : 0;
          const pct = d.totalTarget > 0 ? (d.totalFlats / d.totalTarget) * 100 : 0;

          const tr = document.createElement("tr");
          tr.dataset.varieties = Array.from(d.varieties).join("|");
          tr.innerHTML = `
            <td>${d.dateKey}</td>
            <td>${d.seedWeek || ""}</td>
            <td>${avgWorkers.toFixed(1)}</td>
            <td>${d.totalHours.toFixed(1)}</td>
            <td>${Math.round(d.totalFlats).toString()}</td>
            <td>${Math.round(d.totalTarget).toString()}</td>
            <td><span class="cell-pill ${pctClass(pct)}">${pct.toFixed(0)}%</span></td>
            <td>${fpph.toFixed(1)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // WEEKLY aggregation (from daily rows)
      const weekMap = new Map();
      const years = new Set();
      dailyRows.forEach((d) => {
        const wk = (d.seedWeek || "").trim();
        if (!wk) return;

        const year = d.dateObj instanceof Date && !isNaN(d.dateObj.getTime())
          ? d.dateObj.getFullYear()
          : null;
        if (year) years.add(year);

        const key = year ? `${year}-W${wk}` : wk;
        if (!weekMap.has(key)) {
          weekMap.set(key, {
            week: wk,
            year,
            weekNum: parseFloat(wk),
            label: "",
            days: 0,
            totalFlats: 0,
            totalTarget: 0,
            totalHours: 0,
            totalWorkerHours: 0,
            totalWorkersSum: 0,
          });
        }
        const w = weekMap.get(key);
        w.days += 1;
        w.totalFlats += d.totalFlats;
        w.totalTarget += d.totalTarget;
        w.totalHours += d.totalHours;
        w.totalWorkerHours += d.totalWorkerHours;

        const dayAvgWorkers = d.totalHours > 0 ? (d.totalWorkerHours / d.totalHours) : 0;
        w.totalWorkersSum += dayAvgWorkers;
      });

      const showYear = years.size > 1;
      weekMap.forEach((w) => {
        const hasWeekNum = !isNaN(w.weekNum);
        if (w.year && hasWeekNum) {
          w.label = showYear ? `Wk ${w.week} (${w.year})` : `Wk ${w.week}`;
          w.order = w.year * 100 + w.weekNum;
        } else if (hasWeekNum) {
          w.label = `Wk ${w.week}`;
          w.order = w.weekNum;
        } else {
          w.label = String(w.week || "N/A");
          w.order = null;
        }
      });

      const weeklyRows = Array.from(weekMap.values()).sort((a, b) => {
        if (a.order === null || b.order === null) return String(a.label).localeCompare(String(b.label));
        return a.order - b.order;
      });

      if (weeklyBody) {
        weeklyRows.forEach((w) => {
          const pct = w.totalTarget > 0 ? (w.totalFlats / w.totalTarget) * 100 : 0;
          const avgWorkers = w.days > 0 ? (w.totalWorkersSum / w.days) : 0;
          const fpphWeek = w.totalWorkerHours > 0 ? (w.totalFlats / w.totalWorkerHours) : 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${w.label}</td>
            <td>${w.days}</td>
            <td>${Math.round(w.totalFlats).toString()}</td>
            <td>${Math.round(w.totalTarget).toString()}</td>
            <td>${pct.toFixed(0)}%</td>
            <td>${avgWorkers.toFixed(1)}</td>
            <td>${w.totalHours.toFixed(1)}</td>
            <td>${fpphWeek.toFixed(1)}</td>
          `;
          weeklyBody.appendChild(tr);
        });
      }

      setChip("chip-ok", `Master Grow loaded (${rows.length.toLocaleString()} rows)`);
      chipWarn(dailyRows.length ? "â€“" : "No daily seeding rows built");

      // Show drop diagnostics if needed
      if (!dailyRows.length) {
        setEmpty(
          "No daily rows were built.\n\n" +
          `Diagnostics:\n- Dropped blank rows: ${droppedBlank}\n- Dropped rows w/ unparseable date: ${droppedNoDate}\n\n` +
          "Fix: ensure Seed Date is present (MM/DD/YYYY, ISO, long-form, or Excel serial)."
        );
      } else {
        setEmpty("");
      }

      return { daily: dailyRows, weekly: weeklyRows };
    }

    // =========================================================
    // DASHBOARD COMPUTE
    // =========================================================
    function recomputeDashboard() {
      const rows = Array.from(document.querySelectorAll("#data-table tbody tr"));
      const varietiesSeen = new Set();

      const data = rows.map((row) => {
        const varietiesRaw = row.dataset.varieties || "";
        const varieties = varietiesRaw
          .split("|")
          .map((v) => v.trim().toLowerCase())
          .filter((v) => v.length);
        varieties.forEach((v) => varietiesSeen.add(v));

        const cells = Array.from(row.querySelectorAll("td"));
        const rawPctCell = cells[6];
        const rawPctText = rawPctCell ? (rawPctCell.innerText || rawPctCell.textContent) : "";

        const pctMatch = rawPctText.match(/(\d+(\.\d+)?)/);
        let pct = pctMatch ? parseFloat(pctMatch[1]) : 0;
        if (pct > 0 && pct <= 1.5) pct = pct * 100;

        return {
          date: (cells[0]?.textContent || "").trim(),
          seedWeek: (cells[1]?.textContent || "").trim(),
          workers: parseNumber(cells[2]?.textContent),
          hours: parseNumber(cells[3]?.textContent),
          flatsSeeded: parseNumber(cells[4]?.textContent),
          targetFlats: parseNumber(cells[5]?.textContent),
          pctComplete: pct || 0,
          flatsPerPersonHour: parseNumber(cells[7]?.textContent),
          varieties,
        };
      });

      const fmtNumber = (n) => n.toLocaleString(undefined, { maximumFractionDigits: 0 });
      const fmt1 = (n) => n.toLocaleString(undefined, { maximumFractionDigits: 1 });
      const fmtPct = (n, digits = 1) => n.toLocaleString(undefined, { maximumFractionDigits: digits }) + "%";

      if (!data.length) {
        document.getElementById("kpi-total-flats").textContent = "â€“";
        document.getElementById("kpi-distinct-varieties").textContent = "â€“";
        document.getElementById("kpi-variety-note").textContent = "â€“";
        document.getElementById("kpi-avg-fpph").textContent = "â€“";
        document.getElementById("kpi-avg-workers").textContent = "â€“";
        document.getElementById("kpi-overall-pct").textContent = "â€“";
        document.getElementById("kpi-best-day").textContent = "Top day: â€“";
        document.getElementById("kpi-workers-note").textContent = "â€“";
        document.getElementById("kpi-below-target").textContent = "Below target days: â€“";
        renderCharts([], [], [], [], [], [], [], []);
        return;
      }

      const totalFlats = data.reduce((sum, d) => sum + d.flatsSeeded, 0);
      const totalHours = data.reduce((sum, d) => sum + d.hours, 0);
      const totalWorkersCount = data.reduce((sum, d) => sum + d.workers, 0);
      const avgWorkers = data.length ? totalWorkersCount / data.length : 0;
      const avgFPPH = data.length ? data.reduce((sum, d) => sum + d.flatsPerPersonHour, 0) / data.length : 0;
      const totalTarget = data.reduce((sum, d) => sum + d.targetFlats, 0);
      const overallPct = totalTarget > 0 ? (totalFlats / totalTarget) * 100 : 0;
      const belowTargetDays = data.filter((d) => d.pctComplete < 100).length;

      const bestDay = data.reduce((best, d) =>
        (d.flatsPerPersonHour > best.flatsPerPersonHour ? d : best),
        data[0]
      );

      document.getElementById("kpi-total-flats").textContent = fmtNumber(totalFlats);

      const distinctVarieties = varietiesSeen.size;
      document.getElementById("kpi-distinct-varieties").textContent = distinctVarieties ? fmtNumber(distinctVarieties) : "â€“";
      document.getElementById("kpi-variety-note").textContent = distinctVarieties ? "From Master Grow variety field" : "Variety not present / blank";

      document.getElementById("kpi-avg-fpph").textContent = fmt1(avgFPPH);
      document.getElementById("kpi-avg-workers").textContent = fmt1(avgWorkers);
      document.getElementById("kpi-overall-pct").textContent = fmtPct(overallPct);

      document.getElementById("kpi-best-day").textContent =
        "Top day: " + fmt1(bestDay.flatsPerPersonHour) + " FPPH (" + bestDay.date + ")";

      document.getElementById("kpi-workers-note").textContent =
        data.filter((d) => d.workers === 3).length + " days ran with 3 workers";

      document.getElementById("kpi-below-target").textContent =
        "Below target days: " + belowTargetDays;

      // Update DAILY grand total row
      const tfootRow = document.querySelector("#data-table tfoot tr");
      if (tfootRow) {
        const tds = tfootRow.querySelectorAll("td");
        const avgFPPHDisplay = fmt1(data.reduce((sum, d) => sum + d.flatsPerPersonHour, 0) / data.length);
        if (tds.length >= 8) {
          tds[0].textContent = "Grand Total";
          tds[1].textContent = "â€“";
          tds[2].textContent = fmt1(avgWorkers);
          tds[3].textContent = fmt1(totalHours);
          tds[4].textContent = fmtNumber(totalFlats);
          tds[5].textContent = fmtNumber(totalTarget);
          tds[6].textContent = fmtPct(overallPct, 0);
          tds[7].textContent = avgFPPHDisplay;
        }
      }

      // DAILY arrays for charts
      const labelsByDate = data.map((d) => d.date);
      const flatsByDate = data.map((d) => d.flatsSeeded);
      const targetByDate = data.map((d) => d.targetFlats);
      const fpphByDate = data.map((d) => d.flatsPerPersonHour);

      // WEEKLY arrays from weekly table
      const weekRows = Array.from(document.querySelectorAll("#weekly-table tbody tr")).map(tr => {
        const tds = Array.from(tr.querySelectorAll("td"));
        return {
          week: (tds[0]?.textContent || "").trim(),
          flats: parseNumber(tds[2]?.textContent),
          target: parseNumber(tds[3]?.textContent),
          fpph: parseNumber(tds[7]?.textContent),
        };
      });

      const labelsByWeek = weekRows.map(w => w.week);
      const flatsByWeek = weekRows.map(w => w.flats);
      const targetByWeek = weekRows.map(w => w.target);
      const fpphByWeek = weekRows.map(w => w.fpph);

      renderCharts(
        labelsByDate, flatsByDate, targetByDate, fpphByDate,
        labelsByWeek, flatsByWeek, targetByWeek, fpphByWeek
      );
    }

    // =========================================================
    // CHARTS
    // =========================================================
    function renderCharts(
      labelsByDate, flatsByDate, targetByDate, fpphByDate,
      labelsByWeek, flatsByWeek, targetByWeek, fpphByWeek
    ) {
      const usingWeekly = viewMode === "weekly";

      const labels = usingWeekly ? labelsByWeek : labelsByDate;
      const flatsValues = usingWeekly ? flatsByWeek : flatsByDate;
      const targetValues = usingWeekly ? targetByWeek : targetByDate;
      const fpphValues = usingWeekly ? fpphByWeek : fpphByDate;

      const ctxFlats = document.getElementById("chart-flats")?.getContext("2d");
      const ctxFpph = document.getElementById("chart-fpph")?.getContext("2d");
      if (!ctxFlats || !ctxFpph) return;

      if (flatsChart) flatsChart.destroy();
      if (fpphChart) fpphChart.destroy();

      flatsChart = new Chart(ctxFlats, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: usingWeekly ? "Flats seeded (per week)" : "Flats seeded",
              data: flatsValues,
              borderWidth: 0,
              borderRadius: 4,
              backgroundColor: "rgba(59, 130, 246, 0.8)",
            },
            {
              label: usingWeekly ? "Target flats (per week)" : "Target flats (per day)",
              data: targetValues,
              type: "line",
              tension: 0.35,
              borderWidth: 1.8,
              pointRadius: 2.5,
              fill: false,
              borderColor: "rgba(148, 163, 184, 0.9)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, labels: { color: "rgba(209, 213, 219, 0.9)", font: { size: 10 } } }
          },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 },
              title: { display: true, text: usingWeekly ? "Seed Week" : "Date", color: "rgba(148, 163, 184, 0.9)" }
            },
            y: {
              grid: { color: "rgba(31, 41, 55, 0.8)" },
              ticks: { color: "rgba(148, 163, 184, 0.9)" },
              title: { display: true, text: "Flats Seeded", color: "rgba(148, 163, 184, 0.9)" }
            },
          },
        },
      });

      const fpphDatasets = [
        {
          label: usingWeekly ? "FPPH (weekly)" : "Flats / person / hour",
          data: fpphValues,
          tension: 0.35,
          borderWidth: 2.2,
          pointRadius: 2.8,
          fill: false,
          borderColor: "rgba(34, 197, 94, 0.9)",
        },
      ];

      if (showTrendLine) {
        const trend = computeTrendLine(fpphValues);
        if (trend.length === fpphValues.length) {
          fpphDatasets.push({
            label: "Trend",
            data: trend,
            tension: 0,
            borderWidth: 1.8,
            pointRadius: 0,
            fill: false,
            borderDash: [5, 4],
            borderColor: "rgba(148, 163, 184, 0.8)",
          });
        }
      }

      fpphChart = new Chart(ctxFpph, {
        type: "line",
        data: { labels, datasets: fpphDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 },
              title: { display: true, text: usingWeekly ? "Seed Week" : "Date", color: "rgba(148, 163, 184, 0.9)" }
            },
            y: {
              grid: { color: "rgba(31, 41, 55, 0.8)" },
              ticks: { color: "rgba(148, 163, 184, 0.9)" },
              title: { display: true, text: "FPPH", color: "rgba(148, 163, 184, 0.9)" }
            },
          },
        },
      });
    }

    // =========================================================
    // VIEW MODE TOGGLES
    // =========================================================
    function setViewMode(mode) {
      if (mode !== "daily" && mode !== "weekly") return;
      viewMode = mode;

      const usingWeekly = viewMode === "weekly";

      document.getElementById("view-by-date")?.classList.toggle("active", !usingWeekly);
      document.getElementById("view-by-week")?.classList.toggle("active", usingWeekly);
      document.getElementById("table-view-daily")?.classList.toggle("active", !usingWeekly);
      document.getElementById("table-view-weekly")?.classList.toggle("active", usingWeekly);

      const dailyWrapper = document.getElementById("daily-table-wrapper");
      const weeklyWrapper = document.getElementById("weekly-table-wrapper");
      if (dailyWrapper && weeklyWrapper) {
        dailyWrapper.style.display = usingWeekly ? "none" : "block";
        weeklyWrapper.style.display = usingWeekly ? "block" : "none";
      }

      const tableTitle = document.getElementById("table-title-text");
      const tableSubtitle = document.getElementById("table-subtitle-text");
      const tableLabel = document.getElementById("table-view-label");
      if (tableTitle && tableSubtitle && tableLabel) {
        if (usingWeekly) {
          tableTitle.textContent = "Weekly seeding summary";
          tableSubtitle.textContent = "One row per seed week â€“ totals, averages, and weekly FPPH.";
          tableLabel.textContent = "Weekly view";
        } else {
          tableTitle.textContent = "Daily seeding log";
          tableSubtitle.textContent = "Built from Master Grow (batch rows aggregated into daily totals).";
          tableLabel.textContent = "Daily view";
        }
      }

      recomputeDashboard();
    }

    function setupToggles() {
      document.getElementById("view-by-date")?.addEventListener("click", () => setViewMode("daily"));
      document.getElementById("view-by-week")?.addEventListener("click", () => setViewMode("weekly"));
      document.getElementById("table-view-daily")?.addEventListener("click", () => setViewMode("daily"));
      document.getElementById("table-view-weekly")?.addEventListener("click", () => setViewMode("weekly"));

      const chk = document.getElementById("trend-toggle-input");
      if (chk) {
        chk.addEventListener("change", () => {
          showTrendLine = chk.checked;
          recomputeDashboard();
        });
      }
    }

    // =========================================================
    // LIVE REFRESH (bulletproof)
    // =========================================================
    let reloadTimer = null;
    function reloadAll(reason){
      // Debounce to avoid multi-fire storms (storage + message + bc)
      if (reloadTimer) clearTimeout(reloadTimer);
      reloadTimer = setTimeout(() => {
        reloadTimer = null;
        buildFromMasterGrow();
        recomputeDashboard();
        // Optional debug:
        // console.log("ðŸ”„ Reloaded seeding dashboard", reason || "");
      }, 60);
    }

    function setupLiveListeners() {
      // 1) storage events (cross-tab / sometimes iframe)
      window.addEventListener("storage", (e) => {
        if (!e) return;
        if (e.key === MASTER_GROW_KEY || e.key === MASTER_GROW_PING_KEY) reloadAll("storage");
      });

      // 2) postMessage from index/data-input
      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === MSG_GROW || msg.type === "MASTER_GROW_UPDATED") {
          reloadAll("message");
        }
      });

      // 3) CustomEvent in same frame (Data Input sometimes dispatches these)
      window.addEventListener(MSG_GROW, () => reloadAll("customevent"));

      // 4) BroadcastChannel (same-origin only)
      if (bc) {
        bc.onmessage = (ev) => {
          const msg = ev?.data;
          if (msg?.type === MSG_GROW) reloadAll("broadcast");
        };
      }

      // 5) Safety poll: catch cases where none of the events fire (Safari iframe oddities)
      let lastLen = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
      setInterval(() => {
        const curLen = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
        if (curLen !== lastLen) {
          lastLen = curLen;
          reloadAll("poll");
        }
      }, 1500);
    }

    // =========================================================
    // INIT
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      setupToggles();
      setupLiveListeners();
      reloadAll("init");
      setViewMode("daily");
    });
  </script>
</body>
</html>
