<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campo Caribe Operations ‚Äì Unified Testing Dashboard</title>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --border:#1f2937;
      --text:#e5e7eb;
      --sub:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --shadow: 0 24px 80px rgba(0,0,0,0.75);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      overflow:hidden;
    }

    .shell{height:100%;display:flex;flex-direction:column;}
    .topbar{
      padding:14px 16px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex;flex-direction:column;gap:4px;min-width:240px;}
    .brand .title{font-weight:700;letter-spacing:.02em;font-size:1.05rem;}
    .brand .subtitle{color:var(--sub);font-size:.85rem;line-height:1.2;}

    .tabs{
      margin:0 16px;
      padding:10px;
      border-radius:18px;
      background: linear-gradient(135deg, rgba(15,23,42,.88), rgba(15,23,42,.96));
      border:1px solid rgba(148,163,184,.25);
      box-shadow: 0 10px 34px rgba(0,0,0,.45);

      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;

      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15,23,42,0.2);

      user-select:none;
      -webkit-user-select:none;
      touch-action: pan-x;
      position:relative;
    }
    .tabs::-webkit-scrollbar{height:6px;}
    .tabs::-webkit-scrollbar-thumb{background:#4b5563;border-radius:999px;}

    .tab{
      border:1px solid rgba(55,65,81,.8);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:.88rem;
      white-space:nowrap;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      -webkit-user-select:none;
      flex:0 0 auto;
    }
    .tab:hover{ background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.35); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 1px rgba(34,197,94,.08) inset;
    }

    .tab.dragging{
      cursor:grabbing;
      opacity:.98;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.12);
      position:fixed;
      z-index:9999;
      transform:none;
      pointer-events:none;
    }
    .tab.placeholder{
      opacity:.35;
      border-style:dashed;
      background: rgba(2,6,23,.18);
    }

    .main{flex:1 1 auto;padding:14px 16px 16px;overflow:hidden;}
    .panel{
      height:100%;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.25);
      background:
        radial-gradient(circle at top right, rgba(34,197,94,0.08), transparent 60%),
        linear-gradient(135deg, rgba(15,23,42,0.92), rgba(15,23,42,0.98));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }
    .panel.active{ display:flex; flex-direction:column; }

    .section-head{
      padding:16px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(148,163,184,.16);
      min-height:82px;
    }
    .section-head .head-left{flex:1 1 auto;min-width:320px;}
    .section-head h2{margin:0;font-size:1.05rem;letter-spacing:.02em;}
    .section-head p{margin:6px 0 0;color:var(--sub);font-size:.86rem;line-height:1.25;}

    .iframe-wrap{flex:1 1 auto;overflow:hidden;}
    iframe{width:100%;height:100%;border:0;background: transparent;}

    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    .toast{
      position:fixed;
      left:12px;
      bottom:12px;
      z-index:99999;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.92);
      color: var(--text);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      font-size:12px;
      max-width:min(560px, calc(100vw - 24px));
      white-space:pre-wrap;
      display:none;
    }
    .toast .t-sub{color:var(--sub);margin-top:4px;font-size:11px;}
    .toast.ok{border-color: rgba(34,197,94,.4);}
    .toast.bad{border-color: rgba(239,68,68,.45);}
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="title">Campo Caribe Operations</div>
        <div class="subtitle">Unified testing harness (Data Input + Seeding + Transplant + Harvest + Packing + Sanitation). Drag tabs to reorder (saved to localStorage).</div>
      </div>
    </div>

    <!-- IMPORTANT: id="tabs" must exist -->
    <div class="tabs" id="tabs" aria-label="Dashboards">
      <button class="tab active" data-target="p-data" data-tab="data">üì• <span>Data Input</span></button>
      <button class="tab" data-target="p-seeding" data-tab="seeding">üå± <span>Seeding</span></button>
      <button class="tab" data-target="p-transplant" data-tab="transplant">ü™¥ <span>Transplant</span></button>
      <button class="tab" data-target="p-harvest" data-tab="harvest">‚úÇÔ∏è <span>Harvest</span></button>
      <button class="tab" data-target="p-packing" data-tab="packing">üì¶ <span>Packing</span></button>
      <button class="tab" data-target="p-sanitation" data-tab="sanitation">üßº <span>Sanitation</span></button>
    </div>

    <div class="main">
      <section class="panel active" id="p-data">
        <div class="section-head">
          <div class="head-left">
            <h2>Data Input Dashboard</h2>
            <p>Loads the standalone Data Input tool and writes Master Grow / Master Pack to localStorage (and can publish to Supabase via Worker).</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>07.0 Data Input Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-data" data-src="07.0 Data Input Dashboard.html?v=refresh1"></iframe>
        </div>
      </section>

      <section class="panel" id="p-seeding">
        <div class="section-head">
          <div class="head-left">
            <h2>Seeding Dashboard</h2>
            <p>Reads Master Grow from <code>localStorage</code> key <code>campo_master_grow_v1</code> ‚Üí <code>sheets["Master Grow"]</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>01.0 Seeding Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-seeding" data-src="01.0 Seeding Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-transplant">
        <div class="section-head">
          <div class="head-left">
            <h2>Transplant Dashboard</h2>
            <p>Reads Master Grow from <code>localStorage</code> key <code>campo_master_grow_v1</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>02.0 Transplant Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-transplant" data-src="02.0 Transplant Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-harvest">
        <div class="section-head">
          <div class="head-left">
            <h2>Harvest Dashboard</h2>
            <p>Reads Master Grow from <code>localStorage</code> key <code>campo_master_grow_v1</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>03.0 Harvest Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-harvest" data-src="03.0 Harvest Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-packing">
        <div class="section-head">
          <div class="head-left">
            <h2>Packing Dashboard</h2>
            <p>Reads Master Pack from <code>localStorage</code> key <code>campo_master_pack_v1</code> ‚Üí <code>sheets["Master Pack"]</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>04.0 Packing Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-packing" data-src="04.0 Packing Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-sanitation">
        <div class="section-head">
          <div class="head-left">
            <h2>Sanitation Dashboard</h2>
            <p>Reads Master Grow from <code>localStorage</code> key <code>campo_master_grow_v1</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>05.0 Sanitation Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-sanitation" data-src="05.0 Sanitation Dashboard.html"></iframe>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast">
    <div id="toastText">‚Äì</div>
    <div class="t-sub" id="toastSub">‚Äì</div>
  </div>

  <script>
    (function(){
      // =========================================================
      // Worker (source of truth)
      // =========================================================
      const WORKER_BASE = "https://campo-publisher.kevin-lopezgomez.workers.dev";
      const WORKER_HEALTH_URL = `${WORKER_BASE}/health`;
      const WORKER_GROW_URL   = `${WORKER_BASE}/data/master/grow.json`;
      const WORKER_PACK_URL   = `${WORKER_BASE}/data/master/pack.json`;

      // =========================================================
      // LocalStorage keys (MUST match dashboards)
      // =========================================================
      const MASTER_GROW_KEY  = "campo_master_grow_v1";
      const MASTER_PACK_KEY  = "campo_master_pack_v1";
      const MASTER_GROW_PING = "campo_master_grow_push_ping_v1";
      const MASTER_PACK_PING = "campo_master_pack_push_ping_v1";

      // Contract: dashboards (Seeding) expect sheets["Master Grow"] and sheets["Master Pack"]
      const CANON_GROW_SHEET = "Master Grow";
      const CANON_PACK_SHEET = "Master Pack";

      // Events dashboards should listen for
      const MSG_GROW = "MASTER_GROW_UPDATED";
      const MSG_PACK = "MASTER_PACK_UPDATED";

      // BroadcastChannel (same-origin only; optional)
      const BC_NAME = "campo_updates_v1";
      const bc = (() => {
        try { return ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null; }
        catch { return null; }
      })();

      // =========================================================
      // DOM refs
      // =========================================================
      const tabsWrap = document.getElementById("tabs");
      const panels = Array.from(document.querySelectorAll(".panel"));
      const LS_ORDER_KEY = "campo_unified_tabs_order_v1";
      const toast = document.getElementById("toast");
      const toastText = document.getElementById("toastText");
      const toastSub = document.getElementById("toastSub");

      if (!tabsWrap) {
        console.error("FATAL: #tabs not found. Index HTML is missing the tabs container.");
        document.body.innerHTML = "<div style='padding:20px;font-family:system-ui;color:#111'>FATAL: #tabs not found. Restore index.html markup.</div>";
        return;
      }

      // =========================================================
      // Toast helper (replaces badge, more informative)
      // =========================================================
      let toastTimer = null;
      function showToast(msg, sub, ok){
        if (!toast || !toastText || !toastSub) return;
        toast.classList.remove("ok","bad");
        toast.classList.add(ok ? "ok" : "bad");
        toastText.textContent = msg || "";
        toastSub.textContent = sub || "";
        toast.style.display = "block";
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => { toast.style.display = "none"; }, ok ? 2200 : 4200);
      }

      // =========================================================
      // iFrame notify helper (bulletproof)
      // =========================================================
      const IFRAME_IDS = ["ifr-seeding","ifr-transplant","ifr-harvest","ifr-packing","ifr-sanitation","ifr-data"];
      function notifyIframes(type){
        for (const id of IFRAME_IDS){
          const ifr = document.getElementById(id);
          if (ifr?.contentWindow){
            try { ifr.contentWindow.postMessage({ type, ts: Date.now() }, "*"); } catch(e) {}
          }
        }
      }

      function broadcast(type){
        // BroadcastChannel (same-origin)
        try { bc?.postMessage?.({ type, ts: Date.now() }); } catch(e){}
      }

      // =========================================================
      // Worker fetch helper
      // =========================================================
      async function workerGetJson(url){
        const bust = url + (url.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const r = await fetch(bust, { cache:"no-store" });
        const t = await r.text();
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${t}`);
        return JSON.parse(t);
      }

      // =========================================================
      // Contract normalizer (bulletproof)
      // - Ensures sheets["Master Grow"] / sheets["Master Pack"] exist.
      // - If worker returns sheets under different keys, remap.
      // =========================================================
      function isObject(x){ return x && typeof x === "object" && !Array.isArray(x); }

      function normalizeMasterPayload(raw, kind){
        if (!isObject(raw)) return raw;

        // If it already has the canonical sheet, keep it
        const sheets = raw.sheets;
        if (isObject(sheets)) {
          const want = (kind === "grow") ? CANON_GROW_SHEET : CANON_PACK_SHEET;
          if (sheets[want]) return raw;

          // Try to find an equivalent sheet key
          const keys = Object.keys(sheets);
          const wantLower = want.toLowerCase();
          let match = keys.find(k => String(k).trim().toLowerCase() === wantLower);

          if (!match && kind === "grow") {
            match = keys.find(k => String(k).toLowerCase().includes("grow"));
          }
          if (!match && kind === "pack") {
            match = keys.find(k => String(k).toLowerCase().includes("pack"));
          }

          if (match) {
            const clone = JSON.parse(JSON.stringify(raw));
            clone.sheets = clone.sheets || {};
            clone.sheets[want] = clone.sheets[match];
            // keep original too (harmless)
            return clone;
          }
        }

        // If payload looks like a single-sheet object (headers/rows at top-level), wrap it
        if (Array.isArray(raw.headers) && Array.isArray(raw.rows)) {
          const wrapped = {
            version: raw.version || "v1",
            updatedAt: raw.updatedAt || new Date().toISOString(),
            kind: raw.kind || (kind === "grow" ? "grow" : "pack"),
            sourceLabel: raw.sourceLabel || "worker",
            sheets: {
              [(kind === "grow") ? CANON_GROW_SHEET : CANON_PACK_SHEET]: { headers: raw.headers, rows: raw.rows }
            }
          };
          return wrapped;
        }

        // If none apply, return as-is
        return raw;
      }

      function storageContractOk(){
        // Grow contract
        const growRaw = (localStorage.getItem(MASTER_GROW_KEY) || "").trim();
        if (growRaw) {
          try {
            const g = JSON.parse(growRaw);
            if (!g?.sheets?.[CANON_GROW_SHEET]) return false;
          } catch { return false; }
        }
        // Pack contract (only if present)
        const packRaw = (localStorage.getItem(MASTER_PACK_KEY) || "").trim();
        if (packRaw) {
          try {
            const p = JSON.parse(packRaw);
            if (!p?.sheets?.[CANON_PACK_SHEET]) return false;
          } catch { return false; }
        }
        return true;
      }

      // =========================================================
      // Hydrate localStorage from Worker (bulletproof + normalized)
      // =========================================================
      async function tryHydrateFromWorker(){
        // Health check
        try{
          const hr = await fetch(WORKER_HEALTH_URL, { cache:"no-store" });
          if (!hr.ok) throw new Error(`Health HTTP ${hr.status}`);
          showToast("Worker connected", "Hydrating localStorage‚Ä¶", true);
        } catch(err){
          console.error("‚ùå Worker not reachable:", err);
          showToast("Worker not reachable", "Using whatever is already in localStorage.", false);
          return;
        }

        let wroteAny = false;
        const now = Date.now();

        // Grow
        try{
          const growJson = await workerGetJson(WORKER_GROW_URL);
          const normalizedGrow = normalizeMasterPayload(growJson, "grow");
          localStorage.setItem(MASTER_GROW_KEY, JSON.stringify(normalizedGrow));
          localStorage.setItem(MASTER_GROW_PING, String(now));
          window.dispatchEvent(new CustomEvent(MSG_GROW, { detail:{ key: MASTER_GROW_KEY, ts: now } }));
          notifyIframes(MSG_GROW);
          broadcast(MSG_GROW);
          wroteAny = true;
        } catch(e){
          console.warn("Grow load failed:", e);
        }

        // Pack
        try{
          const packJson = await workerGetJson(WORKER_PACK_URL);
          const normalizedPack = normalizeMasterPayload(packJson, "pack");
          localStorage.setItem(MASTER_PACK_KEY, JSON.stringify(normalizedPack));
          localStorage.setItem(MASTER_PACK_PING, String(now));
          window.dispatchEvent(new CustomEvent(MSG_PACK, { detail:{ key: MASTER_PACK_KEY, ts: now } }));
          notifyIframes(MSG_PACK);
          broadcast(MSG_PACK);
          wroteAny = true;
        } catch(e){
          console.warn("Pack load failed:", e);
        }

        if (wroteAny) {
          const ok = storageContractOk();
          showToast("Hydrated from Worker", ok ? "Contract OK (Master Grow/Pack sheets present)" : "‚ö†Ô∏è Contract warning: missing canonical sheet keys", ok);
          console.log("‚úÖ Hydrated localStorage from Worker (grow/pack).");
        } else {
          showToast("Worker connected", "No grow/pack loaded (files missing or errors).", false);
          console.log("‚ÑπÔ∏è Worker connected, but grow/pack were not loaded.");
        }
      }

      // =========================================================
      // Panel activation (lazy iframe src)
      // =========================================================
      function activate(id){
        const tabs = Array.from(tabsWrap.querySelectorAll(".tab"));
        tabs.forEach(t => t.classList.toggle("active", t.dataset.target === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));

        const panel = document.getElementById(id);
        const iframe = panel ? panel.querySelector("iframe[data-src]") : null;
        if (iframe && !iframe.src) iframe.src = iframe.getAttribute("data-src");
      }

      // =========================================================
      // Restore / save tab order
      // =========================================================
      function loadOrder(){
        try { return JSON.parse(localStorage.getItem(LS_ORDER_KEY) || "[]"); }
        catch(e){ return []; }
      }
      function saveOrder(){
        const ids = Array.from(tabsWrap.querySelectorAll(".tab")).map(t => t.dataset.tab);
        try { localStorage.setItem(LS_ORDER_KEY, JSON.stringify(ids)); } catch(e){}
      }
      function applySavedOrder(){
        const order = loadOrder();
        if (!order.length) return;
        const map = new Map(Array.from(tabsWrap.querySelectorAll(".tab")).map(t => [t.dataset.tab, t]));
        order.forEach(id => {
          const el = map.get(id);
          if (el) tabsWrap.appendChild(el);
        });
      }

      // =========================================================
      // Drag-to-reorder with threshold (bulletproof)
      // =========================================================
      function makeSortable(){
        const DRAG_THRESHOLD = 8;

        let downTab = null;
        let isDragging = false;
        let placeholder = null;
        let offsetX = 0, offsetY = 0;
        let startX = 0, startY = 0;

        function pointerXY(e){
          const p = e.touches ? e.touches[0] : e;
          return { x: p.clientX, y: p.clientY };
        }

        function startDrag(tab, x, y){
          isDragging = true;

          const rect = tab.getBoundingClientRect();
          offsetX = x - rect.left;
          offsetY = y - rect.top;

          placeholder = tab.cloneNode(true);
          placeholder.classList.remove("active");
          placeholder.classList.add("placeholder");
          placeholder.style.width = rect.width + "px";
          placeholder.style.height = rect.height + "px";

          tabsWrap.insertBefore(placeholder, tab.nextSibling);

          tab.classList.add("dragging");
          tab.style.width = rect.width + "px";
          tab.style.height = rect.height + "px";
          tab.style.left = rect.left + "px";
          tab.style.top  = rect.top  + "px";
          tab.style.cursor = "grabbing";
        }

        function moveDrag(tab, x, y){
          tab.style.left = (x - offsetX) + "px";
          tab.style.top  = (y - offsetY) + "px";

          const tabs = Array.from(tabsWrap.querySelectorAll(".tab"))
            .filter(t => t !== tab && t !== placeholder);

          let inserted = false;
          for (const t of tabs) {
            const r = t.getBoundingClientRect();
            const tCenter = r.left + r.width/2;
            if (x < tCenter) {
              tabsWrap.insertBefore(placeholder, t);
              inserted = true;
              break;
            }
          }
          if (!inserted) tabsWrap.appendChild(placeholder);

          const wrapRect = tabsWrap.getBoundingClientRect();
          const edge = 36;
          if (x < wrapRect.left + edge) tabsWrap.scrollLeft -= 10;
          if (x > wrapRect.right - edge) tabsWrap.scrollLeft += 10;
        }

        function endDrag(tab){
          tab.classList.remove("dragging");
          tab.style.left = "";
          tab.style.top  = "";
          tab.style.width = "";
          tab.style.height = "";
          tab.style.cursor = "";

          if (placeholder) {
            tabsWrap.insertBefore(tab, placeholder);
            placeholder.remove();
            placeholder = null;
          }

          saveOrder();
          isDragging = false;
        }

        function cleanupListeners(){
          window.removeEventListener("mousemove", onMove);
          window.removeEventListener("mouseup", onUp);
          window.removeEventListener("touchmove", onMove);
          window.removeEventListener("touchend", onUp);
        }

        function onDown(e){
          const tab = e.target.closest(".tab");
          if (!tab) return;

          downTab = tab;
          isDragging = false;
          const {x,y} = pointerXY(e);
          startX = x; startY = y;

          window.addEventListener("mousemove", onMove, { passive:false });
          window.addEventListener("mouseup", onUp, { passive:true });
          window.addEventListener("touchmove", onMove, { passive:false });
          window.addEventListener("touchend", onUp, { passive:true });
        }

        function onMove(e){
          if (!downTab) return;

          const {x,y} = pointerXY(e);
          const dx = x - startX;
          const dy = y - startY;

          if (!isDragging) {
            if (Math.hypot(dx, dy) < DRAG_THRESHOLD) return;
            e.preventDefault();
            startDrag(downTab, x, y);
          } else {
            e.preventDefault();
            moveDrag(downTab, x, y);
          }
        }

        function onUp(){
          cleanupListeners();
          if (!downTab) return;

          if (isDragging) endDrag(downTab);
          else activate(downTab.dataset.target);

          downTab = null;
        }

        tabsWrap.addEventListener("mousedown", onDown);
        tabsWrap.addEventListener("touchstart", onDown, { passive:true });
      }

      // =========================================================
      // Message bridge (bulletproof)
      // - Any iframe (data-input or dashboards) can send MASTER_*_UPDATED
      // - Index forwards to all iframes + BroadcastChannel
      // =========================================================
      window.addEventListener("message", (event) => {
        const msg = event?.data || {};
        if (!msg.type) return;
        if (msg.type === MSG_GROW || msg.type === MSG_PACK || msg.type === "MASTER_GROW_UPDATED" || msg.type === "MASTER_PACK_UPDATED") {
          notifyIframes(msg.type);
          broadcast(msg.type);
          showToast("Update received", msg.type, true);
        }
      });

      if (bc) {
        bc.onmessage = (ev) => {
          const msg = ev?.data || {};
          if (!msg.type) return;
          if (msg.type === MSG_GROW || msg.type === MSG_PACK) {
            notifyIframes(msg.type);
          }
        };
      }

      // Safety poll: if a browser fails to deliver events to iframes, ping occasionally
      let lastGrowPing = localStorage.getItem(MASTER_GROW_PING) || "";
      let lastPackPing = localStorage.getItem(MASTER_PACK_PING) || "";
      setInterval(() => {
        const g = localStorage.getItem(MASTER_GROW_PING) || "";
        const p = localStorage.getItem(MASTER_PACK_PING) || "";
        if (g !== lastGrowPing) { lastGrowPing = g; notifyIframes(MSG_GROW); broadcast(MSG_GROW); }
        if (p !== lastPackPing) { lastPackPing = p; notifyIframes(MSG_PACK); broadcast(MSG_PACK); }
      }, 1500);

      // =========================================================
      // INIT
      // =========================================================
      applySavedOrder();
      makeSortable();

      const firstActive = tabsWrap.querySelector(".tab.active") || tabsWrap.querySelector(".tab");
      if (firstActive) activate(firstActive.dataset.target);

      // Hydrate from Worker immediately (and normalize contract)
      tryHydrateFromWorker();
    })();
  </script>
</body>
</html>
