<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campo Caribe Operations ‚Äì Unified Testing Dashboard</title>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --border:#1f2937;
      --text:#e5e7eb;
      --sub:#9ca3af;
      --accent:#22c55e;
      --shadow: 0 24px 80px rgba(0,0,0,0.75);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      overflow:hidden;
    }

    .shell{height:100%;display:flex;flex-direction:column;}
    .topbar{
      padding:14px 16px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex;flex-direction:column;gap:4px;min-width:240px;}
    .brand .title{font-weight:700;letter-spacing:.02em;font-size:1.05rem;}
    .brand .subtitle{color:var(--sub);font-size:.85rem;line-height:1.2;}

    .tabs{
      margin:0 16px;
      padding:10px;
      border-radius:18px;
      background: linear-gradient(135deg, rgba(15,23,42,.88), rgba(15,23,42,.96));
      border:1px solid rgba(148,163,184,.25);
      box-shadow: 0 10px 34px rgba(0,0,0,.45);

      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;

      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15,23,42,0.2);

      user-select:none;
      -webkit-user-select:none;
      touch-action: pan-x;
      position:relative;
    }
    .tabs::-webkit-scrollbar{height:6px;}
    .tabs::-webkit-scrollbar-thumb{background:#4b5563;border-radius:999px;}

    .tab{
      border:1px solid rgba(55,65,81,.8);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:.88rem;
      white-space:nowrap;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      -webkit-user-select:none;
      flex:0 0 auto;
    }
    .tab:hover{ background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.35); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 1px rgba(34,197,94,.08) inset;
    }

    .tab.dragging{
      cursor:grabbing;
      opacity:.98;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.12);
      position:fixed;
      z-index:9999;
      transform:none;
      pointer-events:none;
    }
    .tab.placeholder{
      opacity:.35;
      border-style:dashed;
      background: rgba(2,6,23,.18);
    }

    .main{flex:1 1 auto;padding:14px 16px 16px;overflow:hidden;}
    .panel{
      height:100%;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.25);
      background:
        radial-gradient(circle at top right, rgba(34,197,94,0.08), transparent 60%),
        linear-gradient(135deg, rgba(15,23,42,0.92), rgba(15,23,42,0.98));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }
    .panel.active{ display:flex; flex-direction:column; }

    .section-head{
      padding:16px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(148,163,184,.16);
      min-height:82px;
    }
    .section-head .head-left{flex:1 1 auto;min-width:320px;}
    .section-head h2{margin:0;font-size:1.05rem;letter-spacing:.02em;}
    .section-head p{margin:6px 0 0;color:var(--sub);font-size:.86rem;line-height:1.25;}

    .iframe-wrap{flex:1 1 auto;overflow:hidden;}
    iframe{width:100%;height:100%;border:0;background: transparent;}

    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="title">Campo Caribe Operations</div>
        <div class="subtitle">Unified testing harness (Data Input + Seeding + Transplant + Harvest + Packing + Sanitation). Drag tabs to reorder (saved to localStorage).</div>
      </div>
    </div>

    <div class="tabs" id="tabs" aria-label="Dashboards">
      <button class="tab active" data-target="p-data" data-tab="data">üì• <span>Data Input</span></button>
      <button class="tab" data-target="p-seeding" data-tab="seeding">üå± <span>Seeding</span></button>
      <button class="tab" data-target="p-transplant" data-tab="transplant">ü™¥ <span>Transplant</span></button>
      <button class="tab" data-target="p-harvest" data-tab="harvest">‚úÇÔ∏è <span>Harvest</span></button>
      <button class="tab" data-target="p-packing" data-tab="packing">üì¶ <span>Packing</span></button>
      <button class="tab" data-target="p-sanitation" data-tab="sanitation">üßº <span>Sanitation</span></button>
    </div>

    <div class="main">
      <section class="panel active" id="p-data">
        <div class="section-head">
          <div class="head-left">
            <h2>Data Input Dashboard</h2>
            <p>Loads the standalone Data Input tool and writes the selected sheet to localStorage (and can later publish to Supabase via Worker).</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>07.0 Data Input Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-data" data-src="07.0 Data Input Dashboard.html?v=refresh3"></iframe>
        </div>
      </section>

      <section class="panel" id="p-seeding">
        <div class="section-head">
          <div class="head-left">
            <h2>Seeding Dashboard</h2>
            <p>Loads the seeding dashboard file in an iframe.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>01.0 Seeding Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-seeding" data-src="01.0 Seeding Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-transplant">
        <div class="section-head">
          <div class="head-left">
            <h2>Transplant Dashboard</h2>
            <p>Loads the transplant dashboard file in an iframe.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>02.0 Transplant Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-transplant" data-src="02.0 Transplant Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-harvest">
        <div class="section-head">
          <div class="head-left">
            <h2>Harvest Dashboard</h2>
            <p>Reads from <code>localStorage</code> key <code>campo_harvest_rawlog_v1</code>.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>03.0 Harvest Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-harvest" data-src="03.0 Harvest Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-packing">
        <div class="section-head">
          <div class="head-left">
            <h2>Packing Dashboard</h2>
            <p>Loads the packing dashboard file in an iframe.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>04.0 Packing Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-packing" data-src="04.0 Packing Dashboard.html"></iframe>
        </div>
      </section>

      <section class="panel" id="p-sanitation">
        <div class="section-head">
          <div class="head-left">
            <h2>Sanitation Dashboard</h2>
            <p>Loads the sanitation dashboard file in an iframe.</p>
          </div>
          <div style="opacity:.9;color:var(--sub);font-size:.85rem;">üìÑ file: <code>05.0 Sanitation Dashboard.html</code></div>
        </div>
        <div class="iframe-wrap">
          <iframe id="ifr-sanitation" data-src="05.0 Sanitation Dashboard.html"></iframe>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function(){
      // =========================
      // Supabase-ready configuration
      // =========================
      const CONFIG = {
        supabase: {
          enabled: true,
          baseUrl: "https://lxxysrhhmtjikzpmupqb.supabase.co",
          bucket: "campo-data",
          // These must match what you upload in Storage:
          // campo-data / master / grow.json
          // campo-data / master / pack.json
          paths: {
            grow: "master/grow.json",
            pack: "master/pack.json",
            test: "master/test.json"
          }
        }
      };

      // =========================
      // LocalStorage keys (MUST match your dashboards)
      // =========================
      const MASTER_GROW_KEY  = "campo_master_grow_v1";
      const MASTER_PACK_KEY  = "campo_master_pack_v1";
      const MASTER_GROW_PING = "campo_master_grow_push_ping_v1";
      const MASTER_PACK_PING = "campo_master_pack_push_ping_v1";

      // Message types your dashboards already listen for
      const MSG_GROW = "MASTER_GROW_UPDATED";
      const MSG_PACK = "MASTER_PACK_UPDATED";

      const tabsWrap = document.getElementById("tabs");
      const panels = Array.from(document.querySelectorAll(".panel"));
      const LS_ORDER_KEY = "campo_unified_tabs_order_v1";

      // -------------------------
      // Small helpers
      // -------------------------
      function buildPublicUrl(path){
        const s = CONFIG.supabase;
        return `${s.baseUrl}/storage/v1/object/public/${s.bucket}/${path}`;
      }

      function upsertBadge(text, ok){
        let badge = document.getElementById("__sb_badge");
        if (!badge){
          badge = document.createElement("div");
          badge.id = "__sb_badge";
          badge.style.position = "fixed";
          badge.style.bottom = "12px";
          badge.style.right = "12px";
          badge.style.padding = "8px 12px";
          badge.style.borderRadius = "8px";
          badge.style.fontSize = "12px";
          badge.style.zIndex = 9999;
          badge.style.boxShadow = "0 10px 24px rgba(0,0,0,.35)";
          document.body.appendChild(badge);
        }
        badge.textContent = text;
        badge.style.background = ok ? "#16a34a" : "#b91c1c";
        badge.style.color = "white";
      }

      function dispatchLocal(type, key){
        try { window.dispatchEvent(new CustomEvent(type, { detail: { key, ts: Date.now() } })); } catch(e) {}
        try { document.dispatchEvent(new CustomEvent(type, { detail: { key, ts: Date.now() } })); } catch(e) {}
      }

      function notifyIframes(type){
        const targets = {
          "MASTER_GROW_UPDATED": ["ifr-seeding","ifr-transplant","ifr-sanitation","ifr-harvest","ifr-packing","ifr-data"],
          "MASTER_PACK_UPDATED": ["ifr-seeding","ifr-transplant","ifr-sanitation","ifr-harvest","ifr-packing","ifr-data"],
        }[type] || [];

        for (const id of targets){
          const ifr = document.getElementById(id);
          if (ifr?.contentWindow) {
            try { ifr.contentWindow.postMessage({ type, ts: Date.now() }, "*"); } catch(e) {}
          }
        }
      }

      // -------------------------
      // Supabase bootstrap -> hydrate localStorage
      // -------------------------
      async function tryHydrateFromSupabase(){
        if (!CONFIG.supabase.enabled) return;

        const testUrl = buildPublicUrl(CONFIG.supabase.paths.test);
        try{
          const tr = await fetch(testUrl, { cache: "no-store" });
          if (!tr.ok) throw new Error(`Test fetch failed: HTTP ${tr.status}`);
          await tr.json();
          upsertBadge("Supabase connected", true);
        } catch(err){
          console.error("‚ùå Supabase connection test failed:", err);
          upsertBadge("Supabase not reachable", false);
          return; // don‚Äôt try grow/pack if test fails
        }

        // Load grow.json + pack.json and write into the SAME localStorage keys dashboards use
        const growUrl = buildPublicUrl(CONFIG.supabase.paths.grow);
        const packUrl = buildPublicUrl(CONFIG.supabase.paths.pack);

        let wroteAny = false;

        try{
          const r = await fetch(growUrl, { cache: "no-store" });
          if (r.ok){
            const growJson = await r.json();
            localStorage.setItem(MASTER_GROW_KEY, JSON.stringify(growJson));
            localStorage.setItem(MASTER_GROW_PING, String(Date.now()));
            dispatchLocal(MSG_GROW, MASTER_GROW_KEY);
            notifyIframes(MSG_GROW);
            wroteAny = true;
          } else {
            console.warn("Grow fetch failed:", r.status);
          }
        } catch(e){
          console.warn("Grow fetch error:", e);
        }

        try{
          const r = await fetch(packUrl, { cache: "no-store" });
          if (r.ok){
            const packJson = await r.json();
            localStorage.setItem(MASTER_PACK_KEY, JSON.stringify(packJson));
            localStorage.setItem(MASTER_PACK_PING, String(Date.now()));
            dispatchLocal(MSG_PACK, MASTER_PACK_KEY);
            notifyIframes(MSG_PACK);
            wroteAny = true;
          } else {
            console.warn("Pack fetch failed:", r.status);
          }
        } catch(e){
          console.warn("Pack fetch error:", e);
        }

        if (wroteAny){
          console.log("‚úÖ Hydrated localStorage from Supabase (grow/pack).");
        } else {
          console.log("‚ÑπÔ∏è Supabase connected, but grow/pack were not loaded (missing files or blocked).");
        }
      }

      // ---------- Panel activation ----------
      function activate(id){
        const tabs = Array.from(tabsWrap.querySelectorAll(".tab"));
        tabs.forEach(t => t.classList.toggle("active", t.dataset.target === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));

        const panel = document.getElementById(id);
        const iframe = panel ? panel.querySelector("iframe[data-src]") : null;
        if (iframe && !iframe.src) iframe.src = iframe.getAttribute("data-src");
      }

      // ---------- Restore / Save order ----------
      function loadOrder(){
        try { return JSON.parse(localStorage.getItem(LS_ORDER_KEY) || "[]"); }
        catch(e){ return []; }
      }
      function saveOrder(){
        const ids = Array.from(tabsWrap.querySelectorAll(".tab")).map(t => t.dataset.tab);
        try { localStorage.setItem(LS_ORDER_KEY, JSON.stringify(ids)); } catch(e){}
      }
      function applySavedOrder(){
        const order = loadOrder();
        if (!order.length) return;
        const map = new Map(Array.from(tabsWrap.querySelectorAll(".tab")).map(t => [t.dataset.tab, t]));
        order.forEach(id => {
          const el = map.get(id);
          if (el) tabsWrap.appendChild(el);
        });
      }

      // ---------- Drag-to-reorder with threshold (click still works) ----------
      function makeSortable(){
        const DRAG_THRESHOLD = 8;

        let downTab = null;
        let isDragging = false;
        let placeholder = null;
        let offsetX = 0, offsetY = 0;
        let startX = 0, startY = 0;

        function pointerXY(e){
          const p = e.touches ? e.touches[0] : e;
          return { x: p.clientX, y: p.clientY };
        }

        function startDrag(tab, x, y){
          isDragging = true;

          const rect = tab.getBoundingClientRect();
          offsetX = x - rect.left;
          offsetY = y - rect.top;

          placeholder = tab.cloneNode(true);
          placeholder.classList.remove("active");
          placeholder.classList.add("placeholder");
          placeholder.style.width = rect.width + "px";
          placeholder.style.height = rect.height + "px";

          tabsWrap.insertBefore(placeholder, tab.nextSibling);

          tab.classList.add("dragging");
          tab.style.width = rect.width + "px";
          tab.style.height = rect.height + "px";
          tab.style.left = rect.left + "px";
          tab.style.top  = rect.top  + "px";
          tab.style.cursor = "grabbing";
        }

        function moveDrag(tab, x, y){
          tab.style.left = (x - offsetX) + "px";
          tab.style.top  = (y - offsetY) + "px";

          const tabs = Array.from(tabsWrap.querySelectorAll(".tab"))
            .filter(t => t !== tab && t !== placeholder);

          let inserted = false;
          for (const t of tabs) {
            const r = t.getBoundingClientRect();
            const tCenter = r.left + r.width/2;
            if (x < tCenter) {
              tabsWrap.insertBefore(placeholder, t);
              inserted = true;
              break;
            }
          }
          if (!inserted) tabsWrap.appendChild(placeholder);

          const wrapRect = tabsWrap.getBoundingClientRect();
          const edge = 36;
          if (x < wrapRect.left + edge) tabsWrap.scrollLeft -= 10;
          if (x > wrapRect.right - edge) tabsWrap.scrollLeft += 10;
        }

        function endDrag(tab){
          tab.classList.remove("dragging");
          tab.style.left = "";
          tab.style.top  = "";
          tab.style.width = "";
          tab.style.height = "";
          tab.style.cursor = "";

          if (placeholder) {
            tabsWrap.insertBefore(tab, placeholder);
            placeholder.remove();
            placeholder = null;
          }

          saveOrder();
          isDragging = false;
        }

        function cleanupListeners(){
          window.removeEventListener("mousemove", onMove);
          window.removeEventListener("mouseup", onUp);
          window.removeEventListener("touchmove", onMove);
          window.removeEventListener("touchend", onUp);
        }

        function onDown(e){
          const tab = e.target.closest(".tab");
          if (!tab) return;

          downTab = tab;
          isDragging = false;
          const {x,y} = pointerXY(e);
          startX = x; startY = y;

          window.addEventListener("mousemove", onMove, { passive:false });
          window.addEventListener("mouseup", onUp, { passive:true });
          window.addEventListener("touchmove", onMove, { passive:false });
          window.addEventListener("touchend", onUp, { passive:true });
        }

        function onMove(e){
          if (!downTab) return;

          const {x,y} = pointerXY(e);
          const dx = x - startX;
          const dy = y - startY;

          if (!isDragging) {
            if (Math.hypot(dx, dy) < DRAG_THRESHOLD) return;
            e.preventDefault();
            startDrag(downTab, x, y);
          } else {
            e.preventDefault();
            moveDrag(downTab, x, y);
          }
        }

        function onUp(){
          cleanupListeners();
          if (!downTab) return;

          if (isDragging) endDrag(downTab);
          else activate(downTab.dataset.target);

          downTab = null;
        }

        tabsWrap.addEventListener("mousedown", onDown);
        tabsWrap.addEventListener("touchstart", onDown, { passive:true });
      }

      // ---------- init ----------
      applySavedOrder();
      makeSortable();

      const firstActive = tabsWrap.querySelector(".tab.active") || tabsWrap.querySelector(".tab");
      if (firstActive) activate(firstActive.dataset.target);

      // Forward update pings into the right iframe (existing behavior)
      window.addEventListener("message", (event) => {
        const msg = event?.data || {};
        if (!msg.type) return;

        const map = {
          "HARVEST_DATA_UPDATED": "ifr-harvest",
          "PACKING_DATA_UPDATED": "ifr-packing",
          "SANITATION_DATA_UPDATED": "ifr-sanitation",
          "SEEDING_DATA_UPDATED": "ifr-seeding",
          "TRANSPLANT_DATA_UPDATED": "ifr-transplant",
          "MASTER_GROW_UPDATED": null,
          "MASTER_PACK_UPDATED": null
        };

        if (map[msg.type]) {
          const ifr = document.getElementById(map[msg.type]);
          if (ifr?.contentWindow) ifr.contentWindow.postMessage({ type: msg.type, ts: msg.ts }, "*");
        }
      });

      // IMPORTANT: hydrate localStorage from Supabase BEFORE users start clicking dashboards
      tryHydrateFromSupabase();
    })();
  </script>
</body>
</html>
