<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Packing Productivity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --border: #1f2937;
      --border-subtle: #374151;
      --text: #e5e7eb;
      --sub: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #4ade80;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --muted: #6b7280;
      --accent-blue: #3b82f6;
      --warn: #f59e0b;
      --warn-soft: rgba(245, 158, 11, 0.16);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1320px;
      border-radius: 24px;
      padding: 20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.09), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
    }

    /* Header */
    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block { flex: 1 1 200px; min-width: 0; }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 4px;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
    }

    .title-pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e 55%, #16a34a 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9), 0 12px 30px rgba(16, 185, 129, 0.6);
    }

    .title-pill span {
      font-size: 15px;
      font-weight: 700;
      color: #022c22;
    }

    .title-text {
      font-weight: 620;
      display: flex;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title-sub {
      font-size: 0.8rem;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .header-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--sub);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 55%);
      white-space: nowrap;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
    }

    .chip-warn-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.35);
    }

    .chip-danger-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 0 3px rgba(248, 180, 116, 0.6);
    }

    .chip-err-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.28);
    }

    /* Panel */
    .panel {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(14px);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .panel-title {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sub);
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .panel-title-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.45);
    }

    .panel-title-dot.blue {
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.48);
    }

    .panel-subtitle { font-size: 0.75rem; color: var(--muted); }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--sub);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.55), rgba(15, 23, 42, 0.95));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
    }

    .badge-soft span {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(226, 232, 240, 0.95);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 5px 12px;
      font-size: 0.74rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      transition: background 0.12s ease, transform 0.05s ease, box-shadow 0.12s ease;
      font-family: inherit;
      user-select: none;
      -webkit-user-select: none;
    }
    .btn:active { transform: scale(.99); }
    .btn-ghost { background: rgba(15, 23, 42, 0.9); }
    .btn-ghost:hover { background: rgba(31, 41, 55, 0.95); }
    .btn-toggle { padding: 4px 9px; font-size: 0.7rem; }

    /* Config */
    .throughput-config {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 8px 12px;
      align-items: end;
      font-size: 0.73rem;
    }

    .throughput-config label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: var(--muted);
    }

    .throughput-config input {
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.73rem;
      padding: 4px 6px;
      width: 100%;
    }

    .throughput-config-note {
      grid-column: 1 / -1;
      color: var(--muted);
      font-size: 0.7rem;
    }

    .case-config {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
    }

    .case-config-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sub);
      margin-bottom: 6px;
    }

    .case-config-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
      font-size: 0.73rem;
    }

    .case-config-item label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .case-config-item span { color: var(--muted); }

    .case-config-item input {
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.73rem;
      padding: 4px 6px;
      width: 100%;
    }

    .config-panel { margin-bottom: 12px; }
    .config-panel-body { margin-top: 8px; }
    .config-panel-body.collapsed { display: none; }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 10px;
    }
    .config-grid .case-config,
    .config-grid .throughput-config { margin-top: 0; height: 100%; }

    /* SKU Tabs */
    .sku-tabs {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .sku-tab-group {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 3px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow-x: auto;
      max-width: 100%;
    }

    .sku-tab-group::-webkit-scrollbar { height: 6px; }
    .sku-tab-group::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.9); }
    .sku-tab-group::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.9); border-radius: 999px; }

    .sku-tab {
      border: none;
      background: transparent;
      color: var(--sub);
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      padding: 5px 12px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      white-space: nowrap;
      user-select: none;
      -webkit-user-select: none;
    }

    .sku-tab-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }

    .sku-tab.active {
      background: radial-gradient(circle at 20% 0, #1d4ed8, #020617 55%);
      color: #e5e7eb;
    }

    .sku-tab.active .sku-tab-dot {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .sku-tabs-note {
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
      text-align: right;
    }

    /* KPI cards */
    .kpi-toolbar {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
      margin-bottom: 4px;
      gap: 8px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
      margin-top: 6px;
    }

    .kpi-card {
      position: relative;
      border-radius: 16px;
      padding: 10px 12px 11px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(51, 65, 85, 0.9);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .kpi-label {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--sub);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kpi-value {
      font-size: 1.15rem;
      font-weight: 650;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-unit {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
    }

    .kpi-trend {
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-meta {
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .kpi-glow {
      position: absolute;
      inset: 0;
      opacity: 0.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34, 197, 94, 0.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.4), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    @media (max-width: 960px) {
      .container { border-radius: 18px; padding: 14px 12px 14px; }
      .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    /* Main layout */
    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 2.2fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 960px) {
      .layout-main { grid-template-columns: minmax(0, 1fr); }
    }

    /* Charts */
    .chart-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
      flex: 1 1 auto;
    }

    .chart-row { position: relative; width: 100%; }
    .chart-canvas-main { width: 100%; height: 230px; }
    .chart-canvas-secondary { width: 100%; height: 200px; }

    @media (max-width: 960px) {
      .chart-canvas-main { height: 210px; }
      .chart-canvas-secondary { height: 180px; }
    }

    .trend-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--sub);
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      user-select: none;
      -webkit-user-select: none;
    }

    .trend-toggle input { margin: 0; }

    /* View toggle (Run / Daily / Weekly) */
    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 2px;
    }

    .view-pill {
      border: none;
      background: transparent;
      color: var(--sub);
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-family: inherit;
      user-select: none;
      -webkit-user-select: none;
    }

    .view-pill.active {
      background: radial-gradient(circle at 20% 0, rgba(34, 197, 94, 0.48), rgba(15, 23, 42, 1));
      color: #e5e7eb;
    }

    /* Table */
    .table-wrapper {
      margin-top: 4px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background:
        linear-gradient(135deg, rgba(17, 24, 39, 0.96), rgba(15, 23, 42, 0.99)),
        radial-gradient(circle at top left, rgba(51, 65, 85, 0.65), rgba(15, 23, 42, 0.96));
      overflow: hidden;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .table-scroll {
      max-height: 430px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15, 23, 42, 0.2);
      flex: 1 1 auto;
    }

    .table-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-scroll::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.8); }
    .table-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 999px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 720px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background:
        linear-gradient(to bottom, #020617, #020617),
        radial-gradient(circle at top left, rgba(55, 65, 81, 0.5), rgba(15, 23, 42, 0.95));
      box-shadow: 0 1px 0 rgba(31, 41, 55, 0.9);
    }

    th, td {
      text-align: right;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; padding-left: 14px; }
    th:last-child, td:last-child { padding-right: 12px; }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--sub);
      background: transparent;
    }

    tbody tr:nth-child(odd) td { background: rgba(15, 23, 42, 0.85); }
    tbody tr:nth-child(even) td { background: rgba(17, 24, 39, 0.92); }
    tbody tr:hover td {
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.08), rgba(15, 23, 42, 0.98));
    }

    tfoot td {
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.12), rgba(15, 23, 42, 0.98));
      font-weight: 600;
      border-top: 1px solid rgba(55, 65, 81, 0.95);
      border-bottom: none;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-note span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-box {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .legend-box.weight { background: rgba(59, 130, 246, 0.5); }
    .legend-box.speed { background: rgba(34, 197, 94, 0.7); }

    .banner {
      border-radius: 16px;
      border: 1px solid rgba(245, 158, 11, 0.55);
      background: radial-gradient(circle at top left, rgba(245, 158, 11, 0.16), rgba(15, 23, 42, 0.98));
      padding: 10px 12px;
      margin-bottom: 12px;
      color: rgba(226, 232, 240, 0.92);
      font-size: 0.8rem;
      display: none;
    }
    .banner strong { color: #fff; }
    .banner ul { margin: 6px 0 0; padding-left: 18px; color: rgba(148, 163, 184, 0.95); }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <!-- Header -->
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>Σ</span></div>
            <div class="title-text">
              <span>Packing Productivity Dashboard</span>
              <span class="title-sub">LIVE • MASTER PACK</span>
            </div>
          </div>
          <p class="subtitle">
            Reads Master Pack from <code>localStorage["campo_master_pack_v1"]</code> (JSON payload from Data Input).
            Updates automatically on <code>MASTER_PACK_UPDATED</code>.
            Modes: <strong>Run</strong> (raw), <strong>Daily</strong> (aggregated by date),
            <strong>Weekly</strong> (by Pack Week; week 0 / N/A ignored).
          </p>
        </div>
        <div class="header-tags">
          <div class="chip" id="chip-data-status">
            <span class="chip-warn-dot"></span>
            <span id="chip-data-text">Waiting for data…</span>
          </div>
          <div class="chip" id="chip-last-updated">
            <span class="chip-dot"></span>
            <span id="chip-updated-text">Updated: –</span>
          </div>
          <div class="chip">
            <span class="chip-danger-dot"></span>
            <span>Zeros removed • Week 0 / N/A ignored in weekly</span>
          </div>
        </div>
      </header>

      <!-- Missing columns / status banner -->
      <div class="banner" id="status-banner"></div>

      <!-- Configuration panel -->
      <section class="panel config-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span>
              <span>Configuration</span>
            </div>
            <div class="panel-subtitle">
              Tune units per case and potential throughput hours; saved locally.
            </div>
          </div>
          <div class="panel-header-right">
            <button class="btn btn-ghost btn-toggle" id="toggle-config-panel-btn" type="button">
              <span class="icon" id="toggle-config-icon">▸</span>
              <span id="toggle-config-label">Show</span>
            </button>
          </div>
        </div>
        <div class="config-panel-body collapsed" id="config-panel-body">
          <div class="config-grid">
            <div class="case-config">
              <div class="case-config-title">Case size settings (units per case)</div>
              <div class="case-config-grid">
                <div class="case-config-item">
                  <label>
                    <span>1 lb bags (e.g. 01LB)</span>
                    <input id="cfg-1lb" type="number" step="0.01" min="0" />
                  </label>
                </div>
                <div class="case-config-item">
                  <label>
                    <span>3 lb bags (e.g. 03LB)</span>
                    <input id="cfg-3lb" type="number" step="0.01" min="0" />
                  </label>
                </div>
                <div class="case-config-item">
                  <label>
                    <span>5 oz clamshells (05OZ)</span>
                    <input id="cfg-5oz" type="number" step="0.01" min="0" />
                  </label>
                </div>
                <div class="case-config-item">
                  <label>
                    <span>10 oz clamshells (10OZ)</span>
                    <input id="cfg-10oz" type="number" step="0.01" min="0" />
                  </label>
                </div>
                <div class="case-config-item">
                  <label>
                    <span>16 oz clamshells (16OZ)</span>
                    <input id="cfg-16oz" type="number" step="0.01" min="0" />
                  </label>
                </div>
              </div>
            </div>

            <div class="throughput-config">
              <label>
                <span>Hours per day used for potential lbs / week</span>
                <input id="potential-hours-input" type="number" step="0.1" min="0" />
              </label>
              <label>
                <span>Top # of speeds to average for potential</span>
                <input id="potential-topn-input" type="number" step="1" min="1" />
              </label>
              <div class="throughput-config-note" id="potential-hours-note">
                Potential uses avg of top 2 speeds × 7 hours/day × 5 days.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SKU Tabs -->
      <section class="sku-tabs">
        <div class="sku-tab-group" id="sku-tab-group"></div>
        <div class="sku-tabs-note">VIEW BY PRODUCT • CLICK TO FILTER</div>
      </section>

      <!-- KPI toolbar -->
      <div class="kpi-toolbar">
        <button class="btn btn-ghost btn-toggle" id="toggle-units-kpi-btn" type="button">
          Show Units/min card
        </button>
      </div>

      <!-- KPI row -->
      <section class="kpi-grid">
        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Total packed weight</div>
          <div class="kpi-value">
            <span id="kpi-total-weight">–</span>
            <span class="kpi-unit">lbs</span>
          </div>
          <div class="kpi-trend" id="kpi-days-recorded">–</div>
          <div class="kpi-meta">Sum of packed pounds in current view mode.</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average lbs / hour</div>
          <div class="kpi-value">
            <span id="kpi-avg-lbshour">–</span>
            <span class="kpi-unit">lbs / hour</span>
          </div>
          <div class="kpi-trend" id="kpi-top-speed">–</div>
          <div class="kpi-meta">Computed as total weight ÷ total hours (mode-aware).</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Total cases packed</div>
          <div class="kpi-value">
            <span id="kpi-total-cases">–</span>
          </div>
          <div class="kpi-trend">Finished cases in current view.</div>
          <div class="kpi-meta">Sum of cases produced.</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Potential lbs / week</div>
          <div class="kpi-value">
            <span id="kpi-potential-week">–</span>
            <span class="kpi-unit">lbs / week</span>
          </div>
          <div class="kpi-trend" id="kpi-potential-note">–</div>
          <div class="kpi-meta" id="kpi-potential-formula">Avg of top speeds × hours × 5 days.</div>
        </article>

        <!-- Units/min KPI (hidden by default) -->
        <article class="kpi-card" id="kpi-units-card" style="display:none;">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average units / minute</div>
          <div class="kpi-value">
            <span id="kpi-units-min">–</span>
            <span class="kpi-unit">units / min</span>
          </div>
          <div class="kpi-trend" id="kpi-units-note">
            Uses case size settings (units per case).
          </div>
          <div class="kpi-meta">
            Weighted by total minutes across rows with known case size.
          </div>
        </article>
      </section>

      <!-- Main layout: charts + table -->
      <section class="layout-main">
        <!-- Charts -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot"></span>
                <span>Performance over time</span>
              </div>
              <div class="panel-subtitle">
                Top: Packed weight · Bottom: Lbs / hour. Run = raw rows; Daily = aggregated by date; Weekly = aggregated by Pack Week (week 0/N/A ignored).
              </div>
            </div>
            <div class="panel-header-right">
              <div class="badge-soft">
                <span class="badge-dot"></span>
                <span>Live from Master Pack</span>
              </div>
              <div class="view-toggle" id="view-toggle">
                <button class="view-pill" type="button" data-view="run">Run</button>
                <button class="view-pill active" type="button" data-view="daily">Daily</button>
                <button class="view-pill" type="button" data-view="weekly">Weekly</button>
              </div>
              <label class="trend-toggle">
                <input type="checkbox" id="trend-toggle-input" />
                <span>Trend line (speed)</span>
              </label>
            </div>
          </div>
          <div class="chart-wrapper">
            <div class="chart-row">
              <canvas id="chart-weight" class="chart-canvas-main"></canvas>
            </div>
            <div class="chart-row">
              <canvas id="chart-speed" class="chart-canvas-secondary"></canvas>
            </div>
          </div>
          <div class="footer-note">
            <span><span class="legend-box weight"></span> Top chart: Packed weight (bars)</span>
            <span><span class="legend-box speed"></span> Bottom chart: Lbs / hour (line + optional trend)</span>
          </div>
        </section>

        <!-- Table -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot blue"></span>
                <span>Run / Daily / Weekly packing log</span>
              </div>
              <div class="panel-subtitle">
                Table follows the Run / Daily / Weekly toggle.
              </div>
            </div>
            <div class="panel-header-right">
              <span id="table-mode-badge">Mode: Daily</span>
            </div>
          </div>
          <div class="table-wrapper">
            <div class="table-scroll">
              <table id="packing-table">
                <thead>
                  <tr>
                    <th>Date / Week / Run</th>
                    <th>Hours</th>
                    <th>SKU</th>
                    <th>Packed weight (lbs)</th>
                    <th>Cases packed</th>
                    <th>Lbs / hour</th>
                    <th>Lbs / day</th>
                    <th>Projected lbs / week</th>
                  </tr>
                </thead>
                <tbody id="log-body"></tbody>
                <tfoot>
                  <tr>
                    <td>Totals</td>
                    <td id="tf-hours">–</td>
                    <td>–</td>
                    <td id="tf-weight">–</td>
                    <td id="tf-cases">–</td>
                    <td id="tf-avg-lbshour">–</td>
                    <td id="tf-avg-lbsday">–</td>
                    <td id="tf-note">–</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <div class="footer-note" id="packing-footer-note"></div>
        </section>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // Data source (DO NOT CHANGE)
    // =========================
    const MASTER_PACK_KEY = "campo_master_pack_v1";
    const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";
    const UPDATE_EVENT_TYPE = "MASTER_PACK_UPDATED"; // received via postMessage
    const MASTER_PACK_SHEET_NAME = "Master Pack";
    const POTENTIAL_DAYS_PER_WEEK = 5;

    // Config storage
    const UNITS_CONFIG_KEY = "campo_packing_units_config_v1";
    const POTENTIAL_SETTINGS_KEY = "campo_packing_potential_hours_v1";
    const POTENTIAL_TOPN_KEY = "campo_packing_potential_topn_v1";

    // Required exact headers in MASTER PACK (JSON payload sheet.headers)
    const REQUIRED_HEADERS = [
      "Batch Run Date",
      "Pack Week",
      "SKU Packed",
      "Quantity of Cases Packed",
      "Total # de personas Pack",
      "Total Pack Tiempo Transcurido",
      "Total Packed Weight"
    ];

    // default units-per-case settings
    let unitsConfig = {
      "1lb": 10,   // 10 bags per case
      "3lb": 3,    // 3 bags per case
      "5oz": 18,   // 18 clamshells per case
      "10oz": 12,  // 12 clamshells per case
      "16oz": 8    // 8 clamshells per case
    };

    let potentialHoursPerDay = 7;
    let potentialTopNSpeeds = 2;

    let allRows = []; // master list (filtered non-zero, valid)
    let filteredOutCount = 0;

    let showTrendLine = false;
    let weightChart = null;
    let speedChart = null;

    let currentTabKey = "all";
    let currentViewMode = "daily"; // "run" | "daily" | "weekly"

    // -------------------------
    // Utils
    // -------------------------
    function formatNumber(value, decimals = 0) {
      return Number(value || 0).toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function parseNumber(v) {
      if (v == null) return 0;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const clean = s.replace(/,/g, "");
      const n = parseFloat(clean);
      return Number.isFinite(n) ? n : 0;
    }

    function fmtTs(ts) {
      if (!ts) return "–";
      const d = new Date(Number(ts));
      if (isNaN(d.getTime())) return "–";
      return d.toLocaleString();
    }

    function setStatusChip(kind, text) {
      const chip = document.getElementById("chip-data-status");
      const dot = chip?.querySelector("span");
      const label = document.getElementById("chip-data-text");
      if (!chip || !dot || !label) return;

      const newDot = document.createElement("span");
      newDot.className =
        kind === "ok" ? "chip-dot" :
        kind === "warn" ? "chip-warn-dot" :
        "chip-err-dot";
      chip.replaceChild(newDot, dot);

      label.textContent = text || "";
    }

    function setUpdatedChip(ts) {
      const el = document.getElementById("chip-updated-text");
      if (el) el.textContent = `Updated: ${fmtTs(ts)}`;
    }

    function showBanner(htmlOrNull) {
      const b = document.getElementById("status-banner");
      if (!b) return;
      if (!htmlOrNull) {
        b.style.display = "none";
        b.innerHTML = "";
        return;
      }
      b.style.display = "block";
      b.innerHTML = htmlOrNull;
    }

    function normalizeWeek(rawWeek) {
      const s = String(rawWeek ?? "").trim();
      if (!s) return null;
      const up = s.toUpperCase();
      if (up === "N/A" || up === "NA" || up === "NULL") return null;
      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n <= 0) return null; // ignores week 0
      return String(n);
    }

    function dayKeyFromDate(dateStr) {
      const s = String(dateStr || "").trim();
      if (!s) return null;
      const d = new Date(s);
      if (isNaN(d.getTime())) return s; // fallback if it's already formatted
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    function labelFromDayKey(dayKey) {
      if (!dayKey) return "–";
      if (/^\d{4}-\d{2}-\d{2}$/.test(dayKey)) {
        const d = new Date(dayKey + "T00:00:00");
        return d.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      }
      return String(dayKey);
    }

    // -------------------------
    // MASTER PACK JSON PAYLOAD (from Data Input)
    // -------------------------
    function loadMasterPackPayload() {
      const raw = (localStorage.getItem(MASTER_PACK_KEY) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToRowObjects(sheetObj) {
      const headers = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
      const out = [];
      for (const r of rows) {
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i = 0; i < headers.length; i++) {
          const h = headers[i];
          const key = (h === null || h === undefined) ? "" : String(h);
          if (!key.trim()) continue;
          obj[key] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    // -------------------------
    // Parse rows from Master Pack (JSON) + FILTER OUT ZEROS/INVALID
    // -------------------------
    function parseMasterPackJSON(payload) {
      const sheet = payload?.sheets?.[MASTER_PACK_SHEET_NAME];
      if (!sheet) {
        return { rows: [], missing: REQUIRED_HEADERS.slice(), headers: [] };
      }

      const headers = Array.isArray(sheet.headers) ? sheet.headers.map(h => String(h ?? "")) : [];
      const headerSet = new Set(headers);
      const missing = REQUIRED_HEADERS.filter(h => !headerSet.has(h));
      if (missing.length) {
        return { rows: [], missing, headers };
      }

      const rowObjs = sheetToRowObjects(sheet);
      const out = [];
      let removed = 0;

      for (const r of rowObjs) {
        const date = String(r["Batch Run Date"] ?? "").trim();
        const weekRaw = String(r["Pack Week"] ?? "").trim();
        const week = normalizeWeek(weekRaw);
        const sku = String(r["SKU Packed"] ?? "").trim();

        const cases = parseNumber(r["Quantity of Cases Packed"]);
        const persons = parseNumber(r["Total # de personas Pack"]);
        const hours = parseNumber(r["Total Pack Tiempo Transcurido"]);
        const weight = parseNumber(r["Total Packed Weight"]);

        // skip fully empty rows
        if (!date && !weekRaw && !sku && !cases && !persons && !hours && !weight) continue;

        // HARD FILTER (same behavior as your TSV version)
        if (!date || !sku || !(hours > 0) || !(weight > 0)) { removed++; continue; }

        const lbsHour = weight / hours;
        if (!(lbsHour > 0)) { removed++; continue; }

        const lbsDay = lbsHour * potentialHoursPerDay;
        const lbsWeek = lbsDay * POTENTIAL_DAYS_PER_WEEK;

        out.push({
          date,
          dayKey: dayKeyFromDate(date),
          week,
          weekRaw,
          sku,
          hours,
          weight,
          cases,
          persons,
          lbsHour,
          lbsDay,
          lbsWeek
        });
      }

      filteredOutCount = removed;
      return { rows: out, missing: [], headers };
    }

    // -------------------------
    // Config storage
    // -------------------------
    function loadUnitsConfigFromStorage() {
      try {
        const raw = localStorage.getItem(UNITS_CONFIG_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        ["1lb", "3lb", "5oz", "10oz", "16oz"].forEach((k) => {
          if (obj && obj[k] != null && !isNaN(parseFloat(obj[k]))) {
            unitsConfig[k] = parseFloat(obj[k]);
          }
        });
      } catch (e) {
        console.warn("Could not load units config:", e);
      }
    }

    function saveUnitsConfigToStorage() {
      try { localStorage.setItem(UNITS_CONFIG_KEY, JSON.stringify(unitsConfig)); }
      catch (e) { console.warn("Could not save units config:", e); }
    }

    function loadPotentialHoursFromStorage() {
      try {
        const raw = localStorage.getItem(POTENTIAL_SETTINGS_KEY);
        const val = parseFloat(raw);
        if (!isNaN(val) && val > 0) potentialHoursPerDay = val;
      } catch (e) {
        console.warn("Could not load potential hours:", e);
      }
    }

    function savePotentialHoursToStorage() {
      try { localStorage.setItem(POTENTIAL_SETTINGS_KEY, String(potentialHoursPerDay)); }
      catch (e) { console.warn("Could not save potential hours:", e); }
    }

    function loadPotentialTopNFromStorage() {
      try {
        const raw = localStorage.getItem(POTENTIAL_TOPN_KEY);
        const val = parseInt(raw, 10);
        if (!isNaN(val) && val > 0) potentialTopNSpeeds = val;
      } catch (e) {
        console.warn("Could not load potential top N:", e);
      }
    }

    function savePotentialTopNToStorage() {
      try { localStorage.setItem(POTENTIAL_TOPN_KEY, String(potentialTopNSpeeds)); }
      catch (e) { console.warn("Could not save potential top N:", e); }
    }

    function updatePotentialCopy() {
      const note = document.getElementById("potential-hours-note");
      if (note) {
        note.textContent = `Potential uses avg of top ${potentialTopNSpeeds} speed(s) × ${formatNumber(
          potentialHoursPerDay, 1
        )} hours/day × ${POTENTIAL_DAYS_PER_WEEK} days.`;
      }
      const meta = document.getElementById("kpi-potential-formula");
      if (meta) {
        meta.textContent = `Avg of top ${potentialTopNSpeeds} packing speed(s) × ${formatNumber(
          potentialHoursPerDay, 1
        )} hours × ${POTENTIAL_DAYS_PER_WEEK} days.`;
      }
    }

    // -------------------------
    // Units / SKU helpers
    // -------------------------
    function getSizeKeyForSku(skuRaw) {
      if (!skuRaw) return null;
      const sku = String(skuRaw).toUpperCase();
      if (sku.includes("16OZ")) return "16oz";
      if (sku.includes("10OZ")) return "10oz";
      if (sku.includes("05OZ") || sku.includes("5OZ")) return "5oz";
      if (sku.includes("03LB") || sku.includes("3LB")) return "3lb";
      if (sku.includes("01LB") || sku.includes("1LB")) return "1lb";
      return null;
    }

    function getUnitsPerCaseForSku(sku) {
      const key = getSizeKeyForSku(sku);
      if (!key) return 0;
      const val = unitsConfig[key];
      return typeof val === "number" && val > 0 ? val : 0;
    }

    // -------------------------
    // Tabs + filtering
    // -------------------------
    function getRowsForTab(tabKey) {
      if (!allRows.length) return [];
      if (!tabKey || tabKey === "all") return allRows.slice();
      if (tabKey.startsWith("sku:")) {
        const sku = tabKey.slice(4);
        return allRows.filter((r) => (r.sku || "").trim() === sku);
      }
      return allRows.slice();
    }

    function getTabLabel(tabKey) {
      if (!tabKey || tabKey === "all") return "All SKUs";
      if (tabKey.startsWith("sku:")) return tabKey.slice(4);
      return tabKey;
    }

    function buildSkuTabs() {
      const group = document.getElementById("sku-tab-group");
      if (!group) return;
      group.innerHTML = "";

      const makeBtn = (label, tabKey) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sku-tab";
        btn.dataset.tab = tabKey;
        btn.innerHTML = `<span class="sku-tab-dot"></span><span>${label}</span>`;
        group.appendChild(btn);
      };

      makeBtn("All SKUs", "all");

      const uniqueSkus = Array.from(
        new Set(allRows.map((r) => (r.sku || "").trim()).filter(Boolean))
      ).sort();

      uniqueSkus.forEach((sku) => makeBtn(sku, "sku:" + sku));

      document.querySelectorAll(".sku-tab").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === currentTabKey);
      });
    }

    // -------------------------
    // View builders (RUN / DAILY AGG / WEEKLY AGG)
    // -------------------------
    function buildRunRows(tabKey) {
      const rows = getRowsForTab(tabKey);
      rows.sort((a, b) => {
        const ta = new Date(a.date).getTime();
        const tb = new Date(b.date).getTime();
        if (!isNaN(ta) && !isNaN(tb)) return ta - tb;
        return String(a.date).localeCompare(String(b.date));
      });

      return rows.map((r) => ({
        label: r.date,
        sku: r.sku,
        hours: r.hours,
        weight: r.weight,
        cases: r.cases,
        lbsHour: r.lbsHour,
        lbsDay: r.lbsHour * potentialHoursPerDay,
        lbsWeek: r.lbsHour * potentialHoursPerDay * POTENTIAL_DAYS_PER_WEEK
      }));
    }

    function buildDailyRows(tabKey) {
      const rows = getRowsForTab(tabKey);

      const map = new Map(); // dayKey -> agg
      rows.forEach((r) => {
        const k = r.dayKey || r.date;
        if (!k) return;
        if (!map.has(k)) map.set(k, { dayKey: k, hours: 0, weight: 0, cases: 0 });
        const acc = map.get(k);
        acc.hours += r.hours || 0;
        acc.weight += r.weight || 0;
        acc.cases += r.cases || 0;
      });

      const keys = Array.from(map.keys()).sort((a, b) => {
        if (/^\d{4}-\d{2}-\d{2}$/.test(a) && /^\d{4}-\d{2}-\d{2}$/.test(b)) return a.localeCompare(b);
        return String(a).localeCompare(String(b));
      });

      const skuLabel = getTabLabel(tabKey);

      return keys.map((k) => {
        const acc = map.get(k);
        const lbsHour = acc.hours > 0 ? (acc.weight / acc.hours) : 0;
        return {
          label: labelFromDayKey(k),
          sku: skuLabel,
          hours: acc.hours,
          weight: acc.weight,
          cases: acc.cases,
          lbsHour,
          lbsDay: lbsHour * potentialHoursPerDay,
          lbsWeek: lbsHour * potentialHoursPerDay * POTENTIAL_DAYS_PER_WEEK
        };
      }).filter(r => (r.weight > 0 && r.hours > 0 && r.lbsHour > 0));
    }

    function buildWeeklyRows(tabKey) {
      const rows = getRowsForTab(tabKey).filter(r => r.week != null); // ignores 0 / N/A / blank
      const map = new Map(); // year-week -> agg
      const years = new Set();
      rows.forEach((r) => {
        const year = (() => {
          const d = new Date(r.date);
          return isNaN(d.getTime()) ? null : d.getFullYear();
        })();
        if (year) years.add(year);

        const k = r.week;
        const key = year ? `${year}-W${k}` : k;
        if (!map.has(key)) {
          map.set(key, { week: k, year, weekNum: parseFloat(k), label: "", hours: 0, weight: 0, cases: 0 });
        }
        const acc = map.get(key);
        acc.hours += r.hours || 0;
        acc.weight += r.weight || 0;
        acc.cases += r.cases || 0;
      });

      const showYear = years.size > 1;
      map.forEach(acc => {
        const hasWeekNum = !isNaN(acc.weekNum);
        if (acc.year && hasWeekNum) {
          acc.label = showYear ? `Wk ${acc.week} (${acc.year})` : `Wk ${acc.week}`;
          acc.order = acc.year * 100 + acc.weekNum;
        } else if (hasWeekNum) {
          acc.label = `Wk ${acc.week}`;
          acc.order = acc.weekNum;
        } else {
          acc.label = String(acc.week || "N/A");
          acc.order = null;
        }
      });
      const values = Array.from(map.values()).sort((a, b) => {
        if (a.order === null || b.order === null) return String(a.label).localeCompare(String(b.label));
        return a.order - b.order;
      });
      const skuLabel = getTabLabel(tabKey);

      return values.map((acc) => {
        const lbsHour = acc.hours > 0 ? (acc.weight / acc.hours) : 0;
        return {
          label: acc.label,
          sku: skuLabel,
          hours: acc.hours,
          weight: acc.weight,
          cases: acc.cases,
          lbsHour,
          lbsDay: lbsHour * potentialHoursPerDay,
          lbsWeek: lbsHour * potentialHoursPerDay * POTENTIAL_DAYS_PER_WEEK
        };
      }).filter(r => (r.weight > 0 && r.hours > 0 && r.lbsHour > 0));
    }

    function getViewRows(tabKey) {
      if (currentViewMode === "run") return buildRunRows(tabKey);
      if (currentViewMode === "weekly") return buildWeeklyRows(tabKey);
      return buildDailyRows(tabKey);
    }

    // -------------------------
    // Metrics (mode-aware / weighted)
    // -------------------------
    function computeMetrics(viewRows) {
      if (!viewRows.length) {
        return {
          totalWeight: 0,
          totalCases: 0,
          totalHours: 0,
          avgLbsHour: 0,
          avgLbsDay: 0,
          topSpeedsAvg: 0,
          potentialWeek: 0,
          avgUnitsMin: 0
        };
      }

      let totalWeight = 0;
      let totalCases = 0;
      let totalHours = 0;

      const speeds = [];

      let totalUnits = 0;
      let totalMinutes = 0;

      viewRows.forEach((r) => {
        totalWeight += r.weight || 0;
        totalCases += r.cases || 0;
        totalHours += r.hours || 0;

        const lh = r.lbsHour || 0;
        speeds.push(lh);

        const skuForUnits = (currentViewMode === "run")
          ? r.sku
          : (currentTabKey.startsWith("sku:") ? currentTabKey.slice(4) : null);

        const unitsPerCase = skuForUnits ? getUnitsPerCaseForSku(skuForUnits) : 0;
        if (unitsPerCase && (r.hours > 0)) {
          totalUnits += (r.cases || 0) * unitsPerCase;
          totalMinutes += (r.hours || 0) * 60;
        }
      });

      const avgLbsHour = totalHours > 0 ? (totalWeight / totalHours) : 0;
      const avgLbsDay = avgLbsHour * potentialHoursPerDay;

      speeds.sort((a, b) => b - a);
      const n = Math.min(Math.max(1, potentialTopNSpeeds), speeds.length);
      let topSpeedsAvg = 0;
      if (n > 0) {
        let sumTop = 0;
        for (let i = 0; i < n; i++) sumTop += speeds[i];
        topSpeedsAvg = sumTop / n;
      }

      const potentialWeek = topSpeedsAvg * potentialHoursPerDay * POTENTIAL_DAYS_PER_WEEK;
      const avgUnitsMin = totalMinutes ? (totalUnits / totalMinutes) : 0;

      return {
        totalWeight,
        totalCases,
        totalHours,
        avgLbsHour,
        avgLbsDay,
        topSpeedsAvg,
        potentialWeek,
        avgUnitsMin
      };
    }

    // -------------------------
    // Trend line
    // -------------------------
    function computeTrendLine(values) {
      const n = values.length;
      if (!n || n < 2) return [];
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (let i = 0; i < n; i++) {
        const x = i + 1;
        const y = Number(values[i]) || 0;
        sumX += x; sumY += y; sumXY += x * y; sumXX += x * x;
      }
      const denom = n * sumXX - sumX * sumX;
      if (denom === 0) return Array(n).fill(values[0] || 0);
      const slope = (n * sumXY - sumX * sumY) / denom;
      const intercept = (sumY - slope * sumX) / n;
      const trend = [];
      for (let i = 0; i < n; i++) trend.push(slope * (i + 1) + intercept);
      return trend;
    }

    // -------------------------
    // KPIs
    // -------------------------
    function renderKpis(tabKey) {
      const viewRows = getViewRows(tabKey);
      const metrics = computeMetrics(viewRows);
      const label = getTabLabel(tabKey);
      updatePotentialCopy();

      const modeLabel =
        currentViewMode === "run" ? "Run" :
        currentViewMode === "weekly" ? "Weekly" : "Daily";

      document.getElementById("kpi-total-weight").textContent = formatNumber(metrics.totalWeight, 0);
      document.getElementById("kpi-days-recorded").textContent =
        `${label} • ${viewRows.length} ${modeLabel.toLowerCase()} row(s) • ${filteredOutCount.toLocaleString()} removed`;

      document.getElementById("kpi-avg-lbshour").textContent = formatNumber(metrics.avgLbsHour, 1);

      if (viewRows.length) {
        const best = viewRows.reduce((bestRow, r) => (r.lbsHour > bestRow.lbsHour ? r : bestRow), viewRows[0]);
        document.getElementById("kpi-top-speed").textContent =
          `Top ${modeLabel}: ${formatNumber(best.lbsHour, 0)} lbs/hr (${best.label})`;
      } else {
        document.getElementById("kpi-top-speed").textContent = "Top: –";
      }

      document.getElementById("kpi-total-cases").textContent = formatNumber(metrics.totalCases, 1);
      document.getElementById("kpi-potential-week").textContent = formatNumber(metrics.potentialWeek, 0);
      document.getElementById("kpi-potential-note").textContent =
        `Avg of top ${potentialTopNSpeeds}: ${formatNumber(metrics.topSpeedsAvg, 0)} lbs/hr`;

      const unitsSpan = document.getElementById("kpi-units-min");
      const unitsNote = document.getElementById("kpi-units-note");
      if (unitsSpan) unitsSpan.textContent = formatNumber(metrics.avgUnitsMin, 2);
      if (unitsNote) {
        if (currentTabKey.startsWith("sku:") || currentViewMode === "run") {
          unitsNote.textContent = `Weighted units/min using case-size settings.`;
        } else {
          unitsNote.textContent = `Units/min needs a single SKU selection (or use Run mode).`;
        }
      }
    }

    // -------------------------
    // Table
    // -------------------------
    function renderTable(tabKey) {
      const tbody = document.getElementById("log-body");
      const tfHours = document.getElementById("tf-hours");
      const tfWeight = document.getElementById("tf-weight");
      const tfCases = document.getElementById("tf-cases");
      const tfAvgLbsHour = document.getElementById("tf-avg-lbshour");
      const tfAvgLbsDay = document.getElementById("tf-avg-lbsday");
      const tfNote = document.getElementById("tf-note");
      const footerNote = document.getElementById("packing-footer-note");
      const tableModeBadge = document.getElementById("table-mode-badge");

      tbody.innerHTML = "";

      const viewRows = getViewRows(tabKey);
      const metrics = computeMetrics(viewRows);

      const modeLabel =
        currentViewMode === "run" ? "Run (raw rows)" :
        currentViewMode === "weekly" ? "Weekly (aggregated)" : "Daily (aggregated)";

      if (tableModeBadge) tableModeBadge.textContent = `Mode: ${modeLabel}`;

      viewRows.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.label}</td>
          <td>${formatNumber(row.hours, 1)}</td>
          <td>${row.sku || ""}</td>
          <td>${formatNumber(row.weight, 1)}</td>
          <td>${formatNumber(row.cases, 1)}</td>
          <td>${formatNumber(row.lbsHour, 0)}</td>
          <td>${formatNumber(row.lbsDay, 0)}</td>
          <td>${formatNumber(row.lbsWeek, 0)}</td>
        `;
        tbody.appendChild(tr);
      });

      tfHours.textContent = formatNumber(metrics.totalHours, 1);
      tfWeight.textContent = formatNumber(metrics.totalWeight, 1);
      tfCases.textContent = formatNumber(metrics.totalCases, 1);
      tfAvgLbsHour.textContent = formatNumber(metrics.avgLbsHour, 1);
      tfAvgLbsDay.textContent = formatNumber(metrics.avgLbsDay, 0);
      tfNote.textContent = viewRows.length
        ? `Potential (top ${potentialTopNSpeeds}): ${formatNumber(metrics.potentialWeek, 0)} lbs/wk`
        : "–";

      footerNote.innerHTML = viewRows.length
        ? `<span>Mode: <strong>${modeLabel}</strong></span>
           <span>Total hours: <strong>${formatNumber(metrics.totalHours, 1)}</strong></span>
           <span>Rows shown: <strong>${viewRows.length}</strong></span>
           <span>Filtered out: <strong>${filteredOutCount.toLocaleString()}</strong></span>`
        : `<span>No rows for this view.</span>`;
    }

    // -------------------------
    // Charts
    // -------------------------
    function renderCharts(tabKey) {
      const viewRows = getViewRows(tabKey);

      const labels = viewRows.map(r => r.label);
      const weightValues = viewRows.map(r => r.weight);
      const speedValues = viewRows.map(r => r.lbsHour);

      const ctxWeight = document.getElementById("chart-weight").getContext("2d");
      const ctxSpeed = document.getElementById("chart-speed").getContext("2d");

      if (weightChart) weightChart.destroy();
      if (speedChart) speedChart.destroy();

      const weightLabel =
        currentViewMode === "run" ? "Packed weight (lbs) — run" :
        currentViewMode === "weekly" ? "Packed weight (lbs) — weekly" :
        "Packed weight (lbs) — daily";

      const isWeekly = currentViewMode === "weekly";
      const isDaily = currentViewMode === "daily";

      weightChart = new Chart(ctxWeight, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: weightLabel,
            data: weightValues,
            borderWidth: 0,
            borderRadius: 4,
            backgroundColor: "rgba(59, 130, 246, 0.8)"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 },
              title: { display: isWeekly || isDaily, text: isWeekly ? "Week" : "Date", color: "rgba(148, 163, 184, 0.9)", font: { size: 10 } }
            },
            y: {
              grid: { color: "rgba(31, 41, 55, 0.8)" },
              ticks: { color: "rgba(148, 163, 184, 0.9)" },
              title: { display: true, text: weightLabel, color: "rgba(148, 163, 184, 0.9)", font: { size: 10 } }
            }
          }
        }
      });

      const speedLabel =
        currentViewMode === "run" ? "Lbs / hour — run" :
        currentViewMode === "weekly" ? "Lbs / hour — weekly" :
        "Lbs / hour — daily";

      const speedDatasets = [{
        label: speedLabel,
        data: speedValues,
        tension: 0.35,
        borderWidth: 2.2,
        pointRadius: 2.8,
        pointHoverRadius: 4,
        fill: false,
        borderColor: "rgba(34, 197, 94, 0.9)",
        backgroundColor: "rgba(22, 163, 74, 0.25)"
      }];

      if (showTrendLine) {
        const trend = computeTrendLine(speedValues);
        if (trend.length === speedValues.length) {
          speedDatasets.push({
            label: "Trend",
            data: trend,
            tension: 0,
            borderWidth: 1.8,
            pointRadius: 0,
            fill: false,
            borderDash: [5, 4],
            borderColor: "rgba(148, 163, 184, 0.8)"
          });
        }
      }

      speedChart = new Chart(ctxSpeed, {
        type: "line",
        data: { labels, datasets: speedDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 },
              title: { display: isWeekly || isDaily, text: isWeekly ? "Week" : "Date", color: "rgba(148, 163, 184, 0.9)", font: { size: 10 } }
            },
            y: {
              grid: { color: "rgba(31, 41, 55, 0.8)" },
              ticks: { color: "rgba(148, 163, 184, 0.9)" },
              title: { display: true, text: speedLabel, color: "rgba(148, 163, 184, 0.9)", font: { size: 10 } }
            }
          }
        }
      });
    }

    function recomputeDashboard(tabKey) {
      const key = tabKey || currentTabKey || "all";
      renderKpis(key);
      renderTable(key);
      renderCharts(key);
    }

    function setActiveTab(tabKey) {
      currentTabKey = tabKey || "all";
      document.querySelectorAll(".sku-tab").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === currentTabKey);
      });
      recomputeDashboard(currentTabKey);
    }

    function setViewMode(mode) {
      if (!["run", "daily", "weekly"].includes(mode)) return;
      currentViewMode = mode;
      const toggle = document.getElementById("view-toggle");
      if (toggle) {
        toggle.querySelectorAll(".view-pill").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.view === currentViewMode);
        });
      }
      recomputeDashboard();
    }

    // -------------------------
    // Load from Master Pack (JSON) and render
    // -------------------------
    function loadFromMasterPackAndRender(opts = {}) {
      const { keepTab = true } = opts;

      const ping = (() => {
        try { return localStorage.getItem(MASTER_PACK_PING_KEY); } catch(e) { return null; }
      })();
      setUpdatedChip(ping);

      const payload = loadMasterPackPayload();
      const parsed = parseMasterPackJSON(payload);

      if (parsed.missing.length) {
        allRows = [];
        buildSkuTabs();
        setActiveTab("all");

        const hasAny = !!(localStorage.getItem(MASTER_PACK_KEY) || "").trim();
        setStatusChip("warn", hasAny ? "Master Pack missing required columns" : "Master Pack not loaded");

        const missingList = parsed.missing.map(h => `<li><code>${h}</code></li>`).join("");
        showBanner(`
          <strong>Master Pack is not ready.</strong>
          <div style="margin-top:6px;color:rgba(148,163,184,.95);">
            This dashboard requires these exact headers in <code>${MASTER_PACK_SHEET_NAME}</code>:
          </div>
          <ul>${missingList}</ul>
          <div style="margin-top:6px;color:rgba(148,163,184,.95);">
            Upload Master Pack again via Data Input (it overwrites) and ensure the headers match exactly.
          </div>
        `);

        if (weightChart) { weightChart.destroy(); weightChart = null; }
        if (speedChart) { speedChart.destroy(); speedChart = null; }
        document.getElementById("log-body").innerHTML = "";
        document.getElementById("packing-footer-note").innerHTML = `<span>No data.</span>`;

        document.getElementById("kpi-days-recorded").textContent = "–";
        document.getElementById("kpi-total-weight").textContent = "–";
        document.getElementById("kpi-avg-lbshour").textContent = "–";
        document.getElementById("kpi-total-cases").textContent = "–";
        document.getElementById("kpi-potential-week").textContent = "–";
        document.getElementById("kpi-top-speed").textContent = "Top: –";
        document.getElementById("kpi-potential-note").textContent = "–";

        document.getElementById("tf-hours").textContent = "–";
        document.getElementById("tf-weight").textContent = "–";
        document.getElementById("tf-cases").textContent = "–";
        document.getElementById("tf-avg-lbshour").textContent = "–";
        document.getElementById("tf-avg-lbsday").textContent = "–";
        document.getElementById("tf-note").textContent = "–";
        return;
      }

      allRows = parsed.rows;
      showBanner(null);

      if (!allRows.length) {
        setStatusChip("warn", `Master Pack loaded (0 valid rows). Removed: ${filteredOutCount}`);
      } else {
        setStatusChip("ok", `Loaded ${allRows.length} rows (removed ${filteredOutCount})`);
      }

      buildSkuTabs();

      const nextTab = (keepTab && currentTabKey && currentTabKey !== "all") ? currentTabKey : "all";
      const possible = new Set(["all", ...allRows.map(r => "sku:" + (r.sku || "").trim()).filter(Boolean)]);
      currentTabKey = possible.has(nextTab) ? nextTab : "all";

      document.querySelectorAll(".sku-tab").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === currentTabKey);
      });

      recomputeDashboard(currentTabKey);
    }

    // -------------------------
    // UI setup
    // -------------------------
    function setupConfigPanelToggle() {
      const btn = document.getElementById("toggle-config-panel-btn");
      const body = document.getElementById("config-panel-body");
      const icon = document.getElementById("toggle-config-icon");
      const label = document.getElementById("toggle-config-label");
      if (!btn || !body) return;
      let collapsed = true;
      body.classList.add("collapsed");
      label.textContent = "Show";
      icon.textContent = "▸";
      btn.addEventListener("click", () => {
        collapsed = !collapsed;
        if (collapsed) {
          body.classList.add("collapsed");
          label.textContent = "Show";
          icon.textContent = "▸";
        } else {
          body.classList.remove("collapsed");
          label.textContent = "Hide";
          icon.textContent = "▾";
        }
      });
    }

    function setupUnitsConfigInputs() {
      const mapping = [
        { key: "1lb", id: "cfg-1lb" },
        { key: "3lb", id: "cfg-3lb" },
        { key: "5oz", id: "cfg-5oz" },
        { key: "10oz", id: "cfg-10oz" },
        { key: "16oz", id: "cfg-16oz" }
      ];

      mapping.forEach(({ key, id }) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = unitsConfig[key];
        el.addEventListener("change", () => {
          const v = parseFloat(el.value);
          if (!isNaN(v) && v > 0) {
            unitsConfig[key] = v;
            saveUnitsConfigToStorage();
            recomputeDashboard();
          } else {
            el.value = unitsConfig[key];
          }
        });
      });
    }

    function setupPotentialHoursInput() {
      const input = document.getElementById("potential-hours-input");
      if (!input) return;
      input.value = potentialHoursPerDay;
      input.addEventListener("change", () => {
        const v = parseFloat(input.value);
        if (!isNaN(v) && v > 0) {
          potentialHoursPerDay = v;
          savePotentialHoursToStorage();
          updatePotentialCopy();
          loadFromMasterPackAndRender({ keepTab: true }); // refresh derived values
        } else {
          input.value = potentialHoursPerDay;
        }
      });
    }

    function setupPotentialTopNInput() {
      const input = document.getElementById("potential-topn-input");
      if (!input) return;
      input.value = potentialTopNSpeeds;
      input.addEventListener("change", () => {
        const v = parseInt(input.value, 10);
        if (!isNaN(v) && v > 0) {
          potentialTopNSpeeds = v;
          savePotentialTopNToStorage();
          updatePotentialCopy();
          recomputeDashboard();
        } else {
          input.value = potentialTopNSpeeds;
        }
      });
    }

    function setupUnitsKpiToggle() {
      const btn = document.getElementById("toggle-units-kpi-btn");
      const card = document.getElementById("kpi-units-card");
      if (!btn || !card) return;
      let visible = false;
      btn.addEventListener("click", () => {
        visible = !visible;
        card.style.display = visible ? "" : "none";
        btn.textContent = visible ? "Hide Units/min card" : "Show Units/min card";
      });
    }

    // -------------------------
    // Init + live refresh (matches grow dashboards)
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {
      setupConfigPanelToggle();
      setupUnitsKpiToggle();

      // SKU tab click handling (delegated)
      const tabGroup = document.getElementById("sku-tab-group");
      if (tabGroup) {
        tabGroup.addEventListener("click", (e) => {
          const btn = e.target.closest(".sku-tab");
          if (!btn) return;
          setActiveTab(btn.dataset.tab);
        });
      }

      // View toggle (Run / Daily / Weekly)
      const viewToggle = document.getElementById("view-toggle");
      if (viewToggle) {
        viewToggle.addEventListener("click", (e) => {
          const btn = e.target.closest(".view-pill");
          if (!btn) return;
          setViewMode(btn.dataset.view);
        });
      }

      const trendChk = document.getElementById("trend-toggle-input");
      if (trendChk) {
        trendChk.addEventListener("change", () => {
          showTrendLine = trendChk.checked;
          recomputeDashboard();
        });
      }

      // load configs
      loadUnitsConfigFromStorage();
      loadPotentialHoursFromStorage();
      loadPotentialTopNFromStorage();
      setupUnitsConfigInputs();
      setupPotentialHoursInput();
      setupPotentialTopNInput();
      updatePotentialCopy();

      // initial load
      currentTabKey = "all";
      currentViewMode = "daily";
      buildSkuTabs();
      loadFromMasterPackAndRender({ keepTab: false });

      // Live refresh: accept MASTER_PACK_UPDATED with OR without key (like transplant/seeding)
      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === UPDATE_EVENT_TYPE) {
          loadFromMasterPackAndRender({ keepTab: true });
        }
      });

      // Storage listeners
      window.addEventListener("storage", (e) => {
        if (e.key === MASTER_PACK_KEY || e.key === MASTER_PACK_PING_KEY) {
          loadFromMasterPackAndRender({ keepTab: true });
        }
      });
    });
  </script>
</body>
</html>
