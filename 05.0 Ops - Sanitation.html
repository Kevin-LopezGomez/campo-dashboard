<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sanitation Productivity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --border: #1f2937;
      --border-subtle: #374151;
      --text: #e5e7eb;
      --sub: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #4ade80;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.25);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    /* ✅ ONLY CHANGED: add width:100% + align-items */
    .page {
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
    }

    /* ✅ ONLY CHANGED: max-width 1320px -> 1760px */
    .container {
      width: 100%;
      max-width: 1760px;
      border-radius: 24px;
      padding: 20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.09), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block { flex: 1 1 200px; min-width: 0; }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 4px;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
    }

    .title-pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #34d399, #22c55e 55%, #16a34a 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9), 0 12px 30px rgba(16, 185, 129, 0.6);
    }

    .title-pill span {
      font-size: 15px;
      font-weight: 700;
      color: #022c22;
    }

    .title-text {
      font-weight: 620;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .title-sub {
      font-size: 0.8rem;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .header-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--sub);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 55%);
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
    }

    .chip-danger-dot {
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4);
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 2.2fr);
      gap: 16px;
      align-items: stretch;
    }

    /* ✅ ONLY CHANGED: add max-width:100% on mobile so it doesn’t fight */
    @media (max-width: 960px) {
      .container { max-width: 100%; border-radius: 18px; padding: 14px 12px 14px; }
      .layout-main { grid-template-columns: minmax(0, 1fr); }
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
      margin-top: 10px;
    }

    @media (max-width: 960px) {
      .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .kpi-card {
      position: relative;
      border-radius: 16px;
      padding: 10px 12px 16px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(51, 65, 85, 0.9);
      box-shadow:
        0 14px 30px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .kpi-label {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--sub);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kpi-value {
      font-size: 1.15rem;
      font-weight: 650;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-unit {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
    }

    .kpi-trend {
      margin-top: 6px;
      font-size: 0.7rem;
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #kpi-broken-caption { color: var(--sub); }

    .kpi-glow {
      position: absolute;
      inset: 0;
      opacity: 0.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34, 197, 94, 0.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.4), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .kpi-card-danger .kpi-value span:first-child { color: var(--danger); }
    .kpi-card-danger .kpi-trend { color: var(--danger-soft); }
    .kpi-card-danger .kpi-glow {
      background:
        radial-gradient(circle at 20% 0, rgba(239, 68, 68, 0.45), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(148, 163, 184, 0.4), transparent 60%);
    }

    .panel {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(14px);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .panel-title {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sub);
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .panel-title-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.45);
    }

    .panel-subtitle { font-size: 0.75rem; color: var(--muted); }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--sub);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.55), rgba(15, 23, 42, 0.95));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
    }

    .badge-soft span {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(226, 232, 240, 0.95);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.48);
    }

    .chart-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
      flex: 1 1 auto;
    }

    .chart-row { position: relative; width: 100%; }
    .chart-canvas-main { width: 100%; height: 200px; }
    .chart-canvas-broken { width: 100%; height: 130px; }
    .chart-canvas-secondary { width: 100%; height: 160px; }

    @media (max-width: 960px) {
      .chart-canvas-main { height: 190px; }
      .chart-canvas-broken { height: 120px; }
      .chart-canvas-secondary { height: 150px; }
    }

    .table-wrapper {
      margin-top: 4px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background:
        linear-gradient(135deg, rgba(17, 24, 39, 0.96), rgba(15, 23, 42, 0.99)),
        radial-gradient(circle at top left, rgba(51, 65, 85, 0.65), rgba(15, 23, 42, 0.96));
      overflow: hidden;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .table-scroll {
      max-height: 430px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15, 23, 42, 0.2);
      flex: 1 1 auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 880px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background:
        linear-gradient(to bottom, #020617, #020617),
        radial-gradient(circle at top left, rgba(55, 65, 81, 0.5), rgba(15, 23, 42, 0.95));
      box-shadow: 0 1px 0 rgba(31, 41, 55, 0.9);
    }

    th, td {
      text-align: right;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; padding-left: 14px; }
    th:last-child, td:last-child { padding-right: 12px; }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--sub);
      background: transparent;
    }

    tbody tr:nth-child(odd) td { background: rgba(15, 23, 42, 0.85); }
    tbody tr:nth-child(even) td { background: rgba(17, 24, 39, 0.92); }
    tbody tr:hover td { background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.08), rgba(15, 23, 42, 0.98)); }

    tfoot td {
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.12), rgba(15, 23, 42, 0.98));
      font-weight: 600;
      border-top: 1px solid rgba(55, 65, 81, 0.95);
      border-bottom: none;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-note span { display: inline-flex; align-items: center; gap: 4px; }

    .legend-box {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .legend-box.flats { background: rgba(59, 130, 246, 0.5); }
    .legend-box.broken { background: rgba(239, 68, 68, 0.7); }
    .legend-box.fpph { background: rgba(34, 197, 94, 0.7); }

    .view-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 1px;
      font-size: 0.7rem;
    }

    .view-toggle-btn {
      border: none;
      background: transparent;
      color: var(--sub);
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.7rem;
      font-family: inherit;
    }

    .view-toggle-btn.active {
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }

    .trend-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--sub);
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .trend-toggle input { margin: 0; }

    .hint-empty {
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--muted);
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>Ψ</span></div>
            <div class="title-text">
              <span>Sanitation Productivity Dashboard</span>
              <span class="title-sub">LIVE FROM DATA INPUT</span>
            </div>
          </div>
          <p class="subtitle">Daily sanitation output, labor utilization, and speed (boards per worker per hour).</p>
        </div>

        <div class="header-tags">
          <div class="chip"><span class="chip-dot"></span><span id="chip-ok">Waiting for Master Grow…</span></div>
          <div class="chip"><span class="chip-danger-dot"></span><span id="chip-warn">–</span></div>
        </div>
      </header>

      <section class="kpi-grid">
        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Total boards cleaned</div>
          <div class="kpi-value"><span id="kpi-total-boards">–</span></div>
          <div class="kpi-trend"><span>Across all recorded days</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average boards / worker / hour</div>
          <div class="kpi-value"><span id="kpi-avg-bpwh">–</span><span class="kpi-unit">BPWH</span></div>
          <div class="kpi-trend"><span id="kpi-best-day">Top day: –</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Average sanitation crew size</div>
          <div class="kpi-value"><span id="kpi-avg-workers">–</span><span class="kpi-unit">Workers</span></div>
          <div class="kpi-trend"><span id="kpi-workers-note">–</span></div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Total equipment cleaned</div>
          <div class="kpi-value"><span id="kpi-total-items">–</span></div>
          <div class="kpi-trend"><span>Crates + cisternas + pallets</span></div>
        </article>

        <article class="kpi-card kpi-card-danger">
          <div class="kpi-glow"></div>
          <div class="kpi-label" id="kpi-broken-label">Avg broken boards / day</div>
          <div class="kpi-value"><span id="kpi-broken-boards">–</span></div>
          <div class="kpi-trend"><span id="kpi-broken-caption">Quality losses to reduce</span></div>
        </article>
      </section>

      <section class="layout-main">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span>Performance over time</span></div>
              <div class="panel-subtitle">Top: Boards cleaned · Middle: Boards / worker / hour · Bottom: Broken boards.</div>
            </div>
            <div class="panel-header-right">
              <div class="badge-soft"><span class="badge-dot"></span><span>Live from Master Grow</span></div>
              <div class="view-toggle">
                <button id="view-by-date" class="view-toggle-btn active" type="button">By date</button>
                <button id="view-by-week" class="view-toggle-btn" type="button">By week</button>
              </div>
              <label class="trend-toggle">
                <input type="checkbox" id="trend-toggle-input" />
                <span>Trend line</span>
              </label>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-row"><canvas id="chart-boards" class="chart-canvas-main"></canvas></div>
            <div class="chart-row"><canvas id="chart-bpwh" class="chart-canvas-secondary"></canvas></div>
            <div class="chart-row"><canvas id="chart-broken" class="chart-canvas-broken"></canvas></div>
          </div>

          <div class="footer-note">
            <span><span class="legend-box flats"></span> Top: Boards cleaned (bars)</span>
            <span><span class="legend-box fpph"></span> Middle: BPWH (line + optional trend)</span>
            <span><span class="legend-box broken"></span> Bottom: Broken boards (bars + optional trend)</span>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span id="table-title-text">Daily sanitation log</span></div>
              <div class="panel-subtitle" id="table-subtitle-text">Built from Master Grow (Sanitation columns aggregated into daily totals).</div>
            </div>
            <div class="panel-header-right">
              <span id="table-view-label">Daily view</span>
              <div class="view-toggle">
                <button id="table-view-daily" class="view-toggle-btn active" type="button">Daily</button>
                <button id="table-view-weekly" class="view-toggle-btn" type="button">Weekly</button>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <div class="table-scroll" id="daily-table-wrapper">
              <table id="sanitation-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Week</th>
                    <th>Team Start</th>
                    <th>Team Finish</th>
                    <th># Workers</th>
                    <th>Board hrs</th>
                    <th>Total boards</th>
                    <th>Broken</th>
                    <th>Boards / worker / hr</th>
                    <th>Crates</th>
                    <th>Cisternas</th>
                    <th>Pallets</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Grand Total</td>
                    <td>–</td>
                    <td>–</td>
                    <td>–</td>
                    <td>0.0</td>
                    <td>0.0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0.0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="table-scroll" id="weekly-table-wrapper" style="display:none;">
              <table id="sanitation-weekly-table">
                <thead>
                  <tr>
                    <th>Week</th>
                    <th>Days</th>
                    <th>Total boards</th>
                    <th>Boards / worker / hr</th>
                    <th>Total board hrs</th>
                    <th>Avg # workers</th>
                    <th>Total crates</th>
                    <th>Total cisternas</th>
                    <th>Total pallets</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Grand Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0.0</td>
                    <td>0.0</td>
                    <td>0.0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div id="empty-hint" class="hint-empty"></div>
        </section>
      </section>
    </div>
  </div>

  <script>
    // =========================================================
    // STORAGE CONTRACT (from Data Input)
    // =========================================================
    const MASTER_GROW_KEY = "campo_master_grow_v1";
    const MASTER_GROW_PING_KEY = "campo_master_grow_push_ping_v1";
    const MASTER_GROW_SHEET_NAME = "Master Grow";

    // Exact sanitation column names (from your header row)
    const SAN = Object.freeze({
      TEAM_START: "Sanitation Team Start",
      TEAM_FINISH: "Sanitation Team Finish",
      WEEK: "Sanitation Week",
      DATE: "Date of Sanitation",
      BOARD_HOURS: "Board Cleaning Tiempo Transcurido",
      TOTAL_BOARDS: "Total # of Boards Cleaned",
      BROKEN: "# of Broken Boards",
      CRATES: "# of Crates Cleaned",
      WORKERS: "Sanitation # of Workers",
      CISTERNAS: "# of Cisternas Cleaned",
      PALLETS_BLACK: "# de Palletas Negras Cleaned",
      PALLETS_BLUE: "# de Palletas Azules",
    });

    // =========================================================
    // STATE
    // =========================================================
    let boardsChart = null;
    let brokenChart = null;
    let bpwhChart = null;
    let viewMode = "daily"; // "daily" or "weekly"
    let showTrendLine = false;

    // =========================================================
    // UI HELPERS
    // =========================================================
    function setEmpty(msg) {
      const el = document.getElementById("empty-hint");
      if (el) el.textContent = msg || "";
    }
    function setChip(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // =========================================================
    // PARSERS
    // =========================================================
    function parseNumber(v) {
      if (v === null || v === undefined) return 0;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const cleaned = s.replace(/,/g, "");
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function parseFlexibleDate(str) {
      if (!str) return null;
      let s = String(str).trim();

      // If it's like "Wednesday, October 1, 2025" -> strip weekday
      const parts = s.split(",");
      if (parts.length >= 2 && /[a-z]/i.test(parts[0])) {
        s = parts.slice(1).join(",").trim();
      }

      // Try native parse
      let d = new Date(s);
      if (!isNaN(d.getTime())) return d;

      // Try MM/DD/YYYY explicitly
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        const mm = parseInt(m[1], 10);
        const dd = parseInt(m[2], 10);
        let yy = parseInt(m[3], 10);
        if (yy < 100) yy += 2000;
        d = new Date(yy, mm - 1, dd);
        if (!isNaN(d.getTime())) return d;
      }

      return null;
    }

    function formatDateMMDDYYYY(date) {
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      const yyyy = date.getFullYear();
      return mm + "/" + dd + "/" + yyyy;
    }

    function timeToMinutes(t) {
      if (!t) return null;
      const s = String(t).trim();

      // supports "HH:MM", "H:MM", "HH:MM AM"
      const m = s.match(/(\d{1,2}):(\d{2})(?:\s*([AaPp][Mm]))?/);
      if (!m) return null;
      let hh = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      const ap = m[3] ? m[3].toUpperCase() : null;

      if (ap) {
        if (ap === "PM" && hh < 12) hh += 12;
        if (ap === "AM" && hh === 12) hh = 0;
      }
      return hh * 60 + mm;
    }

    function computeTrendLine(values) {
      const n = values.length;
      if (n < 2) return [];
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (let i = 0; i < n; i++) {
        const x = i + 1;
        const y = Number(values[i]) || 0;
        sumX += x; sumY += y; sumXY += x * y; sumXX += x * x;
      }
      const denom = n * sumXX - sumX * sumX;
      if (denom === 0) return Array(n).fill(values[0] || 0);
      const slope = (n * sumXY - sumX * sumY) / denom;
      const intercept = (sumY - slope * sumX) / n;
      return Array.from({ length: n }, (_, i) => slope * (i + 1) + intercept);
    }

    // =========================================================
    // MASTER GROW JSON LOADER
    // =========================================================
    function loadMasterGrowPayload() {
      const raw = (localStorage.getItem(MASTER_GROW_KEY) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToRowObjects(sheetObj) {
      const headers = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
      const out = [];
      for (const r of rows) {
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i = 0; i < headers.length; i++) {
          const h = headers[i];
          const key = (h === null || h === undefined) ? "" : String(h);
          if (!key.trim()) continue;
          obj[key] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    function buildHeaderLookup(headers) {
      // normalize: trim + lower. this protects against accidental leading spaces in stored headers
      const map = new Map();
      (headers || []).forEach((h) => {
        const raw = String(h ?? "");
        const norm = raw.trim().toLowerCase();
        if (!norm) return;
        if (!map.has(norm)) map.set(norm, raw);
      });
      return map;
    }

    function resolveHeader(headerLookup, expected) {
      const norm = String(expected || "").trim().toLowerCase();
      return headerLookup.get(norm) || null;
    }

    // =========================================================
    // BUILD DAILY + WEEKLY TABLES FROM MASTER GROW
    // =========================================================
    function buildFromMasterGrow() {
      const payload = loadMasterGrowPayload();
      const sheet = payload?.sheets?.[MASTER_GROW_SHEET_NAME];

      const tbody = document.querySelector("#sanitation-table tbody");
      const weeklyBody = document.querySelector("#sanitation-weekly-table tbody");
      if (tbody) tbody.innerHTML = "";
      if (weeklyBody) weeklyBody.innerHTML = "";

      if (!sheet) {
        setEmpty("No Master Grow sheet found. Upload Master Grow in Data Input.");
        setChip("chip-ok", "Master Grow missing");
        setChip("chip-warn", "Upload Master Grow CSV/XLSX");
        return { daily: [], weekly: [] };
      }

      const headers = Array.isArray(sheet.headers) ? sheet.headers : [];
      const headerLookup = buildHeaderLookup(headers);

      // Resolve actual stored header strings (in case stored has weird spacing)
      const H = {
        TEAM_START: resolveHeader(headerLookup, SAN.TEAM_START),
        TEAM_FINISH: resolveHeader(headerLookup, SAN.TEAM_FINISH),
        WEEK: resolveHeader(headerLookup, SAN.WEEK),
        DATE: resolveHeader(headerLookup, SAN.DATE),
        BOARD_HOURS: resolveHeader(headerLookup, SAN.BOARD_HOURS),
        TOTAL_BOARDS: resolveHeader(headerLookup, SAN.TOTAL_BOARDS),
        BROKEN: resolveHeader(headerLookup, SAN.BROKEN),
        CRATES: resolveHeader(headerLookup, SAN.CRATES),
        WORKERS: resolveHeader(headerLookup, SAN.WORKERS),
        CISTERNAS: resolveHeader(headerLookup, SAN.CISTERNAS),
        PALLETS_BLACK: resolveHeader(headerLookup, SAN.PALLETS_BLACK),
        PALLETS_BLUE: resolveHeader(headerLookup, SAN.PALLETS_BLUE) || resolveHeader(headerLookup, "# de Palletas Azules Cleaned"),
      };

      const required = [H.DATE, H.WEEK, H.WORKERS, H.BOARD_HOURS, H.TOTAL_BOARDS];
      const missing = [];
      if (!H.DATE) missing.push(SAN.DATE);
      if (!H.WEEK) missing.push(SAN.WEEK);
      if (!H.WORKERS) missing.push(SAN.WORKERS);
      if (!H.BOARD_HOURS) missing.push(SAN.BOARD_HOURS);
      if (!H.TOTAL_BOARDS) missing.push(SAN.TOTAL_BOARDS);

      const rows = sheetToRowObjects(sheet);

      if (!rows.length) {
        setEmpty("Master Grow loaded, but the sheet has no rows.");
        setChip("chip-ok", "Master Grow loaded (0 rows)");
        setChip("chip-warn", "No sanitation rows found");
        return { daily: [], weekly: [] };
      }

      if (missing.length) {
        setEmpty(
          "Master Grow loaded, but Sanitation headers are missing (strict contract):\n- " +
          missing.join("\n- ")
        );
        setChip("chip-ok", "Master Grow loaded (bad headers)");
        setChip("chip-warn", "Fix sanitation header names");
        return { daily: [], weekly: [] };
      }

      // Aggregate DAILY by Date of Sanitation
      const dailyMap = new Map();

      for (const r of rows) {
        if (!r || typeof r !== "object") continue;

        const dateRaw = String(r[H.DATE] ?? "").trim();
        const weekRaw = String(r[H.WEEK] ?? "").trim();
        const teamStart = String(r[H.TEAM_START] ?? "").trim();
        const teamFinish = String(r[H.TEAM_FINISH] ?? "").trim();

        const workers = parseNumber(r[H.WORKERS]);
        const boardHours = parseNumber(r[H.BOARD_HOURS]);
        const boards = parseNumber(r[H.TOTAL_BOARDS]);
        const broken = H.BROKEN ? parseNumber(r[H.BROKEN]) : 0;
        const crates = H.CRATES ? parseNumber(r[H.CRATES]) : 0;
        const cisternas = H.CISTERNAS ? parseNumber(r[H.CISTERNAS]) : 0;

        const palletsBlack = H.PALLETS_BLACK ? parseNumber(r[H.PALLETS_BLACK]) : 0;
        const palletsBlue = H.PALLETS_BLUE ? parseNumber(r[H.PALLETS_BLUE]) : 0;
        const pallets = palletsBlack + palletsBlue;

        const allBlank =
          !dateRaw && !weekRaw && !teamStart && !teamFinish &&
          workers === 0 && boardHours === 0 && boards === 0 && broken === 0 &&
          crates === 0 && cisternas === 0 && pallets === 0;

        if (allBlank) continue;

        const dateObj = parseFlexibleDate(dateRaw);
        if (!dateObj) continue;

        const dateKey = formatDateMMDDYYYY(dateObj);
        const workerHours = (workers > 0 && boardHours > 0) ? (workers * boardHours) : 0;

        if (!dailyMap.has(dateKey)) {
          dailyMap.set(dateKey, {
            dateKey,
            dateObj,
            week: weekRaw || "",
            // time bounds
            teamStart: "",
            teamStartMin: null,
            teamFinish: "",
            teamFinishMax: null,
            // totals
            totalBoards: 0,
            totalBroken: 0,
            totalCrates: 0,
            totalCisternas: 0,
            totalPallets: 0,
            totalBoardHours: 0,
            totalWorkerHours: 0,
          });
        }

        const d = dailyMap.get(dateKey);

        // keep week if missing
        if (!d.week && weekRaw) d.week = weekRaw;

        // merge start/finish by min/max time (if parsable)
        const stMin = timeToMinutes(teamStart);
        if (teamStart) {
          if (d.teamStartMin === null || (stMin !== null && stMin < d.teamStartMin)) {
            d.teamStartMin = stMin;
            d.teamStart = teamStart;
          } else if (!d.teamStart) {
            d.teamStart = teamStart;
          }
        }

        const fnMin = timeToMinutes(teamFinish);
        if (teamFinish) {
          if (d.teamFinishMax === null || (fnMin !== null && fnMin > d.teamFinishMax)) {
            d.teamFinishMax = fnMin;
            d.teamFinish = teamFinish;
          } else if (!d.teamFinish) {
            d.teamFinish = teamFinish;
          }
        }

        d.totalBoards += boards;
        d.totalBroken += broken;
        d.totalCrates += crates;
        d.totalCisternas += cisternas;
        d.totalPallets += pallets;

        d.totalBoardHours += (boardHours > 0 ? boardHours : 0);
        d.totalWorkerHours += workerHours;
      }

      const dailyRows = Array.from(dailyMap.values()).sort((a, b) => a.dateObj - b.dateObj);

      // Populate DAILY table
      const tbodyEl = document.querySelector("#sanitation-table tbody");
      if (tbodyEl) {
        dailyRows.forEach((d) => {
          const avgWorkers = d.totalBoardHours > 0 ? (d.totalWorkerHours / d.totalBoardHours) : 0;
          const bpwh = d.totalWorkerHours > 0 ? (d.totalBoards / d.totalWorkerHours) : 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.dateKey}</td>
            <td>${d.week || ""}</td>
            <td>${d.teamStart || ""}</td>
            <td>${d.teamFinish || ""}</td>
            <td>${avgWorkers ? avgWorkers.toFixed(1) : "0.0"}</td>
            <td>${d.totalBoardHours ? d.totalBoardHours.toFixed(1) : "0.0"}</td>
            <td>${Math.round(d.totalBoards).toLocaleString()}</td>
            <td>${Math.round(d.totalBroken).toLocaleString()}</td>
            <td>${bpwh ? bpwh.toFixed(1) : "0.0"}</td>
            <td>${Math.round(d.totalCrates).toLocaleString()}</td>
            <td>${Math.round(d.totalCisternas).toLocaleString()}</td>
            <td>${Math.round(d.totalPallets).toLocaleString()}</td>
          `;
          tbodyEl.appendChild(tr);
        });
      }

      // Build WEEKLY aggregation from DAILY rows
      const weekMap = new Map();
      dailyRows.forEach((d) => {
        const wk = String(d.week || "").trim();
        if (!wk) return;

        if (!weekMap.has(wk)) {
          weekMap.set(wk, {
            week: wk,
            days: 0,
            totalBoards: 0,
            totalBroken: 0,
            totalBoardHours: 0,
            totalWorkerHours: 0,
            totalWorkersSum: 0,
            totalCrates: 0,
            totalCisternas: 0,
            totalPallets: 0,
          });
        }
        const w = weekMap.get(wk);

        w.days += 1;
        w.totalBoards += d.totalBoards;
        w.totalBroken += d.totalBroken;
        w.totalBoardHours += d.totalBoardHours;
        w.totalWorkerHours += d.totalWorkerHours;
        w.totalCrates += d.totalCrates;
        w.totalCisternas += d.totalCisternas;
        w.totalPallets += d.totalPallets;

        const dayAvgWorkers = d.totalBoardHours > 0 ? (d.totalWorkerHours / d.totalBoardHours) : 0;
        w.totalWorkersSum += dayAvgWorkers;
      });

      const weeklyRows = Array.from(weekMap.values()).sort((a, b) => {
        const aw = parseFloat(a.week);
        const bw = parseFloat(b.week);
        if (isNaN(aw) || isNaN(bw)) return String(a.week).localeCompare(String(b.week));
        return aw - bw;
      });

      const weeklyBodyEl = document.querySelector("#sanitation-weekly-table tbody");
      if (weeklyBodyEl) {
        weeklyBodyEl.innerHTML = "";
        weeklyRows.forEach((w) => {
          const bpwhWeek = w.totalWorkerHours > 0 ? (w.totalBoards / w.totalWorkerHours) : 0;
          const avgWorkers = w.days > 0 ? (w.totalWorkersSum / w.days) : 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${w.week}</td>
            <td>${w.days}</td>
            <td>${Math.round(w.totalBoards).toLocaleString()}</td>
            <td>${bpwhWeek ? bpwhWeek.toFixed(1) : "0.0"}</td>
            <td>${w.totalBoardHours ? w.totalBoardHours.toFixed(1) : "0.0"}</td>
            <td>${avgWorkers ? avgWorkers.toFixed(1) : "0.0"}</td>
            <td>${Math.round(w.totalCrates).toLocaleString()}</td>
            <td>${Math.round(w.totalCisternas).toLocaleString()}</td>
            <td>${Math.round(w.totalPallets).toLocaleString()}</td>
          `;
          weeklyBodyEl.appendChild(tr);
        });
      }

      setEmpty("");
      setChip("chip-ok", `Master Grow loaded (${rows.length.toLocaleString()} rows)`);
      setChip("chip-warn", dailyRows.length ? "–" : "No sanitation daily rows built");

      return { daily: dailyRows, weekly: weeklyRows };
    }

    // =========================================================
    // DASHBOARD COMPUTE (reads from table)
    // =========================================================
    function recomputeDashboard() {
      const rows = Array.from(document.querySelectorAll("#sanitation-table tbody tr"));
      const brokenLabelEl = document.getElementById("kpi-broken-label");
      const brokenCaptionEl = document.getElementById("kpi-broken-caption");

      if (!rows.length) {
        if (boardsChart) boardsChart.destroy();
        if (brokenChart) brokenChart.destroy();
        if (bpwhChart) bpwhChart.destroy();

        document.getElementById("kpi-total-boards").textContent = "–";
        document.getElementById("kpi-avg-bpwh").textContent = "–";
        document.getElementById("kpi-avg-workers").textContent = "–";
        document.getElementById("kpi-total-items").textContent = "–";
        document.getElementById("kpi-broken-boards").textContent = "–";
        document.getElementById("kpi-best-day").textContent = "Top day: –";
        document.getElementById("kpi-workers-note").textContent = "–";
        if (brokenLabelEl) brokenLabelEl.textContent = "Avg broken boards / day";
        if (brokenCaptionEl) brokenCaptionEl.textContent = "Quality losses to reduce";
        return;
      }

      const data = rows.map((row) => {
        const cells = Array.from(row.querySelectorAll("td"));
        return {
          date: (cells[0]?.textContent || "").trim(),
          week: (cells[1]?.textContent || "").trim(),
          workers: parseNumber(cells[4]?.textContent),
          boardHours: parseNumber(cells[5]?.textContent),
          boards: parseNumber(cells[6]?.textContent),
          broken: parseNumber(cells[7]?.textContent),
          bpwh: parseNumber(cells[8]?.textContent),
          crates: parseNumber(cells[9]?.textContent),
          cisternas: parseNumber(cells[10]?.textContent),
          pallets: parseNumber(cells[11]?.textContent),
        };
      });

      const fmtNumber = (n) => n.toLocaleString(undefined, { maximumFractionDigits: 0 });
      const fmt1 = (n) => n.toLocaleString(undefined, { maximumFractionDigits: 1 });

      const totalBoards = data.reduce((sum, d) => sum + d.boards, 0);
      const totalBroken = data.reduce((sum, d) => sum + d.broken, 0);
      const totalCrates = data.reduce((sum, d) => sum + d.crates, 0);
      const totalCisternas = data.reduce((sum, d) => sum + d.cisternas, 0);
      const totalPallets = data.reduce((sum, d) => sum + d.pallets, 0);
      const totalItems = totalCrates + totalCisternas + totalPallets;

      const avgWorkers = data.length ? data.reduce((sum, d) => sum + d.workers, 0) / data.length : 0;

      // recompute overall avg BPWH using totals
      const totalWorkerHours = data.reduce((sum, d) => sum + (d.workers * d.boardHours), 0);
      const avgBpwh = totalWorkerHours > 0 ? totalBoards / totalWorkerHours : 0;

      const bestDay = data.reduce((best, d) => (d.bpwh > best.bpwh ? d : best), data[0]);
      const zeroBoardDays = data.filter((d) => d.boards === 0).length;

      document.getElementById("kpi-total-boards").textContent = fmtNumber(totalBoards);
      document.getElementById("kpi-avg-bpwh").textContent = fmt1(avgBpwh);
      document.getElementById("kpi-avg-workers").textContent = fmt1(avgWorkers);
      document.getElementById("kpi-total-items").textContent = fmtNumber(totalItems);

      document.getElementById("kpi-best-day").textContent =
        "Top day: " + fmt1(bestDay.bpwh) + " BPWH (" + (bestDay.date || "–") + ")";
      document.getElementById("kpi-workers-note").textContent =
        zeroBoardDays + " days with 0 boards cleaned";

      // weekly aggregation for charts + broken KPI label
      const weekMap = new Map();
      data.forEach((d) => {
        const key = d.week || "N/A";
        if (!weekMap.has(key)) {
          weekMap.set(key, {
            week: key,
            days: 0,
            totalBoards: 0,
            totalBroken: 0,
            totalBoardHours: 0,
            totalWorkers: 0,
            totalWorkerHours: 0,
            totalCrates: 0,
            totalCisternas: 0,
            totalPallets: 0,
          });
        }
        const agg = weekMap.get(key);
        agg.days += 1;
        agg.totalBoards += d.boards;
        agg.totalBroken += d.broken;
        agg.totalBoardHours += d.boardHours;
        agg.totalWorkers += d.workers;
        agg.totalWorkerHours += d.workers * d.boardHours;
        agg.totalCrates += d.crates;
        agg.totalCisternas += d.cisternas;
        agg.totalPallets += d.pallets;
      });

      const weekAgg = Array.from(weekMap.values()).sort((a, b) => {
        const aw = parseFloat(a.week);
        const bw = parseFloat(b.week);
        if (!Number.isFinite(aw) || !Number.isFinite(bw)) return String(a.week).localeCompare(String(b.week));
        return aw - bw;
      });

      weekAgg.forEach((w) => {
        w.avgWorkers = w.days ? w.totalWorkers / w.days : 0;
        w.bpwhWeek = w.totalWorkerHours > 0 ? w.totalBoards / w.totalWorkerHours : 0;
      });

      const numDays = data.length;
      const numWeeks = weekAgg.length || 1;

      let brokenKpiValue = 0;
      if (viewMode === "weekly") {
        brokenKpiValue = numWeeks ? totalBroken / numWeeks : 0;
        if (brokenLabelEl) brokenLabelEl.textContent = "Avg broken boards / week";
        if (brokenCaptionEl) brokenCaptionEl.textContent = numWeeks + " weeks in range";
      } else {
        brokenKpiValue = numDays ? totalBroken / numDays : 0;
        if (brokenLabelEl) brokenLabelEl.textContent = "Avg broken boards / day";
        if (brokenCaptionEl) brokenCaptionEl.textContent = numDays + " days in range";
      }
      document.getElementById("kpi-broken-boards").textContent = fmt1(brokenKpiValue);

      // Update weekly table footer + body
      const weeklyBody = document.querySelector("#sanitation-weekly-table tbody");
      const weeklyFootRow = document.querySelector("#sanitation-weekly-table tfoot tr");
      if (weeklyBody && weeklyFootRow) {
        weeklyBody.innerHTML = "";
        let grandDays = 0, grandBoards = 0, grandBoardHours = 0, grandWorkers = 0, grandWorkerHours = 0;
        let grandCrates = 0, grandCisternas = 0, grandPallets = 0;

        weekAgg.forEach((w) => {
          grandDays += w.days;
          grandBoards += w.totalBoards;
          grandBoardHours += w.totalBoardHours;
          grandWorkers += w.totalWorkers;
          grandWorkerHours += w.totalWorkerHours;
          grandCrates += w.totalCrates;
          grandCisternas += w.totalCisternas;
          grandPallets += w.totalPallets;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${w.week}</td>
            <td>${w.days}</td>
            <td>${fmtNumber(w.totalBoards)}</td>
            <td>${fmt1(w.bpwhWeek)}</td>
            <td>${fmt1(w.totalBoardHours)}</td>
            <td>${fmt1(w.avgWorkers)}</td>
            <td>${fmtNumber(w.totalCrates)}</td>
            <td>${fmtNumber(w.totalCisternas)}</td>
            <td>${fmtNumber(w.totalPallets)}</td>
          `;
          weeklyBody.appendChild(tr);
        });

        const overallAvgWorkersWeekly = grandDays > 0 ? grandWorkers / grandDays : 0;
        const overallBpwhWeekly = grandWorkerHours > 0 ? grandBoards / grandWorkerHours : 0;

        const tds = weeklyFootRow.querySelectorAll("td");
        if (tds.length >= 9) {
          tds[0].textContent = "Grand Total";
          tds[1].textContent = String(grandDays);
          tds[2].textContent = fmtNumber(grandBoards);
          tds[3].textContent = fmt1(overallBpwhWeekly);
          tds[4].textContent = fmt1(grandBoardHours);
          tds[5].textContent = fmt1(overallAvgWorkersWeekly);
          tds[6].textContent = fmtNumber(grandCrates);
          tds[7].textContent = fmtNumber(grandCisternas);
          tds[8].textContent = fmtNumber(grandPallets);
        }
      }

      // Update DAILY grand total row
      const tfootRow = document.querySelector("#sanitation-table tfoot tr");
      if (tfootRow) {
        const tds = tfootRow.querySelectorAll("td");
        const totalBoardHours = data.reduce((sum, d) => sum + d.boardHours, 0);
        if (tds.length >= 12) {
          tds[0].textContent = "Grand Total";
          tds[1].textContent = "–";
          tds[2].textContent = "–";
          tds[3].textContent = "–";
          tds[4].textContent = fmt1(avgWorkers);
          tds[5].textContent = fmt1(totalBoardHours);
          tds[6].textContent = fmtNumber(totalBoards);
          tds[7].textContent = fmtNumber(totalBroken);
          tds[8].textContent = fmt1(avgBpwh);
          tds[9].textContent = fmtNumber(totalCrates);
          tds[10].textContent = fmtNumber(totalCisternas);
          tds[11].textContent = fmtNumber(totalPallets);
        }
      }

      // Chart arrays
      const labelsByDate = data.map((d) => d.date);
      const boardsByDate = data.map((d) => d.boards);
      const brokenByDate = data.map((d) => d.broken);
      const bpwhByDate = data.map((d) => d.bpwh);

      const labelsByWeek = weekAgg.map((w) => String(w.week));
      const boardsByWeek = weekAgg.map((w) => w.totalBoards);
      const brokenByWeek = weekAgg.map((w) => w.totalBroken);
      const bpwhByWeek = weekAgg.map((w) => w.bpwhWeek);

      renderCharts(
        labelsByDate, boardsByDate, brokenByDate, bpwhByDate,
        labelsByWeek, boardsByWeek, brokenByWeek, bpwhByWeek
      );
    }

    // =========================================================
    // CHARTS
    // =========================================================
    function renderCharts(
      labelsByDate, boardsByDate, brokenByDate, bpwhByDate,
      labelsByWeek, boardsByWeek, brokenByWeek, bpwhByWeek
    ) {
      const usingWeekly = viewMode === "weekly";

      const labels = usingWeekly ? labelsByWeek : labelsByDate;
      const boardsValues = usingWeekly ? boardsByWeek : boardsByDate;
      const brokenValues = usingWeekly ? brokenByWeek : brokenByDate;
      const bpwhValues = usingWeekly ? bpwhByWeek : bpwhByDate;

      const ctxBoards = document.getElementById("chart-boards")?.getContext("2d");
      const ctxBroken = document.getElementById("chart-broken")?.getContext("2d");
      const ctxBpwh = document.getElementById("chart-bpwh")?.getContext("2d");
      if (!ctxBoards || !ctxBroken || !ctxBpwh) return;

      if (boardsChart) boardsChart.destroy();
      if (brokenChart) brokenChart.destroy();
      if (bpwhChart) bpwhChart.destroy();

      boardsChart = new Chart(ctxBoards, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: usingWeekly ? "Boards cleaned (per week)" : "Boards cleaned",
            data: boardsValues,
            borderWidth: 0,
            borderRadius: 4,
            backgroundColor: "rgba(59, 130, 246, 0.8)"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { grid: { display: false }, ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 } },
            y: { grid: { color: "rgba(31, 41, 55, 0.8)" }, ticks: { color: "rgba(148, 163, 184, 0.9)" } }
          }
        }
      });

      const brokenDatasets = [{
        label: usingWeekly ? "Broken boards (per week)" : "Broken boards",
        data: brokenValues,
        borderWidth: 0,
        borderRadius: 4,
        backgroundColor: "rgba(239, 68, 68, 0.85)"
      }];

      if (showTrendLine) {
        const trend = computeTrendLine(brokenValues);
        if (trend.length === brokenValues.length) {
          brokenDatasets.push({
            type: "line",
            label: "Broken trend",
            data: trend,
            tension: 0,
            borderWidth: 1.8,
            pointRadius: 0,
            fill: false,
            borderDash: [5, 4],
            borderColor: "rgba(248, 113, 113, 0.9)",
            order: 1
          });
        }
      }

      brokenChart = new Chart(ctxBroken, {
        type: "bar",
        data: { labels, datasets: brokenDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { grid: { display: false }, ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 } },
            y: { grid: { color: "rgba(31, 41, 55, 0.8)" }, ticks: { color: "rgba(148, 163, 184, 0.9)" } }
          }
        }
      });

      const bpwhDatasets = [{
        label: usingWeekly ? "BPWH (weekly)" : "Boards / worker / hour",
        data: bpwhValues,
        tension: 0.35,
        borderWidth: 2.2,
        pointRadius: 2.8,
        fill: false,
        borderColor: "rgba(34, 197, 94, 0.9)"
      }];

      if (showTrendLine) {
        const trend = computeTrendLine(bpwhValues);
        if (trend.length === bpwhValues.length) {
          bpwhDatasets.push({
            label: "Trend",
            data: trend,
            tension: 0,
            borderWidth: 1.8,
            pointRadius: 0,
            fill: false,
            borderDash: [5, 4],
            borderColor: "rgba(148, 163, 184, 0.8)"
          });
        }
      }

      bpwhChart = new Chart(ctxBpwh, {
        type: "line",
        data: { labels, datasets: bpwhDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { grid: { display: false }, ticks: { color: "rgba(148, 163, 184, 0.9)", maxRotation: 0, autoSkip: true, autoSkipPadding: 18 } },
            y: { grid: { color: "rgba(31, 41, 55, 0.8)" }, ticks: { color: "rgba(148, 163, 184, 0.9)" } }
          }
        }
      });
    }

    // =========================================================
    // VIEW TOGGLES
    // =========================================================
    function setViewMode(mode) {
      if (mode !== "daily" && mode !== "weekly") return;
      viewMode = mode;
      const usingWeekly = viewMode === "weekly";

      document.getElementById("view-by-date")?.classList.toggle("active", !usingWeekly);
      document.getElementById("view-by-week")?.classList.toggle("active", usingWeekly);
      document.getElementById("table-view-daily")?.classList.toggle("active", !usingWeekly);
      document.getElementById("table-view-weekly")?.classList.toggle("active", usingWeekly);

      const dailyWrapper = document.getElementById("daily-table-wrapper");
      const weeklyWrapper = document.getElementById("weekly-table-wrapper");
      if (dailyWrapper && weeklyWrapper) {
        dailyWrapper.style.display = usingWeekly ? "none" : "block";
        weeklyWrapper.style.display = usingWeekly ? "block" : "none";
      }

      const tableTitle = document.getElementById("table-title-text");
      const tableSubtitle = document.getElementById("table-subtitle-text");
      const tableLabel = document.getElementById("table-view-label");
      if (tableTitle && tableSubtitle && tableLabel) {
        if (usingWeekly) {
          tableTitle.textContent = "Weekly sanitation summary";
          tableSubtitle.textContent = "One row per sanitation week – totals, averages, and weekly BPWH.";
          tableLabel.textContent = "Weekly view";
        } else {
          tableTitle.textContent = "Daily sanitation log";
          tableSubtitle.textContent = "Built from Master Grow (Sanitation columns aggregated into daily totals).";
          tableLabel.textContent = "Daily view";
        }
      }

      recomputeDashboard();
    }

    function setupToggles() {
      document.getElementById("view-by-date")?.addEventListener("click", () => setViewMode("daily"));
      document.getElementById("view-by-week")?.addEventListener("click", () => setViewMode("weekly"));
      document.getElementById("table-view-daily")?.addEventListener("click", () => setViewMode("daily"));
      document.getElementById("table-view-weekly")?.addEventListener("click", () => setViewMode("weekly"));

      const chk = document.getElementById("trend-toggle-input");
      if (chk) {
        chk.addEventListener("change", () => {
          showTrendLine = chk.checked;
          recomputeDashboard();
        });
      }
    }

    // =========================================================
    // LIVE REFRESH + IFRAME SNAPSHOT REQUEST
    // =========================================================
    function reloadAll() {
      const res = buildFromMasterGrow();
      recomputeDashboard();

      // extra hint if nothing built
      if (!res.daily.length) {
        setEmpty(
          "Master Grow loaded, but no sanitation rows were built.\n" +
          "Check:\n" +
          "- Date of Sanitation values are present + parseable\n" +
          "- Sanitation Week values are present\n" +
          "- Total # of Boards Cleaned / Board Cleaning Tiempo Transcurido / Sanitation # of Workers are populated"
        );
      }
    }

    function requestSnapshotFromParent() {
      try {
        window.parent?.postMessage?.({ type: "REQUEST_DATA_SNAPSHOT", key: MASTER_GROW_KEY }, "*");
      } catch (e) {}
    }

    function acceptSnapshot(payload) {
      if (!payload || !String(payload).trim()) return false;
      try { localStorage.setItem(MASTER_GROW_KEY, String(payload)); } catch (e) {}
      reloadAll();
      return true;
    }

    function setupLiveListeners() {
      window.addEventListener("storage", (e) => {
        if (e.key === MASTER_GROW_KEY || e.key === MASTER_GROW_PING_KEY) reloadAll();
      });

      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;

        if (msg.type === "MASTER_GROW_UPDATED" && msg.key === MASTER_GROW_KEY) reloadAll();

        // parent sends snapshot of localStorage value
        if (msg.type === "DATA_SNAPSHOT" && msg.key === MASTER_GROW_KEY) {
          acceptSnapshot(msg.payload || "");
        }
      });

      // custom events (some harnesses dispatch these)
      window.addEventListener("MASTER_GROW_UPDATED", (e) => {
        const key = e?.detail?.key;
        if (!key || key === MASTER_GROW_KEY) reloadAll();
      });
      document.addEventListener("MASTER_GROW_UPDATED", (e) => {
        const key = e?.detail?.key;
        if (!key || key === MASTER_GROW_KEY) reloadAll();
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupToggles();
      setupLiveListeners();
      reloadAll();
      setViewMode("daily");
      requestSnapshotFromParent();
    });
  </script>
</body>
</html>
