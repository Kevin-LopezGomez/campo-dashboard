<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Retail Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --border: #1f2937;
      --border-subtle: #334155;
      --text: #e5e7eb;
      --sub: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --accent-strong: rgba(34, 197, 94, 0.45);
      --danger: #ef4444;
      --radius: 20px;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #172554 0, transparent 55%),
        radial-gradient(circle at bottom right, #0b1120 0, #020617 55%);
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      padding: 18px 18px 32px;
      max-width: 1360px;
      margin: 0 auto;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .page-subtitle {
      font-size: 0.8rem;
      color: var(--sub);
      margin-top: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
      font-size: 0.74rem;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 340px) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(30, 64, 175, 0.45), transparent 60%),
        radial-gradient(circle at bottom right, rgba(15, 118, 110, 0.3), transparent 65%),
        linear-gradient(145deg, #020617, #020617);
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.95);
      box-shadow:
        0 26px 60px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 16px 16px 18px;
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 0.86rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--sub);
    }

    .card-subtitle {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--sub);
    }

    /* Store select */
    .store-select {
      width: 100%;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617, #020617);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      margin-bottom: 8px;
    }

    /* Metric chips */
    .chip-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .chip-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chip {
      padding: 8px 10px;
      border-radius: 14px;
      background:
        radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(51, 65, 85, 0.9);
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
      box-shadow: 0 18px 35px rgba(0, 0, 0, 0.8);
    }

    .chip-label {
      font-size: 0.68rem;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .chip-value {
      font-size: 1.0rem;
      font-weight: 600;
    }

    .chip-value-5 { color: #38bdf8; }
    .chip-value-10 { color: #a855f7; }

    .chip small {
      font-size: 0.7rem;
      color: var(--sub);
    }

    /* Toggles */
    .mode-toggle {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 2px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
    }

    .mode-btn {
      border: none;
      background: transparent;
      color: var(--sub);
      font-size: 0.75rem;
      padding: 5px 12px;
      border-radius: 999px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(16, 185, 129, 0.28));
      color: #bbf7d0;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.7);
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;
      margin-top: 6px;
    }

    .chart-container-small {
      position: relative;
      width: 100%;
      height: 220px;
    }

    @media (max-width: 960px) {
      .chart-container {
        height: 260px;
      }
      .chart-container-small {
        height: 200px;
      }
    }

    .table-wrapper {
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(30, 64, 175, 0.45);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
      max-height: 260px;
      overflow: auto;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #020617, #020617);
      z-index: 1;
    }

    th, td {
      padding: 7px 8px;
      border-bottom: 1px solid #0f172a;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child, td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: radial-gradient(circle at top left, #020617, #020617);
      box-shadow: 2px 0 0 #020617;
    }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--sub);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.96);
    }
    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    tfoot td {
      font-weight: 600;
      border-top: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at bottom, #020617, #020617);
    }

    .muted {
      color: var(--sub);
      font-size: 0.78rem;
    }

    /* Threshold inputs */
    .threshold-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--sub);
    }

    .threshold-input {
      width: 100%;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617, #020617);
      color: var(--text);
      font-size: 0.78rem;
      outline: none;
    }

    /* Collapsible data input */
    .collapse-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      padding: 7px 10px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border: 1px dashed rgba(75, 85, 99, 0.9);
      margin-top: 8px;
    }

    .collapse-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--sub);
    }

    .collapse-icon {
      font-size: 0.9rem;
      color: var(--sub);
    }

    .collapse-body {
      margin-top: 10px;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    .collapse-body.open {
      display: block;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      color: var(--text);
      font-size: 0.78rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      resize: vertical;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.95);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      margin-top: 6px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: radial-gradient(circle at top, rgba(21, 128, 61, 0.35), rgba(6, 95, 70, 0.32));
      color: #bbf7d0;
      font-size: 0.78rem;
      cursor: pointer;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.8);
    }

    .btn span {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .btn-secondary {
      border-color: rgba(75, 85, 99, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      color: var(--sub);
    }

    /* Low inventory cell highlight */
    .low-cell {
      background: rgba(127, 29, 29, 0.9) !important;
      color: #fee2e2 !important;
    }

    /* Multi: chains and stores checkbox sections */
    .checkbox-section {
      margin-top: 4px;
    }

    .checkbox-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--sub);
      margin-bottom: 3px;
    }

    .checkbox-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
      max-height: 90px;
      overflow: auto;
      padding-right: 4px;
    }

    .checkbox-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.74rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .checkbox-pill input {
      accent-color: var(--accent);
      cursor: pointer;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-2px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Retail Inventory Dashboard</div>
        <div class="page-subtitle">Daily store-level inventory – 5 oz &amp; 10 oz units on shelf.</div>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        Live from pasted Excel data
      </div>
    </div>

    <!-- DATA INPUT CARD (separate from selector) -->
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title">Data input</div>
          <div class="card-subtitle">
            Paste or edit inventory data from Excel. This feeds all views above.
          </div>
        </div>
      </div>

      <div class="collapse-header" id="collapseToggle">
        <div class="collapse-title">Data input – paste / edit inventory</div>
        <div class="collapse-icon" id="collapseIcon">+</div>
      </div>
      <div class="collapse-body" id="collapseBody">
        <p class="muted">
          Paste your Excel data here (tab-separated). Supported formats:
          <br />
          <strong>1)</strong> Store, Day, 5 oz - inventory, 10 oz - Inventory<br />
          <strong>2)</strong> Store, Location, Day, 5 oz - inventory, 10 oz - Inventory<br />
          <strong>3)</strong> Matrix: first row = store names (columns), first col = Date/Day with "5oz" or "10oz"
          <br /><br />
          Example Day: <strong>Thursday, October 23, 2025</strong> or <strong>23-Oct</strong>.
          Empty cells are treated as <strong>0</strong>.
        </p>
        <textarea id="dataInput"></textarea>
        <div class="chip-row" style="margin-top:4px; grid-template-columns: repeat(2,minmax(0,1fr));">
          <button class="btn" id="loadDataBtn">
            <span>Load data</span>
          </button>
          <button class="btn btn-secondary" id="clearDataBtn">
            <span>Clear</span>
          </button>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Store selector & metrics -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Store selector</div>
            <div class="card-subtitle">
              Choose a store (chain – location) to explore daily or weekly inventory.
            </div>
          </div>
        </div>

        <select id="storeSelect" class="store-select"></select>

        <div class="chip-row" id="summaryChips">
          <div class="chip">
            <div class="chip-label">Latest 5 oz</div>
            <div class="chip-value chip-value-5" id="latest5oz">–</div>
          </div>
          <div class="chip">
            <div class="chip-label">Latest 10 oz</div>
            <div class="chip-value chip-value-10" id="latest10oz">–</div>
          </div>
          <div class="chip">
            <div class="chip-label">Days with data</div>
            <div class="chip-value" id="daysWithData">–</div>
          </div>
          <div class="chip">
            <div class="chip-label">Avg total units</div>
            <div class="chip-value" id="avgTotal">–</div>
          </div>
          <div class="chip">
            <div class="chip-label">Low inventory days</div>
            <div class="chip-value" id="lowDaysStore">–</div>
          </div>
        </div>

        <!-- Threshold controls -->
        <div class="card-subtitle" style="margin-top:12px;">
          Low inventory thresholds (units)
        </div>
        <div class="chip-row" style="margin-top:6px;">
          <div class="threshold-group">
            <label for="threshold5">5 oz threshold</label>
            <input id="threshold5" type="number" min="0" value="5" class="threshold-input" />
          </div>
          <div class="threshold-group">
            <label for="threshold10">10 oz threshold</label>
            <input id="threshold10" type="number" min="0" value="5" class="threshold-input" />
          </div>
        </div>
      </div>

      <!-- RIGHT: Chart & table -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="viewTitle">Daily inventory</div>
            <div class="card-subtitle" id="viewSubtitle"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
            <div class="mode-toggle">
              <button class="mode-btn active" id="dailyBtn">By date</button>
              <button class="mode-btn" id="weeklyBtn">By week</button>
            </div>
            <div class="mode-toggle">
              <button class="mode-btn active" id="singleModeBtn">Store</button>
              <button class="mode-btn" id="multiModeBtn">Multi</button>
            </div>
            <button class="btn btn-secondary" id="clearStoresBtn" style="display:none; padding:4px 12px;">
              <span>Clear stores</span>
            </button>
          </div>
        </div>

        <!-- Multi: chains & stores selector -->
        <div id="multiStoreSelectorRow" style="display:none;margin-bottom:8px;">
          <div class="checkbox-section">
            <div class="checkbox-section-title">Chains</div>
            <div class="checkbox-list" id="chainCheckboxes"></div>
          </div>
          <div class="checkbox-section" style="margin-top:6px;">
            <div class="checkbox-section-title">Stores</div>
            <div class="checkbox-list" id="storeCheckboxes"></div>
          </div>
          <p class="muted" style="margin-top:4px;">
            Select one or more chains and/or stores. Chains aggregate all their locations.
          </p>
          <div class="chip-row" style="margin-top:4px; grid-template-columns: repeat(3,minmax(0,1fr));">
            <button class="btn btn-secondary" id="selectAllChainsBtn"><span>All chains</span></button>
            <button class="btn btn-secondary" id="selectAllStoresBtn"><span>All stores</span></button>
            <button class="btn btn-secondary" id="clearAllMultiBtn"><span>Clear all</span></button>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="inventoryChart"></canvas>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
            <tfoot>
              <tr id="tableFooterRow"></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Low inventory by day of week -->
    <div class="card" style="margin-top:18px;">
      <div class="card-header">
        <div>
          <div class="card-title">Low inventory by day of week</div>
          <div class="card-subtitle">
            Counts of low-inventory days by weekday. Uses thresholds above.
          </div>
        </div>
      </div>
      <div class="chart-container-small">
        <canvas id="dowChart"></canvas>
      </div>
      <p class="muted" style="margin-top:8px;">
        A day is considered low inventory if 5 oz ≤ threshold or 10 oz ≤ threshold and there was recorded data.
        Darker bar = all stores; lighter bar = selected store.
      </p>
    </div>

    <!-- Multi-store summary -->
    <div class="card" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title">Multi-store summary</div>
          <div class="card-subtitle">
            Top 5 stores (chain – location) with the lowest latest inventory. Low-inventory days use the thresholds above.
          </div>
        </div>
      </div>
      <div class="table-wrapper" style="max-height:220px;">
        <table>
          <thead>
            <tr>
              <th>Store</th>
              <th>Latest day</th>
              <th>Latest 5 oz</th>
              <th>Latest 10 oz</th>
              <th>Latest total</th>
              <th>Low-inv days</th>
            </tr>
          </thead>
          <tbody id="multiStoreBody"></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:8px;">
        Low-inventory days = days where 5 oz ≤ threshold or 10 oz ≤ threshold and there was recorded data.
      </p>
    </div>
  </div>

<script>
  // --------- RAW DATA (preloaded) ----------
  const initialData = `Date\tPueblo. Trujillo Plaza\tEcono Expreso\tAmigo Paseos\tPueblo Señorial\tPueblo Cupey\tWalmart Escorial
Nov. 17 5oz\t10\t8\t2\t2\t12\t59
Nov. 18 5oz\t0\t4\t1\t0\t11\t63
Nov. 19 5oz\t17\t3\t28\t15\t23\t58
Nov. 20 5oz\t15\t3\t17\t9\t20\t48
Nov. 21 5oz\t0\t0\t0\t0\t0\t0
Nov. 24 5oz\t0\t0\t0\t0\t0\t0
Nov. 25 5oz\t0\t0\t0\t0\t0\t0
Nov. 26 5oz\t0\t0\t0\t0\t0\t0
Dec. 1 5oz\t0\t0\t0\t0\t0\t0
Dec. 2 5oz\t0\t0\t0\t0\t0\t0
Dec. 3 5oz\t0\t0\t0\t0\t0\t0
Dec. 4 5oz\t0\t0\t0\t0\t0\t0
Dec. 5 5oz\t0\t0\t0\t0\t0\t0
Dec. 8 5oz\t0\t0\t0\t0\t0\t0
Dec. 9 5oz\t0\t0\t0\t0\t0\t0
Dec. 10 5oz\t0\t0\t0\t0\t0\t0
Dec. 11 5oz\t0\t0\t0\t0\t0\t0
Dec. 12 5oz\t0\t0\t0\t0\t0\t0
Nov. 17 10oz\t1\t0\t7\t0\t7\t23
Nov. 18 10oz\t0\t0\t3\t0\t7\t17
Nov. 19 10oz\t0\t0\t2\t0\t5\t20
Nov. 20 10oz\t0\t0\t1\t0\t3\t18
Nov. 21 10oz\t0\t0\t0\t0\t0\t0
Nov. 24 10oz\t0\t0\t0\t0\t0\t0
Nov. 25 10oz\t0\t0\t0\t0\t0\t0
Nov. 26 10oz\t0\t0\t0\t0\t0\t0
Dec. 1 10oz\t0\t0\t0\t0\t0\t0
Dec. 2 10oz\t0\t0\t0\t0\t0\t0
Dec. 3 10oz\t0\t0\t0\t0\t0\t0
Dec. 4 10oz\t0\t0\t0\t0\t0\t0
Dec. 5 10oz\t0\t0\t0\t0\t0\t0
Dec. 8 10oz\t0\t0\t0\t0\t0\t0
Dec. 9 10oz\t0\t0\t0\t0\t0\t0
Dec. 10 10oz\t0\t0\t0\t0\t0\t0
Dec. 11 10oz\t0\t0\t0\t0\t0\t0
Dec. 12 10oz\t0\t0\t0\t0\t0\t0`;

  // --------- STATE ----------
  let inventoryRows = [];
  let stores = [];
  let chains = [];
  let currentStore = null;
  let viewMode = 'daily';   // daily | weekly
  let chartMode = 'single'; // single | multi
  let chartInstance = null;
  let dowChartInstance = null;
  let threshold5 = 5;
  let threshold10 = 5;

  const monthShortMap = {
    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3,
    'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7,
    'Sep': 8, 'Sept': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
  };
  const weekdayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  function parseStoreLabel(label) {
    const trimmed = (label || '').replace(/\s+/g, ' ').trim();
    const parts = trimmed.split(' ');
    const chain = (parts[0] || 'Store').replace(/\.$/, '');
    const location = parts.slice(1).join(' ');
    const store = location ? `${chain} – ${location}` : chain;
    return { chain, location, store };
  }

  function parseDayToDate(dayStr) {
    if (!dayStr) return null;

    const cleaned = dayStr
      .replace(/\b(5|10)\s*oz\b/gi, '')
      .replace(/[–-]\s*(5|10)\s*oz\b/gi, '')
      .replace(/\s+/g, ' ')
      .trim();

    const d1 = new Date(cleaned);
    if (!isNaN(d1.getTime())) return d1;

    const mdMatch = cleaned.match(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\.?\s*(\d{1,2})(?:,?\s*(\d{4}))?$/i);
    if (mdMatch) {
      const month = monthShortMap[mdMatch[1].slice(0, 3)];
      const day = parseInt(mdMatch[2], 10);
      const year = mdMatch[3] ? parseInt(mdMatch[3], 10) : (new Date()).getFullYear();
      if (!isNaN(month) && !isNaN(day)) return new Date(year, month, day);
    }

    const parts = cleaned.split('-');
    if (parts.length === 2) {
      const d = parseInt(parts[0], 10);
      const m = monthShortMap[parts[1]];
      if (!isNaN(d) && m !== undefined) {
        return new Date(2024, m, d);
      }
    }
    return null;
  }

  function getISOWeek(date) {
    if (!date) return null;
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return weekNo;
  }

  // Robust parser
  function parseData(text) {
    const rawLines = text.split(/\r?\n/);
    const lines = rawLines.filter(l => l.trim().length > 0);
    if (lines.length <= 1) return [];

    const clean = (v) => (v == null ? '' : String(v).trim());

    function parseNumberCell(str) {
      const raw = clean(str).replace(/,/g, '');
      if (raw === '') return null;
      const match = raw.match(/-?\d+(\.\d+)?/);
      if (!match) return null;
      const n = Number(match[0]);
      return isNaN(n) ? null : n;
    }

    function parseMatrixStyle() {
      const headerRaw = lines[0].split('\t');
      const secondParts = (lines[1] || '').split('\t');
      const looksMatrix = secondParts.length > 2 &&
        (secondParts.length === headerRaw.length + 1 || secondParts.length === headerRaw.length) &&
        !/store/i.test(clean(headerRaw[0]));
      if (!looksMatrix) return null;

      const hasDateHeader = /^date$/i.test(clean(headerRaw[0]));
      const headerOffset = hasDateHeader ? 1 : 0;

      const records = new Map();

      function upsert(storeInfo, dayLabel, size, value) {
        const key = `${storeInfo.store}||${dayLabel}`;
        if (!records.has(key)) {
          const date = parseDayToDate(dayLabel);
          records.set(key, {
            store: storeInfo.store,
            chain: storeInfo.chain,
            location: storeInfo.location,
            dayLabel,
            date,
            week: date ? getISOWeek(date) : null,
            inv5: 0,
            inv10: 0,
            hasData: false
          });
        }
        const rec = records.get(key);
        if (size === '5') {
          rec.inv5 = value == null ? 0 : value;
        } else {
          rec.inv10 = value == null ? 0 : value;
        }
        if (value !== null) rec.hasData = true;
      }

      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split('\t');
        if (parts.length < 2) continue;
        const labelRaw = clean(parts[0]);
        if (!labelRaw) continue;

        const size = /10\s*oz/i.test(labelRaw) ? '10' : '5';
        const dayLabel = labelRaw.replace(/\b(5|10)\s*oz\b/i, '').trim() || labelRaw;

        for (let col = 1; col < parts.length; col++) {
          const headerIdx = col - 1 + headerOffset;
          const storeName = clean(headerRaw[headerIdx] || headerRaw[col] || `Store ${col}`);
          if (!storeName) continue;
          const storeInfo = parseStoreLabel(storeName);
          const num = parseNumberCell(parts[col]);
          const hasVal = clean(parts[col]) !== '' && num !== null;
          upsert(storeInfo, dayLabel, size, hasVal ? num : null);
        }
      }

      return Array.from(records.values());
    }

    const matrixRows = parseMatrixStyle();
    if (matrixRows) return matrixRows;

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      const parts = line.split('\t');

      if (parts.length < 2) continue;

      const storeChain = clean(parts[0]);
      let location = '';
      let dayLabelIdx, inv5Idx, inv10Idx;

      if (parts.length >= 5) {
        location    = clean(parts[1]);
        dayLabelIdx = 2;
        inv5Idx     = 3;
        inv10Idx    = 4;
      } else {
        dayLabelIdx = 1;
        inv5Idx     = 2;
        inv10Idx    = 3;
      }

      const dayLabel = clean(parts[dayLabelIdx]);
      if (!storeChain || !dayLabel) continue;

      const inv5Str  = parts[inv5Idx]  != null ? parts[inv5Idx]  : '';
      const inv10Str = parts[inv10Idx] != null ? parts[inv10Idx] : '';

      const inv5Num  = parseNumberCell(inv5Str);
      const inv10Num = parseNumberCell(inv10Str);

      const has5  = clean(inv5Str)  !== '' && inv5Num  !== null;
      const has10 = clean(inv10Str) !== '' && inv10Num !== null;
      const hasData = has5 || has10;

      const inv5  = inv5Num  == null ? 0 : inv5Num;
      const inv10 = inv10Num == null ? 0 : inv10Num;

      const date = parseDayToDate(dayLabel);
      const week = date ? getISOWeek(date) : null;

      const storeInfo = parseStoreLabel(location ? `${storeChain} ${location}` : storeChain);

      rows.push({
        store: storeInfo.store,
        chain: storeInfo.chain,
        location: location || storeInfo.location,
        dayLabel,
        date,
        week,
        inv5,
        inv10,
        hasData
      });
    }
    return rows;
  }

  function recomputeStores() {
    const storeSet = new Set();
    const chainSet = new Set();
    inventoryRows.forEach(r => {
      if (r.store) storeSet.add(r.store);
      if (r.chain) chainSet.add(r.chain);
    });
    stores = Array.from(storeSet).sort();
    chains = Array.from(chainSet).sort();
  }

  function populateStoreSelect() {
    const select = document.getElementById('storeSelect');
    select.innerHTML = '';
    stores.forEach(store => {
      const opt = document.createElement('option');
      opt.value = store;
      opt.textContent = store;
      select.appendChild(opt);
    });
    if (!currentStore && stores.length > 0) {
      currentStore = stores[0];
    }
    if (currentStore) {
      select.value = currentStore;
    }
  }

  function populateChainCheckboxes() {
    const container = document.getElementById('chainCheckboxes');
    if (!container) return;
    container.innerHTML = '';
    chains.forEach(chain => {
      const label = document.createElement('label');
      label.className = 'checkbox-pill';

      const input = document.createElement('input');
      input.type = 'checkbox';
      input.value = chain;
      input.checked = true;

      const span = document.createElement('span');
      span.textContent = chain;

      label.appendChild(input);
      label.appendChild(span);
      container.appendChild(label);
    });
  }

  function populateStoreCheckboxes() {
    const container = document.getElementById('storeCheckboxes');
    if (!container) return;
    container.innerHTML = '';
    stores.forEach(store => {
      const label = document.createElement('label');
      label.className = 'checkbox-pill';

      const input = document.createElement('input');
      input.type = 'checkbox';
      input.value = store;

      const span = document.createElement('span');
      span.textContent = store;

      label.appendChild(input);
      label.appendChild(span);
      container.appendChild(label);
    });
  }

  function getSelectedChains() {
    const container = document.getElementById('chainCheckboxes');
    if (!container) return [];
    return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
      .map(input => input.value);
  }

  function getSelectedStores() {
    const container = document.getElementById('storeCheckboxes');
    if (!container) return [];
    return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
      .map(input => input.value);
  }

  function formatNumber(n) {
    if (n === null || n === undefined || isNaN(n)) return '–';
    return n.toLocaleString('en-US', { maximumFractionDigits: 1 });
  }

  function readThresholds() {
    const t5 = Number(document.getElementById('threshold5').value);
    const t10 = Number(document.getElementById('threshold10').value);
    threshold5 = isNaN(t5) || t5 < 0 ? 0 : t5;
    threshold10 = isNaN(t10) || t10 < 0 ? 0 : t10;
  }

  function updateSummary(storeRows) {
    const latest5El = document.getElementById('latest5oz');
    const latest10El = document.getElementById('latest10oz');
    const daysEl = document.getElementById('daysWithData');
    const avgTotalEl = document.getElementById('avgTotal');
    const lowDaysEl = document.getElementById('lowDaysStore');

    if (!storeRows || storeRows.length === 0) {
      latest5El.textContent = '–';
      latest10El.textContent = '–';
      daysEl.textContent = '0';
      avgTotalEl.textContent = '–';
      lowDaysEl.textContent = '0';
      return;
    }

    const sorted = [...storeRows].sort((a, b) => {
      if (a.date && b.date) return a.date - b.date;
      return a.dayLabel.localeCompare(b.dayLabel);
    });
    const latest = sorted[sorted.length - 1];

    const rowsWithData = storeRows.filter(r => r.hasData);
    const daysWithAnyData = rowsWithData.length;
    const avgTotal = rowsWithData.length
      ? rowsWithData.reduce((sum, r) => sum + (r.inv5 + r.inv10), 0) / rowsWithData.length
      : 0;

    const lowDaysStore = rowsWithData.filter(r =>
      (r.inv5 <= threshold5) || (r.inv10 <= threshold10)
    ).length;

    latest5El.textContent = formatNumber(latest.inv5);
    latest10El.textContent = formatNumber(latest.inv10);
    daysEl.textContent = daysWithAnyData.toString();
    avgTotalEl.textContent = formatNumber(avgTotal);
    lowDaysEl.textContent = lowDaysStore.toString();
  }

  function buildDailySeries(storeRows) {
    const sorted = [...storeRows].sort((a, b) => {
      if (a.date && b.date) return a.date - b.date;
      return a.dayLabel.localeCompare(b.dayLabel);
    });

    const labels = sorted.map(r => r.dayLabel);
    const data5 = sorted.map(r => r.inv5);
    const data10 = sorted.map(r => r.inv10);

    return { labels, data5, data10, rows: sorted };
  }

  function buildWeeklySeries(storeRows) {
    const weekMap = new Map();
    storeRows.forEach(r => {
      if (!r.week) return;
      if (!weekMap.has(r.week)) {
        weekMap.set(r.week, { week: r.week, inv5Sum: 0, inv10Sum: 0, count: 0 });
      }
      const bucket = weekMap.get(r.week);
      bucket.inv5Sum += r.inv5;
      bucket.inv10Sum += r.inv10;
      bucket.count += 1;
    });

    const buckets = Array.from(weekMap.values()).sort((a, b) => a.week - b.week);
    const labels = buckets.map(b => `W${b.week}`);
    const data5 = buckets.map(b => b.inv5Sum / b.count);
    const data10 = buckets.map(b => b.inv10Sum / b.count);

    const rows = buckets.map(b => ({
      label: `W${b.week}`,
      inv5: b.inv5Sum / b.count,
      inv10: b.inv10Sum / b.count,
      hasData: true
    }));

    return { labels, data5, data10, rows };
  }

  function updateMultiStoreSummary() {
    const body = document.getElementById('multiStoreBody');
    if (!body) return;

    const per = new Map();

    inventoryRows.forEach(r => {
      if (!per.has(r.store)) {
        per.set(r.store, { store: r.store, latest: null, lowDays: 0 });
      }
      const obj = per.get(r.store);

      if (!obj.latest || (r.date && (!obj.latest.date || r.date > obj.latest.date))) {
        obj.latest = {
          date: r.date,
          dayLabel: r.dayLabel,
          inv5: r.inv5,
          inv10: r.inv10
        };
      }

      if (r.hasData && ((r.inv5 <= threshold5) || (r.inv10 <= threshold10))) {
        obj.lowDays++;
      }
    });

    const list = Array.from(per.values()).map(obj => {
      const latestTotal = obj.latest ? obj.latest.inv5 + obj.latest.inv10 : 0;
      return { ...obj, latestTotal };
    });

    list.sort((a, b) => a.latestTotal - b.latestTotal);
    const top = list.slice(0, 5);

    body.innerHTML = '';
    top.forEach(item => {
      const tr = document.createElement('tr');
      const latest = item.latest || { dayLabel: '–', inv5: null, inv10: null };
      const cells = [
        item.store,
        latest.dayLabel || '–',
        formatNumber(latest.inv5),
        formatNumber(latest.inv10),
        formatNumber(item.latestTotal),
        item.lowDays.toString()
      ];
      cells.forEach((val) => {
        const td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  }

  function drawChart(config) {
    const ctx = document.getElementById('inventoryChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, config);
  }

  function drawDowChart(allCounts, storeCounts) {
    const ctx = document.getElementById('dowChart').getContext('2d');
    if (dowChartInstance) dowChartInstance.destroy();
    dowChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weekdayLabels,
        datasets: [
          {
            label: 'All stores',
            data: allCounts,
            borderWidth: 1,
            backgroundColor: 'rgba(59,130,246,0.6)'
          },
          {
            label: currentStore ? `Selected store: ${currentStore}` : 'Selected store',
            data: storeCounts,
            borderWidth: 1,
            backgroundColor: 'rgba(34,197,94,0.6)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const v = ctx.parsed.y;
                return `${ctx.dataset.label}: ${v} low days`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af' },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#9ca3af', precision: 0 },
            grid: { color: 'rgba(55,65,81,0.5)' }
          }
        }
      }
    });
  }

  function updateDowChart() {
    readThresholds();
    const allCounts = new Array(7).fill(0);
    const storeCounts = new Array(7).fill(0);

    inventoryRows.forEach(r => {
      if (!r.hasData || !r.date) return;
      const isLow = (r.inv5 <= threshold5) || (r.inv10 <= threshold10);
      if (!isLow) return;
      const dow = r.date.getDay();
      allCounts[dow]++;
      if (currentStore && r.store === currentStore) {
        storeCounts[dow]++;
      }
    });

    drawDowChart(allCounts, storeCounts);
  }

  function updateSingleChartAndTable() {
    if (!currentStore) return;
    const storeRows = inventoryRows.filter(r => r.store === currentStore);
    updateSummary(storeRows);

    let labels = [];
    let data5 = [];
    let data10 = [];
    let tableRows = [];
    const isWeekly = (viewMode === 'weekly');

    if (isWeekly) {
      const weekly = buildWeeklySeries(storeRows);
      labels = weekly.labels;
      data5 = weekly.data5;
      data10 = weekly.data10;
      tableRows = weekly.rows;
    } else {
      const daily = buildDailySeries(storeRows);
      labels = daily.labels;
      data5 = daily.data5;
      data10 = daily.data10;
      tableRows = daily.rows.map(r => ({
        label: r.dayLabel,
        inv5: r.inv5,
        inv10: r.inv10,
        hasData: r.hasData
      }));
    }

    const lowMask = labels.map((_, idx) =>
      (data5[idx] <= threshold5) || (data10[idx] <= threshold10)
    );

    drawChart({
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '5 oz inventory',
            data: data5,
            borderWidth: 2,
            borderColor: '#38bdf8',
            tension: 0.25,
            pointRadius: 3,
            pointBackgroundColor: labels.map((_, idx) =>
              lowMask[idx] ? '#f97373' : '#e5e7eb'
            )
          },
          {
            label: '10 oz inventory',
            data: data10,
            borderWidth: 2,
            borderColor: '#a855f7',
            tension: 0.25,
            pointRadius: 3,
            pointBackgroundColor: labels.map((_, idx) =>
              lowMask[idx] ? '#f97373' : '#e5e7eb'
            )
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = context.parsed.y;
                return `${context.dataset.label}: ${formatNumber(v)} units`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#9ca3af',
              maxRotation: 0,
              autoSkip: true
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#9ca3af' },
            grid: { color: 'rgba(55,65,81,0.5)' }
          }
        }
      }
    });

    const viewTitle = document.getElementById('viewTitle');
    const viewSubtitle = document.getElementById('viewSubtitle');
    viewTitle.textContent = isWeekly ? 'Weekly inventory (average)' : 'Daily inventory';
    viewSubtitle.textContent = currentStore || '';

    const headerRow = document.getElementById('tableHeaderRow');
    const body = document.getElementById('tableBody');
    const footerRow = document.getElementById('tableFooterRow');

    headerRow.innerHTML = '';
    ['Day / Week', '5 oz', '10 oz', 'Total'].forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });

    body.innerHTML = '';
    let total5 = 0;
    let total10 = 0;

    tableRows.forEach(r => {
      const tr = document.createElement('tr');
      const total = r.inv5 + r.inv10;
      total5 += r.inv5;
      total10 += r.inv10;

      const isLow5 = r.hasData && (r.inv5 <= threshold5);
      const isLow10 = r.hasData && (r.inv10 <= threshold10);
      const isLowAny = r.hasData && (isLow5 || isLow10);

      const tdLabel = document.createElement('td');
      tdLabel.textContent = r.label;
      tr.appendChild(tdLabel);

      const td5 = document.createElement('td');
      td5.textContent = formatNumber(r.inv5);
      if (isLow5) td5.classList.add('low-cell');
      tr.appendChild(td5);

      const td10 = document.createElement('td');
      td10.textContent = formatNumber(r.inv10);
      if (isLow10) td10.classList.add('low-cell');
      tr.appendChild(td10);

      const tdTotal = document.createElement('td');
      tdTotal.textContent = formatNumber(total);
      if (isLowAny) tdTotal.classList.add('low-cell');
      tr.appendChild(tdTotal);

      body.appendChild(tr);
    });

    footerRow.innerHTML = '';
    const footerCells = [
      'Total (sum)',
      formatNumber(total5),
      formatNumber(total10),
      formatNumber(total5 + total10)
    ];
    footerCells.forEach((val) => {
      const td = document.createElement('td');
      td.textContent = val;
      footerRow.appendChild(td);
    });
  }

  function updateMultiChartAndTable() {
    const storeRows = currentStore
      ? inventoryRows.filter(r => r.store === currentStore)
      : [];
    updateSummary(storeRows);

    const selectedChains = getSelectedChains();
    const selectedStores = getSelectedStores();
    const isWeekly = (viewMode === 'weekly');

    const headerRow = document.getElementById('tableHeaderRow');
    const body = document.getElementById('tableBody');
    const footerRow = document.getElementById('tableFooterRow');
    const viewTitle = document.getElementById('viewTitle');
    const viewSubtitle = document.getElementById('viewSubtitle');

    headerRow.innerHTML = '';
    ['Day / Week', '5 oz', '10 oz', 'Total'].forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });

    if (selectedChains.length === 0 && selectedStores.length === 0) {
      viewTitle.textContent = isWeekly
        ? 'Weekly inventory – multi (no selection)'
        : 'Daily inventory – multi (no selection)';
      viewSubtitle.textContent = 'Select at least one chain or store.';

      drawChart({
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb', font: { size: 11 } } }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(55,65,81,0.5)' } }
          }
        }
      });

      body.innerHTML = '';
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = 'Select one or more chains/stores above to see a multi view.';
      tr.appendChild(td);
      body.appendChild(tr);
      footerRow.innerHTML = '';
      return;
    }

    const relevantRows = inventoryRows.filter(r =>
      selectedChains.includes(r.chain) || selectedStores.includes(r.store)
    );

    if (!relevantRows.length) {
      body.innerHTML = '';
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.textContent = 'No matching data for selected chains/stores.';
      tr.appendChild(td);
      body.appendChild(tr);
      footerRow.innerHTML = '';
      return;
    }

    let labels = [];
    let datasets = [];

    if (!isWeekly) {
      const labelMap = new Map();
      relevantRows.forEach(r => {
        if (!labelMap.has(r.dayLabel)) {
          labelMap.set(r.dayLabel, r.date || parseDayToDate(r.dayLabel));
        }
      });
      const entries = Array.from(labelMap.entries()).sort((a, b) => {
        const da = a[1], db = b[1];
        if (da && db) return da - db;
        return a[0].localeCompare(b[0]);
      });
      labels = entries.map(e => e[0]);

      selectedChains.forEach(chain => {
        const data = labels.map(lbl => {
          const rows = relevantRows.filter(r =>
            r.chain === chain && r.dayLabel === lbl && r.hasData
          );
          if (!rows.length) return null;
          return rows.reduce((sum, r) => sum + r.inv5 + r.inv10, 0);
        });
        datasets.push({
          label: `Chain: ${chain}`,
          data,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        });
      });

      selectedStores.forEach(store => {
        const data = labels.map(lbl => {
          const rows = relevantRows.filter(r =>
            r.store === store && r.dayLabel === lbl && r.hasData
          );
          if (!rows.length) return null;
          return rows.reduce((sum, r) => sum + r.inv5 + r.inv10, 0);
        });
        datasets.push({
          label: store,
          data,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        });
      });

    } else {
      const weekSet = new Set();
      relevantRows.forEach(r => {
        if (r.week) weekSet.add(r.week);
      });
      const weeks = Array.from(weekSet).sort((a, b) => a - b);
      labels = weeks.map(w => `W${w}`);

      selectedChains.forEach(chain => {
        const data = weeks.map(week => {
          const rows = relevantRows.filter(r =>
            r.chain === chain && r.week === week && r.hasData
          );
          if (!rows.length) return null;
          const avg = rows.reduce((sum, r) => sum + (r.inv5 + r.inv10), 0) / rows.length;
          return avg;
        });
        datasets.push({
          label: `Chain: ${chain}`,
          data,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        });
      });

      selectedStores.forEach(store => {
        const data = weeks.map(week => {
          const rows = relevantRows.filter(r =>
            r.store === store && r.week === week && r.hasData
          );
          if (!rows.length) return null;
          const avg = rows.reduce((sum, r) => sum + (r.inv5 + r.inv10), 0) / rows.length;
          return avg;
        });
        datasets.push({
          label: store,
          data,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        });
      });
    }

    drawChart({
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const v = context.parsed.y;
                return `${context.dataset.label}: ${formatNumber(v)} total units`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#9ca3af',
              maxRotation: 0,
              autoSkip: true
            },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#9ca3af' },
            grid: { color: 'rgba(55,65,81,0.5)' }
          }
        }
      }
    });

    viewTitle.textContent = isWeekly
      ? 'Weekly inventory – chains & stores (avg total units)'
      : 'Daily inventory – chains & stores (total units)';
    const subParts = [];
    if (selectedChains.length) subParts.push(`Chains: ${selectedChains.join(', ')}`);
    if (selectedStores.length) subParts.push(`Stores: ${selectedStores.join(', ')}`);
    viewSubtitle.textContent = subParts.join(' | ');

    body.innerHTML = '';
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.textContent = 'Switch to Store mode to see detailed table for a single store.';
    tr.appendChild(td);
    body.appendChild(tr);
    footerRow.innerHTML = '';
  }

  function updateChartAndTable() {
    readThresholds();
    updateMultiStoreSummary();
    updateDowChart();
    updateClearStoresButtonVisibility();

    const multiRow = document.getElementById('multiStoreSelectorRow');
    if (chartMode === 'multi') {
      multiRow.style.display = 'block';
      updateMultiChartAndTable();
    } else {
      multiRow.style.display = 'none';
      updateSingleChartAndTable();
    }
  }

  function setViewMode(mode) {
    viewMode = mode;
    const dailyBtn = document.getElementById('dailyBtn');
    const weeklyBtn = document.getElementById('weeklyBtn');
    if (mode === 'daily') {
      dailyBtn.classList.add('active');
      weeklyBtn.classList.remove('active');
    } else {
      weeklyBtn.classList.add('active');
      dailyBtn.classList.remove('active');
    }
    updateChartAndTable();
  }

  function setChartMode(mode) {
    chartMode = mode;
    const singleBtn = document.getElementById('singleModeBtn');
    const multiBtn = document.getElementById('multiModeBtn');
    if (mode === 'single') {
      singleBtn.classList.add('active');
      multiBtn.classList.remove('active');
    } else {
      multiBtn.classList.add('active');
      singleBtn.classList.remove('active');
    }
    updateChartAndTable();
  }

  function updateClearStoresButtonVisibility() {
    const btn = document.getElementById('clearStoresBtn');
    if (!btn) return;
    const shouldShow = chartMode === 'multi' && viewMode === 'daily';
    btn.style.display = shouldShow ? 'inline-flex' : 'none';
  }

  function initCollapse() {
    const toggle = document.getElementById('collapseToggle');
    const icon = document.getElementById('collapseIcon');
    const body = document.getElementById('collapseBody');

    body.classList.remove('open');
    icon.textContent = '+';

    toggle.addEventListener('click', () => {
      const isOpen = body.classList.contains('open');
      if (isOpen) {
        body.classList.remove('open');
        icon.textContent = '+';
      } else {
        body.classList.add('open');
        icon.textContent = '−';
      }
    });
  }

  function initEvents() {
    document.getElementById('storeSelect').addEventListener('change', (e) => {
      currentStore = e.target.value;
      updateChartAndTable();
    });
    document.getElementById('dailyBtn').addEventListener('click', () => setViewMode('daily'));
    document.getElementById('weeklyBtn').addEventListener('click', () => setViewMode('weekly'));
    document.getElementById('singleModeBtn').addEventListener('click', () => setChartMode('single'));
    document.getElementById('multiModeBtn').addEventListener('click', () => setChartMode('multi'));

    document.getElementById('loadDataBtn').addEventListener('click', () => {
      const text = document.getElementById('dataInput').value;
      const rows = parseData(text);
      if (!rows.length) {
        alert('No valid rows found. Check that your data is tab-separated and matches one of the supported column formats.');
        return;
      }
      inventoryRows = rows;
      recomputeStores();
      currentStore = stores[0] || null;
      populateStoreSelect();
      populateChainCheckboxes();
      populateStoreCheckboxes();
      updateChartAndTable();
    });

    document.getElementById('clearDataBtn').addEventListener('click', () => {
      document.getElementById('dataInput').value = '';
    });

    document.getElementById('threshold5').addEventListener('input', () => {
      readThresholds();
      updateChartAndTable();
    });
    document.getElementById('threshold10').addEventListener('input', () => {
      readThresholds();
      updateChartAndTable();
    });

    const chainContainer = document.getElementById('chainCheckboxes');
    const storeContainer = document.getElementById('storeCheckboxes');

    chainContainer.addEventListener('change', () => {
      if (chartMode === 'multi') updateChartAndTable();
    });
    storeContainer.addEventListener('change', () => {
      if (chartMode === 'multi') updateChartAndTable();
    });

    document.getElementById('clearStoresBtn').addEventListener('click', () => {
      storeContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
      if (chartMode === 'multi') updateChartAndTable();
    });

    document.getElementById('selectAllChainsBtn').addEventListener('click', () => {
      chainContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = true; });
      if (chartMode === 'multi') updateChartAndTable();
    });

    document.getElementById('selectAllStoresBtn').addEventListener('click', () => {
      storeContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = true; });
      if (chartMode === 'multi') updateChartAndTable();
    });

    document.getElementById('clearAllMultiBtn').addEventListener('click', () => {
      chainContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
      storeContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
      if (chartMode === 'multi') updateChartAndTable();
    });
  }

  function init() {
    document.getElementById('dataInput').value = initialData;
    inventoryRows = parseData(initialData);
    recomputeStores();
    populateStoreSelect();
    populateChainCheckboxes();
    populateStoreCheckboxes();
    initCollapse();
    initEvents();
    readThresholds();
    setViewMode('daily');
    setChartMode('single');
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
