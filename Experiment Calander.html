<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Experiment Calendar</title>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --card: rgba(2,6,23,.70);
      --border: rgba(148,163,184,.16);
      --border2: rgba(148,163,184,.10);

      --text:#e5e7eb;
      --sub:#a7b0be;
      --muted:#7c8798;

      --accent:#22c55e;

      --seed:#60a5fa;
      --prop:#f59e0b;
      --trans:#ff3ea5;
      --harv:#a78bfa;

      --danger:#ef4444;

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);

      --radius: 16px;
      --radius2: 22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      /* Gantt sizing (JS will tune heights dynamically) */
      --gRowH: 44px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1100px 600px at 22% -20%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(900px 700px at 80% 90%, rgba(167,139,250,.10), transparent 60%),
        var(--bg);
    }

    .wrap{
      max-width: 1320px;
      margin: 22px auto 120px; /* extra breathing room at bottom */
      padding: 0 18px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 16px 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,23,42,.72), rgba(2,6,23,.62));
      box-shadow: var(--shadow2);
      position: sticky;
      top: 12px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }

    .titleBlock{ min-width: 270px; }
    .title{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .subtitle{
      color: var(--sub);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.25;
    }

    .chips{
      display:flex;
      align-items:center;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      flex: 1 1 auto;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.55);
      color: var(--text);
      font-size: 12px;
      font-weight: 800;
      user-select:none;
      cursor:pointer;
    }
    .chip .dot{
      width: 9px; height: 9px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .chip.on{
      border-color: rgba(34,197,94,.40);
      background: rgba(34,197,94,.10);
    }
    .chip.on .dot{ background: var(--accent); }

    .chip.seed.on{ border-color: rgba(96,165,250,.40); background: rgba(96,165,250,.10); }
    .chip.seed.on .dot{ background: var(--seed); }

    .chip.prop.on{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.10); }
    .chip.prop.on .dot{ background: var(--prop); }

    .chip.trans.on{ border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.10); }
    .chip.trans.on .dot{ background: var(--trans); }

    .chip.harv.on{ border-color: rgba(167,139,250,.40); background: rgba(167,139,250,.10); }
    .chip.harv.on .dot{ background: var(--harv); }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(2,6,23,.55);
      color: var(--text);
      font-weight: 900;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.03) inset;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(148,163,184,.28); }
    .btn.primary{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.10));
      box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset, 0 14px 35px rgba(0,0,0,.35);
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 800;
      color: var(--sub);
      border: 1px solid var(--border2);
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(2,6,23,.35);
    }

    .btn.mode{
      border-color: rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
    }
    .btn.mode.on{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }
    .btn.expandAccent{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.10));
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset, 0 10px 28px rgba(0,0,0,.30);
    }
    .modeDot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn.mode.on .modeDot{ background: var(--accent); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .panel{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,23,42,.62), rgba(2,6,23,.58));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .panel .hdr{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .panel .hdr .h{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .panel .hdr .s{
      margin-top: 3px;
      color: var(--sub);
      font-size: 11px;
      line-height: 1.25;
    }

    .panel .body{ padding: 14px 16px 16px; }

    .field{ margin-bottom: 12px; }
    .label{
      color: var(--sub);
      font-size: 11px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="date"], select, textarea{
      width: 100%;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--border2);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      font-weight: 700;
      font-size: 12px;
    }
    textarea{
      font-family: var(--mono);
      min-height: 180px;
      resize: vertical;
      line-height: 1.25;
    }
    input[type="text"]::placeholder{ color: rgba(167,176,190,.55); }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .togRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .miniToggle{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.45);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 11px;
    }
    .miniToggle.on{
      border-color: rgba(148,163,184,.26);
      background: rgba(15,23,42,.62);
    }
    .miniToggle .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--muted);
    }
    .miniToggle.seed.on .dot{ background: var(--seed); }
    .miniToggle.prop.on .dot{ background: var(--prop); }
    .miniToggle.trans.on .dot{ background: var(--trans); }
    .miniToggle.harv.on .dot{ background: var(--harv); }

    .tip{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(245,158,11,.28);
      background: rgba(245,158,11,.10);
      color: #fde68a;
      font-size: 11px;
      font-weight: 900;
      line-height: 1.25;
    }

    .summary{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      font-family: var(--mono);
      font-size: 11px;
      color: #fecaca;
    }

    .collapsible{
      margin-top: 12px;
      border-top: 1px solid var(--border2);
      padding-top: 12px;
    }
    .collapHdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
      padding: 8px 0;
      color: var(--sub);
      font-size: 12px;
      font-weight: 950;
    }
    .collapHdr .chev{
      width: 26px; height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      display:grid; place-items:center;
      background: rgba(2,6,23,.45);
      font-family: var(--mono);
      font-weight: 950;
      color: var(--sub);
    }
    .collapBody{ display:none; }
    .collapsible.open .collapBody{ display:block; }
    .collapsible.open .chev{ transform: rotate(180deg); }

    .mainHdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border2);
      background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(2,6,23,.0));
      flex-wrap: wrap;
    }

    .viewTabs{
      display:flex;
      gap: 6px;
      padding: 4px;
      border: 1px solid var(--border2);
      border-radius: 999px;
      background: rgba(2,6,23,.45);
      flex-wrap: wrap;
    }
    .tab{
      padding: 7px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-weight: 950;
      font-size: 12px;
      color: var(--sub);
      white-space:nowrap;
    }
    .tab.on{
      background: rgba(15,23,42,.72);
      color: var(--text);
      border: 1px solid rgba(148,163,184,.16);
    }

    .metaRow{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap: wrap;
      color: var(--sub);
      font-size: 12px;
      font-weight: 850;
    }
    .metaPill{
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      padding: 7px 10px;
      border-radius: 999px;
      color: var(--sub);
      font-weight: 900;
      font-size: 11px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .metaPill.clickable{ cursor:pointer; }
    .metaPill .dot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .metaPill.on .dot{ background: #39ff14; }

    .mainBody{ padding: 14px; }

    /* Month view */
    .monthTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .monthName{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 13px;
      color: var(--text);
    }
    .navBtns{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .navBtns .btn{ padding: 8px 11px; font-size: 12px; }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 6px 2px 10px;
      color: var(--sub);
      font-size: 11px;
      font-weight: 950;
      text-align:center;
      letter-spacing:.3px;
    }

    .monthGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    .cell{
      min-height: 92px;
      border-radius: 16px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.42);
      box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset;
      overflow:hidden;
      position: relative;
      cursor:pointer;
    }
    .cell:hover{ border-color: rgba(148,163,184,.25); }
    .cell.out{ opacity: .45; filter: saturate(.8); }
    .cell .d{
      padding: 10px 10px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      font-weight: 950;
      color: var(--sub);
      font-size: 12px;
    }
    .cell .dots{ display:flex; gap: 6px; align-items:center; }
    .miniDot{
      width: 7px; height: 7px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .miniDot.seed{ background: var(--seed); }
    .miniDot.prop{ background: var(--prop); }
    .miniDot.trans{ background: var(--trans); }
    .miniDot.harv{ background: var(--harv); }

    .lines{
      padding: 6px 8px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      padding: 7px 8px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: rgba(15,23,42,.35);
      color: var(--sub);
      font-size: 11px;
      font-weight: 900;
    }
    .line strong{ color: var(--text); font-weight: 950; }
    .line .l{
      display:flex;
      align-items:center;
      gap: 8px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .bar{
      width: 3px;
      height: 14px;
      border-radius: 999px;
      background: var(--muted);
      flex: 0 0 auto;
    }
    .bar.seed{ background: var(--seed); }
    .bar.prop{ background: var(--prop); }
    .bar.trans{ background: var(--trans); }
    .bar.harv{ background: var(--harv); }

    .more{
      border: 1px dashed rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
      color: var(--sub);
      font-family: var(--mono);
    }

    /* Agenda view */
    .agenda{ display:flex; flex-direction:column; gap: 10px; }

    .dayGroup{
      border-radius: 18px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.40);
      overflow:hidden;
    }

    .dayHdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--border2);
    }
    .dayHdr .left{ display:flex; flex-direction:column; gap: 2px; }
    .dayHdr .left .date{ font-weight: 950; font-size: 13px; color: var(--text); }
    .dayHdr .left .mini{ color: var(--sub); font-size: 11px; font-weight: 850; }
    .dayHdr .right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-weight: 950;
      font-size: 11px;
      white-space:nowrap;
    }

    .groups{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .groupRow{
      border-radius: 16px;
      border: 1px solid var(--border2);
      background: rgba(15,23,42,.25);
      overflow:hidden;
    }
    .groupHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
    }
    .groupHead .l{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .groupHead .title{
      font-size: 12px;
      font-weight: 950;
      margin:0;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .groupHead .count{
      width: 26px;
      height: 26px;
      display:grid;
      place-items:center;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-weight: 950;
      font-size: 12px;
      flex: 0 0 auto;
    }
    .groupHead .r{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--sub);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }

    .groupBody{ display:none; }
    .groupRow.open .groupBody{ display:block; }

    .items{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      border-top: 1px solid var(--border2);
    }
    .item{
      border-radius: 16px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width:0;
    }
    .item .meta .name{
      font-weight: 950;
      font-size: 12px;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pills{ display:flex; flex-wrap: wrap; gap: 6px; }
    .pill{
      border: 1px solid var(--border2);
      background: rgba(15,23,42,.35);
      color: var(--sub);
      font-weight: 900;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .pill.seed{ border-color: rgba(96,165,250,.25); }
    .pill.prop{ border-color: rgba(245,158,11,.25); }
    .pill.trans{ border-color: rgba(34,197,94,.25); }
    .pill.harv{ border-color: rgba(167,139,250,.25); }

    .openBtn{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 950;
      cursor:pointer;
      flex: 0 0 auto;
      white-space:nowrap;
    }
    .openBtn:hover{ border-color: rgba(148,163,184,.28); }

    /* Holidays */
    .cell.holiday{
      border-color: rgba(239,68,68,.32) !important;
      box-shadow: 0 0 0 2px rgba(239,68,68,.08) inset;
      background: linear-gradient(180deg, rgba(239,68,68,.06), rgba(2,6,23,.35));
    }

    /* ===== Gantt ===== */
    .ganttWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items:start;
    }
    .ganttRight,
    .ganttLeft{
      border: 1px solid var(--border2);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(2,6,23,.35);
    }

    .gHdr{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(15,23,42,.55), rgba(2,6,23,.0));
      flex-wrap: wrap;
    }
    .gHdr .h{
      font-weight: 950;
      font-size: 12px;
      color: var(--text);
    }
    .gHdr .s{
      font-weight: 900;
      font-size: 11px;
      color: var(--sub);
      font-family: var(--mono);
    }
    .gHdr .hint{
      color: var(--accent);
      font-size: 11px;
      font-weight: 800;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.35);
      padding: 6px 10px;
      border-radius: 12px;
    }

    .legend{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .legItem{
      display:inline-flex;
      align-items:center;
      gap: 7px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      color: var(--sub);
      font-weight: 900;
      font-size: 11px;
      white-space:nowrap;
    }
    .legSwatch{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
      background: var(--muted);
    }
    .legSwatch.today{ background: rgba(34,197,94,.95); }
    .legSwatch.holiday{ background: rgba(239,68,68,.95); }
    .legSwatch.harv{ background: rgba(167,139,250,.95); }

    /* scroll containers (JS sets max-height dynamically) */
    .timelineScroll,
    .ganttLeft .scroll{
      overflow:auto;
      /* max-height set in JS for “up to 10 rows without scrolling” */
    }
    .ganttLeft.collapsed .scroll{ display:none; }

    /* Sticky axis while scrolling rows */
    .timelineTopAxis{
      position: sticky;
      top: 0;
      z-index: 12;
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.65));
      backdrop-filter: blur(8px);
    }

    .setRowLeft{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148,163,184,.08);
      display:flex;
      flex-direction:column;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      scroll-margin-top: 10px;
    }
    .setRowLeft:hover{ background: rgba(255,255,255,.02); }
    .setRowLeft.selected{
      outline: 2px solid rgba(34,197,94,.18);
      background: rgba(34,197,94,.06);
    }
    .setRowLeft.hovered{
      outline: 2px solid rgba(148,163,184,.16);
      background: rgba(148,163,184,.06);
    }
    .setRowLeft.selected.hovered{
      outline: 2px solid rgba(34,197,94,.22);
      background: rgba(34,197,94,.08);
    }

    .setHeadLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .setTitle{
      font-weight: 950;
      font-size: 12px;
      color: var(--text);
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 980px;
    }
    .chevMini{
      width: 26px; height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      display:grid; place-items:center;
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-weight: 950;
      font-family: var(--mono);
      flex: 0 0 auto;
      transition: transform .15s ease;
    }
    .setRowLeft.open .chevMini{ transform: rotate(180deg); }

    .setMeta{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items:center;
    }
    .miniPill{
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.35);
      color: var(--sub);
      font-weight: 900;
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .miniPill.seed{ border-color: rgba(96,165,250,.25); }
    .miniPill.prop{ border-color: rgba(245,158,11,.25); }
    .miniPill.trans{ border-color: rgba(34,197,94,.25); }
    .miniPill.harv{ border-color: rgba(167,139,250,.35); background: rgba(167,139,250,.10); color: rgba(229,231,235,.9); }

    .setDetails{
      display:none;
      margin-top: 4px;
      border-top: 1px solid rgba(148,163,184,.10);
      padding-top: 10px;
      gap: 8px;
      flex-direction:column;
    }
    .setRowLeft.open .setDetails{ display:flex; }

    .detailRow{
      border: 1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.30);
      border-radius: 14px;
      padding: 8px 9px;
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items:center;
    }
    .detailKey{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(167,176,190,.75);
      font-weight: 900;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.10);
      background: rgba(15,23,42,.22);
    }

    .timeline{
      position: relative;
      padding: 10px 10px 14px;
      min-height: 120px;
    }
    .timelineTopAxis{
      display:flex;
      gap: 0;
      border-bottom: 1px solid rgba(148,163,184,.10);
      padding-bottom: 8px;
      margin-bottom: 6px;
      overflow:hidden;
    }
    .tick{
      flex: 1 1 0;
      min-width: 24px;
      text-align:center;
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(167,176,190,.70);
      padding: 0 2px;
      position: relative;
      cursor: help;
    }
    .tick .dow{ display:block; font-size:9px; color: rgba(167,176,190,.78); font-weight:900; letter-spacing:.2px; }
    .tick .d{ display:block; margin-top:1px; }
    .tick .m{ display:block; font-size: 9px; color: rgba(167,176,190,.55); }

    .holidayBand{
      position:absolute;
      top: 0; bottom: 0;
      background: rgba(239,68,68,.05);
      pointer-events:none;
    }

    .todayLine{
      position:absolute;
      top: 0; bottom: 0;
      width: 4px;
      background: rgba(34,197,94,.95);
      box-shadow:
        0 0 0 2px rgba(34,197,94,.18),
        0 0 18px rgba(34,197,94,.22);
      pointer-events:none;
      border-radius: 999px;
      z-index: 6;
    }
    .holidayLine{
      position:absolute;
      top: 0; bottom: 0;
      width: 5px;
      background: rgba(239,68,68,.95);
      box-shadow:
        0 0 0 2px rgba(239,68,68,.18),
        0 0 18px rgba(239,68,68,.18);
      pointer-events:none;
      border-radius: 999px;
      z-index: 5;
      opacity: .98;
    }

    .setBarRow{
      position: relative;
      height: var(--gRowH);
      border-bottom: 1px solid rgba(148,163,184,.06);
      overflow:hidden;
    }
    .setBarRow.hovered{ background: rgba(148,163,184,.06); }
    .setBarRow.selected{ background: rgba(34,197,94,.06); }
    .setBarRow.selected.hovered{ background: rgba(34,197,94,.08); }

    .seg{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.35);
      box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset;
      overflow:hidden;
      min-width: 4px;
      z-index: 2;
      cursor: help;
    }
    .seg.seed{ border-color: rgba(96,165,250,.28); background: rgba(96,165,250,.12); }
    .seg.prop{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.12); }
    .seg.trans{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10); }
    .seg.harv{ border-color: rgba(167,139,250,.30); background: rgba(167,139,250,.12); }

    .segLabel{
      position:absolute;
      top: 50%;
      transform: translate(-50%,-50%);
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 900;
      color: rgba(229,231,235,.78);
      pointer-events:auto;
      white-space:nowrap;
      z-index: 3;
      cursor: help;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }

    /* More explicit harvest marker (recommendation) */
    .harvMarker{
      position:absolute;
      top: 50%;
      transform: translate(-50%,-50%) rotate(45deg);
      width: 12px;
      height: 12px;
      border-radius: 3px;
      background: rgba(167,139,250,.95);
      box-shadow:
        0 0 0 2px rgba(167,139,250,.18),
        0 0 22px rgba(167,139,250,.20);
      z-index: 4;
      pointer-events:auto;
      cursor: help;
    }

    /* ✅ tooltip */
    .gTip{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      display: none;
      max-width: 420px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.92);
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 12px;
      line-height: 1.25;
    }
    .gTip .k{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(167,176,190,.85);
      font-weight: 900;
    }
    .gTip .row{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .gTip .tag{
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 900;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(15,23,42,.45);
      color: rgba(229,231,235,.82);
      white-space:nowrap;
    }
    .gTip .tag.harv{
      border-color: rgba(167,139,250,.28);
      background: rgba(167,139,250,.12);
      color: rgba(229,231,235,.92);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 80;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      max-height: min(86vh, 860px);
      border-radius: 22px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,.82), rgba(2,6,23,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
    }
    .modalHdr{
      padding: 14px 14px;
      border-bottom: 1px solid var(--border2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .modalHdr .t{ display:flex; flex-direction:column; gap: 4px; }
    .modalHdr .t .h{ font-weight: 950; font-size: 14px; color: var(--text); }
    .modalHdr .t .s{
      color: var(--sub);
      font-size: 11px;
      font-weight: 850;
      line-height: 1.25;
    }
    .modalHdr .x{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.45);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
    }
    .modalBody{ padding: 12px 14px 14px; overflow:auto; }

    @media (max-width: 1080px){
      .titleBlock{ min-width: 0; }
      .topbar{ flex-wrap: wrap; }
      .actions{ width:100%; justify-content:space-between; }
      .chips{ justify-content:flex-start; }
      .row2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <div class="title">Experiment Calendar</div>
        <div class="subtitle">
          Paste TSV → filter → <b>Agenda / Month / Gantt</b>.<br/>
          Defaults to <b>Active only</b> (sets hidden after harvest).
        </div>
      </div>

      <div class="chips" id="milestoneChips">
        <div class="chip seed on" data-k="seed"><span class="dot"></span>Seed</div>
        <div class="chip prop on" data-k="prop"><span class="dot"></span>Propagation Start</div>
        <div class="chip trans on" data-k="trans"><span class="dot"></span>Transplant</div>
        <div class="chip harv on" data-k="harv"><span class="dot"></span>Harvest</div>
      </div>

      <div class="actions">
        <button class="btn mode on" id="historyToggle" title="Toggle showing harvested sets">
          <span class="modeDot"></span><span id="historyToggleLabel">Active only</span>
        </button>
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn primary" id="buildBtn">Build / Refresh Calendar</button>
        <span class="kbd">Ctrl/⌘ + Enter</span>
      </div>
    </div>

    <div class="grid">
      <!-- Filters panel -->
      <div class="panel">
        <div class="hdr">
          <div>
            <div class="h">Filters</div>
            <div class="s">Active-only sets, agenda next 60 days, Gantt shows full lifecycle</div>
          </div>
        </div>

        <div class="body">
          <div class="collapsible" id="filtersBox">
            <div class="collapHdr" id="filtersHdr">
              <span>Filters</span>
              <span class="chev">⌄</span>
            </div>
            <div class="collapBody">
              <div class="field">
                <div class="label">Search (batch / variety / experiment)</div>
                <input id="q" type="text" placeholder="e.g. SM8, Gladius, Rockwool..." />
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">Experiment</div>
                  <select id="fExperiment"></select>
                </div>
                <div class="field">
                  <div class="label">Media</div>
                  <select id="fMedia"></select>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">Grow Pond (post-transplant)</div>
                  <select id="fPond"></select>
                </div>
                <div class="field">
                  <div class="label">Range (Agenda/Month only)</div>
                  <select id="fRange">
                    <option value="60">Next 60 days</option>
                    <option value="90">Next 90 days</option>
                    <option value="120">Next 120 days</option>
                    <option value="365">Next 365 days</option>
                    <option value="9999">All</option>
                  </select>
                </div>
              </div>

              <div class="field">
                <div class="label">Start date (Agenda/Month only)</div>
                <input id="startDate" type="date" />
              </div>

              <div class="tip">
                <b>Prop Pond</b> is separate from <b>Grow Pond</b> (post-transplant).<br/>
                Active-only rule: if a set’s <b>Harvest Date</b> is before today, it’s hidden (unless history is on).
              </div>
            </div>
          </div>

          <div class="collapsible" id="dataBox">
            <div class="collapHdr" id="dataHdr">
              <span>Data Input</span>
              <span class="chev">⌄</span>
            </div>
            <div class="collapBody">
              <div class="summary" id="buildSummary">Rows parsed: 0<br/>Rows skipped: 0<br/>Events created: 0</div>
              <div class="s" style="margin-bottom:8px;">Paste TSV data</div>
              <textarea id="tsv"></textarea>
              <div class="s" style="margin-top:8px;">Saved automatically in your browser (localStorage).</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Views panel -->
      <div class="panel">
        <div class="mainHdr">
          <div class="viewTabs">
            <div class="tab on" id="tabAgenda">Agenda</div>
            <div class="tab" id="tabMonth">Month</div>
            <div class="tab" id="tabGantt">Gantt</div>
          </div>
          <div class="metaRow">
            <div class="togRow" style="margin:0 8px 0 0;">
              <div class="miniToggle seed on" data-k="seed"><span class="dot"></span>Seed</div>
              <div class="miniToggle prop on" data-k="prop"><span class="dot"></span>Prop Start</div>
              <div class="miniToggle trans on" data-k="trans"><span class="dot"></span>Transplant</div>
              <div class="miniToggle harv on" data-k="harv"><span class="dot"></span>Harvest</div>
            </div>
            <span class="metaPill clickable" id="metaActiveMode"><span class="dot"></span><span id="metaActiveModeText">Active only</span></span>
            <span class="metaPill" id="metaRange">Start: — End: —</span>
            <span class="metaPill" id="metaGrouping">Grouping: milestone + pond</span>
          </div>
        </div>

        <div class="mainBody">
          <div id="agendaView" class="agenda"></div>

          <div id="monthView" style="display:none;">
            <div class="monthTop">
              <div class="monthName" id="monthName">—</div>
              <div class="navBtns">
                <button class="btn" id="prevMonth">‹ Prev</button>
                <button class="btn" id="thisMonth">This month</button>
                <button class="btn" id="nextMonth">Next ›</button>
              </div>
            </div>
            <div class="dow">
              <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="monthGrid" id="monthGrid"></div>
          </div>

          <div id="ganttView" style="display:none;">
            <div class="ganttWrap">
              <!-- Timeline first -->
              <div class="ganttRight">
                <div class="gHdr">
                  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div class="h">Timeline</div>
                    <div class="s" id="ganttSpan">—</div>
                  </div>
                  <div class="legend" aria-label="Timeline legend">
                    <span class="legItem"><span class="legSwatch today"></span>Today</span>
                    <span class="legItem"><span class="legSwatch holiday"></span>Holiday</span>
                    <span class="legItem"><span class="legSwatch harv"></span>Harvest</span>
                  </div>
                </div>

                <div class="timelineScroll" id="ganttRightScroll">
                  <div class="timeline" id="ganttTimeline">
                    <div class="timelineTopAxis" id="ganttAxis"></div>
                    <div id="ganttRows"></div>
                  </div>
                </div>
              </div>

              <!-- Sets under timeline -->
              <div class="ganttLeft">
                <div class="gHdr">
                  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div class="h">Sets (merged)</div>
                    <div class="s" id="ganttCount">0</div>
                    <button class="btn expandAccent" id="collapseSetsBtn" style="padding:6px 10px; font-size:11px; font-weight:900;">Collapse all</button>
                  </div>
                  <div class="hint" id="setsHint">Expand to view merged batches with seed/prop/trans/harvest dates and ponds.</div>
                </div>
                <div class="scroll" id="ganttLeftBody"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Gantt tooltip -->
  <div class="gTip" id="ganttTip" role="tooltip" aria-hidden="true"></div>

  <div class="modalBack" id="dayModalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHdr">
        <div class="t">
          <div class="h" id="dayModalTitle">—</div>
          <div class="s" id="dayModalSub">—</div>
        </div>
        <button class="x" id="dayModalClose" title="Close">✕</button>
      </div>
      <div class="modalBody" id="dayModalBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // Company Holidays (Hard-coded) — Keys MUST be YYYY-MM-DD
    // =========================
    const COMPANY_HOLIDAYS = new Map([
      ["2026-01-01", "New Year's Day"],
      ["2026-01-06", "Epiphany"],
      ["2026-02-16", "President's Day"],
      ["2026-04-03", "Good Friday"],
      ["2026-05-25", "Memorial Day"],
      ["2026-07-04", "Independence Day"],
      ["2026-07-25", "PR Constitution Day"],
      ["2026-09-07", "Labor Day"],
      ["2026-10-12", "Columbus Day"],
      ["2026-11-26", "Thanksgiving"],
      ["2026-11-27", "Black Friday"],
      ["2026-12-25", "Christmas Day"],
    ]);
    function getHolidayName(dateISO){ return COMPANY_HOLIDAYS.get(dateISO) || ""; }

    // =========================
    // Utilities
    // =========================
    const $ = (id)=>document.getElementById(id);
    const MS = 24*60*60*1000;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function safeNum(v){
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function parseISODateLocal(s){
      const m = String(s).trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return null;
      const yy = Number(m[1]), mm = Number(m[2]), dd = Number(m[3]);
      const d = new Date(yy, mm-1, dd);
      if(!isNaN(d.getTime()) && d.getFullYear()===yy && d.getMonth()===(mm-1) && d.getDate()===dd){
        return startOfDay(d);
      }
      return null;
    }

    function parseDateLoose(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      if(s.includes("January 0, 1900")) return null;
      if(s.includes("Saturday, January 0, 1900")) return null;

      const iso = parseISODateLocal(s);
      if(iso) return iso;

      const d1 = new Date(s);
      if(!isNaN(d1.getTime())){
        if(d1.getFullYear() <= 1901) return null;
        return startOfDay(d1);
      }

      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const mm = Number(m[1]), dd = Number(m[2]), yy = Number(m[3]);
        const d2 = new Date(yy, mm-1, dd);
        if(!isNaN(d2.getTime()) && d2.getFullYear()===yy && d2.getMonth()===(mm-1) && d2.getDate()===dd){
          if(d2.getFullYear() <= 1901) return null;
          return startOfDay(d2);
        }
      }
      return null;
    }

    function getTodayLocal(){ return startOfDay(new Date()); }

    function isRowActive(row, today){
      const h = row.harvestDate;
      if(!h) return true;
      return h.getTime() >= today.getTime();
    }

    function fmtDowISO(d){
      if(!d) return "—";
      const wd = d.toLocaleDateString(undefined, { weekday:"short" });
      return `${wd} ${toISODate(d)}`;
    }

    // =========================
    // State
    // =========================
    const state = {
      rawTSV: "",
      rows: [],
      events: [],
      filtered: [],
      view: "gantt",
      monthCursor: startOfDay(new Date()),
      q: "",
      experiment: "All",
      media: "All",
      pond: "All",
      rangeDays: 60,
      startDate: startOfDay(new Date()),
      milestoneOn: { seed:true, prop:true, trans:true, harv:true },
      includeHarvested: false,
      selectedSetKey: null,
      openSetKeys: new Set(),
      _syncingScroll: false,
      _ganttDom: null, // cache for “no jump” expanding
      setsCollapsed: false,
    };

    // =========================
    // TSV Parsing (header-based)
    // =========================
    const FIELD_ALIASES = {
      experiment: ["Experiment Name/Purpose","Experiment","Experiment Name"],
      batch: ["Batch"],
      variety: ["Variety"],
      media: ["Media"],

      seedDate: ["seed/germ","Seed","Germination Date","Seed Date","Seed/Germ"],
      propDate: ["propagation start date","Propagation Start","Prop Start","Propagation Start Date"],
      transDate: ["transplant date","Transplant Date"],
      harvestDate: ["Harvest Date","Harvested Date","Harvest"],

      propPond: ["Prop Pond","Propagation Pond","Propagation Pond #","Propag Pond"],
      growPond: ["Pond","Grow Pond","Transplant Pond","Grow Pond #"],

      pos: ["Pos","Position","Position ID"],

      flats: ["Flats"],
      actualFlats: ["Actual Flats"],
      plugs: ["Plugs"],
      seededPlugs: ["Seeded Plugs"],
      transplantedPlugs: ["Trans-planted plugs","Transplanted plugs","Trans-planted Plugs"],
      expectedBoards: ["Expected Boards Transplanted"],
      forecastBoards: ["Forecasted Boards Transplanted"],
      actualBoards: ["Actual Boards Transplanted"],
      emergence: ["Actual Emergence %","Emergence %"],
      lossActual: ["Actual Loss"],
    };

    function buildHeaderIndex(headerCells){
      const idx = new Map();
      headerCells.forEach((h,i)=> idx.set(h.trim(), i));
      function pick(aliasList){
        for(const a of aliasList){
          if(idx.has(a)) return idx.get(a);
        }
        return -1;
      }
      return {
        experiment: pick(FIELD_ALIASES.experiment),
        batch: pick(FIELD_ALIASES.batch),
        variety: pick(FIELD_ALIASES.variety),
        media: pick(FIELD_ALIASES.media),

        seedDate: pick(FIELD_ALIASES.seedDate),
        propDate: pick(FIELD_ALIASES.propDate),
        transDate: pick(FIELD_ALIASES.transDate),
        harvestDate: pick(FIELD_ALIASES.harvestDate),

        propPond: pick(FIELD_ALIASES.propPond),
        growPond: pick(FIELD_ALIASES.growPond),

        pos: pick(FIELD_ALIASES.pos),

        flats: pick(FIELD_ALIASES.flats),
        actualFlats: pick(FIELD_ALIASES.actualFlats),
        plugs: pick(FIELD_ALIASES.plugs),
        seededPlugs: pick(FIELD_ALIASES.seededPlugs),
        transplantedPlugs: pick(FIELD_ALIASES.transplantedPlugs),
        expectedBoards: pick(FIELD_ALIASES.expectedBoards),
        forecastBoards: pick(FIELD_ALIASES.forecastBoards),
        actualBoards: pick(FIELD_ALIASES.actualBoards),
        emergence: pick(FIELD_ALIASES.emergence),
        lossActual: pick(FIELD_ALIASES.lossActual),
      };
    }

    function parseTSV(tsv){
      const text = String(tsv ?? "").replace(/\r/g,"").trim();
      if(!text) return { rows:[], skipped:0, parsed:0 };

      const lines = text.split("\n").filter(l=>l.trim().length>0);
      if(lines.length < 2) return { rows:[], skipped:0, parsed:0 };

      const header = lines[0].split("\t");
      const H = buildHeaderIndex(header);

      const rows = [];
      let skipped = 0;

      for(let i=1;i<lines.length;i++){
        const cells = lines[i].split("\t");
        const get = (j)=> (j>=0 && j<cells.length) ? String(cells[j] ?? "").trim() : "";

        const experiment = get(H.experiment) || "";
        const batch = get(H.batch) || "";
        const variety = get(H.variety) || "";
        const media = get(H.media) || "";

        const propPond = get(H.propPond) || "";
        const growPond = get(H.growPond) || "";
        const pos = get(H.pos) || "";

        const seedD = parseDateLoose(get(H.seedDate));
        const propD = parseDateLoose(get(H.propDate));
        const transD = parseDateLoose(get(H.transDate));
        const harvD = parseDateLoose(get(H.harvestDate));

        const hasAny = experiment || batch || variety || media || propPond || growPond || pos || seedD || propD || transD || harvD;
        if(!hasAny){ skipped++; continue; }

        rows.push({
          i,
          experiment, batch, variety, media,
          propPond: (propPond||"").trim(),
          growPond: (growPond||"").trim(),
          pos: (pos||"").trim(),

          seedDate: seedD,
          propDate: propD,
          transDate: transD,
          harvestDate: harvD,

          flats: safeNum(get(H.flats)),
          actualFlats: safeNum(get(H.actualFlats)),
          plugs: safeNum(get(H.plugs)),
          seededPlugs: safeNum(get(H.seededPlugs)),
          transplantedPlugs: safeNum(get(H.transplantedPlugs)),
          expectedBoards: safeNum(get(H.expectedBoards)),
          forecastBoards: safeNum(get(H.forecastBoards)),
          actualBoards: safeNum(get(H.actualBoards)),
          emergence: get(H.emergence) || "",
          lossActual: get(H.lossActual) || "",
        });
      }

      return { rows, skipped, parsed: rows.length };
    }

    function kindLabel(kind){
      if(kind==="seed") return "Seed";
      if(kind==="prop") return "Propagation Start";
      if(kind==="trans") return "Transplant";
      return "Harvest";
    }
    function kindColorClass(kind){
      if(kind==="seed") return "seed";
      if(kind==="prop") return "prop";
      if(kind==="trans") return "trans";
      return "harv";
    }

    function makeEvent(kind, dateObj, row){
      const dateISO = toISODate(dateObj);
      const pondForStage =
        (kind === "prop") ? row.propPond :
        (kind === "trans" || kind === "harv") ? row.growPond :
        (row.propPond || "");

      const title = `${kindLabel(kind)}${pondForStage ? ` — Pond ${pondForStage}` : ""}`;

      return {
        kind,
        date: dateObj,
        dateISO,
        title,
        experiment: row.experiment || "",
        batch: row.batch || "",
        variety: row.variety || "",
        media: row.media || "",
        propPond: row.propPond || "",
        growPond: row.growPond || "",
        pos: row.pos || "",
        harvestDate: row.harvestDate || null,
      };
    }

    function expandEvents(rows){
      const events = [];
      for(const r of rows){
        if(r.seedDate)      events.push(makeEvent("seed",  r.seedDate,  r));
        if(r.propDate)      events.push(makeEvent("prop",  r.propDate,  r));
        if(r.transDate)     events.push(makeEvent("trans", r.transDate, r));
        if(r.harvestDate)   events.push(makeEvent("harv",  r.harvestDate, r));
      }
      events.sort((a,b)=> a.date - b.date || a.kind.localeCompare(b.kind) || (a.batch||"").localeCompare(b.batch||""));
      return events;
    }

    // =========================
    // Filters (events)
    // =========================
    function applyFilters(){
      const q = state.q.trim().toLowerCase();
      const start = startOfDay(state.startDate);
      const end = (state.rangeDays>=9999) ? null : new Date(start.getTime() + (state.rangeDays*MS));
      const today = getTodayLocal();

      const on = state.milestoneOn;
      const out = [];

      for(const e of state.events){
        if(!state.includeHarvested){
          if(e.harvestDate && e.harvestDate.getTime() < today.getTime()) continue;
        }

        if(!on[e.kind]) continue;
        if(e.date < start) continue;
        if(end && e.date >= end) continue;

        if(state.experiment!=="All" && e.experiment!==state.experiment) continue;
        if(state.media!=="All" && e.media!==state.media) continue;
        if(state.pond!=="All"){
          if(String(e.growPond||"") !== String(state.pond)) continue;
        }

        if(q){
          const hay = `${e.experiment} ${e.batch} ${e.variety} ${e.media} ${e.propPond} ${e.growPond} ${e.pos}`.toLowerCase();
          if(!hay.includes(q)) continue;
        }

        out.push(e);
      }

      state.filtered = out;
      state.rangeStart = start;
      state.rangeEnd = end;

      const endLabel = (state.rangeDays>=9999) ? "∞" : toISODate(new Date(end.getTime()-MS));
      $("metaRange").textContent = `Start: ${toISODate(start)}  End: ${endLabel}`;
      $("eventCountBadge").textContent = `${out.length} events`;

      $("metaActiveMode").classList.toggle("on", !state.includeHarvested);
      $("metaActiveModeText").textContent = state.includeHarvested ? "History included" : "Active only";

      return { start, end };
    }

    // =========================
    // Agenda + Month grouping
    // =========================
    function groupAgenda(events, rangeStart, rangeEnd){
      const dayMap = new Map();
      for(const e of events){
        if(!dayMap.has(e.dateISO)) dayMap.set(e.dateISO, []);
        dayMap.get(e.dateISO).push(e);
      }

      for(const [dateISO] of COMPANY_HOLIDAYS.entries()){
        const d = parseDateLoose(dateISO);
        if(!d) continue;
        if(d < rangeStart) continue;
        if(rangeEnd && d >= rangeEnd) continue;
        if(!dayMap.has(dateISO)) dayMap.set(dateISO, []);
      }

      const days = Array.from(dayMap.entries())
        .map(([dateISO, items])=>{
          items.sort((a,b)=> a.kind.localeCompare(b.kind) || String(a.growPond||"").localeCompare(String(b.growPond||"")));
          return { dateISO, date: parseDateLoose(dateISO) || startOfDay(new Date()), items };
        })
        .sort((a,b)=> (a.date - b.date));

      for(const day of days){
        const gm = new Map();
        for(const e of day.items){
          const pondKey =
            (e.kind==="prop") ? (e.propPond||"") :
            (e.kind==="trans"||e.kind==="harv") ? (e.growPond||"") :
            (e.propPond||"");
          const key = `${e.kind}||${pondKey}`;
          if(!gm.has(key)) gm.set(key, []);
          gm.get(key).push(e);
        }

        const groups = Array.from(gm.entries()).map(([key, items])=>{
          const [kind, pond] = key.split("||");
          items.sort((a,b)=> (a.batch||"").localeCompare(b.batch||"") || (a.variety||"").localeCompare(b.variety||""));
          return { kind, pond, items };
        });

        const order = { seed:0, prop:1, trans:2, harv:3 };
        groups.sort((a,b)=> (order[a.kind]-order[b.kind]) || String(a.pond||"").localeCompare(String(b.pond||"")));
        day.groups = groups;
      }

      return days;
    }

    function monthSummary(events){
      const m = new Map();
      for(const e of events){
        if(!m.has(e.dateISO)){
          m.set(e.dateISO, { kinds:new Set(), groups:new Map() });
        }
        const obj = m.get(e.dateISO);
        obj.kinds.add(e.kind);

        const pondKey =
          (e.kind==="prop") ? (e.propPond||"") :
          (e.kind==="trans"||e.kind==="harv") ? (e.growPond||"") :
          (e.propPond||"");

        const gk = `${e.kind}||${pondKey}`;
        obj.groups.set(gk, (obj.groups.get(gk) || 0) + 1);
      }
      return m;
    }

    // =========================
    // Sets for Gantt (merged definition)
    // =========================
    function setKeyFromRow(r){
      const s = r.seedDate ? toISODate(r.seedDate) : "";
      const p = r.propDate ? toISODate(r.propDate) : "";
      const t = r.transDate ? toISODate(r.transDate) : "";
      const h = r.harvestDate ? toISODate(r.harvestDate) : "";
      return `${s}||${p}||${t}||${h}`;
    }

    function buildSetsFromRows(rows){
      const today = getTodayLocal();
      const map = new Map();

      for(const r of rows){
        if(!state.includeHarvested && !isRowActive(r, today)) continue;

        if(state.experiment!=="All" && r.experiment!==state.experiment) continue;
        if(state.media!=="All" && r.media!==state.media) continue;
        if(state.pond!=="All"){
          if(String(r.growPond||"") !== String(state.pond)) continue;
        }
        if(state.q.trim()){
          const hay = `${r.experiment} ${r.batch} ${r.variety} ${r.media} ${r.propPond} ${r.growPond} ${r.pos}`.toLowerCase();
          if(!hay.includes(state.q.trim().toLowerCase())) continue;
        }

        const key = setKeyFromRow(r);
        if(!map.has(key)){
          map.set(key, {
            key,
            seed: r.seedDate,
            prop: r.propDate,
            trans: r.transDate,
            harv: r.harvestDate,
            rows: [],
            propPonds: new Set(),
            growPonds: new Set(),
          });
        }
        const S = map.get(key);
        S.rows.push(r);
        if(r.propPond) S.propPonds.add(r.propPond);
        if(r.growPond) S.growPonds.add(r.growPond);
      }

      const sets = Array.from(map.values());
      sets.sort((a,b)=>{
        const ah = a.harv ? a.harv.getTime() : Infinity;
        const bh = b.harv ? b.harv.getTime() : Infinity;
        if(ah!==bh) return ah-bh;
        const at = a.trans ? a.trans.getTime() : Infinity;
        const bt = b.trans ? b.trans.getTime() : Infinity;
        if(at!==bt) return at-bt;
        const as = a.seed ? a.seed.getTime() : Infinity;
        const bs = b.seed ? b.seed.getTime() : Infinity;
        return as-bs;
      });

      return sets;
    }

    // =========================
    // Tooltip helpers (Gantt)
    // =========================
    const tip = ()=> $("ganttTip");

    function showTipAt(ev, html){
      const el = tip();
      el.innerHTML = html;
      el.style.display = "block";
      el.setAttribute("aria-hidden","false");

      const pad = 14;
      const r = el.getBoundingClientRect();
      let x = ev.clientX + 14;
      let y = ev.clientY + 14;

      if(x + r.width + pad > window.innerWidth) x = ev.clientX - r.width - 14;
      if(y + r.height + pad > window.innerHeight) y = ev.clientY - r.height - 14;

      el.style.left = `${Math.max(pad, x)}px`;
      el.style.top  = `${Math.max(pad, y)}px`;
    }

    function hideTip(){
      const el = tip();
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
    }

    function attachTip(el, htmlFn){
      el.addEventListener("mouseenter", (ev)=> showTipAt(ev, htmlFn()));
      el.addEventListener("mousemove", (ev)=> showTipAt(ev, htmlFn()));
      el.addEventListener("mouseleave", hideTip);
    }

    // =========================
    // Rendering
    // =========================
    function render(){
      const { start, end } = applyFilters();

      $("agendaView").style.display = (state.view==="agenda") ? "flex" : "none";
      $("monthView").style.display  = (state.view==="month") ? "block" : "none";
      $("ganttView").style.display  = (state.view==="gantt") ? "block" : "none";

      if(state.view==="agenda") renderAgenda(start, end);
      if(state.view==="month") renderMonth();
      if(state.view==="gantt") renderGantt();
    }

    function renderAgenda(rangeStart, rangeEnd){
      const host = $("agendaView");
      host.innerHTML = "";

      const days = groupAgenda(state.filtered, rangeStart, rangeEnd);

      if(!days.length){
        host.innerHTML = `<div class="summary" style="border-color: rgba(148,163,184,.22); background: rgba(2,6,23,.35); color: var(--sub);">
          No events in the selected filters/range.
        </div>`;
        return;
      }

      for(const day of days){
        const holidayName = getHolidayName(day.dateISO);
        const isHoliday = !!holidayName;
        const nice = day.date.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric" });

        const dayEl = document.createElement("div");
        dayEl.className = "dayGroup open" + (isHoliday ? " holidayDay" : "");

        dayEl.innerHTML = `
          <div class="dayHdr">
            <div class="left">
              <div class="date">${escapeHtml(nice)}</div>
              <div class="mini">${day.groups.length} group${day.groups.length===1?"":"s"} • ${day.items.length} item${day.items.length===1?"":"s"}</div>
            </div>
            <div class="right">
              ${isHoliday ? `<span class="badge" style="border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08); color:#fecaca;">Not onsite • ${escapeHtml(holidayName)}</span>` : ""}
              <span class="badge">${day.items.length} total</span>
            </div>
          </div>
          <div class="groups"></div>
        `;

        const groupsHost = dayEl.querySelector(".groups");
        const order = { seed:0, prop:1, trans:2, harv:3 };

        day.groups.sort((a,b)=> (order[a.kind]-order[b.kind]) || String(a.pond||"").localeCompare(String(b.pond||"")));

        day.groups.forEach((g)=>{
          const gr = document.createElement("div");
          gr.className = "groupRow";

          const label = kindLabel(g.kind);
          const pondPart = g.pond ? ` — Pond ${g.pond}` : "";

          gr.innerHTML = `
            <div class="groupHead">
              <div class="l">
                <span class="bar ${kindColorClass(g.kind)}"></span>
                <div class="title">${escapeHtml(label + pondPart)}</div>
                <div class="count">${g.items.length}</div>
              </div>
              <div class="r">Click to expand</div>
            </div>
            <div class="groupBody">
              <div class="items"></div>
            </div>
          `;

          const itemsHost = gr.querySelector(".items");
          for(const e of g.items){
            const batchTitle = e.batch ? `Batch ${e.batch}` : (e.variety || e.experiment || "Item");
            const pondLabel =
              (e.kind==="prop") ? (e.propPond ? `Prop Pond ${e.propPond}` : "") :
              (e.kind==="trans"||e.kind==="harv") ? (e.growPond ? `Grow Pond ${e.growPond}` : "") :
              (e.propPond ? `Prop Pond ${e.propPond}` : "");

            const pills = [
              e.variety ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.variety)}</span>` : "",
              e.media ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.media)}</span>` : "",
              pondLabel ? `<span class="pill">${escapeHtml(pondLabel)}</span>` : "",
              e.experiment ? `<span class="pill">${escapeHtml(e.experiment)}</span>` : "",
            ].filter(Boolean).join("");

            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="meta">
                <div class="name">${escapeHtml(batchTitle)}</div>
                <div class="pills">${pills}</div>
              </div>
              <button class="openBtn">Open</button>
            `;
            item.querySelector(".openBtn").addEventListener("click", (ev)=>{
              ev.stopPropagation();
              openDayModal(e.dateISO);
            });
            itemsHost.appendChild(item);
          }

          gr.querySelector(".groupHead").addEventListener("click", ()=>{
            gr.classList.toggle("open");
          });

          groupsHost.appendChild(gr);
        });

        dayEl.querySelector(".dayHdr").addEventListener("click", ()=>{
          openDayModal(day.dateISO);
        });

        host.appendChild(dayEl);
      }
    }

    function renderMonth(){
      const grid = $("monthGrid");
      grid.innerHTML = "";

      const cur = new Date(state.monthCursor.getFullYear(), state.monthCursor.getMonth(), 1);
      const year = cur.getFullYear();
      const month = cur.getMonth();

      $("monthName").textContent = cur.toLocaleDateString(undefined, { month:"long", year:"numeric" });

      const firstDow = cur.getDay();
      const gridStart = new Date(year, month, 1 - firstDow);

      const summaries = monthSummary(state.filtered);

      for(let i=0;i<42;i++){
        const d = new Date(gridStart.getTime() + i*MS);
        const dISO = toISODate(d);
        const inMonth = (d.getMonth() === month);

        const cell = document.createElement("div");
        cell.className = "cell" + (inMonth ? "" : " out");

        const holidayName = getHolidayName(dISO);
        if(holidayName) cell.classList.add("holiday");

        const sum = summaries.get(dISO);
        const dots = [];
        if(sum){
          if(sum.kinds.has("seed")) dots.push(`<span class="miniDot seed" title="Seed"></span>`);
          if(sum.kinds.has("prop")) dots.push(`<span class="miniDot prop" title="Propagation Start"></span>`);
          if(sum.kinds.has("trans")) dots.push(`<span class="miniDot trans" title="Transplant"></span>`);
          if(sum.kinds.has("harv")) dots.push(`<span class="miniDot harv" title="Harvest"></span>`);
        }

        cell.innerHTML = `
          <div class="d">
            <span>${d.getDate()}</span>
            <span class="dots">${dots.join("")}</span>
          </div>
          <div class="lines"></div>
        `;

        const lines = cell.querySelector(".lines");

        if(holidayName){
          const hol = document.createElement("div");
          hol.className = "line";
          hol.style.borderColor = "rgba(239,68,68,.20)";
          hol.style.background = "rgba(239,68,68,.06)";
          hol.style.color = "#fecaca";
          hol.innerHTML = `<div class="l"><span class="bar" style="background:rgba(239,68,68,.9)"></span><span><strong>Not onsite</strong> • ${escapeHtml(holidayName)}</span></div><span>—</span>`;
          lines.appendChild(hol);
        }

        if(sum){
          const entries = Array.from(sum.groups.entries());
          const order = { seed:0, prop:1, trans:2, harv:3 };
          entries.sort((a,b)=>{
            const [ak] = a[0].split("||");
            const [bk] = b[0].split("||");
            const ap = a[0].split("||")[1] || "";
            const bp = b[0].split("||")[1] || "";
            return (order[ak]-order[bk]) || ap.localeCompare(bp);
          });

          const maxLines = 3;
          const shown = entries.slice(0, maxLines);
          const remaining = entries.length - shown.length;

          for(const [key, count] of shown){
            const [kind, pond] = key.split("||");
            const label = kindLabel(kind);
            const div = document.createElement("div");
            div.className = "line";
            div.innerHTML = `
              <div class="l">
                <span class="bar ${kindColorClass(kind)}"></span>
                <span><strong>${escapeHtml(label)}</strong>${pond ? ` — Pond ${escapeHtml(pond)}` : ""}</span>
              </div>
              <span>${count}</span>
            `;
            lines.appendChild(div);
          }

          if(remaining > 0){
            const more = document.createElement("div");
            more.className = "line more";
            more.innerHTML = `<div class="l"><span>+${remaining} more</span></div><span>→</span>`;
            lines.appendChild(more);
          }
        }

        cell.addEventListener("click", ()=> openDayModal(dISO));
        grid.appendChild(cell);
      }
    }

    // =========================
    // ✅ Gantt: NO-JUMP expanding + up-to-10-rows height + seed-label rule + hover dates
    // =========================
    function renderGantt(){
      const setsAll = buildSetsFromRows(state.rows);
      const sets = setsAll.filter(S => (S.seed || S.prop || S.trans || S.harv));

      $("ganttCount").textContent = `${sets.length} set${sets.length===1?"":"s"}`;

      const leftScroll = $("ganttLeftBody");
      const rightScroll = $("ganttRightScroll");
      const rowsHost = $("ganttRows");
      const axis = $("ganttAxis");
      const timeline = $("ganttTimeline");

      // Preserve scroll positions (and DO NOT rebuild on expand/collapse)
      const prevLeftTop = leftScroll.scrollTop;
      const prevRightTop = rightScroll.scrollTop;

      // Hard rebuild (filters changed / data changed)
      leftScroll.innerHTML = "";
      rowsHost.innerHTML = "";
      axis.innerHTML = "";
      timeline.querySelectorAll(".holidayBand,.todayLine,.holidayLine").forEach(n=>n.remove());
      state._ganttDom = null;

      if(!sets.length){
        $("ganttSpan").textContent = "—";
        leftScroll.innerHTML = `<div class="setRowLeft"><div class="setTitle">No sets match the current filters.</div></div>`;
        rowsHost.innerHTML = `<div class="setBarRow" style="height:60px;"><div class="segLabel" style="left:50%;top:50%;">No sets</div></div>`;
        leftScroll.scrollTop = prevLeftTop;
        rightScroll.scrollTop = prevRightTop;
        toggleSetsSection(); // keep button label in sync
        return;
      }

      state._lastGanttCount = sets.length;

      // Determine span
      let minT = Infinity;
      let maxT = -Infinity;
      for(const S of sets){
        const dates = [S.seed, S.prop, S.trans, S.harv].filter(Boolean);
        for(const d of dates){
          const t = d.getTime();
          if(t < minT) minT = t;
          if(t > maxT) maxT = t;
        }
      }

      const today = getTodayLocal();
      if(today.getTime() > maxT) maxT = today.getTime();

      const PAD_DAYS = 3;
      const start = startOfDay(new Date(minT - PAD_DAYS*MS));
      const end   = startOfDay(new Date(maxT + PAD_DAYS*MS + MS)); // exclusive

      const totalDays = Math.max(1, Math.round((end.getTime()-start.getTime())/MS));
      $("ganttSpan").textContent = `${toISODate(start)} → ${toISODate(new Date(end.getTime()-MS))}`;

      // Axis ticks (and tooltip on hover so you can see exact date)
      const maxTicks = 14;
      const ticks = Math.min(maxTicks, totalDays);
      const step = Math.max(1, Math.floor(totalDays / ticks));

      const tickDates = [];
      for(let i=0, d=0; d<totalDays && i<ticks; i++, d+=step){
        const dt = new Date(start.getTime() + d*MS);
        tickDates.push(dt);
        const el = document.createElement("div");
        el.className = "tick";
        const dow = dt.toLocaleDateString(undefined, { weekday:"short" });
        const monthShort = dt.toLocaleDateString(undefined,{month:"short"});
        el.innerHTML = `<span class="dow">${dow}</span><span class="d">${dt.getDate()} ${monthShort}</span>`;
        attachTip(el, ()=>{
          const iso = toISODate(dt);
          const hol = getHolidayName(iso);
          return `
            <div class="k">Timeline date</div>
            <div class="row">
              <span class="tag">${escapeHtml(fmtDowISO(dt))}</span>
              ${hol ? `<span class="tag">Holiday: ${escapeHtml(hol)}</span>` : ``}
            </div>
          `;
        });
        axis.appendChild(el);
      }

      // Compute px/day based on visible width
      const timelineW = rightScroll.clientWidth ? rightScroll.clientWidth : (timeline.clientWidth || 900);
      const pxPerDay = timelineW / totalDays;

      function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
      function xOf(date){
        const off = (date.getTime()-start.getTime())/MS;
        return clamp(off*pxPerDay, 0, totalDays*pxPerDay);
      }

      // Holiday background bands + holiday bold line
      for(let d=0; d<totalDays; d++){
        const dt = new Date(start.getTime() + d*MS);
        const iso = toISODate(dt);
        if(getHolidayName(iso)){
          const band = document.createElement("div");
          band.className = "holidayBand";
          band.style.left = `${Math.floor(d*pxPerDay)}px`;
          band.style.width = `${Math.ceil(pxPerDay)}px`;
          timeline.appendChild(band);

          const hl = document.createElement("div");
          hl.className = "holidayLine";
          hl.style.left = `${Math.floor(d*pxPerDay)}px`;
          timeline.appendChild(hl);
        }
      }

      // Today line
      const dayOffset = Math.round((today.getTime()-start.getTime())/MS);
      if(dayOffset >= 0 && dayOffset <= totalDays){
        const tl = document.createElement("div");
        tl.className = "todayLine";
        tl.style.left = `${Math.floor(dayOffset*pxPerDay)}px`;
        timeline.appendChild(tl);
      }

      // helpers for cross highlighting
      function setHovered(key, on){
        const l = leftScroll.querySelector(`.setRowLeft[data-key="${CSS.escape(key)}"]`);
        const r = rowsHost.querySelector(`.setBarRow[data-key="${CSS.escape(key)}"]`);
        if(l) l.classList.toggle("hovered", on);
        if(r) r.classList.toggle("hovered", on);
      }

      // Tooltips header (with weekday on Harvest)
      function tipHeader(S){
        const seedISO = S.seed ? toISODate(S.seed) : "—";
        const propISO = S.prop ? toISODate(S.prop) : "—";
        const transISO = S.trans ? toISODate(S.trans) : "—";
        const harvISO = S.harv ? toISODate(S.harv) : "TBD";
        const harvDowISO = S.harv ? fmtDowISO(S.harv) : "TBD";
        const title = `Harvest ${harvISO} • ${S.rows.length} row${S.rows.length===1?"":"s"}`;
        return `
          <div class="k">${escapeHtml(title)}</div>
          <div class="row">
            <span class="tag">S: ${escapeHtml(seedISO)}</span>
            <span class="tag">P: ${escapeHtml(propISO)}</span>
            <span class="tag">T: ${escapeHtml(transISO)}</span>
            <span class="tag harv">H: ${escapeHtml(harvDowISO)}</span>
          </div>
        `;
      }

      // Render rows
      const dom = {
        leftByKey: new Map(),
        rightByKey: new Map(),
      };

      for(const S of sets){
        const seedISO = S.seed ? toISODate(S.seed) : "—";
        const propISO = S.prop ? toISODate(S.prop) : "—";
        const transISO = S.trans ? toISODate(S.trans) : "—";
        const harvISO = S.harv ? toISODate(S.harv) : "TBD";
        const harvDowISO = S.harv ? fmtDowISO(S.harv) : "TBD";

        // Title: make harvest explicit with weekday (your #4)
        const title = `Harvest ${harvDowISO} • ${S.rows.length} row${S.rows.length===1?"":"s"}`;

        // LEFT row
        const lrow = document.createElement("div");
        lrow.className = "setRowLeft";
        lrow.dataset.key = S.key;

        const isOpen = state.openSetKeys.has(S.key);
        const isSelected = state.selectedSetKey === S.key;

        if(isOpen) lrow.classList.add("open");
        if(isSelected) lrow.classList.add("selected");

        const propPonds = Array.from(S.propPonds).sort().join(",") || "—";
        const growPonds = Array.from(S.growPonds).sort().join(",") || "—";

        const detailLines = S.rows
          .slice()
          .sort((a,b)=> (a.batch||"").localeCompare(b.batch||"") || (a.variety||"").localeCompare(b.variety||""))
          .map(r=>{
            const batch = r.batch ? `Batch ${r.batch}` : "Batch —";
            const variety = r.variety || "Variety —";
            const media = r.media || "Media —";
            const pp = r.propPond ? `Prop ${r.propPond}` : "Prop —";
            const gp = r.growPond ? `Grow ${r.growPond}` : "Grow —";
            const pos = (r.pos!=="" && r.pos!=null) ? `Pos ${r.pos}` : "Pos —";
            return `
              <div class="detailRow">
                <span class="detailKey">${escapeHtml(batch)}</span>
                <span class="detailKey">${escapeHtml(variety)}</span>
                <span class="detailKey">${escapeHtml(media)}</span>
                <span class="detailKey">${escapeHtml(pp)}</span>
                <span class="detailKey">${escapeHtml(gp)}</span>
                <span class="detailKey">${escapeHtml(pos)}</span>
              </div>
            `;
          }).join("");

        lrow.innerHTML = `
          <div class="setHeadLine">
            <div class="setTitle">${escapeHtml(title)}</div>
            <div class="chevMini">⌄</div>
          </div>

          <div class="setMeta">
            <span class="miniPill seed">Seed ${escapeHtml(seedISO)}</span>
            <span class="miniPill prop">Prop ${escapeHtml(propISO)}</span>
            <span class="miniPill trans">Trans ${escapeHtml(transISO)}</span>
            <span class="miniPill harv">Harv ${escapeHtml(harvDowISO)}</span>
            <span class="miniPill">Prop Pond: ${escapeHtml(propPonds)}</span>
            <span class="miniPill">Grow Pond: ${escapeHtml(growPonds)}</span>
          </div>

          <div class="setDetails">
            ${detailLines || `<div class="detailRow"><span class="detailKey">No row details</span></div>`}
          </div>
        `;

        lrow.addEventListener("mouseenter", ()=> setHovered(S.key, true));
        lrow.addEventListener("mouseleave", ()=> setHovered(S.key, false));

        leftScroll.appendChild(lrow);
        dom.leftByKey.set(S.key, lrow);

        // RIGHT row
        const rrow = document.createElement("div");
        rrow.className = "setBarRow";
        rrow.dataset.key = S.key;
        if(isSelected) rrow.classList.add("selected");

        rrow.addEventListener("mouseenter", ()=> setHovered(S.key, true));
        rrow.addEventListener("mouseleave", ()=> setHovered(S.key, false));

        // segments
        function addSeg(kind, startDate, endDate, opacityIfMissingNext){
          if(!startDate) return;
          const x1 = xOf(startDate);
          const x2 = xOf(endDate);
          const seg = document.createElement("div");
          seg.className = "seg " + kindColorClass(kind);
          seg.style.left = `${Math.min(x1,x2)}px`;
          seg.style.width = `${Math.max(4, Math.abs(x2-x1))}px`;
          if(opacityIfMissingNext) seg.style.opacity = "0.55";

          const startISO = toISODate(startDate);
          const endISO = endDate ? toISODate(endDate) : "—";

          attachTip(seg, ()=> `
            ${tipHeader(S)}
            <div class="row">
              <span class="tag">${escapeHtml(kindLabel(kind))}</span>
              <span class="tag">${escapeHtml(startISO)} → ${escapeHtml(endISO)}</span>
            </div>
          `);

          rrow.appendChild(seg);
        }

        const end1 = S.prop || S.trans || S.harv || new Date(end.getTime()-MS);
        const end2 = S.trans || S.harv || new Date(end.getTime()-MS);
        const end3 = S.harv || new Date(end.getTime()-MS);

        addSeg("seed", S.seed, end1, !S.prop);
        addSeg("prop", S.prop, end2, !S.trans);
        addSeg("trans", S.trans, end3, !S.harv);

        // milestone labels (your #3: only show S if seed != prop)
        function addLabel(dateObj, label, labelKind){
          if(!dateObj) return;
          const x = xOf(dateObj);
          const t = document.createElement("div");
          t.className = "segLabel";
          t.style.left = `${x}px`;
          t.textContent = label;

          const iso = toISODate(dateObj);
          attachTip(t, ()=> `
            ${tipHeader(S)}
            <div class="row">
              <span class="tag">${escapeHtml(label)} (${escapeHtml(labelKind)})</span>
              <span class="tag">${escapeHtml(fmtDowISO(dateObj))}</span>
            </div>
          `);

          rrow.appendChild(t);
        }

        const seedEqProp = S.seed && S.prop && toISODate(S.seed) === toISODate(S.prop);
        if(S.seed && (!S.prop || !seedEqProp)) addLabel(S.seed, "S", "Seed");
        if(S.prop) addLabel(S.prop, "P", "Propagation");
        if(S.trans) addLabel(S.trans, "T", "Transplant");
        if(S.harv) addLabel(S.harv, "H", "Harvest");

        // harvest marker (recommendation) – makes harvest “pop”
        if(S.harv){
          const x = xOf(S.harv);
          const m = document.createElement("div");
          m.className = "harvMarker";
          m.style.left = `${x}px`;
          attachTip(m, ()=> `
            ${tipHeader(S)}
            <div class="row">
              <span class="tag harv">Harvest</span>
              <span class="tag harv">${escapeHtml(harvDowISO)}</span>
            </div>
          `);
          rrow.appendChild(m);
        }

        // Hover anywhere on the row: show summary
        attachTip(rrow, ()=> tipHeader(S));

        rowsHost.appendChild(rrow);
        dom.rightByKey.set(S.key, rrow);

        // Click behavior: NO rerender (fixes jump)
        lrow.addEventListener("click", ()=>{
          const anchorBefore = lrow.getBoundingClientRect().top + window.scrollY;
          const keepLeft = leftScroll.scrollTop;
          const keepRight = rightScroll.scrollTop;

          state.selectedSetKey = S.key;
          if(state.openSetKeys.has(S.key)) state.openSetKeys.delete(S.key);
          else state.openSetKeys.add(S.key);

          // toggle classes directly (no rebuild)
          for(const [k, el] of dom.leftByKey.entries()){
            el.classList.toggle("open", state.openSetKeys.has(k));
            el.classList.toggle("selected", state.selectedSetKey === k);
          }
          for(const [k, el] of dom.rightByKey.entries()){
            el.classList.toggle("selected", state.selectedSetKey === k);
          }

          // keep row heights in sync (prevents mismatch & helps scrolling feel stable)
          requestAnimationFrame(()=>{
            syncGanttRowHeights(dom);
            applyGanttHeightsForVisibleRows(state._lastGanttCount || sets.length);
            leftScroll.scrollTop = keepLeft;
            rightScroll.scrollTop = keepRight;
            const anchorAfter = lrow.getBoundingClientRect().top + window.scrollY;
            const delta = anchorAfter - anchorBefore;
            if(delta !== 0){
              window.scrollTo(0, window.scrollY + delta);
            }
          });
        });
      }

      // Restore scroll
      leftScroll.scrollTop = prevLeftTop;
      rightScroll.scrollTop = prevRightTop;

      // Store dom cache for this render
      state._ganttDom = dom;

      // 1) up-to-10 sets visible before scroll (your #2)
      applyGanttHeightsForVisibleRows(sets.length);

      // Keep heights aligned (important when some are open)
      requestAnimationFrame(()=>{
        syncGanttRowHeights(dom);
        applyGanttHeightsForVisibleRows(state._lastGanttCount || sets.length);
      });

      ensureGanttScrollSync();
    }

    const GANTT_VISIBLE_ROWS = 10;

    function applyGanttHeightsForVisibleRows(setCount){
      const leftScroll = $("ganttLeftBody");
      const rightScroll = $("ganttRightScroll");
      if(!leftScroll || !rightScroll) return;

      // If ≤ visible rows limit, show all without vertical scroll (expand to content height).
      if(setCount <= GANTT_VISIBLE_ROWS){
        leftScroll.style.maxHeight = "none";
        rightScroll.style.maxHeight = "none";
        leftScroll.style.overflowY = "visible";
        rightScroll.style.overflowY = "visible";
        return;
      }

      // Otherwise cap to the rendered height of the first N rows (measured), then allow scrolling.
      const rows = Array.from(leftScroll.querySelectorAll(".setRowLeft"));
      const axisEl = $("ganttAxis");
      const axisHeight = axisEl ? axisEl.offsetHeight : 44;
      const padApprox = 22; // timeline padding + borders

      const slice = rows.slice(0, GANTT_VISIBLE_ROWS);
      const rowsHeight = slice.reduce((sum, r)=> sum + (r.offsetHeight || 0), 0);
      const maxPx = Math.max(160, rowsHeight + axisHeight + padApprox);

      leftScroll.style.maxHeight = `${maxPx}px`;
      rightScroll.style.maxHeight = `${maxPx}px`;
      leftScroll.style.overflowY = "auto";
      rightScroll.style.overflowY = "auto";
    }

    function syncGanttRowHeights(dom){
      // Make right-row height match left-row height so expanding doesn’t “fight” scrolling
      const leftScroll = $("ganttLeftBody");
      const rightScroll = $("ganttRightScroll");
      if(!dom || !leftScroll || !rightScroll) return;

      for(const [key, lrow] of dom.leftByKey.entries()){
        const rrow = dom.rightByKey.get(key);
        if(!rrow) continue;

        // Use actual rendered height
        const h = Math.max(44, lrow.offsetHeight);
        rrow.style.height = `${h}px`;
      }
    }

    function ensureGanttScrollSync(){
      const leftScroll = $("ganttLeftBody");
      const rightScroll = $("ganttRightScroll");
      if(!leftScroll || !rightScroll) return;

      if(leftScroll.dataset.syncBound === "1") return;
      leftScroll.dataset.syncBound = "1";
      rightScroll.dataset.syncBound = "1";

      leftScroll.addEventListener("scroll", ()=>{
        if(state._syncingScroll) return;
        state._syncingScroll = true;
        rightScroll.scrollTop = leftScroll.scrollTop;
        state._syncingScroll = false;
      });

      rightScroll.addEventListener("scroll", ()=>{
        if(state._syncingScroll) return;
        state._syncingScroll = true;
        leftScroll.scrollTop = rightScroll.scrollTop;
        state._syncingScroll = false;
      });
    }

    function collapseAllSets(){
      state.openSetKeys.clear();
      state.selectedSetKey = null;
      const dom = state._ganttDom;
      if(dom){
        for(const el of dom.leftByKey.values()){
          el.classList.remove("open","selected");
        }
        for(const el of dom.rightByKey.values()){
          el.classList.remove("selected");
        }
        syncGanttRowHeights(dom);
        applyGanttHeightsForVisibleRows(state._lastGanttCount || 0);
      }
    }

    function toggleSetsSection(){
      state.setsCollapsed = !state.setsCollapsed;
      const left = document.querySelector(".ganttLeft");
      if(left){
        left.classList.toggle("collapsed", state.setsCollapsed);
      }
      const btn = $("collapseSetsBtn");
      if(btn){
        btn.textContent = state.setsCollapsed ? "Expand (show set details)" : "Collapse all";
        btn.setAttribute("aria-pressed", state.setsCollapsed ? "true" : "false");
      }
    }

    // =========================
    // Modal (simple)
    // =========================
    function openDayModal(dayISO){
      const items = state.filtered.filter(e=>e.dateISO===dayISO);
      const d = parseDateLoose(dayISO) || startOfDay(new Date());
      const nice = d.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric" });

      $("dayModalTitle").textContent = nice;

      const holidayName = getHolidayName(dayISO);
      const isHoliday = !!holidayName;

      $("dayModalSub").textContent =
        `${items.length} item${items.length===1?"":"s"}` +
        (isHoliday ? ` • Not onsite: ${holidayName}` : "") +
        (state.includeHarvested ? ` • History included` : ` • Active-only`);

      const body = $("dayModalBody");
      body.innerHTML = "";

      if(isHoliday && items.length===0){
        body.innerHTML = `
          <div class="summary" style="border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08); color:#fecaca;">
            <b>Not onsite</b> • ${escapeHtml(holidayName)}<br/>
            No scheduled experiment events on this day.
          </div>
        `;
      }else if(items.length===0){
        body.innerHTML = `
          <div class="summary" style="border-color: rgba(148,163,184,.22); background: rgba(2,6,23,.35); color: var(--sub);">
            No events on this day (for the current filters).
          </div>
        `;
      }else{
        const list = items
          .slice()
          .sort((a,b)=> a.kind.localeCompare(b.kind) || (a.batch||"").localeCompare(b.batch||""))
          .map(e=>{
            const pondLabel =
              (e.kind==="prop") ? (e.propPond ? `Prop Pond ${e.propPond}` : "") :
              (e.kind==="trans"||e.kind==="harv") ? (e.growPond ? `Grow Pond ${e.growPond}` : "") :
              (e.propPond ? `Prop Pond ${e.propPond}` : "");
            return `
              <div class="item">
                <div class="meta">
                  <div class="name">${escapeHtml(kindLabel(e.kind))} • ${escapeHtml(e.batch ? ("Batch " + e.batch) : (e.variety || e.experiment || "Item"))}</div>
                  <div class="pills">
                    ${e.variety ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.variety)}</span>` : ""}
                    ${e.media ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.media)}</span>` : ""}
                    ${pondLabel ? `<span class="pill">${escapeHtml(pondLabel)}</span>` : ""}
                    ${e.experiment ? `<span class="pill">${escapeHtml(e.experiment)}</span>` : ""}
                  </div>
                </div>
                <button class="openBtn" onclick="document.getElementById('dayModalBack').classList.remove('open')">Close</button>
              </div>
            `;
          }).join("");
        body.innerHTML = `<div class="groups" style="padding:0;">${list}</div>`;
      }

      $("dayModalBack").classList.add("open");
    }

    function closeDayModal(){ $("dayModalBack").classList.remove("open"); }

    // =========================
    // Build / Refresh
    // =========================
    function rebuildFilterOptions(){
      const today = getTodayLocal();
      const sourceRows = state.includeHarvested ? state.rows : state.rows.filter(r=>isRowActive(r,today));

      const exps = new Set();
      const medias = new Set();
      const ponds = new Set();

      for(const r of sourceRows){
        if(r.experiment) exps.add(r.experiment);
        if(r.media) medias.add(r.media);
        if(r.growPond) ponds.add(String(r.growPond).trim());
      }

      function fillSelect(sel, values, current){
        const s = $(sel);
        const arr = Array.from(values).sort((a,b)=> String(a).localeCompare(String(b)));
        const keep = current ?? "All";
        s.innerHTML = `<option>All</option>` + arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
        if(arr.includes(keep)) s.value = keep;
        else s.value = "All";
      }

      fillSelect("fExperiment", exps, state.experiment);
      fillSelect("fMedia", medias, state.media);
      fillSelect("fPond", ponds, state.pond);

      state.experiment = $("fExperiment").value;
      state.media = $("fMedia").value;
      state.pond = $("fPond").value;
    }

    function buildFromTSV(){
      const tsv = $("tsv").value || "";
      state.rawTSV = tsv;
      localStorage.setItem("expCal_tsv", tsv);

      const parsed = parseTSV(tsv);
      state.rows = parsed.rows;
      state.events = expandEvents(state.rows);

      rebuildFilterOptions();

      const eCount = state.events.length;
      const byKind = { seed:0, prop:0, trans:0, harv:0 };
      for(const e of state.events) byKind[e.kind]++;

      $("buildSummary").innerHTML =
        `Rows parsed: ${parsed.parsed}<br/>` +
        `Rows skipped: ${parsed.skipped}<br/>` +
        `Events created: ${eCount} (Seed ${byKind.seed}, Prop ${byKind.prop}, Trans ${byKind.trans}, Harvest ${byKind.harv})`;

      if(!state.selectedSetKey){
        const sets = buildSetsFromRows(state.rows);
        if(sets[0]) state.selectedSetKey = sets[0].key;
      }

      render();
    }

    // =========================
    // Wiring
    // =========================
    function setView(v){
      state.view = v;
      $("tabAgenda").classList.toggle("on", v==="agenda");
      $("tabMonth").classList.toggle("on", v==="month");
      $("tabGantt").classList.toggle("on", v==="gantt");
      render();
      if(v==="gantt") ensureGanttScrollSync();
    }

    function toggleMilestone(k){
      state.milestoneOn[k] = !state.milestoneOn[k];
      document.querySelectorAll(`[data-k="${k}"]`).forEach(el=>{
        el.classList.toggle("on", state.milestoneOn[k]);
      });
      render();
    }

    function syncHistoryUI(){
      const btn = $("historyToggle");
      const lbl = $("historyToggleLabel");
      const on = !state.includeHarvested;
      btn.classList.toggle("on", on);
      lbl.textContent = state.includeHarvested ? "Include harvested" : "Active only";
      $("metaActiveMode").classList.toggle("on", on);
      $("metaActiveModeText").textContent = state.includeHarvested ? "History included" : "Active only";
    }

    function toggleHistory(){
      state.includeHarvested = !state.includeHarvested;
      syncHistoryUI();
      rebuildFilterOptions();
      render();
    }

    function init(){
      const saved = localStorage.getItem("expCal_tsv") || "";
      $("tsv").value = saved;
      state.rawTSV = saved;

      const today = startOfDay(new Date());
      state.startDate = today;
      $("startDate").value = toISODate(today);
      state.monthCursor = new Date(today.getFullYear(), today.getMonth(), 1);

      $("fExperiment").innerHTML = `<option>All</option>`;
      $("fMedia").innerHTML = `<option>All</option>`;
      $("fPond").innerHTML = `<option>All</option>`;

      syncHistoryUI();

      if(saved.trim()) buildFromTSV();
      else render();

      $("milestoneChips").addEventListener("click", (ev)=>{
        const chip = ev.target.closest(".chip");
        if(!chip) return;
        const k = chip.getAttribute("data-k");
        if(!k) return;
        toggleMilestone(k);
      });

      document.querySelectorAll(".miniToggle").forEach(el=>{
        el.addEventListener("click", ()=>{
          const k = el.getAttribute("data-k");
          toggleMilestone(k);
        });
      });

      $("q").addEventListener("input", ()=>{ state.q = $("q").value; render(); });
      $("fExperiment").addEventListener("change", ()=>{ state.experiment = $("fExperiment").value; render(); });
      $("fMedia").addEventListener("change", ()=>{ state.media = $("fMedia").value; render(); });
      $("fPond").addEventListener("change", ()=>{ state.pond = $("fPond").value; render(); });
      $("fRange").addEventListener("change", ()=>{ state.rangeDays = Number($("fRange").value); render(); });

      $("startDate").addEventListener("change", ()=>{
        const d = parseDateLoose($("startDate").value);
        if(d){
          state.startDate = d;
          state.monthCursor = new Date(d.getFullYear(), d.getMonth(), 1);
          render();
        }
      });

      $("buildBtn").addEventListener("click", buildFromTSV);

      document.addEventListener("keydown", (e)=>{
        const isCmd = e.metaKey || e.ctrlKey;
        if(isCmd && e.key === "Enter"){ e.preventDefault(); buildFromTSV(); }
        if(e.key === "Escape"){ hideTip(); closeDayModal(); }
      });

      $("todayBtn").addEventListener("click", ()=>{
        const t = startOfDay(new Date());
        state.startDate = t;
        $("startDate").value = toISODate(t);
        state.monthCursor = new Date(t.getFullYear(), t.getMonth(), 1);
        render();
      });

      $("tabAgenda").addEventListener("click", ()=> setView("agenda"));
      $("tabMonth").addEventListener("click", ()=> setView("month"));
      $("tabGantt").addEventListener("click", ()=> setView("gantt"));

      $("prevMonth").addEventListener("click", ()=>{ state.monthCursor = new Date(state.monthCursor.getFullYear(), state.monthCursor.getMonth()-1, 1); render(); });
      $("nextMonth").addEventListener("click", ()=>{ state.monthCursor = new Date(state.monthCursor.getFullYear(), state.monthCursor.getMonth()+1, 1); render(); });
      $("thisMonth").addEventListener("click", ()=>{
        const t = startOfDay(new Date());
        state.monthCursor = new Date(t.getFullYear(), t.getMonth(), 1);
        render();
      });

      $("dayModalClose").addEventListener("click", closeDayModal);
      $("dayModalBack").addEventListener("click", (ev)=>{ if(ev.target === $("dayModalBack")) closeDayModal(); });

      $("historyToggle").addEventListener("click", toggleHistory);
      $("metaActiveMode").addEventListener("click", toggleHistory);
      $("filtersHdr").addEventListener("click", ()=>{ $("filtersBox").classList.toggle("open"); });
      $("dataHdr").addEventListener("click", ()=>{ $("dataBox").classList.toggle("open"); });
      const collapseBtn = $("collapseSetsBtn");
      if(collapseBtn){
        collapseBtn.addEventListener("click", (ev)=>{
          // If already expanded and user wants collapse all rows within, first collapse rows; then toggle whole section.
          if(!state.setsCollapsed){
            collapseAllSets();
          }
          toggleSetsSection();
        });
      }

      // handle resize (recompute gantt scale)
      window.addEventListener("resize", ()=>{
        if(state.view==="gantt"){
          // safe rebuild on resize (keeps correct pxPerDay)
          renderGantt();
        }
      });
    }

    init();
  </script>
</body>
</html>
