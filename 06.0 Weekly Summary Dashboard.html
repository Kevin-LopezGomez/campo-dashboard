<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Summary Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --bg-alt:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --card:#020617;
      --border:#1f2937;
      --border-subtle:#374151;
      --text:#e5e7eb;
      --sub:#9ca3af;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.15);
      --accent-strong:#4ade80;
      --danger:#ef4444;
      --danger-soft:rgba(239,68,68,.15);
      --muted:#6b7280;
      --blue:rgba(59,130,246,.85);
      --amber:rgba(234,179,8,.9);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color:var(--text);
    }

    .page{min-height:100vh;padding:16px;display:flex;justify-content:center;}
    .container{
      width:100%;
      max-width:1320px;
      border-radius:24px;
      padding:20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.10), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.10), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border:1px solid rgba(148,163,184,.35);
      box-shadow:
        0 24px 80px rgba(0,0,0,.8),
        0 0 0 1px rgba(15,23,42,.8);
      backdrop-filter:blur(20px);
    }

    .header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }

    .title-block{flex:1 1 380px;min-width:0;}
    .title{
      display:flex;align-items:center;gap:10px;
      margin:0 0 4px;
      font-size:1.3rem;letter-spacing:.02em;
    }
    .title-pill{
      width:26px;height:26px;border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #93c5fd, #22c55e 55%, #16a34a 100%);
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow: 0 0 0 2px rgba(15,23,42,.9), 0 12px 30px rgba(16,185,129,.55);
    }
    .title-pill span{font-size:15px;font-weight:800;color:#052e2b;}
    .title-text{font-weight:650;display:flex;align-items:baseline;gap:8px;}
    .title-sub{
      font-size:.8rem;color:var(--sub);
      text-transform:uppercase;letter-spacing:.18em;
    }
    .subtitle{margin:0;font-size:.85rem;color:var(--muted);line-height:1.35;}

    .header-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex:1 1 320px;
      min-width:280px;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:999px;padding:4px 9px;
      font-size:.72rem;border:1px solid rgba(148,163,184,.5);
      color:var(--sub);
      background: radial-gradient(circle at top left, rgba(148,163,184,.18), transparent 55%);
      white-space:nowrap;
    }
    .chip-dot{width:6px;height:6px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 3px rgba(34,197,94,.35);}
    .chip-danger-dot{background:var(--danger);box-shadow:0 0 0 3px rgba(248,113,113,.35);}

    .week-picker{
      display:flex;align-items:center;gap:10px;
      border:1px solid rgba(55,65,81,.9);
      background: rgba(15,23,42,.9);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .week-label{
      font-size:.75rem;color:var(--sub);
      text-transform:uppercase;letter-spacing:.14em;
    }
    select{
      background: rgba(2,6,23,.65);
      border:1px solid rgba(55,65,81,.9);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-size:.9rem;
      outline:none;
      min-width:160px;
    }

    /* ======= HIGHLIGHTS ======= */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      margin:10px 0 12px;
    }
    @media(max-width:1100px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media(max-width:620px){ .kpi-grid{ grid-template-columns: 1fr; } }

    .kpi-card{
      position:relative;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(55,65,81,.9);
      background:
        radial-gradient(circle at top left, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(135deg, rgba(17,24,39,.92), rgba(15,23,42,.98));
      box-shadow: 0 18px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(15,23,42,.7);
      padding:12px 12px 10px;
      min-height:86px;
    }
    .kpi-glow{
      position:absolute; inset:-40px -60px auto auto;
      width:140px;height:140px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.35), transparent 62%);
      filter: blur(6px);
      opacity:.9;
      pointer-events:none;
    }
    .kpi-label{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:rgba(156,163,175,.92);
    }
    .kpi-value{
      margin-top:6px;
      font-size:1.35rem;
      font-weight:720;
      letter-spacing:.01em;
      font-variant-numeric: tabular-nums;
      display:flex;align-items:baseline;gap:8px;
    }
    .kpi-unit{ font-size:.78rem; color:rgba(156,163,175,.85); text-transform:uppercase; letter-spacing:.14em; }
    .kpi-sub{
      margin-top:6px;
      font-size:.78rem;
      color:rgba(148,163,184,.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .callouts{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:0 0 10px;
    }
    .callout{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(55,65,81,.9);
      background: rgba(2,6,23,.35);
      color:rgba(209,213,219,.92);
      font-size:.78rem;
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .callout .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.25);
    }
    .callout.warn .dot{ background: rgba(251,146,60,.95); box-shadow: 0 0 0 3px rgba(251,146,60,.22); }
    .callout.bad .dot{ background: rgba(248,113,113,.95); box-shadow: 0 0 0 3px rgba(248,113,113,.20); }

    .panel{
      border-radius:18px;
      padding:12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15,23,42,.97), rgba(15,23,42,.99));
      border:1px solid rgba(55,65,81,.9);
      box-shadow:
        0 18px 40px rgba(0,0,0,.85),
        0 0 0 1px rgba(15,23,42,.9);
      backdrop-filter: blur(14px);
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .panel-header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;flex-wrap:wrap;
    }
    .panel-title{
      font-size:.82rem;text-transform:uppercase;letter-spacing:.16em;color:var(--sub);
      display:flex;align-items:center;gap:7px;
    }
    .panel-title-dot{
      width:7px;height:7px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 3px rgba(34,197,94,.45);
    }
    .panel-subtitle{font-size:.75rem;color:var(--muted);}

    .table-wrapper{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,.95);
      background:
        linear-gradient(135deg, rgba(17,24,39,.96), rgba(15,23,42,.99)),
        radial-gradient(circle at top left, rgba(51,65,85,.55), rgba(15,23,42,.96));
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .table-scroll{
      max-height:640px;
      overflow:auto;
      scrollbar-width:thin;
      scrollbar-color:#4b5563 rgba(15,23,42,.2);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
      min-width:920px;
    }
    thead{
      position:sticky;top:0;z-index:2;
      background:
        linear-gradient(to bottom, #020617, #020617),
        radial-gradient(circle at top left, rgba(55,65,81,.5), rgba(15,23,42,.95));
      box-shadow:0 1px 0 rgba(31,41,55,.9);
    }
    th,td{
      padding:10px 12px;
      border-bottom:1px solid rgba(31,41,55,.85);
      white-space:nowrap;
      text-align:right;
    }
    th:first-child, td:first-child{ text-align:left; padding-left:14px; }
    th{
      font-size:.72rem;text-transform:uppercase;letter-spacing:.15em;color:var(--sub);
    }
    tbody tr:nth-child(odd) td{ background: rgba(15,23,42,.85); }
    tbody tr:nth-child(even) td{ background: rgba(17,24,39,.92); }

    .row-label{
      font-weight:650;
      letter-spacing:.01em;
    }

    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      background: rgba(2,6,23,.35);
      font-variant-numeric: tabular-nums;
    }
    .pill.good{ border-color: rgba(74,222,128,.65); color:#bbf7d0; background: rgba(22,163,74,.12); }
    .pill.warn{ border-color: rgba(251,146,60,.7); color:#fed7aa; background: rgba(251,146,60,.12); }
    .pill.bad{ border-color: rgba(248,113,113,.75); color:#fecaca; background: rgba(239,68,68,.12); }
    .pill.muted{ border-color: rgba(148,163,184,.35); color: rgba(209,213,219,.9); background: rgba(148,163,184,.06); }

    .hint{
      margin-top:10px;
      font-size:.75rem;
      color:var(--muted);
      white-space:pre-wrap;
    }
    .debug{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(55,65,81,.9);
      background: rgba(2,6,23,.35);
      font-size:.74rem;
      color:var(--sub);
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>W</span></div>
            <div class="title-text">
              <span>Weekly Summary Dashboard</span>
              <span class="title-sub">LIVE FROM DATA INPUT</span>
            </div>
          </div>
          <p class="subtitle">
            Weekly rollup across <b>Grow + Pack</b>. Reads from localStorage (Data Input is the compiler).
            Select a week to match the “Week ##” summary format.
          </p>
        </div>

        <div class="header-right">
          <div class="chip" id="chip-grow"><span class="chip-dot"></span><span>Grow: –</span></div>
          <div class="chip" id="chip-pack"><span class="chip-dot"></span><span>Pack: –</span></div>
          <div class="chip" id="chip-warn" style="display:none;"><span class="chip-danger-dot"></span><span>Warnings</span></div>

          <div class="week-picker" id="viewToggle">
            <button class="pill good" id="toggleWeekly" type="button">Weekly</button>
            <button class="pill muted" id="toggleDaily" type="button">Daily</button>
          </div>

          <div class="week-picker" id="weekPicker">
            <div class="week-label">Week</div>
            <select id="weekSelect"></select>
          </div>

          <div class="week-picker" id="datePicker" hidden>
            <div class="week-label">Day</div>
            <input id="dateSelect" type="date" />
          </div>
        </div>
      </header>

      <section class="kpi-grid" id="highlights">
        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label" id="hi-period-label">Week</div>
          <div class="kpi-value"><span id="hi-week">–</span></div>
          <div class="kpi-sub" id="hi-range">—</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Best % Completed</div>
          <div class="kpi-value"><span id="hi-best">—</span></div>
          <div class="kpi-sub" id="hi-best-label">—</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Lowest % Completed</div>
          <div class="kpi-value"><span id="hi-worst">—</span></div>
          <div class="kpi-sub" id="hi-worst-label">—</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Shipping (Sales)</div>
          <div class="kpi-value"><span id="hi-sales">—</span> <span class="kpi-unit">LBS</span></div>
          <div class="kpi-sub" id="hi-ship-note">—</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Board Inventory (Est. Remaining)</div>
          <div class="kpi-value"><span id="inv-left">—</span></div>
          <div class="kpi-sub" id="inv-sub">—</div>
        </article>

        <article class="kpi-card">
          <div class="kpi-glow"></div>
          <div class="kpi-label">Avg Broken Boards (Last 5)</div>
          <div class="kpi-value"><span id="avg-broken-5">—</span></div>
          <div class="kpi-sub" id="avg-broken-5-sub">—</div>
        </article>
      </section>

      <div class="callouts" id="callouts"></div>

      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span id="panelTitle">Week –</span></div>
            <div class="panel-subtitle" id="panelSubtitle">Targets + actuals + % (when applicable).</div>
          </div>
          <div class="panel-subtitle" id="lastUpdated">–</div>
        </div>

        <div class="table-wrapper">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="min-width:280px;">Category</th>
                  <th>Completed</th>
                  <th>Target to Reach</th>
                  <th>Units</th>
                  <th>% Completed</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="hint" class="hint"></div>
        <div id="debug" class="debug"></div>
      </section>
    </div>
  </div>

  <script>
    // =========================================================
    // STORAGE CONTRACT
    // =========================================================
    const MASTER_GROW_KEY = "campo_master_grow_v1";
    const MASTER_PACK_KEY = "campo_master_pack_v1";
    const MASTER_GROW_PING_KEY = "campo_master_grow_push_ping_v1";
    const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";

    const MSG_GROW = "MASTER_GROW_UPDATED";
    const MSG_PACK = "MASTER_PACK_UPDATED";

    const BC_NAME = "campo_updates_v1";
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null;

    const CANON_GROW_SHEET = "Master Grow";
    const CANON_PACK_SHEET = "Master Pack";

    // =========================================================
    // BOARD INVENTORY BASELINE (physical count)
    // =========================================================
    const BOARD_INV_BASE_DATE_STR = "12/15/2025";
    const BOARD_INV_BASE_COUNT = 26204;

    // =========================================================
    // PACK CONFIG
    // =========================================================
    const PACKS_PER_CASE = { "5OZ":18, "10OZ":12, "16OZ":8, "1LB":10, "3LB":3 };
    const LB_PER_UNIT    = { "5OZ":0.3125, "10OZ":0.625, "16OZ":1, "1LB":1, "3LB":3 };

    function skuType(sku){
      const s = String(sku||"").toUpperCase();
      if (!s) return "";
      if (s.includes("10OZ")) return "10OZ";
      if (s.includes("5OZ")) return "5OZ";
      if (s.includes("16OZ")) return "16OZ";
      if (s.includes("1LB")) return "1LB";
      if (s.includes("3LB")) return "3LB";
      return "";
    }

    const DONATION_LOCATIONS = new Set([
      "DONACIÓN - MANATIES",
      "DONACIÓN - EQUIPO",
      "DONACIÓN - FUNDACIÓN FE Y ESPERANZA",
      "DONACIÓN - BANCO DE ALIMENTO PR",
      "SAMPLES"
    ]);
    const RECEIVED_LOCATION = "WAREHOUSE";
    const WASTE_LOCATION = "BASURA";

    // =========================================================
    // HEADERS
    // =========================================================
    const H = Object.freeze({
      SEED_WEEK: "Seed Week",
      FLATS_SEEDED: "Flats Seeded",
      TARGET_FLATS: "Target Flats to Seed",

      TRANS_WEEK: "Transplant Week",
      BOARDS_TRANS: "Boards Transplant",
      EXPECT_BOARDS: "Expected Boards Transplanted",
      TRANS_WORKERS: "Transplant Total # of Workers",
      TRANS_START: "Transplant Start Time",
      TRANS_FINISH: "Transplant Finish Time",
      TRANS_DATE: "Transplant Date",
      TRANS_BROKEN: "Transplant Broken Boards",

      HARV_WEEK: "Harvest Week",
      HARV_BOARDS: "# of Boards Harvested",
      HARV_CUT: "Peso de La Lechuga Cortada",
      HARV_WITH_WASTE: "Peso de La Lechuga con Waste",
      HARV_BROKEN: "Harvest Boards Broken ",

      SAN_WEEK: "Sanitation Week",
      SAN_DATE: "Date of Sanitation",
      CLEAN_BOARDS: "Total # of Boards Cleaned",
      BROKEN_BOARDS: "# of Broken Boards",

      PACK_WEEK: "Pack Week",
      SKU: "SKU Packed",
      CASES: "Quantity of Cases Packed",

      LBS_SHIPPED: "# Lbs Shipped",
      LOC_SHIPPED: "Location Shipped",

      DATE: "Harvest Date"
    });

    function normHeader(s){ return String(s ?? "").replace(/\s+/g," ").trim().toLowerCase(); }

    const HEADER_ALIASES = new Map([
      ["seed week", H.SEED_WEEK],
      ["flats seeded", H.FLATS_SEEDED],
      ["target flats to seed", H.TARGET_FLATS],

      ["transplant week", H.TRANS_WEEK],
      ["boards transplant", H.BOARDS_TRANS],
      ["expected boards transplanted", H.EXPECT_BOARDS],
      ["transplant total # of workers", H.TRANS_WORKERS],
      ["transplant start time", H.TRANS_START],
      ["transplant finish time", H.TRANS_FINISH],
      ["transplant date", H.TRANS_DATE],
      ["transplant broken boards", H.TRANS_BROKEN],

      ["harvest week", H.HARV_WEEK],
      ["# of boards harvested", H.HARV_BOARDS],
      ["peso de la lechuga cortada", H.HARV_CUT],
      ["peso de la lechuga con waste", H.HARV_WITH_WASTE],
      ["harvest date", H.DATE],
      ["harvest boards broken", H.HARV_BROKEN],
      ["harvest boards broken ", H.HARV_BROKEN],

      ["sanitation week", H.SAN_WEEK],
      ["semana de sanitation", H.SAN_WEEK],
      ["semana sanitation", H.SAN_WEEK],
      ["date of sanitation", H.SAN_DATE],
      ["total # of boards cleaned", H.CLEAN_BOARDS],
      ["# of broken boards", H.BROKEN_BOARDS],
      ["total # of broken boards", H.BROKEN_BOARDS],

      ["pack week", H.PACK_WEEK],
      ["sku packed", H.SKU],
      ["quantity of cases packed", H.CASES],

      ["# lbs shipped", H.LBS_SHIPPED],
      ["lbs shipped", H.LBS_SHIPPED],
      ["location shipped", H.LOC_SHIPPED],

      ["date", H.DATE]
    ]);

    function canonicalizeHeaders(headersRaw){
      const canonHeaders = [];
      headersRaw.forEach((h, idx) => {
        const raw = String(h ?? "");
        const key = normHeader(raw);
        const canon = HEADER_ALIASES.get(key) || raw.trim();
        canonHeaders[idx] = canon;
      });
      return canonHeaders;
    }

    // =========================================================
    // PARSERS / HELPERS
    // =========================================================
    function parseNumber(v){
      if (v === null || v === undefined) return 0;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const cleaned = s.replace(/,/g,"");
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function parseAnyDate(v){
      if (v === null || v === undefined) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return v;

      if (typeof v === "number" && Number.isFinite(v) && v > 20000 && v < 60000) {
        const excelEpoch = new Date(Date.UTC(1899,11,30));
        const d = new Date(excelEpoch.getTime() + v * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      const s0 = String(v).trim();
      if (!s0) return null;

      const s0n = s0.toLowerCase();
      if (["(no date)","no date","n/a","na","null","undefined","#value!"].includes(s0n)) return null;

      const n = Number(s0);
      if (Number.isFinite(n) && n > 20000 && n < 60000) {
        const excelEpoch = new Date(Date.UTC(1899,11,30));
        const d = new Date(excelEpoch.getTime() + n * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      let s = s0;
      const parts = s.split(",");
      if (parts.length >= 2 && /[a-z]/i.test(parts[0])) s = parts.slice(1).join(",").trim();

      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }

      if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) {
        const [mm,dd,yy] = s.split("/").map(Number);
        const yyyy = yy < 100 ? 2000 + yy : yy;
        const d = new Date(yyyy, mm-1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatMMDDYYYY(d){
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    function toISODateStr(date){
      if (!(date instanceof Date) || isNaN(date.getTime())) return "";
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth()+1).padStart(2,"0");
      const dd = String(date.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatDayPill(date){
      const d = date instanceof Date ? date : parseAnyDate(date);
      if (!d || isNaN(d.getTime())) return "—";
      const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      return `${days[d.getDay()]} ${formatMMDDYYYY(d)}`;
    }

    function getISOWeekFromDate(date){
      if (!(date instanceof Date) || isNaN(date.getTime())) return "";
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return String(weekNum);
    }

    function getCurrentISOWeek(){
      return getISOWeekFromDate(new Date());
    }

    function getMostRecentDataDateISO(growRows, packRows){
      let latest = null;
      const consider = (d) => {
        if (!d || isNaN(d.getTime())) return;
        if (!latest || d.getTime() > latest.getTime()) latest = d;
      };

      for (const r of (growRows||[])){
        consider(parseAnyDate(r[H.DATE]));
        consider(parseAnyDate(r[H.TRANS_DATE]));
        consider(parseAnyDate(r[H.SAN_DATE]));
      }

      const packDateFields = [H.DATE, "Date", "Pack Date", "Ship Date"];
      for (const r of (packRows||[])){
        for (const f of packDateFields){
          if (f in r) consider(parseAnyDate(r[f]));
        }
      }

      return latest ? toISODateStr(latest) : "";
    }

    function hasAnyDataForDateISO(dateISO, growRows, packRows){
      if (!dateISO) return false;
      const isMatch = (val) => {
        const d = parseAnyDate(val);
        return d && toISODateStr(d) === dateISO;
      };

      for (const r of (growRows||[])){
        if (isMatch(r[H.DATE]) || isMatch(r[H.TRANS_DATE]) || isMatch(r[H.SAN_DATE])) return true;
      }

      const packDateFields = [H.DATE, "Date", "Pack Date", "Ship Date"];
      for (const r of (packRows||[])){
        for (const f of packDateFields){
          if (f in r && isMatch(r[f])) return true;
        }
      }

      return false;
    }

    function parseTimeToMinutes(v){
      if (v === null || v === undefined) return NaN;

      if (typeof v === "number" && Number.isFinite(v) && v >= 0 && v < 1) return Math.round(v * 24 * 60);
      if (typeof v === "number" && Number.isFinite(v) && v >= 1 && v <= 24) return Math.round(v * 60);

      const str = String(v ?? "").trim();
      if (!str) return NaN;

      const asNum = Number(str);
      if (Number.isFinite(asNum)) {
        if (asNum >= 0 && asNum < 1) return Math.round(asNum * 24 * 60);
        if (asNum >= 1 && asNum <= 24) return Math.round(asNum * 60);
      }

      const m = str.match(/^(\d{1,2}):(\d{2})(?:\s*([APap][Mm]))?$/);
      if (!m) return NaN;
      let hh = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      const ap = m[3] ? m[3].toUpperCase() : "";
      if (ap) {
        if (hh === 12) hh = 0;
        if (ap === "PM") hh += 12;
      }
      return hh * 60 + mm;
    }

    function spanHours(minStart, maxFinish){
      if (!Number.isFinite(minStart) || !Number.isFinite(maxFinish)) return 0;
      let diff = maxFinish - minStart;
      if (diff < 0) diff += 24 * 60;
      return diff / 60;
    }

    function weekNumFromCell(v){
      const raw = String(v ?? "").trim();
      if (!raw) return null;
      const u = raw.toUpperCase();
      if (u.includes("#VALUE")) return null;
      if (u === "N/A" || u === "NA" || u === "NULL" || u === "UNDEFINED") return null;

      const m = raw.match(/(\d{1,3})/);
      if (!m) return null;
      const n = parseInt(m[1],10);
      if (!Number.isFinite(n) || n <= 0 || n > 60) return null;
      return String(n);
    }

    // =========================================================
    // WEEKLY BROKEN BOARDS (for any week)
    // =========================================================
    function computeWeeklyBrokenBoards(wkNum, growRows){
      const wk = weekNumFromCell(wkNum);
      if (!wk) return 0;
      const isWeek = (val) => weekNumFromCell(val) === wk;

      const sanRows = (growRows||[]).filter(r => isWeek(r[H.SAN_WEEK]));
      const transRows = (growRows||[]).filter(r => isWeek(r[H.TRANS_WEEK]));
      const harvRows = (growRows||[]).filter(r => isWeek(r[H.HARV_WEEK]));

      const brokenSanWeek   = sanRows.reduce((s,r)=>s+parseNumber(r[H.BROKEN_BOARDS]),0);
      const brokenTransWeek = transRows.reduce((s,r)=>s+parseNumber(r[H.TRANS_BROKEN]),0);
      const brokenHarvWeek  = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_BROKEN]),0);
      return brokenSanWeek + brokenTransWeek + brokenHarvWeek;
    }

    // =========================================================
    // LOADERS
    // =========================================================
    function loadJson(key){
      const raw = (localStorage.getItem(key) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToObjects(sheetObj){
      const headersRaw = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
      const canonHeaders = canonicalizeHeaders(headersRaw);

      const out = [];
      for (const r of rows){
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i=0;i<canonHeaders.length;i++){
          const k = String(canonHeaders[i] ?? "").trim();
          if (!k) continue;
          obj[k] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    // =========================================================
    // WEEK DISCOVERY
    // =========================================================
    function collectWeeks(growRows, packRows){
      const weeks = new Set();
      const addWeek = (v) => {
        const w = weekNumFromCell(v);
        if (w) weeks.add(w);
      };

      for (const r of (growRows||[])){
        addWeek(r[H.SEED_WEEK]);
        addWeek(r[H.TRANS_WEEK]);
        addWeek(r[H.HARV_WEEK]);
        addWeek(r[H.SAN_WEEK]);
      }
      for (const r of (packRows||[])){
        addWeek(r[H.PACK_WEEK]);
      }

      const arr = Array.from(weeks);
      arr.sort((a,b) => (parseFloat(a) - parseFloat(b)));
      return arr;
    }

    // =========================================================
    // COMPUTE WEEK SUMMARY
    // =========================================================
    function computeWeekSummary(week, growRows, packRows){
      const wkNum = weekNumFromCell(week);
      if (!wkNum) {
        return { wkNum:null, empty:true, reason:"Invalid week selection." };
      }

      const isWeek = (val) => weekNumFromCell(val) === wkNum;

      // ---- SEEDING ----
      const seedRows = growRows.filter(r => isWeek(r[H.SEED_WEEK]));
      const flatsCompleted = seedRows.reduce((s,r)=>s+parseNumber(r[H.FLATS_SEEDED]),0);
      const flatsTarget = seedRows.reduce((s,r)=>s+parseNumber(r[H.TARGET_FLATS]),0);

      // ---- TRANSPLANT ----
      const transRows = growRows.filter(r => isWeek(r[H.TRANS_WEEK]));
      const boardsTrans = transRows.reduce((s,r)=>s+parseNumber(r[H.BOARDS_TRANS]),0);
      const boardsExpected = transRows.reduce((s,r)=>s+parseNumber(r[H.EXPECT_BOARDS]),0);
      const plugsCompleted = boardsTrans * 127;
      const plugsTarget = boardsExpected * 127;

      // ---- TRANSPLANT TIME + AVG WORKERS ----
      const dateCandidates = [H.TRANS_DATE, H.DATE, "Date"];
      function getBestDate(row){
        for (const h of dateCandidates){
          if (h in row) {
            const d = parseAnyDate(row[h]);
            if (d) return d;
          }
        }
        return null;
      }

      const dayMap = new Map();
      for (const r of transRows){
        const dObj = getBestDate(r);
        const dayKey = dObj ? formatMMDDYYYY(dObj) : "";
        const startMin = parseTimeToMinutes(r[H.TRANS_START]);
        const finishMin = parseTimeToMinutes(r[H.TRANS_FINISH]);

        const key = dayKey || "__NO_DATE__";
        if (!dayMap.has(key)) dayMap.set(key, { minStart: NaN, maxFinish: NaN });

        const d = dayMap.get(key);
        if (Number.isFinite(startMin)) d.minStart = Number.isFinite(d.minStart) ? Math.min(d.minStart, startMin) : startMin;
        if (Number.isFinite(finishMin)) d.maxFinish = Number.isFinite(d.maxFinish) ? Math.max(d.maxFinish, finishMin) : finishMin;
      }

      let weekHours = 0;
      for (const d of dayMap.values()){
        weekHours += spanHours(d.minStart, d.maxFinish);
      }

      const workersSum = transRows.reduce((s,r)=>{
        const w = parseNumber(r[H.TRANS_WORKERS]);
        return s + (w > 0 ? w : 0);
      },0);
      const workersCount = transRows.reduce((s,r)=> s + (parseNumber(r[H.TRANS_WORKERS])>0 ? 1 : 0), 0);
      const avgWorkers = workersCount > 0 ? (workersSum / workersCount) : 0;

      const boardsPerPersonPerHour_completed = (weekHours > 0 && avgWorkers > 0)
        ? (boardsTrans / (avgWorkers * weekHours))
        : NaN;

      const boardsPerPersonPerHour_target = (weekHours > 0 && avgWorkers > 0)
        ? (boardsExpected / (avgWorkers * weekHours))
        : NaN;

      // ---- HARVEST ----
      const harvRows = growRows.filter(r => isWeek(r[H.HARV_WEEK]));
      const harvestBoards = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_BOARDS]),0);
      const harvestCut = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_CUT]),0);
      const harvestWithWaste = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_WITH_WASTE]),0);

      // ---- SANITATION ----
      const sanRows = growRows.filter(r => isWeek(r[H.SAN_WEEK]));
      const cleanedBoards = sanRows.reduce((s,r)=>s+parseNumber(r[H.CLEAN_BOARDS]),0);

      // ---- BROKEN BOARDS (WEEK): Sanitation + Transplant + Harvest ----
      const brokenSanWeek   = sanRows.reduce((s,r)=>s+parseNumber(r[H.BROKEN_BOARDS]),0);
      const brokenTransWeek = transRows.reduce((s,r)=>s+parseNumber(r[H.TRANS_BROKEN]),0);
      const brokenHarvWeek  = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_BROKEN]),0);
      const brokenBoards = brokenSanWeek + brokenTransWeek + brokenHarvWeek;

      // ---- BROKEN BOARDS (CUMULATIVE up to selected week end date) ----
      const baseDate = parseAnyDate(BOARD_INV_BASE_DATE_STR);

      let weekEnd = null;
      const considerMax = (d) => {
        if (!d) return;
        if (!weekEnd || d.getTime() > weekEnd.getTime()) weekEnd = d;
      };

      for (const r of sanRows) considerMax(parseAnyDate(r[H.SAN_DATE]));
      for (const r of transRows) considerMax(parseAnyDate(r[H.TRANS_DATE]));
      for (const r of harvRows) considerMax(parseAnyDate(r[H.DATE]));

      if (!weekEnd) {
        for (const r of growRows) considerMax(parseAnyDate(r[H.SAN_DATE]));
        for (const r of growRows) considerMax(parseAnyDate(r[H.TRANS_DATE]));
        for (const r of growRows) considerMax(parseAnyDate(r[H.DATE]));
      }

      const inRange = (d) => {
        if (!baseDate || !d) return false;
        const t = d.getTime();
        return t >= baseDate.getTime() && (!weekEnd || t <= weekEnd.getTime());
      };

      const brokenSanSince = growRows
        .filter(r => inRange(parseAnyDate(r[H.SAN_DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.BROKEN_BOARDS]), 0);

      const brokenTransSince = growRows
        .filter(r => inRange(parseAnyDate(r[H.TRANS_DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.TRANS_BROKEN]), 0);

      const brokenHarvSince = growRows
        .filter(r => inRange(parseAnyDate(r[H.DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.HARV_BROKEN]), 0);

      const brokenSinceBaseline = brokenSanSince + brokenTransSince + brokenHarvSince;
      const boardInvRemaining = Math.max(0, BOARD_INV_BASE_COUNT - brokenSinceBaseline);

      // ---- AVG BROKEN (Last 5 weeks, excludes current week) ----
      const wkN = parseInt(wkNum, 10);
      const last5 = [];
      if (Number.isFinite(wkN)) {
        for (let i = 1; i <= 5; i++){
          const w = wkN - i;
          if (w > 0) last5.push(w);
        }
      }
      const last5BrokenValues = last5.map(w => computeWeeklyBrokenBoards(String(w), growRows));
      const last5Avg = last5BrokenValues.length
        ? last5BrokenValues.reduce((a,b)=>a+b,0) / last5BrokenValues.length
        : NaN;

      // ---- PACKING (Pack) ----
      const packRowsW = packRows.filter(r => isWeek(r[H.PACK_WEEK]));
      let cases5=0, units5=0, lbs5=0;
      let cases10=0, units10=0, lbs10=0;
      let lbsAll = 0;

      for (const r of packRowsW){
        const t = skuType(r[H.SKU]);
        const cases = parseNumber(r[H.CASES]);
        if (!t || !cases) continue;
        const units = cases * (PACKS_PER_CASE[t] || 0);
        const lbs = units * (LB_PER_UNIT[t] || 0);

        lbsAll += lbs;
        if (t === "5OZ"){ cases5 += cases; units5 += units; lbs5 += lbs; }
        if (t === "10OZ"){ cases10 += cases; units10 += units; lbs10 += lbs; }
      }

      // ---- SHIPPING (Pack) ----
      let shipReceived=0, shipDonation=0, shipWaste=0, shipSales=0;
      for (const r of packRowsW){
        const lbs = parseNumber(r[H.LBS_SHIPPED]);
        if (!lbs) continue;
        const loc = String(r[H.LOC_SHIPPED] ?? "").trim();
        const locU = loc.toUpperCase();

        if (!locU) continue;
        if (locU === RECEIVED_LOCATION) shipReceived += lbs;
        else if (locU === WASTE_LOCATION) shipWaste += lbs;
        else if (DONATION_LOCATIONS.has(locU)) shipDonation += lbs;
        else shipSales += lbs;
      }

      const hasAny =
        seedRows.length || transRows.length || harvRows.length || sanRows.length || packRowsW.length;

      return {
        wkNum,
        empty: !hasAny,
        counts: { seed: seedRows.length, trans: transRows.length, harv: harvRows.length, san: sanRows.length, pack: packRowsW.length },

        seeding: { completed: flatsCompleted, target: flatsTarget, unit:"Flats" },
        transplant: { completed: plugsCompleted, target: plugsTarget, unit:"Plugs" },

        transplantRate: {
          completed: boardsPerPersonPerHour_completed,
          target: boardsPerPersonPerHour_target,
          unit:"Boards"
        },

        harvestBoards,
        harvestCut,
        harvestWithWaste,

        pack5: { cases: cases5, units: units5, lbs: lbs5 },
        pack10:{ cases: cases10, units: units10, lbs: lbs10 },
        packAllLbs: lbsAll,

        ship: { received: shipReceived, sales: shipSales, donation: shipDonation, waste: shipWaste },

        cleanedBoards,

        brokenBoards,
        brokenBreakdown: { sanitation: brokenSanWeek, transplant: brokenTransWeek, harvest: brokenHarvWeek },

        boardInv: {
          baseDate: BOARD_INV_BASE_DATE_STR,
          baseCount: BOARD_INV_BASE_COUNT,
          weekEnd,
          brokenSinceBaseline,
          brokenSinceBreakdown: { sanitation: brokenSanSince, transplant: brokenTransSince, harvest: brokenHarvSince },
          remaining: boardInvRemaining
        },

        brokenAvg5: {
          weeks: last5,
          values: last5BrokenValues,
          avg: last5Avg
        },

        aux: { weekHours, avgWorkers, boardsTrans, boardsExpected, transRowsCount: transRows.length }
      };
    }

    function computeDaySummary(dateISO, growRows, packRows){
      const dObj = parseAnyDate(dateISO);
      const iso = toISODateStr(dObj);
      const wkNum = getISOWeekFromDate(dObj);
      if (!dObj || !iso || !wkNum) {
        return { wkNum:null, empty:true, reason:"Invalid day selection." };
      }

      const isDate = (val) => {
        const d = parseAnyDate(val);
        return d && toISODateStr(d) === iso;
      };
      const isSeedWeek = (val) => weekNumFromCell(val) === wkNum;

      // ---- SEEDING ----
      const seedRows = (growRows||[]).filter(r => isSeedWeek(r[H.SEED_WEEK]));
      const flatsCompleted = seedRows.reduce((s,r)=>s+parseNumber(r[H.FLATS_SEEDED]),0);
      const flatsTarget = seedRows.reduce((s,r)=>s+parseNumber(r[H.TARGET_FLATS]),0);

      // ---- TRANSPLANT ----
      const transRows = (growRows||[]).filter(r => isDate(r[H.TRANS_DATE]));
      const boardsTrans = transRows.reduce((s,r)=>s+parseNumber(r[H.BOARDS_TRANS]),0);
      const boardsExpected = transRows.reduce((s,r)=>s+parseNumber(r[H.EXPECT_BOARDS]),0);
      const plugsCompleted = boardsTrans * 127;
      const plugsTarget = boardsExpected * 127;

      // ---- TRANSPLANT TIME + AVG WORKERS ----
      const dateCandidates = [H.TRANS_DATE, H.DATE, "Date"];
      function getBestDate(row){
        for (const h of dateCandidates){
          if (h in row) {
            const d = parseAnyDate(row[h]);
            if (d) return d;
          }
        }
        return null;
      }

      const dayMap = new Map();
      for (const r of transRows){
        const dObjRow = getBestDate(r);
        const dayKey = dObjRow ? formatMMDDYYYY(dObjRow) : "";
        const startMin = parseTimeToMinutes(r[H.TRANS_START]);
        const finishMin = parseTimeToMinutes(r[H.TRANS_FINISH]);

        const key = dayKey || "__NO_DATE__";
        if (!dayMap.has(key)) dayMap.set(key, { minStart: NaN, maxFinish: NaN });

        const d = dayMap.get(key);
        if (Number.isFinite(startMin)) d.minStart = Number.isFinite(d.minStart) ? Math.min(d.minStart, startMin) : startMin;
        if (Number.isFinite(finishMin)) d.maxFinish = Number.isFinite(d.maxFinish) ? Math.max(d.maxFinish, finishMin) : finishMin;
      }

      let weekHours = 0;
      for (const d of dayMap.values()){
        weekHours += spanHours(d.minStart, d.maxFinish);
      }

      const workersSum = transRows.reduce((s,r)=>{
        const w = parseNumber(r[H.TRANS_WORKERS]);
        return s + (w > 0 ? w : 0);
      },0);
      const workersCount = transRows.reduce((s,r)=> s + (parseNumber(r[H.TRANS_WORKERS])>0 ? 1 : 0), 0);
      const avgWorkers = workersCount > 0 ? (workersSum / workersCount) : 0;

      const boardsPerPersonPerHour_completed = (weekHours > 0 && avgWorkers > 0)
        ? (boardsTrans / (avgWorkers * weekHours))
        : NaN;

      const boardsPerPersonPerHour_target = (weekHours > 0 && avgWorkers > 0)
        ? (boardsExpected / (avgWorkers * weekHours))
        : NaN;

      // ---- HARVEST ----
      const harvRows = (growRows||[]).filter(r => isDate(r[H.DATE]));
      const harvestBoards = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_BOARDS]),0);
      const harvestCut = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_CUT]),0);
      const harvestWithWaste = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_WITH_WASTE]),0);

      // ---- SANITATION ----
      const sanRows = (growRows||[]).filter(r => isDate(r[H.SAN_DATE]));
      const cleanedBoards = sanRows.reduce((s,r)=>s+parseNumber(r[H.CLEAN_BOARDS]),0);

      // ---- BROKEN BOARDS (DAY): Sanitation + Transplant + Harvest ----
      const brokenSanWeek   = sanRows.reduce((s,r)=>s+parseNumber(r[H.BROKEN_BOARDS]),0);
      const brokenTransWeek = transRows.reduce((s,r)=>s+parseNumber(r[H.TRANS_BROKEN]),0);
      const brokenHarvWeek  = harvRows.reduce((s,r)=>s+parseNumber(r[H.HARV_BROKEN]),0);
      const brokenBoards = brokenSanWeek + brokenTransWeek + brokenHarvWeek;

      // ---- BROKEN BOARDS (CUMULATIVE up to selected day) ----
      const baseDate = parseAnyDate(BOARD_INV_BASE_DATE_STR);
      const weekEnd = dObj;

      const inRange = (d) => {
        if (!baseDate || !d) return false;
        const t = d.getTime();
        return t >= baseDate.getTime() && t <= weekEnd.getTime();
      };

      const brokenSanSince = (growRows||[])
        .filter(r => inRange(parseAnyDate(r[H.SAN_DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.BROKEN_BOARDS]), 0);

      const brokenTransSince = (growRows||[])
        .filter(r => inRange(parseAnyDate(r[H.TRANS_DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.TRANS_BROKEN]), 0);

      const brokenHarvSince = (growRows||[])
        .filter(r => inRange(parseAnyDate(r[H.DATE])))
        .reduce((s,r)=> s + parseNumber(r[H.HARV_BROKEN]), 0);

      const brokenSinceBaseline = brokenSanSince + brokenTransSince + brokenHarvSince;
      const boardInvRemaining = Math.max(0, BOARD_INV_BASE_COUNT - brokenSinceBaseline);

      // ---- AVG BROKEN (Last 5 weeks, excludes current week) ----
      const wkN = parseInt(wkNum, 10);
      const last5 = [];
      if (Number.isFinite(wkN)) {
        for (let i = 1; i <= 5; i++){
          const w = wkN - i;
          if (w > 0) last5.push(w);
        }
      }
      const last5BrokenValues = last5.map(w => computeWeeklyBrokenBoards(String(w), growRows));
      const last5Avg = last5BrokenValues.length
        ? last5BrokenValues.reduce((a,b)=>a+b,0) / last5BrokenValues.length
        : NaN;

      // ---- PACKING (Pack) ----
      const packDateFields = [H.DATE, "Date", "Pack Date", "Ship Date"];
      const packRowsD = (packRows||[]).filter(r => packDateFields.some(f => (f in r) && isDate(r[f])));
      let cases5=0, units5=0, lbs5=0;
      let cases10=0, units10=0, lbs10=0;
      let lbsAll = 0;

      for (const r of packRowsD){
        const t = skuType(r[H.SKU]);
        const cases = parseNumber(r[H.CASES]);
        if (!t || !cases) continue;
        const units = cases * (PACKS_PER_CASE[t] || 0);
        const lbs = units * (LB_PER_UNIT[t] || 0);

        lbsAll += lbs;
        if (t === "5OZ"){ cases5 += cases; units5 += units; lbs5 += lbs; }
        if (t === "10OZ"){ cases10 += cases; units10 += units; lbs10 += lbs; }
      }

      // ---- SHIPPING (Pack) ----
      let shipReceived=0, shipDonation=0, shipWaste=0, shipSales=0;
      for (const r of packRowsD){
        const lbs = parseNumber(r[H.LBS_SHIPPED]);
        if (!lbs) continue;
        const loc = String(r[H.LOC_SHIPPED] ?? "").trim();
        const locU = loc.toUpperCase();

        if (!locU) continue;
        if (locU === RECEIVED_LOCATION) shipReceived += lbs;
        else if (locU === WASTE_LOCATION) shipWaste += lbs;
        else if (DONATION_LOCATIONS.has(locU)) shipDonation += lbs;
        else shipSales += lbs;
      }

      const hasAny =
        seedRows.length || transRows.length || harvRows.length || sanRows.length || packRowsD.length;

      return {
        wkNum,
        empty: !hasAny,
        counts: { seed: seedRows.length, trans: transRows.length, harv: harvRows.length, san: sanRows.length, pack: packRowsD.length },

        seeding: { completed: flatsCompleted, target: flatsTarget, unit:"Flats" },
        transplant: { completed: plugsCompleted, target: plugsTarget, unit:"Plugs" },

        transplantRate: {
          completed: boardsPerPersonPerHour_completed,
          target: boardsPerPersonPerHour_target,
          unit:"Boards"
        },

        harvestBoards,
        harvestCut,
        harvestWithWaste,

        pack5: { cases: cases5, units: units5, lbs: lbs5 },
        pack10:{ cases: cases10, units: units10, lbs: lbs10 },
        packAllLbs: lbsAll,

        ship: { received: shipReceived, sales: shipSales, donation: shipDonation, waste: shipWaste },

        cleanedBoards,

        brokenBoards,
        brokenBreakdown: { sanitation: brokenSanWeek, transplant: brokenTransWeek, harvest: brokenHarvWeek },

        boardInv: {
          baseDate: BOARD_INV_BASE_DATE_STR,
          baseCount: BOARD_INV_BASE_COUNT,
          weekEnd,
          brokenSinceBaseline,
          brokenSinceBreakdown: { sanitation: brokenSanSince, transplant: brokenTransSince, harvest: brokenHarvSince },
          remaining: boardInvRemaining
        },

        brokenAvg5: {
          weeks: last5,
          values: last5BrokenValues,
          avg: last5Avg
        },

        aux: { weekHours, avgWorkers, boardsTrans, boardsExpected, transRowsCount: transRows.length }
      };
    }

    // =========================================================
    // RENDER
    // =========================================================
    const $ = (id)=>document.getElementById(id);

    function fmtInt(n){ return (Number(n)||0).toLocaleString(undefined,{maximumFractionDigits:0}); }
    function fmt1(n){ return (Number(n)||0).toLocaleString(undefined,{maximumFractionDigits:1}); }

    function pctClass(p){
      if (!Number.isFinite(p)) return "muted";
      if (p >= 100) return "good";
      if (p >= 90) return "warn";
      return "bad";
    }

    function pctPill(completed, target){
      if (!(target > 0)) return `<span class="pill muted">—</span>`;
      const p = (completed/target)*100;
      return `<span class="pill ${pctClass(p)}">${p.toFixed(0)}%</span>`;
    }

    function pctValue(completed, target){
      if (!(target > 0)) return NaN;
      return (completed/target)*100;
    }

    function safeText(elId, text){
      const el = $(elId);
      if (el) el.textContent = text;
    }

    function renderHighlights(summary){
      const baseLine = `Base ${fmtInt(BOARD_INV_BASE_COUNT)} @ ${BOARD_INV_BASE_DATE_STR}`;
      const periodLabel = $("hi-period-label");
      if (periodLabel) periodLabel.textContent = (viewMode === "day") ? "Day" : "Week";
      const dayPill = (viewMode === "day") ? formatDayPill(selectedDateISO) : "";

      if (!summary || !summary.wkNum || summary.empty){
        safeText("hi-week", (viewMode === "day" && selectedDateISO) ? dayPill : "—");
        safeText("hi-range", "—");
        safeText("hi-best", "—");
        safeText("hi-best-label", "—");
        safeText("hi-worst", "—");
        safeText("hi-worst-label", "—");
        safeText("hi-sales", "—");
        safeText("hi-ship-note", "—");

        safeText("inv-left", "—");
        safeText("inv-sub", baseLine);

        safeText("avg-broken-5", "—");
        safeText("avg-broken-5-sub", "Last 5 weeks: —");

        renderCallouts(summary);
        return;
      }

      safeText("hi-week", (viewMode === "day") ? dayPill : `Week ${summary.wkNum}`);
      safeText(
        "hi-range",
        `Hours: ${summary.aux.weekHours ? summary.aux.weekHours.toFixed(2) : "0.00"} • Avg workers: ${summary.aux.avgWorkers ? summary.aux.avgWorkers.toFixed(2) : "0.00"}`
      );

      const candidates = [
        { label:"Seeding", pct: pctValue(summary.seeding.completed, summary.seeding.target) },
        { label:"Transplant (Plugs)", pct: pctValue(summary.transplant.completed, summary.transplant.target) },
        { label:"Transplant Rate", pct: pctValue(summary.transplantRate.completed, summary.transplantRate.target) },
      ].filter(x => Number.isFinite(x.pct));

      let best = null, worst = null;
      for (const c of candidates){
        if (!best || c.pct > best.pct) best = c;
        if (!worst || c.pct < worst.pct) worst = c;
      }

      safeText("hi-best", best ? `${Math.round(best.pct)}%` : "—");
      safeText("hi-best-label", best ? best.label : "—");
      safeText("hi-worst", worst ? `${Math.round(worst.pct)}%` : "—");
      safeText("hi-worst-label", worst ? worst.label : "—");

      safeText("hi-sales", fmtInt(summary.ship.sales));
      safeText("hi-ship-note", `Received: ${fmtInt(summary.ship.received)} • Donation: ${fmtInt(summary.ship.donation)}`);

      // Inventory KPI (cumulative up to selected week end)
      safeText("inv-left", fmtInt(summary.boardInv?.remaining ?? 0));
      const b = summary.boardInv?.brokenSinceBreakdown || {sanitation:0, transplant:0, harvest:0};
      const asOf = summary.boardInv?.weekEnd ? formatMMDDYYYY(summary.boardInv.weekEnd) : "—";
      safeText(
        "inv-sub",
        `${baseLine} • As of: ${asOf} • Broken since: ${fmtInt(summary.boardInv?.brokenSinceBaseline ?? 0)} (San ${fmtInt(b.sanitation)} + Trans ${fmtInt(b.transplant)} + Harv ${fmtInt(b.harvest)}) • This week: ${fmtInt(summary.brokenBoards ?? 0)}`
      );

      // Avg broken last 5
      const avg5 = summary.brokenAvg5?.avg;
      safeText("avg-broken-5", Number.isFinite(avg5) ? fmtInt(Math.round(avg5)) : "—");
      const wks = summary.brokenAvg5?.weeks || [];
      safeText("avg-broken-5-sub", wks.length ? `Weeks: ${wks.join(", ")}` : "Weeks: —");

      renderCallouts(summary);
    }

    function renderCallouts(summary){
      const wrap = $("callouts");
      if (!wrap) return;

      const periodTitle = (viewMode === "day") ? "Day" : "Week";
      const periodValue = (viewMode === "day") ? formatDayPill(selectedDateISO) : (summary?.wkNum ?? "—");
      const periodLabel = (viewMode === "day") ? `${periodTitle} ${periodValue}` : `${periodTitle} ${periodValue}`;

      if (!summary || !summary.wkNum){
        wrap.innerHTML = `
          <div class="callout warn"><span class="dot"></span><span>No valid ${viewMode === "day" ? "days" : "weeks"} found. Check ${viewMode === "day" ? "date" : "week"} columns for blanks/#VALUE!</span></div>
        `;
        return;
      }

      if (summary.empty){
        wrap.innerHTML = `
          <div class="callout warn"><span class="dot"></span><span>No data for ${periodLabel}.</span></div>
        `;
        return;
      }

      const items = [];

      if (summary.seeding.target > 0){
        const p = (summary.seeding.completed/summary.seeding.target)*100;
        items.push({ cls: p >= 100 ? "" : p >= 90 ? "warn" : "bad", text: `Seeding: ${Math.round(p)}%` });
      }

      if (summary.transplant.target > 0){
        const p = (summary.transplant.completed/summary.transplant.target)*100;
        items.push({ cls: p >= 100 ? "" : p >= 90 ? "warn" : "bad", text: `Transplant: ${Math.round(p)}%` });
      }

      if (summary.cleanedBoards > 0){
        items.push({ cls:"", text:`Cleaned boards: ${fmtInt(summary.cleanedBoards)} (Sanitation Week)` });
      }

      if (summary.brokenBoards > 0){
        const bb = summary.brokenBreakdown || {sanitation:0, transplant:0, harvest:0};
        items.push({
          cls:"warn",
          text:`Broken boards: ${fmtInt(summary.brokenBoards)} (San ${fmtInt(bb.sanitation)} + Trans ${fmtInt(bb.transplant)} + Harv ${fmtInt(bb.harvest)})`
        });
      }

      if (summary.boardInv?.remaining || summary.boardInv?.remaining === 0){
        items.push({ cls:"", text:`Board inventory (est): ${fmtInt(summary.boardInv.remaining)} remaining` });
      }

      if (summary.ship.sales > 0){
        items.push({ cls:"", text:`Shipping Sales: ${fmtInt(summary.ship.sales)} lbs` });
      }

      wrap.innerHTML = items.slice(0,6).map(i => `
        <div class="callout ${i.cls}">
          <span class="dot"></span>
          <span>${i.text}</span>
        </div>
      `).join("");

      if (!wrap.innerHTML.trim()){
        wrap.innerHTML = `<div class="callout warn"><span class="dot"></span><span>${periodLabel}: Nothing to highlight yet.</span></div>`;
      }
    }

    function renderTable(summary){
      const tbody = $("tbody");
      if (!tbody) return;

      if (!summary || !summary.wkNum){
        tbody.innerHTML = "";
        return;
      }

      if (summary.empty){
        const periodLabel = (viewMode === "day") ? `Day ${formatDayPill(selectedDateISO)}` : `Week ${summary.wkNum}`;
        tbody.innerHTML = `
          <tr>
            <td class="row-label">No data for ${periodLabel}</td>
            <td>—</td><td>—</td><td>—</td><td><span class="pill muted">—</span></td>
          </tr>
        `;
        return;
      }

      const rows = [];
      const pushIfMeaningful = (obj, isMeaningful) => { if (isMeaningful) rows.push(obj); };

      pushIfMeaningful({
        label:"Seeding",
        completed: fmtInt(summary.seeding.completed),
        target: fmtInt(summary.seeding.target),
        units: summary.seeding.unit,
        pct: pctPill(summary.seeding.completed, summary.seeding.target)
      }, (summary.counts.seed > 0) || (summary.seeding.completed !== 0) || (summary.seeding.target !== 0));

      pushIfMeaningful({
        label:"Transplant",
        completed: fmtInt(summary.transplant.completed),
        target: fmtInt(summary.transplant.target),
        units: summary.transplant.unit,
        pct: pctPill(summary.transplant.completed, summary.transplant.target)
      }, (summary.counts.trans > 0) || (summary.transplant.completed !== 0) || (summary.transplant.target !== 0));

      const rateC = summary.transplantRate.completed;
      const rateT = summary.transplantRate.target;
      const rateOkC = Number.isFinite(rateC) && rateC > 0;
      const rateOkT = Number.isFinite(rateT) && rateT > 0;

      pushIfMeaningful({
        label:"Transplant - Boards/Person/Hour",
        completed: rateOkC ? fmt1(rateC) : "—",
        target: rateOkT ? fmt1(rateT) : "—",
        units: "Boards",
        pct: (rateOkC && rateOkT) ? pctPill(rateC, rateT) : `<span class="pill muted">—</span>`
      }, (summary.counts.trans > 0) || rateOkC || rateOkT);

      pushIfMeaningful({ label:"Harvest", completed: fmtInt(summary.harvestBoards), target:"—", units:"Boards", pct:`<span class="pill muted">—</span>` },
        (summary.counts.harv > 0) || summary.harvestBoards !== 0);

      pushIfMeaningful({ label:"Harvest - Lechuga", completed: fmtInt(summary.harvestCut), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.harv > 0) || summary.harvestCut !== 0);

      pushIfMeaningful({ label:"Harvest - Lechuga Con Waste", completed: fmtInt(summary.harvestWithWaste), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.harv > 0) || summary.harvestWithWaste !== 0);

      pushIfMeaningful({
        label:"Pack - 5OZ",
        completed: fmtInt(summary.pack5.cases),
        target:"—",
        units: `${fmtInt(summary.pack5.units)} Units · ${fmtInt(summary.pack5.lbs)} Lbs`,
        pct:`<span class="pill muted">—</span>`
      }, (summary.counts.pack > 0) || summary.pack5.cases !== 0 || summary.pack5.units !== 0 || summary.pack5.lbs !== 0);

      pushIfMeaningful({
        label:"Pack - 10OZ",
        completed: fmtInt(summary.pack10.cases),
        target:"—",
        units: `${fmtInt(summary.pack10.units)} Units · ${fmtInt(summary.pack10.lbs)} Lbs`,
        pct:`<span class="pill muted">—</span>`
      }, (summary.counts.pack > 0) || summary.pack10.cases !== 0 || summary.pack10.units !== 0 || summary.pack10.lbs !== 0);

      pushIfMeaningful({
        label:"Pack - All",
        completed: fmtInt(summary.packAllLbs),
        target:"—",
        units:"Lbs",
        pct:`<span class="pill muted">—</span>`
      }, (summary.counts.pack > 0) || summary.packAllLbs !== 0);

      pushIfMeaningful({ label:"Shipping - Received", completed: fmtInt(summary.ship.received), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.pack > 0) || summary.ship.received !== 0);

      pushIfMeaningful({ label:"Shipping - Sales", completed: fmtInt(summary.ship.sales), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.pack > 0) || summary.ship.sales !== 0);

      pushIfMeaningful({ label:"Shipping - Donation", completed: fmtInt(summary.ship.donation), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.pack > 0) || summary.ship.donation !== 0);

      pushIfMeaningful({ label:"Shipping - Waste", completed: fmtInt(summary.ship.waste), target:"—", units:"Lbs", pct:`<span class="pill muted">—</span>` },
        (summary.counts.pack > 0) || summary.ship.waste !== 0);

      pushIfMeaningful({ label:"# of Cleaned Boards", completed: fmtInt(summary.cleanedBoards), target:"—", units:"Boards", pct:`<span class="pill muted">—</span>` },
        (summary.counts.san > 0) || summary.cleanedBoards !== 0);

      pushIfMeaningful({ label:"# of Broken Boards", completed: fmtInt(summary.brokenBoards), target:"—", units:"Boards", pct:`<span class="pill muted">—</span>` },
        (summary.counts.san > 0) || (summary.counts.trans > 0) || (summary.counts.harv > 0) || summary.brokenBoards !== 0);

      if (!rows.length){
        const periodLabel = (viewMode === "day") ? `Day ${formatDayPill(selectedDateISO)}` : `Week ${summary.wkNum}`;
        rows.push({
          label:periodLabel,
          completed:"—",
          target:"—",
          units:"—",
          pct:`<span class="pill muted">—</span>`
        });
      }

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td class="row-label">${r.label}</td>
          <td>${r.completed}</td>
          <td>${r.target}</td>
          <td>${r.units}</td>
          <td>${r.pct}</td>
        </tr>
      `).join("");
    }

    function setChip(id, ok, text){
      const el = $(id);
      if (!el) return;
      el.innerHTML = ok
        ? `<span class="chip-dot"></span><span>${text}</span>`
        : `<span class="chip-danger-dot"></span><span>${text}</span>`;
    }

    function setHint(msg){ const el=$("hint"); if (el) el.textContent = msg || ""; }
    function setDebug(msg){
      const el = $("debug");
      if (!el) return;
      if (!msg) { el.style.display="none"; el.textContent=""; return; }
      el.style.display="block";
      el.textContent = msg;
    }

    // =========================================================
    // MAIN LOAD/RENDER
    // =========================================================
    let GROW_ROWS = [];
    let PACK_ROWS = [];
    let WEEKS = [];
    let selectedWeek = "";
    let viewMode = "week";
    let selectedDateISO = "";

    function loadData(){
      const grow = loadJson(MASTER_GROW_KEY);
      const pack = loadJson(MASTER_PACK_KEY);

      const growOk = !!grow?.sheets?.[CANON_GROW_SHEET];
      const packOk = !!pack?.sheets?.[CANON_PACK_SHEET];

      setChip("chip-grow", growOk, growOk ? "Grow: Loaded" : "Grow: Missing");
      setChip("chip-pack", packOk, packOk ? "Pack: Loaded" : "Pack: Missing");

      const warnEl = $("chip-warn");
      if (warnEl) warnEl.style.display = (growOk && packOk) ? "none" : "inline-flex";

      GROW_ROWS = growOk ? sheetToObjects(grow.sheets[CANON_GROW_SHEET]) : [];
      PACK_ROWS = packOk ? sheetToObjects(pack.sheets[CANON_PACK_SHEET]) : [];

      const growPing = localStorage.getItem(MASTER_GROW_PING_KEY) || "";
      const packPing = localStorage.getItem(MASTER_PACK_PING_KEY) || "";
      const lu = $("lastUpdated");
      if (lu){
        const parts = [];
        if (growPing) parts.push("Grow: " + new Date(Number(growPing)).toLocaleString());
        if (packPing) parts.push("Pack: " + new Date(Number(packPing)).toLocaleString());
        lu.textContent = parts.length ? parts.join(" · ") : "—";
      }

      WEEKS = collectWeeks(GROW_ROWS, PACK_ROWS);

      if (selectedWeek && !weekNumFromCell(selectedWeek)) selectedWeek = "";

      if (!WEEKS.length){
        setHint(
          "No valid weeks found.\n\nFix:\n- In the week columns, remove blanks/#VALUE!\n- Confirm the week cells are numbers like 51 (or 'Week 51')\n- Columns: Seed Week / Transplant Week / Harvest Week / Pack Week / Sanitation Week"
        );
      } else {
        setHint("");
      }
    }

    function renderWeekOptions(){
      const sel = $("weekSelect");
      if (!sel) return;

      const current = weekNumFromCell(selectedWeek);
      const currentValid = !!(current && WEEKS.includes(current));

      sel.innerHTML = WEEKS.map(w => `<option value="${String(w)}">Week ${String(w)}</option>`).join("");

      if (currentValid) {
        selectedWeek = current;
        sel.value = current;
      } else {
        const isoWeek = getCurrentISOWeek();
        const fallback = WEEKS.includes(isoWeek) ? isoWeek : (WEEKS[WEEKS.length-1] || "");
        selectedWeek = fallback;
        sel.value = selectedWeek;
      }
    }

    function normalizeDateISO(value){
      const d = parseAnyDate(value);
      return d ? toISODateStr(d) : "";
    }

    function setDefaultDateSelection(){
      const todayISO = toISODateStr(new Date());
      if (hasAnyDataForDateISO(todayISO, GROW_ROWS, PACK_ROWS)) selectedDateISO = todayISO;
      else selectedDateISO = getMostRecentDataDateISO(GROW_ROWS, PACK_ROWS);
      const dateInput = $("dateSelect");
      if (dateInput) dateInput.value = selectedDateISO || "";
    }

    function updateViewControls(){
      const weekPicker = $("weekPicker");
      const datePicker = $("datePicker");
      const btnWeek = $("toggleWeekly");
      const btnDay = $("toggleDaily");
      if (weekPicker) weekPicker.hidden = (viewMode !== "week");
      if (datePicker) datePicker.hidden = (viewMode !== "day");
      if (btnWeek) {
        btnWeek.classList.add("pill");
        btnWeek.classList.toggle("good", viewMode === "week");
        btnWeek.classList.toggle("muted", viewMode !== "week");
      }
      if (btnDay) {
        btnDay.classList.add("pill");
        btnDay.classList.toggle("good", viewMode === "day");
        btnDay.classList.toggle("muted", viewMode !== "day");
      }
    }

    function render(){
      const title = $("panelTitle");
      if (viewMode === "day") {
        const dObj = parseAnyDate(selectedDateISO);
        const dayLabel = dObj ? formatDayPill(dObj) : "—";
        if (title) title.textContent = "Day " + dayLabel;

        const summary = computeDaySummary(selectedDateISO, GROW_ROWS, PACK_ROWS);
        if (!summary || !summary.wkNum){
          renderHighlights({ wkNum:null });
          renderTable({ wkNum:null });
          setDebug("");
          return;
        }

        renderHighlights(summary);
        renderTable(summary);

        if (!summary.empty){
          setDebug(
            `Transplant diagnostics:\n` +
            `- rows in day: ${summary.aux.transRowsCount}\n` +
            `- boards transplanted (sum): ${summary.aux.boardsTrans.toLocaleString()}\n` +
            `- expected boards (sum): ${summary.aux.boardsExpected.toLocaleString()}\n` +
            `- avg workers (day): ${summary.aux.avgWorkers ? summary.aux.avgWorkers.toFixed(2) : "0"}\n` +
            `- total hours (sum of daily spans): ${summary.aux.weekHours ? summary.aux.weekHours.toFixed(2) : "0"}\n` +
            `\nNote: If transplant date is missing, time collapses into one bucket for the day.`
          );
        } else {
          setDebug("");
        }
        return;
      }

      const wk = weekNumFromCell(selectedWeek);

      if (!wk){
        if (title) title.textContent = "Week –";
        renderHighlights({ wkNum:null });
        renderTable({ wkNum:null });
        setDebug("");
        return;
      }

      const summary = computeWeekSummary(wk, GROW_ROWS, PACK_ROWS);

      if (title) title.textContent = "Week " + wk;

      renderHighlights(summary);
      renderTable(summary);

      if (!summary.empty){
        setDebug(
          `Transplant diagnostics:\n` +
          `- rows in week: ${summary.aux.transRowsCount}\n` +
          `- boards transplanted (sum): ${summary.aux.boardsTrans.toLocaleString()}\n` +
          `- expected boards (sum): ${summary.aux.boardsExpected.toLocaleString()}\n` +
          `- avg workers (week): ${summary.aux.avgWorkers ? summary.aux.avgWorkers.toFixed(2) : "0"}\n` +
          `- total hours (sum of daily spans): ${summary.aux.weekHours ? summary.aux.weekHours.toFixed(2) : "0"}\n` +
          `\nNote: If transplant date is missing, time collapses into one bucket for the week.`
        );
      } else {
        setDebug("");
      }
    }

    // =========================================================
    // LIVE REFRESH
    // =========================================================
    let reloadTimer = null;
    function reloadAll(){
      if (reloadTimer) clearTimeout(reloadTimer);
      reloadTimer = setTimeout(() => {
        reloadTimer = null;
        loadData();
        renderWeekOptions();
        updateViewControls();

        if (viewMode === "day") {
          const normalized = normalizeDateISO(selectedDateISO);
          if (!normalized) {
            setDefaultDateSelection();
          } else {
            selectedDateISO = normalized;
            const dateInput = $("dateSelect");
            if (dateInput) dateInput.value = selectedDateISO;
          }
        }

        const wk = weekNumFromCell(selectedWeek);
        if (wk && !WEEKS.includes(wk)) {
          selectedWeek = WEEKS[WEEKS.length-1] || "";
        }

        render();
      }, 60);
    }

    function setupListeners(){
      window.addEventListener("storage", (e) => {
        if (!e) return;
        if ([MASTER_GROW_KEY, MASTER_PACK_KEY, MASTER_GROW_PING_KEY, MASTER_PACK_PING_KEY].includes(e.key)) reloadAll();
      });

      window.addEventListener(MSG_GROW, () => reloadAll());
      window.addEventListener(MSG_PACK, () => reloadAll());
      document.addEventListener(MSG_GROW, () => reloadAll());
      document.addEventListener(MSG_PACK, () => reloadAll());

      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === MSG_GROW || msg.type === "MASTER_GROW_UPDATED") reloadAll();
        if (msg.type === MSG_PACK || msg.type === "MASTER_PACK_UPDATED") reloadAll();
      });

      if (bc){
        bc.onmessage = (ev) => {
          const msg = ev?.data;
          if (msg?.type === MSG_GROW) reloadAll();
          if (msg?.type === MSG_PACK) reloadAll();
        };
      }

      let lastGrowLen = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
      let lastPackLen = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
      setInterval(() => {
        const gl = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
        const pl = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
        if (gl !== lastGrowLen || pl !== lastPackLen) {
          lastGrowLen = gl; lastPackLen = pl;
          reloadAll();
        }
      }, 1500);
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupListeners();
      loadData();
      renderWeekOptions();
      updateViewControls();

      const sel = $("weekSelect");
      sel?.addEventListener("change", () => {
        selectedWeek = weekNumFromCell(sel.value) || "";
        if (selectedWeek) sel.value = selectedWeek;
        render();
      });

      const dateSel = $("dateSelect");
      dateSel?.addEventListener("change", () => {
        selectedDateISO = normalizeDateISO(dateSel.value);
        if (selectedDateISO) dateSel.value = selectedDateISO;
        render();
      });

      const toggleWeekly = $("toggleWeekly");
      const toggleDaily = $("toggleDaily");
      toggleWeekly?.addEventListener("click", () => {
        viewMode = "week";
        updateViewControls();
        renderWeekOptions();
        render();
      });
      toggleDaily?.addEventListener("click", () => {
        viewMode = "day";
        updateViewControls();
        setDefaultDateSelection();
        render();
      });

      reloadAll();
    });
  </script>
</body>
</html>
