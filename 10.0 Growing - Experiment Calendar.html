<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Experiment Calendar (PR Time)</title>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --border: rgba(148,163,184,.16);
      --border2: rgba(148,163,184,.10);
      --text:#e5e7eb;
      --sub:#a7b0be;
      --muted:#7c8798;
      --accent:#22c55e;

      --seed:#60a5fa;
      --prop:#f59e0b;
      --trans:#ff3ea5;
      --harv:#a78bfa;

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --gRowH: 44px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1100px 600px at 22% -20%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(900px 700px at 80% 90%, rgba(167,139,250,.10), transparent 60%),
        var(--bg);
    }

    .wrap{ max-width: 1320px; margin: 22px auto 120px; padding: 0 18px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:16px 18px;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,23,42,.72), rgba(2,6,23,.62));
      box-shadow: var(--shadow2);
      position: sticky; top: 12px; z-index: 20;
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }
    .titleBlock{ min-width: 260px; }
    .title{ font-weight: 900; letter-spacing:.2px; font-size: 18px; line-height:1.1; }
    .subtitle{ color: var(--sub); font-size: 12px; margin-top: 4px; line-height:1.25; }

    .actions{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .btn{
      border: 1px solid var(--border);
      background: rgba(2,6,23,.55);
      color: var(--text);
      font-weight: 900;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.03) inset;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(148,163,184,.28); }
    .btn.primary{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.10));
      box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset, 0 14px 35px rgba(0,0,0,.35);
    }
    .kbd{ font-family: var(--mono); font-size: 11px; font-weight: 800; color: var(--sub); border:1px solid var(--border2); padding:6px 9px; border-radius:999px; background: rgba(2,6,23,.35); }
    .modeDot{ width:10px; height:10px; border-radius:999px; background: var(--muted); box-shadow: 0 0 0 3px rgba(255,255,255,.06); }
    .btn.mode.on{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .btn.mode.on .modeDot{ background: var(--accent); }

    .chips{ display:flex; align-items:center; flex-wrap: wrap; gap:8px; justify-content:center; flex: 1 1 auto; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(2,6,23,.55);
      color: var(--text);
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .chip .dot{ width:9px; height:9px; border-radius:999px; background: var(--muted); box-shadow:0 0 0 3px rgba(255,255,255,.06); }
    .chip.on{ border-color: rgba(34,197,94,.40); background: rgba(34,197,94,.10); }
    .chip.on .dot{ background: var(--accent); }
    .chip.seed.on{ border-color: rgba(96,165,250,.40); background: rgba(96,165,250,.10); }
    .chip.seed.on .dot{ background: var(--seed); }
    .chip.prop.on{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.10); }
    .chip.prop.on .dot{ background: var(--prop); }
    .chip.trans.on{ border-color: rgba(255,62,165,.35); background: rgba(255,62,165,.10); }
    .chip.trans.on .dot{ background: var(--trans); }
    .chip.harv.on{ border-color: rgba(167,139,250,.40); background: rgba(167,139,250,.10); }
    .chip.harv.on .dot{ background: var(--harv); }

    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px; }
    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(15,23,42,.62), rgba(2,6,23,.58));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .panel .hdr{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border2);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      flex-wrap: wrap;
    }
    .panel .hdr .h{ font-weight: 950; font-size: 13px; letter-spacing:.2px; }
    .panel .hdr .s{ margin-top:3px; color: var(--sub); font-size: 11px; line-height:1.25; }
    .panel .body{ padding: 14px 16px 16px; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 1080px){ .row2{ grid-template-columns: 1fr; } }

    .label{ color: var(--sub); font-size: 11px; font-weight: 800; margin-bottom: 6px; }
    .field{ margin-bottom: 12px; }
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      background: rgba(2,6,23,.55);
      border: 1px solid var(--border2);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      font-weight: 700;
      font-size: 12px;
    }
    textarea{ font-family: var(--mono); min-height: 180px; resize: vertical; line-height: 1.25; }

    .summary{
      margin: 10px 0 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.10);
      font-family: var(--mono);
      font-size: 11px;
      color: #fecaca;
    }
    .errorBanner{
      display:none;
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      color: #fecaca;
    }
    .tip{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(245,158,11,.28);
      background: rgba(245,158,11,.10);
      color: #fde68a;
      font-size: 11px;
      font-weight: 900;
      line-height: 1.25;
    }

    .mainHdr{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border2);
      background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(2,6,23,.0));
      flex-wrap: wrap;
    }
    .viewTabs{
      display:flex; gap:6px; padding:4px;
      border: 1px solid var(--border2);
      border-radius: 999px;
      background: rgba(2,6,23,.45);
      flex-wrap: wrap;
    }
    .tab{
      padding:7px 12px; border-radius:999px; cursor:pointer; user-select:none;
      font-weight: 950; font-size: 12px; color: var(--sub); white-space:nowrap;
    }
    .tab.on{ background: rgba(15,23,42,.72); color: var(--text); border: 1px solid rgba(148,163,184,.16); }

    .metaRow{
      display:flex; align-items:center; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      color: var(--sub); font-size: 12px; font-weight: 850;
    }
    .metaPill{
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      padding: 7px 10px;
      border-radius: 999px;
      color: var(--sub);
      font-weight: 900;
      font-size: 11px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .metaPill.clickable{ cursor:pointer; }
    .metaPill .dot{ width: 8px; height: 8px; border-radius:999px; background: var(--muted); box-shadow:0 0 0 3px rgba(255,255,255,.05); }
    .metaPill.on .dot{ background: #39ff14; }

    .mainBody{ padding: 14px; }

    /* Agenda */
    .agenda{ display:flex; flex-direction:column; gap:10px; }
    .dayGroup{ border-radius: 18px; border: 1px solid var(--border2); background: rgba(2,6,23,.40); overflow:hidden; }
    .dayHdr{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 12px; border-bottom: 1px solid var(--border2); cursor:pointer; }
    .dayHdr .left{ display:flex; flex-direction:column; gap:2px; }
    .dayHdr .date{ font-weight: 950; font-size: 13px; color: var(--text); }
    .dayHdr .mini{ color: var(--sub); font-size: 11px; font-weight: 850; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius:999px;
      border: 1px solid var(--border2);
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-weight: 950;
      font-size: 11px;
      white-space:nowrap;
    }
    .groups{ padding: 10px 10px 12px; display:flex; flex-direction:column; gap:10px; }
    .groupRow{ border-radius:16px; border:1px solid var(--border2); background: rgba(15,23,42,.25); overflow:hidden; }
    .groupHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; cursor:pointer; user-select:none; }
    .groupHead .l{ display:flex; align-items:center; gap:10px; min-width:0; }
    .groupHead .title{ font-size:12px; font-weight:950; margin:0; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .groupHead .count{ width:26px; height:26px; display:grid; place-items:center; border-radius:999px; border:1px solid var(--border2); background: rgba(2,6,23,.35); color: var(--sub); font-weight:950; font-size:12px; }
    .groupBody{ display:none; }
    .groupRow.open .groupBody{ display:block; }
    .items{ padding:10px; display:flex; flex-direction:column; gap:10px; border-top:1px solid var(--border2); }
    .item{ border-radius:16px; border:1px solid var(--border2); background: rgba(2,6,23,.35); padding:10px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .item .meta{ display:flex; flex-direction:column; gap:8px; min-width:0; }
    .item .name{ font-weight:950; font-size:12px; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pills{ display:flex; flex-wrap:wrap; gap:6px; }
    .pill{ border:1px solid var(--border2); background: rgba(15,23,42,.35); color: var(--sub); font-weight:900; font-size:11px; padding:6px 8px; border-radius:999px; white-space:nowrap; }
    .pill.seed{ border-color: rgba(96,165,250,.25); }
    .pill.prop{ border-color: rgba(245,158,11,.25); }
    .pill.trans{ border-color: rgba(255,62,165,.25); }
    .pill.harv{ border-color: rgba(167,139,250,.25); }

    /* Month */
    .monthTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
    .monthName{ font-weight:950; letter-spacing:.2px; font-size:13px; color: var(--text); }
    .dowRow{ display:grid; grid-template-columns: repeat(7,1fr); gap:10px; padding: 6px 2px 10px; color: var(--sub); font-size:11px; font-weight:950; text-align:center; letter-spacing:.3px; }
    .monthGrid{ display:grid; grid-template-columns: repeat(7,1fr); gap:10px; }
    .cell{ min-height:92px; border-radius:16px; border:1px solid var(--border2); background: rgba(2,6,23,.42); overflow:hidden; cursor:pointer; position: relative; }
    .cell:hover{ border-color: rgba(148,163,184,.25); }
    .cell.out{ opacity:.45; filter:saturate(.8); }
    .cell.holiday{ border-color: rgba(239,68,68,.32) !important; box-shadow: 0 0 0 2px rgba(239,68,68,.08) inset; background: linear-gradient(180deg, rgba(239,68,68,.06), rgba(2,6,23,.35)); }
    .cell .d{ padding:10px 10px 6px; display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:950; color: var(--sub); font-size:12px; }
    .cell .dots{ display:flex; gap:6px; align-items:center; }
    .miniDot{ width:7px; height:7px; border-radius:999px; background: var(--muted); box-shadow:0 0 0 3px rgba(255,255,255,.05); }
    .miniDot.seed{ background: var(--seed); }
    .miniDot.prop{ background: var(--prop); }
    .miniDot.trans{ background: var(--trans); }
    .miniDot.harv{ background: var(--harv); }
    .lines{ padding:6px 8px 10px; display:flex; flex-direction:column; gap:6px; }
    .line{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:7px 8px; border-radius:12px; border:1px solid var(--border2); background: rgba(15,23,42,.35); color: var(--sub); font-size:11px; font-weight:900; }
    .line strong{ color: var(--text); font-weight:950; }
    .bar{ width:3px; height:14px; border-radius:999px; background: var(--muted); flex: 0 0 auto; }
    .bar.seed{ background: var(--seed); }
    .bar.prop{ background: var(--prop); }
    .bar.trans{ background: var(--trans); }
    .bar.harv{ background: var(--harv); }
    .more{ border:1px dashed rgba(148,163,184,.22); background: rgba(2,6,23,.25); color: var(--sub); font-family: var(--mono); }

    /* Gantt */
    .ganttWrap{ display:grid; grid-template-columns: 1fr; gap:12px; align-items:start; }
    .ganttRight,.ganttLeft{ border:1px solid var(--border2); border-radius:18px; overflow:hidden; background: rgba(2,6,23,.35); }
    .gHdr{
      padding:10px 12px; border-bottom:1px solid var(--border2);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(15,23,42,.55), rgba(2,6,23,.0));
      flex-wrap: wrap; position: relative;
      min-height: 54px;
      padding-top: 34px; /* base; stackHeaderTags will increase dynamically */
    }
    .gHdr .h{ font-weight:950; font-size:12px; color: var(--text); }
    .gHdr .s{ font-weight:900; font-size:11px; color: var(--sub); font-family: var(--mono); }
    .legend{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .legItem{ display:inline-flex; align-items:center; gap:7px; padding:6px 9px; border-radius:999px; border:1px solid rgba(148,163,184,.14); background: rgba(2,6,23,.28); color: var(--sub); font-weight:900; font-size:11px; }
    .legSwatch{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 3px rgba(255,255,255,.05); background: var(--muted); }
    .legSwatch.today{ background: rgba(34,197,94,.95); }
    .legSwatch.holiday{ background: rgba(239,68,68,.95); }
    .legSwatch.harv{ background: rgba(167,139,250,.95); }

    /* header tag layer (height is set dynamically in JS) */
    .gHdrLineLayer{
      position:absolute; left:0; top:6px;
      height:80px;
      width:100%;
      pointer-events:none;
      z-index:30;
      overflow:visible;
    }
    .gHdrLineLayer .lineTag{ position:absolute; top:0; transform: translateX(-50%); }

    .timelineScroll{ overflow-x: hidden; overflow-y: visible; }
    .timeline{ position: relative; padding:10px 10px 14px; min-height:120px; }
    .timelineTopAxis{
      position: sticky; top:0; z-index:12;
      background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.65));
      backdrop-filter: blur(8px);
      height:66px; border-bottom: 1px solid rgba(148,163,184,.10);
      overflow: visible;
    }
    .tick{
      position:absolute; top:30px;
      width:26px; text-align:center;
      font-family: var(--mono);
      font-size:10px; color: rgba(167,176,190,.70);
      padding:0 2px; cursor:help; user-select:none;
    }
    .tick .dow{ display:block; font-size:9px; color: rgba(167,176,190,.78); font-weight:900; }
    .tick .d{ display:block; margin-top:1px; }
    .tick .m{ display:block; font-size: 9px; color: rgba(167,176,190,.55); }
    .tick.lit{
      color: rgba(229,231,235,.95);
      background: transparent;
      border: 0px solid transparent;
      border-radius: 4px;
      box-shadow: none;
    }
    .tick.litHoliday{
      background: transparent;
      border-color: transparent;
    }

    .holidayBand{ position:absolute; top:0; bottom:0; background: rgba(239,68,68,.05); pointer-events:none; }

    /* KEEP ONLY THIN FULL-HEIGHT LINES */
    .todayLine{
      position:absolute; top:0; bottom:0;
      width:2px;
      background: rgba(34,197,94,.95);
      z-index:6; pointer-events:none;
      box-shadow: 0 0 0 1px rgba(34,197,94,.18), 0 0 14px rgba(34,197,94,.16);
      border-radius: 999px;
    }
    .holidayLine{
      position:absolute; top:0; bottom:0;
      width:2px;
      background: rgba(239,68,68,.95);
      z-index:5; pointer-events:none;
      box-shadow: 0 0 0 1px rgba(239,68,68,.16), 0 0 14px rgba(239,68,68,.12);
      border-radius: 999px;
    }

    /* Harvest full-height line (one per unique harvest date) */
    .harvLine{
      position:absolute; top:0; bottom:0;
      width:2px;
      background: rgba(167,139,250,.95);
      z-index:4;
      pointer-events:none;
      box-shadow: 0 0 0 1px rgba(167,139,250,.16), 0 0 14px rgba(167,139,250,.12);
      border-radius: 999px;
      opacity:.75;
      /* IMPORTANT: keep translateX(-50%) so line centers on same math as diamond */
      transform: translateX(-50%);
    }

    .lineTag{
      position:absolute; top:2px; transform: translateX(-50%);
      font-family: var(--mono); font-size:10px; font-weight:950;
      padding:4px 7px; border-radius:999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.88);
      color: rgba(229,231,235,.92);
      white-space:nowrap;
      z-index:20;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      pointer-events:none;
    }
    .lineTag.today{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
    .lineTag.holiday{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.08); color:#fecaca; }
    .lineTag.harv{ border-color: rgba(167,139,250,.35); background: rgba(167,139,250,.10); color: rgba(229,231,235,.95); }

    .setRowLeft{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148,163,184,.08);
      display:flex; flex-direction:column; gap:8px;
      cursor:pointer; user-select:none;
    }
    .setRowLeft:hover{ background: rgba(255,255,255,.02); }
    .setRowLeft.selected{ outline: 2px solid rgba(34,197,94,.18); background: rgba(34,197,94,.06); }
    .setRowLeft.hovered{ outline: 2px solid rgba(148,163,184,.16); background: rgba(148,163,184,.06); }
    .setRowLeft.selected.hovered{ outline: 2px solid rgba(34,197,94,.22); background: rgba(34,197,94,.08); }
    .setHeadLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .setTitle{ font-weight:950; font-size:12px; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chevMini{
      width:26px; height:26px; border-radius:999px;
      border: 1px solid rgba(148,163,184,.14);
      display:grid; place-items:center;
      background: rgba(2,6,23,.35);
      color: var(--sub);
      font-weight:950; font-family: var(--mono);
      transition: transform .15s ease;
      flex: 0 0 auto;
    }
    .setRowLeft.open .chevMini{ transform: rotate(180deg); }
    .setMeta{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .miniPill{ border:1px solid rgba(148,163,184,.14); background: rgba(15,23,42,.35); color: var(--sub); font-weight:900; font-size:11px; padding:5px 7px; border-radius:999px; white-space:nowrap; }
    .miniPill.seed{ border-color: rgba(96,165,250,.25); }
    .miniPill.prop{ border-color: rgba(245,158,11,.25); }
    .miniPill.trans{ border-color: rgba(255,62,165,.25); }
    .miniPill.harv{ border-color: rgba(167,139,250,.35); background: rgba(167,139,250,.10); color: rgba(229,231,235,.9); }

    .setDetails{ display:none; margin-top:4px; border-top: 1px solid rgba(148,163,184,.10); padding-top:10px; gap:8px; flex-direction:column; }
    .setRowLeft.open .setDetails{ display:flex; }
    .detailRow{ border:1px solid rgba(148,163,184,.12); background: rgba(2,6,23,.30); border-radius:14px; padding:8px 9px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .detailKey{ font-family: var(--mono); font-size:10px; color: rgba(167,176,190,.75); font-weight:900; padding:4px 7px; border-radius:999px; border:1px solid rgba(148,163,184,.10); background: rgba(15,23,42,.22); }

    .setBarRow{ position: relative; height: var(--gRowH); border-bottom: 1px solid rgba(148,163,184,.06); overflow:hidden; }
    .setBarRow.hovered{ background: rgba(148,163,184,.06); }
    .setBarRow.selected{ background: rgba(34,197,94,.06); }
    .setBarRow.selected.hovered{ background: rgba(34,197,94,.08); }

    .seg{
      position:absolute; top:50%; transform: translateY(-50%);
      height:20px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.35);
      min-width: 4px;
      z-index:2;
    }
    .seg.seed{ border-color: rgba(96,165,250,.28); background: rgba(96,165,250,.12); }
    .seg.prop{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.12); }
    .seg.trans{ border-color: rgba(255,62,165,.28); background: rgba(255,62,165,.12); }

    .segLabel{
      position:absolute; top:50%;
      transform: translate(-50%,-50%);
      font-family: var(--mono);
      font-size:10px; font-weight:900;
      color: rgba(229,231,235,.78);
      white-space:nowrap;
      z-index:3;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
      pointer-events:none;
    }

    /* KEEP HARVEST DIAMONDS */
    .harvMarker{
      position:absolute; top:50%;
      transform: translate(-50%,-50%) rotate(45deg);
      width:12px; height:12px;
      border-radius:3px;
      background: rgba(167,139,250,.95);
      z-index:4;
      pointer-events:none;
      box-shadow: 0 0 0 2px rgba(167,139,250,.18), 0 0 22px rgba(167,139,250,.20);
    }

    .gTip{
      position: fixed; z-index: 9999;
      pointer-events: none; display: none;
      max-width: 420px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.92);
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 12px;
      line-height: 1.25;
    }
    .gTip .k{ font-family: var(--mono); font-size: 11px; color: rgba(167,176,190,.85); font-weight: 900; }
    .gTip .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .gTip .tag{ font-family: var(--mono); font-size: 11px; font-weight: 900; padding: 4px 7px; border-radius: 999px; border: 1px solid rgba(148,163,184,.14); background: rgba(15,23,42,.45); color: rgba(229,231,235,.82); white-space:nowrap; }
    .gTip .tag.harv{ border-color: rgba(167,139,250,.28); background: rgba(167,139,250,.12); color: rgba(229,231,235,.92); }

    .modalBack{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:80; }
    .modalBack.open{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      max-height: min(86vh, 860px);
      border-radius: 22px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,.82), rgba(2,6,23,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      backdrop-filter: blur(10px);
    }
    .modalHdr{ padding: 14px; border-bottom: 1px solid var(--border2); display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .modalHdr .t{ display:flex; flex-direction:column; gap:4px; }
    .modalHdr .t .h{ font-weight:950; font-size:14px; color: var(--text); }
    .modalHdr .t .s{ color: var(--sub); font-size:11px; font-weight:850; line-height:1.25; }
    .modalHdr .x{ width:34px; height:34px; border-radius:999px; border:1px solid var(--border2); background: rgba(2,6,23,.45); color: var(--text); font-weight:950; cursor:pointer; }
    .modalBody{ padding:12px 14px 14px; overflow:auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <div class="title">Experiment Calendar</div>
        <div class="subtitle">
          Paste TSV → filter → <b>Agenda / Month / Gantt</b>.<br/>
          <b>PR time (UTC-4)</b> enforced for all dates (device timezone doesn’t matter).
        </div>
      </div>

      <div class="chips" id="milestoneChips">
        <div class="chip seed on" data-k="seed"><span class="dot"></span>Seed</div>
        <div class="chip prop on" data-k="prop"><span class="dot"></span>Propagation Start</div>
        <div class="chip trans on" data-k="trans"><span class="dot"></span>Transplant</div>
        <div class="chip harv on" data-k="harv"><span class="dot"></span>Harvest</div>
      </div>

      <div class="actions">
        <button class="btn mode on" id="historyToggle" title="Toggle showing harvested sets">
          <span class="modeDot"></span><span id="historyToggleLabel">Active only</span>
        </button>
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn primary" id="buildBtn">Build / Refresh</button>
        <span class="kbd">Ctrl/⌘ + Enter</span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="hdr">
          <div>
            <div class="h">Filters</div>
            <div class="s">Active-only sets, agenda/month range, Gantt full lifecycle</div>
          </div>
          <button class="btn" id="filtersToggle" aria-pressed="false">Show filters</button>
        </div>
        <div class="body" id="filtersBody">
          <div class="field">
            <div class="label">Search (batch / variety / experiment)</div>
            <input id="q" type="text" placeholder="e.g. SM8, Gladius, Rockwool..." />
          </div>

          <div class="row2">
            <div class="field">
              <div class="label">Experiment</div>
              <select id="fExperiment"></select>
            </div>
            <div class="field">
              <div class="label">Media</div>
              <select id="fMedia"></select>
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <div class="label">Grow Pond (post-transplant)</div>
              <select id="fPond"></select>
            </div>
            <div class="field">
              <div class="label">Range (Agenda/Month)</div>
              <select id="fRange">
                <option value="60">Next 60 days</option>
                <option value="90">Next 90 days</option>
                <option value="120">Next 120 days</option>
                <option value="365">Next 365 days</option>
                <option value="9999">All</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <div class="label">Start date (also used as “Today”)</div>
              <input id="startDate" type="date" />
            </div>
            <div class="field">
              <div class="label">TSV Input</div>
              <button class="btn" id="toggleTSV">Show TSV</button>
            </div>
          </div>

          <div class="tip">
            <b>PR Time enforced:</b> all day math uses <b>UTC-4</b> (Puerto Rico, no DST).<br/>
            Active-only rule: if <b>Harvest Date</b> is before “Today”, it’s hidden (unless history is on).
          </div>

          <div class="summary errorBanner" id="errorBanner"></div>

          <div id="tsvBox" style="display:none; margin-top:12px;">
            <div class="summary" id="buildSummary">Rows parsed: 0<br/>Rows skipped: 0<br/>Events created: 0</div>
            <textarea id="tsv" placeholder="Paste TSV here..."></textarea>
            <div class="s" style="color:var(--sub); font-size:11px; margin-top:8px;">Saved automatically in your browser (localStorage).</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="mainHdr">
          <div class="viewTabs">
            <div class="tab" id="tabAgenda">Agenda</div>
            <div class="tab" id="tabMonth">Month</div>
            <div class="tab on" id="tabGantt">Gantt</div>
          </div>
          <div class="metaRow">
            <span class="metaPill clickable" id="metaActiveMode"><span class="dot"></span><span id="metaActiveModeText">Active only</span></span>
            <span class="metaPill" id="eventCountBadge">0 events</span>
            <span class="metaPill" id="metaRange">Start: — End: —</span>
            <span class="metaPill" id="metaTZ">TZ: PR (UTC-4)</span>
          </div>
        </div>

        <div class="mainBody">
          <div id="agendaView" class="agenda"></div>

          <div id="monthView" style="display:none;">
            <div class="monthTop">
              <div class="monthName" id="monthName">—</div>
              <div class="actions">
                <button class="btn" id="prevMonth">‹ Prev</button>
                <button class="btn" id="thisMonth">This month</button>
                <button class="btn" id="nextMonth">Next ›</button>
              </div>
            </div>
            <div class="dowRow">
              <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="monthGrid" id="monthGrid"></div>
          </div>

          <div id="ganttView" style="display:block;">
            <div class="ganttWrap">
              <div class="ganttRight">
                <div class="gHdr">
                  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div class="h">Timeline</div>
                    <div class="s" id="ganttSpan">—</div>
                  </div>
                  <div class="legend">
                    <span class="legItem"><span class="legSwatch today"></span>Today</span>
                    <span class="legItem"><span class="legSwatch holiday"></span>Holiday</span>
                    <span class="legItem"><span class="legSwatch harv"></span>Harvest</span>
                  </div>
                </div>
                <div class="timelineScroll" id="ganttRightScroll">
                  <div class="timeline" id="ganttTimeline">
                    <div class="timelineTopAxis" id="ganttAxis"></div>
                    <div id="ganttRows"></div>
                  </div>
                </div>
              </div>

              <div class="ganttLeft">
                <div class="gHdr" style="padding-top:10px;">
                  <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div class="h">Sets (merged)</div>
                    <div class="s" id="ganttCount">0</div>
                    <button class="btn" id="collapseSetsBtn" style="padding:6px 10px; font-size:11px; font-weight:900;">Collapse all</button>
                  </div>
                  <div class="s" style="color:var(--sub);">Click a set to expand details.</div>
                </div>
                <div class="scroll" id="ganttLeftBody" style="overflow:visible;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="gTip" id="ganttTip" role="tooltip" aria-hidden="true"></div>

  <div class="modalBack" id="dayModalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHdr">
        <div class="t">
          <div class="h" id="dayModalTitle">—</div>
          <div class="s" id="dayModalSub">—</div>
        </div>
        <button class="x" id="dayModalClose" title="Close">✕</button>
      </div>
      <div class="modalBody" id="dayModalBody"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // PR TIMEZONE (Puerto Rico) — fixed offset UTC-4, no DST
    // All "day" math uses PR midnight regardless of device timezone.
    // =========================================================
    const PR_OFFSET_MIN = -4 * 60; // UTC-4

    const MS = 24*60*60*1000;
    const $ = (id)=>document.getElementById(id);

    function pad2(n){ return String(n).padStart(2,"0"); }

    // CSS.escape fallback (fixes runtime errors on browsers missing CSS.escape)
    function cssEscapeSafe(v){
      const s = String(v ?? "");
      if (window.CSS && typeof CSS.escape === "function") return CSS.escape(s);
      // minimal safe escape for attribute selectors
      return s.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    }

    // Convert an absolute UTC ms -> {y,m,d} in PR time
    function partsInPR(ms){
      const shifted = ms + PR_OFFSET_MIN * 60000;
      const u = new Date(shifted);
      return { y: u.getUTCFullYear(), m: u.getUTCMonth()+1, d: u.getUTCDate() };
    }

    function startOfDayPRFromMs(ms){
      const p = partsInPR(ms);
      const utcMs = Date.UTC(p.y, p.m-1, p.d) - PR_OFFSET_MIN*60000;
      return new Date(utcMs);
    }

    function dateFromISO_PR(iso){
      const m = String(iso||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return null;
      const y = +m[1], mo = +m[2], d = +m[3];
      const utcMs = Date.UTC(y, mo-1, d) - PR_OFFSET_MIN*60000;
      return new Date(utcMs);
    }

    function toISO_PR(dateObj){
      const p = partsInPR(dateObj.getTime());
      return `${p.y}-${pad2(p.m)}-${pad2(p.d)}`;
    }

    function addDaysPR(dateObj, n){
      const s = startOfDayPRFromMs(dateObj.getTime());
      return new Date(s.getTime() + n*MS);
    }

    function getTodayPR(){
      return startOfDayPRFromMs(Date.now());
    }

    function fmtDowISO_PR(dateObj){
      if(!dateObj) return "—";
      const p = partsInPR(dateObj.getTime());
      const u = new Date(Date.UTC(p.y, p.m-1, p.d));
      const wd = u.toLocaleDateString(undefined, { weekday:"short", timeZone:"UTC" });
      return `${wd} ${p.y}-${pad2(p.m)}-${pad2(p.d)}`;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function safeNum(v){
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function parseDate(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      if(s.includes("January 0, 1900")) return null;
      if(s.includes("Saturday, January 0, 1900")) return null;

      const iso = dateFromISO_PR(s);
      if(iso) return iso;

      const d1 = new Date(s);
      if(!isNaN(d1.getTime())){
        if(d1.getFullYear() <= 1901) return null;
        return startOfDayPRFromMs(d1.getTime());
      }

      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const mm = Number(m[1]), dd = Number(m[2]), yy = Number(m[3]);
        if(yy <= 1901) return null;
        const utcMs = Date.UTC(yy, mm-1, dd) - PR_OFFSET_MIN*60000;
        return new Date(utcMs);
      }
      return null;
    }

    // =========================================================
    // Company Holidays — Keys MUST be YYYY-MM-DD (PR day)
    // =========================================================
    const COMPANY_HOLIDAYS = new Map([
      ["2026-01-01", "New Year's Day"],
      ["2026-01-06", "Epiphany"],
      ["2026-02-16", "President's Day"],
      ["2026-04-03", "Good Friday"],
      ["2026-05-25", "Memorial Day"],
      ["2026-07-04", "Independence Day"],
      ["2026-07-25", "PR Constitution Day"],
      ["2026-09-07", "Labor Day"],
      ["2026-10-12", "Columbus Day"],
      ["2026-11-26", "Thanksgiving"],
      ["2026-11-27", "Black Friday"],
      ["2026-12-25", "Christmas Day"],
    ]);
    function getHolidayName(dateISO){ return COMPANY_HOLIDAYS.get(dateISO) || ""; }

    // =========================================================
    // State
    // =========================================================
    const state = {
      rawTSV: "",
      rows: [],
      events: [],
      filtered: [],
      view: "gantt",
      monthCursor: null,

      q: "",
      experiment: "All",
      media: "All",
      pond: "All",
      rangeDays: 60,
      startDate: null,

      milestoneOn: { seed:true, prop:true, trans:true, harv:true },
      includeHarvested: false,

      selectedSetKey: null,
      openSetKeys: new Set(),
      _ganttDom: null,
      filtersCollapsed: true,
      tsvCollapsed: true,
    };

    const DEFAULT_TSV = ``;

    // =========================================================
    // TSV Parsing (header-based)
    // =========================================================
    const FIELD_ALIASES = {
      experiment: ["Experiment Name/Purpose","Experiment","Experiment Name"],
      batch: ["Batch"],
      variety: ["Variety"],
      media: ["Media"],

      seedDate: ["seed/germ","Seed","Germination Date","Seed Date","Seed/Germ"],
      propDate: ["propagation start date","Propagation Start","Prop Start","Propagation Start Date"],
      transDate: ["transplant date","Transplant Date"],
      harvestDate: ["Harvest Date","Harvested Date","Harvest"],

      propPond: ["Prop Pond","Propagation Pond","Propagation Pond #","Propag Pond"],
      growPond: ["Pond","Grow Pond","Transplant Pond","Grow Pond #"],

      pos: ["Pos","Position","Position ID"],

      flats: ["Flats"],
      actualFlats: ["Actual Flats"],
      plugs: ["Plugs"],
      seededPlugs: ["Seeded Plugs"],
      transplantedPlugs: ["Trans-planted plugs","Transplanted plugs","Trans-planted Plugs"],
      expectedBoards: ["Expected Boards Transplanted"],
      forecastBoards: ["Forecasted Boards Transplanted"],
      actualBoards: ["Actual Boards Transplanted"],
      emergence: ["Actual Emergence %","Emergence %"],
      lossActual: ["Actual Loss"],
    };

    function buildHeaderIndex(headerCells){
      const idx = new Map();
      headerCells.forEach((h,i)=> idx.set(h.trim(), i));
      function pick(aliasList){
        for(const a of aliasList){
          if(idx.has(a)) return idx.get(a);
        }
        return -1;
      }
      return {
        experiment: pick(FIELD_ALIASES.experiment),
        batch: pick(FIELD_ALIASES.batch),
        variety: pick(FIELD_ALIASES.variety),
        media: pick(FIELD_ALIASES.media),

        seedDate: pick(FIELD_ALIASES.seedDate),
        propDate: pick(FIELD_ALIASES.propDate),
        transDate: pick(FIELD_ALIASES.transDate),
        harvestDate: pick(FIELD_ALIASES.harvestDate),

        propPond: pick(FIELD_ALIASES.propPond),
        growPond: pick(FIELD_ALIASES.growPond),
        pos: pick(FIELD_ALIASES.pos),

        flats: pick(FIELD_ALIASES.flats),
        actualFlats: pick(FIELD_ALIASES.actualFlats),
        plugs: pick(FIELD_ALIASES.plugs),
        seededPlugs: pick(FIELD_ALIASES.seededPlugs),
        transplantedPlugs: pick(FIELD_ALIASES.transplantedPlugs),
        expectedBoards: pick(FIELD_ALIASES.expectedBoards),
        forecastBoards: pick(FIELD_ALIASES.forecastBoards),
        actualBoards: pick(FIELD_ALIASES.actualBoards),
        emergence: pick(FIELD_ALIASES.emergence),
        lossActual: pick(FIELD_ALIASES.lossActual),
      };
    }

    function parseTSV(tsv){
      const text = String(tsv ?? "").replace(/\r/g,"").trim();
      if(!text) return { rows:[], skipped:0, parsed:0 };

      const lines = text.split("\n").filter(l=>l.trim().length>0);
      if(lines.length < 2) return { rows:[], skipped:0, parsed:0 };

      const header = lines[0].split("\t");
      const H = buildHeaderIndex(header);

      const rows = [];
      let skipped = 0;

      for(let i=1;i<lines.length;i++){
        const cells = lines[i].split("\t");
        const get = (j)=> (j>=0 && j<cells.length) ? String(cells[j] ?? "").trim() : "";

        const experiment = get(H.experiment) || "";
        const batch = get(H.batch) || "";
        const variety = get(H.variety) || "";
        const media = get(H.media) || "";
        const propPond = get(H.propPond) || "";
        const growPond = get(H.growPond) || "";
        const pos = get(H.pos) || "";

        const seedD = parseDate(get(H.seedDate));
        const propD = parseDate(get(H.propDate));
        const transD = parseDate(get(H.transDate));
        const harvD = parseDate(get(H.harvestDate));

        const hasAny = experiment || batch || variety || media || propPond || growPond || pos || seedD || propD || transD || harvD;
        if(!hasAny){ skipped++; continue; }

        rows.push({
          i,
          experiment, batch, variety, media,
          propPond: (propPond||"").trim(),
          growPond: (growPond||"").trim(),
          pos: (pos||"").trim(),

          seedDate: seedD,
          propDate: propD,
          transDate: transD,
          harvestDate: harvD,

          flats: safeNum(get(H.flats)),
          actualFlats: safeNum(get(H.actualFlats)),
          plugs: safeNum(get(H.plugs)),
          seededPlugs: safeNum(get(H.seededPlugs)),
          transplantedPlugs: safeNum(get(H.transplantedPlugs)),
          expectedBoards: safeNum(get(H.expectedBoards)),
          forecastBoards: safeNum(get(H.forecastBoards)),
          actualBoards: safeNum(get(H.actualBoards)),
          emergence: get(H.emergence) || "",
          lossActual: get(H.lossActual) || "",
        });
      }

      return { rows, skipped, parsed: rows.length };
    }

    function kindLabel(kind){
      if(kind==="seed") return "Seed";
      if(kind==="prop") return "Propagation Start";
      if(kind==="trans") return "Transplant";
      return "Harvest";
    }
    function kindColorClass(kind){
      if(kind==="seed") return "seed";
      if(kind==="prop") return "prop";
      if(kind==="trans") return "trans";
      return "harv";
    }

    function isRowActive(row, todayPR){
      const h = row.harvestDate;
      if(!h) return true;
      return h.getTime() >= todayPR.getTime();
    }

    function makeEvent(kind, dateObj, row){
      const dateISO = toISO_PR(dateObj);
      const pondForStage =
        (kind === "prop") ? row.propPond :
        (kind === "trans" || kind === "harv") ? row.growPond :
        (row.propPond || "");

      const title = `${kindLabel(kind)}${pondForStage ? ` — Pond ${pondForStage}` : ""}`;

      return {
        kind,
        date: dateObj,
        dateISO,
        title,
        experiment: row.experiment || "",
        batch: row.batch || "",
        variety: row.variety || "",
        media: row.media || "",
        propPond: row.propPond || "",
        growPond: row.growPond || "",
        pos: row.pos || "",
        harvestDate: row.harvestDate || null,
      };
    }

    function expandEvents(rows){
      const events = [];
      for(const r of rows){
        const germ = r?.dates?.germination || r.seedDate;
        const prop = r?.dates?.propagation || r.propDate;
        const trans = r?.dates?.transplant || r.transDate;
        const harv = r?.dates?.harvest || r.harvestDate;

        if(germ)  events.push(makeEvent("seed",  germ,  r));
        if(prop)  events.push(makeEvent("prop",  prop,  r));
        if(trans) events.push(makeEvent("trans", trans, r));
        if(harv)  events.push(makeEvent("harv",  harv,  r));
      }
      events.sort((a,b)=> a.date - b.date || a.kind.localeCompare(b.kind) || (a.batch||"").localeCompare(b.batch||""));
      return events;
    }

    // =========================================================
    // Supabase loader + normalization (object-based format)
    // =========================================================
    const SUPABASE_EXPERIMENTS_URL = "https://lxxysrhhmtjikzpmupqb.supabase.co/storage/v1/object/public/campo-data/master/experiments.json";

    function showError(msg){
      const el = $("errorBanner");
      if(!el) return;
      if(!msg){
        el.textContent = "";
        el.style.display = "none";
        return;
      }
      el.textContent = msg;
      el.style.display = "block";
    }

    function headerIndex(headers){
      const idx = {};
      (headers || []).forEach((h,i)=>{
        const key = String(h ?? "").trim().toLowerCase();
        if(key && !(key in idx)) idx[key] = i;
      });
      return idx;
    }

    function getByHeader(row, idx, key){
      const i = idx[String(key || "").trim().toLowerCase()];
      return (i === undefined) ? "" : (row?.[i] ?? "");
    }

    function firstByHeaders(row, idx, keys){
      for(const k of keys){
        const v = getByHeader(row, idx, k);
        if(String(v ?? "").trim()) return v;
      }
      return "";
    }

    function parseFlag(v){
      if(v === true) return true;
      const s = String(v ?? "").trim().toLowerCase();
      if(!s) return false;
      if(["1","true","yes","y","x","done","complete"].includes(s)) return true;
      const n = Number(s);
      return Number.isFinite(n) ? n > 0 : false;
    }

    function normalizeFromRow(row, idx){
      const experiment_name = firstByHeaders(row, idx, [
        "Production Stage",
        "Experiment Name/Purpose",
        "Experiment",
        "Experiment Name",
        "Reason for Reduction in Germination/ Emergence"
      ]);
      const batch = firstByHeaders(row, idx, ["Batch"]);
      const variety = firstByHeaders(row, idx, ["Variety"]);
      const media = firstByHeaders(row, idx, ["Media"]);
      const propPond = firstByHeaders(row, idx, ["Prop Pond"]);
      const growPond = firstByHeaders(row, idx, ["Pond"]);
      const pos = firstByHeaders(row, idx, ["Pos"]);

      const germination = parseDate(firstByHeaders(row, idx, ["seed/germ","Seed","Germination Date","Seed Date","Seed/Germ"]));
      const propagation = parseDate(firstByHeaders(row, idx, ["propagation start date","Propagation Start","Prop Start","Propagation Start Date"]));
      const transplant = parseDate(firstByHeaders(row, idx, ["transplant date","Transplant Date"]));
      const harvest = parseDate(firstByHeaders(row, idx, ["Harvest Date","Harvested Date","Harvest"]));

      const seededPlugs = safeNum(firstByHeaders(row, idx, ["Seeded Plugs"]));
      const transplantedPlugs = safeNum(firstByHeaders(row, idx, ["Trans-planted plugs","Transplanted plugs","Trans-planted Plugs"]));
      const boards = safeNum(firstByHeaders(row, idx, ["Actual Boards Transplanted"]));

      const flags = {
        germination: parseFlag(firstByHeaders(row, idx, ["Germination"])),
        propagation: parseFlag(firstByHeaders(row, idx, ["Propagation"])),
        production: parseFlag(firstByHeaders(row, idx, ["Production"])),
        harvested: parseFlag(firstByHeaders(row, idx, ["Harvested"])),
      };

      return {
        experiment_name: String(experiment_name || "").trim(),
        batch: String(batch || "").trim(),
        variety: String(variety || "").trim(),
        media: String(media || "").trim(),
        propPond: String(propPond || "").trim(),
        growPond: String(growPond || "").trim(),
        pos: String(pos || "").trim(),
        dates: { germination, propagation, transplant, harvest },
        meta: { seededPlugs, transplantedPlugs, boards },
        flags,
      };
    }

    function normalizeFromObject(obj){
      const experiment_name = obj?.experiment_name || obj?.experiment || obj?.name || "";
      const batch = obj?.batch || "";
      const variety = obj?.variety || "";
      const media = obj?.media || "";
      const propPond = obj?.propPond ?? obj?.prop_pond ?? "";
      const growPond = obj?.growPond ?? obj?.grow_pond ?? obj?.pond ?? "";
      const pos = obj?.pos ?? "";

      const datesIn = obj?.dates || {};
      const germination = parseDate(datesIn.germination ?? obj?.germination ?? obj?.germination_date ?? obj?.seedDate);
      const propagation = parseDate(datesIn.propagation ?? obj?.propagation ?? obj?.propagation_date ?? obj?.propDate);
      const transplant = parseDate(datesIn.transplant ?? obj?.transplant ?? obj?.transplant_date ?? obj?.transDate);
      const harvest = parseDate(datesIn.harvest ?? obj?.harvest ?? obj?.harvest_date ?? obj?.harvestDate);

      const metaIn = obj?.meta || {};
      const seededPlugs = safeNum(metaIn.seededPlugs ?? metaIn.seeded_plugs ?? obj?.seededPlugs ?? obj?.seeded_plugs);
      const transplantedPlugs = safeNum(metaIn.transplantedPlugs ?? metaIn.transplanted_plugs ?? obj?.transplantedPlugs ?? obj?.transplanted_plugs);
      const boards = safeNum(metaIn.boards ?? metaIn.actualBoards ?? obj?.boards ?? obj?.actualBoards);

      const flagsIn = obj?.flags || {};
      const flags = {
        germination: parseFlag(flagsIn.germination ?? obj?.germination),
        propagation: parseFlag(flagsIn.propagation ?? obj?.propagation),
        production: parseFlag(flagsIn.production ?? obj?.production),
        harvested: parseFlag(flagsIn.harvested ?? obj?.harvested),
      };

      return {
        experiment_name: String(experiment_name || "").trim(),
        batch: String(batch || "").trim(),
        variety: String(variety || "").trim(),
        media: String(media || "").trim(),
        propPond: String(propPond || "").trim(),
        growPond: String(growPond || "").trim(),
        pos: String(pos || "").trim(),
        dates: { germination, propagation, transplant, harvest },
        meta: { seededPlugs, transplantedPlugs, boards },
        flags,
      };
    }

    function isValidNormalizedRow(r){
      const batch = String(r?.batch || "").trim();
      const variety = String(r?.variety || "").trim();
      const media = String(r?.media || "").trim();
      const d = r?.dates || {};
      const hasDate = !!(d.germination || d.propagation || d.transplant || d.harvest);
      return !!(batch || variety || media || hasDate);
    }

    function normalizeExperiments(raw){
      if(Array.isArray(raw)){
        return raw.map(normalizeFromObject).filter(isValidNormalizedRow);
      }

      const sheet = raw?.sheets?.["Current Experiments"];
      if(sheet && Array.isArray(sheet.rows)){
        const rows = sheet.rows;
        const headerRowIndex = rows.findIndex(r =>
          Array.isArray(r) &&
          r.some(c => String(c ?? "").trim() === "Batch") &&
          (r.some(c => String(c ?? "").trim() === "Variety") || r.some(c => String(c ?? "").trim() === "Harvest Date"))
        );

        if(headerRowIndex >= 0){
          const headers = rows[headerRowIndex];
          const idx = headerIndex(headers);
          return rows.slice(headerRowIndex + 1).map(r => normalizeFromRow(r, idx)).filter(isValidNormalizedRow);
        }

        if(Array.isArray(sheet.headers) && sheet.headers.some(h => String(h ?? "").trim())){
          const idx = headerIndex(sheet.headers);
          return rows.map(r => normalizeFromRow(r, idx)).filter(isValidNormalizedRow);
        }
      }

      if(Array.isArray(raw?.rows) && Array.isArray(raw?.headers)){
        const idx = headerIndex(raw.headers);
        return raw.rows.map(r => normalizeFromRow(r, idx)).filter(isValidNormalizedRow);
      }

      return [];
    }

    async function loadData(){
      showError("");
      try{
        const bust = SUPABASE_EXPERIMENTS_URL + (SUPABASE_EXPERIMENTS_URL.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(bust, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        const normalized = normalizeExperiments(raw);

        if(!normalized.length){
          showError("Experiments loaded but no rows were found in the payload.");
        }

        // Compatibility fields for existing UI
        const rows = normalized.map(r => ({
          ...r,
          experiment: r.experiment_name || "",
          seedDate: r.dates?.germination || null,
          propDate: r.dates?.propagation || null,
          transDate: r.dates?.transplant || null,
          harvestDate: r.dates?.harvest || null,
          propPond: r.propPond || "",
          growPond: r.growPond || "",
          pos: r.pos || "",
          seededPlugs: r.meta?.seededPlugs ?? null,
          transplantedPlugs: r.meta?.transplantedPlugs ?? null,
          actualBoards: r.meta?.boards ?? null,
        }));

        state.rows = rows;
        state.events = expandEvents(state.rows);
        rebuildFilterOptions();

        const byKind = { seed:0, prop:0, trans:0, harv:0 };
        for(const e of state.events) byKind[e.kind]++;

        $("buildSummary").innerHTML =
          `Loaded from Supabase<br/>` +
          `Rows: ${state.rows.length}<br/>` +
          `Events: ${state.events.length} (Seed ${byKind.seed}, Prop ${byKind.prop}, Trans ${byKind.trans}, Harvest ${byKind.harv})`;

        if(!state.selectedSetKey){
          const sets = buildSetsFromRows(state.rows);
          if(sets[0]) state.selectedSetKey = sets[0].key;
        }

        render();
      }catch(err){
        console.error(err);
        showError(`Failed to load experiments.json from Supabase. ${err.message || err}`);
        state.rows = [];
        state.events = [];
        rebuildFilterOptions();
        render();
      }
    }

    // =========================================================
    // Filtering
    // =========================================================
    function applyFilters(){
      const q = state.q.trim().toLowerCase();
      const start = startOfDayPRFromMs(state.startDate.getTime());
      const end = (state.rangeDays>=9999) ? null : addDaysPR(start, state.rangeDays);
      const today = getTodayPR();
      const on = state.milestoneOn;

      const out = [];
      for(const e of state.events){
        if(!state.includeHarvested){
          if(e.harvestDate && e.harvestDate.getTime() < today.getTime()) continue;
        }
        if(!on[e.kind]) continue;
        if(e.date < start) continue;
        if(end && e.date >= end) continue;

        if(state.experiment!=="All" && e.experiment!==state.experiment) continue;
        if(state.media!=="All" && e.media!==state.media) continue;
        if(state.pond!=="All"){
          if(String(e.growPond||"") !== String(state.pond)) continue;
        }

        if(q){
          const hay = `${e.experiment} ${e.batch} ${e.variety} ${e.media} ${e.propPond} ${e.growPond} ${e.pos}`.toLowerCase();
          if(!hay.includes(q)) continue;
        }
        out.push(e);
      }

      state.filtered = out;
      const endLabel = (state.rangeDays>=9999) ? "∞" : toISO_PR(addDaysPR(end, -1));
      $("metaRange").textContent = `Start: ${toISO_PR(start)}  End: ${endLabel}`;
      $("eventCountBadge").textContent = `${out.length} events`;

      $("metaActiveMode").classList.toggle("on", !state.includeHarvested);
      $("metaActiveModeText").textContent = state.includeHarvested ? "History included" : "Active only";

      return { start, end };
    }

    // =========================================================
    // Agenda + Month
    // =========================================================
    function groupAgenda(events, rangeStart, rangeEnd){
      const dayMap = new Map();
      for(const e of events){
        if(!dayMap.has(e.dateISO)) dayMap.set(e.dateISO, []);
        dayMap.get(e.dateISO).push(e);
      }

      for(const [dateISO] of COMPANY_HOLIDAYS.entries()){
        const d = dateFromISO_PR(dateISO);
        if(!d) continue;
        if(d < rangeStart) continue;
        if(rangeEnd && d >= rangeEnd) continue;
        if(!dayMap.has(dateISO)) dayMap.set(dateISO, []);
      }

      const days = Array.from(dayMap.entries())
        .map(([dateISO, items])=>{
          items.sort((a,b)=> a.kind.localeCompare(b.kind) || String(a.growPond||"").localeCompare(String(b.growPond||"")));
          return { dateISO, date: dateFromISO_PR(dateISO), items };
        })
        .sort((a,b)=> a.date - b.date);

      for(const day of days){
        const gm = new Map();
        for(const e of day.items){
          const pondKey =
            (e.kind==="prop") ? (e.propPond||"") :
            (e.kind==="trans"||e.kind==="harv") ? (e.growPond||"") :
            (e.propPond||"");
          const key = `${e.kind}||${pondKey}`;
          if(!gm.has(key)) gm.set(key, []);
          gm.get(key).push(e);
        }

        const groups = Array.from(gm.entries()).map(([key, items])=>{
          const [kind, pond] = key.split("||");
          items.sort((a,b)=> (a.batch||"").localeCompare(b.batch||"") || (a.variety||"").localeCompare(b.variety||""));
          return { kind, pond, items };
        });

        const order = { seed:0, prop:1, trans:2, harv:3 };
        groups.sort((a,b)=> (order[a.kind]-order[b.kind]) || String(a.pond||"").localeCompare(String(b.pond||"")));
        day.groups = groups;
      }

      return days;
    }

    function monthSummary(events){
      const m = new Map();
      for(const e of events){
        if(!m.has(e.dateISO)) m.set(e.dateISO, { kinds:new Set(), groups:new Map() });
        const obj = m.get(e.dateISO);
        obj.kinds.add(e.kind);

        const pondKey =
          (e.kind==="prop") ? (e.propPond||"") :
          (e.kind==="trans"||e.kind==="harv") ? (e.growPond||"") :
          (e.propPond||"");

        const gk = `${e.kind}||${pondKey}`;
        obj.groups.set(gk, (obj.groups.get(gk) || 0) + 1);
      }
      return m;
    }

    function renderAgenda(rangeStart, rangeEnd){
      const host = $("agendaView");
      host.innerHTML = "";
      const days = groupAgenda(state.filtered, rangeStart, rangeEnd);

      if(!days.length){
        host.innerHTML = `<div class="summary" style="border-color: rgba(148,163,184,.22); background: rgba(2,6,23,.35); color: var(--sub);">
          No events in the selected filters/range.
        </div>`;
        return;
      }

      for(const day of days){
        const holidayName = getHolidayName(day.dateISO);
        const isHoliday = !!holidayName;

        const p = partsInPR(day.date.getTime());
        const u = new Date(Date.UTC(p.y, p.m-1, p.d));
        const nice = u.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric", timeZone:"UTC" });

        const dayEl = document.createElement("div");
        dayEl.className = "dayGroup";

        dayEl.innerHTML = `
          <div class="dayHdr">
            <div class="left">
              <div class="date">${escapeHtml(nice)}</div>
              <div class="mini">${day.groups.length} group${day.groups.length===1?"":"s"} • ${day.items.length} item${day.items.length===1?"":"s"}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              ${isHoliday ? `<span class="badge" style="border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08); color:#fecaca;">Not onsite • ${escapeHtml(holidayName)}</span>` : ""}
              <span class="badge">${day.items.length} total</span>
            </div>
          </div>
          <div class="groups"></div>
        `;

        const groupsHost = dayEl.querySelector(".groups");
        const order = { seed:0, prop:1, trans:2, harv:3 };

        day.groups.sort((a,b)=> (order[a.kind]-order[b.kind]) || String(a.pond||"").localeCompare(String(b.pond||"")));

        day.groups.forEach((g)=>{
          const gr = document.createElement("div");
          gr.className = "groupRow";

          const label = kindLabel(g.kind);
          const pondPart = g.pond ? ` — Pond ${g.pond}` : "";

          gr.innerHTML = `
            <div class="groupHead">
              <div class="l">
                <span class="bar ${kindColorClass(g.kind)}"></span>
                <div class="title">${escapeHtml(label + pondPart)}</div>
                <div class="count">${g.items.length}</div>
              </div>
              <div style="color:var(--sub); font-size:12px; font-weight:900; white-space:nowrap;">Click to expand</div>
            </div>
            <div class="groupBody"><div class="items"></div></div>
          `;

          const itemsHost = gr.querySelector(".items");
          for(const e of g.items){
            const batchTitle = e.batch ? `Batch ${e.batch}` : (e.variety || e.experiment || "Item");
            const pondLabel =
              (e.kind==="prop") ? (e.propPond ? `Prop Pond ${e.propPond}` : "") :
              (e.kind==="trans"||e.kind==="harv") ? (e.growPond ? `Grow Pond ${e.growPond}` : "") :
              (e.propPond ? `Prop Pond ${e.propPond}` : "");

            const pills = [
              e.variety ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.variety)}</span>` : "",
              e.media ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.media)}</span>` : "",
              pondLabel ? `<span class="pill">${escapeHtml(pondLabel)}</span>` : "",
              e.experiment ? `<span class="pill">${escapeHtml(e.experiment)}</span>` : "",
            ].filter(Boolean).join("");

            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="meta">
                <div class="name">${escapeHtml(batchTitle)}</div>
                <div class="pills">${pills}</div>
              </div>
              <button class="btn" style="padding:8px 12px; font-weight:950;">Open</button>
            `;
            item.querySelector("button").addEventListener("click", (ev)=>{
              ev.stopPropagation();
              openDayModal(e.dateISO);
            });
            itemsHost.appendChild(item);
          }

          gr.querySelector(".groupHead").addEventListener("click", ()=> gr.classList.toggle("open"));
          groupsHost.appendChild(gr);
        });

        dayEl.querySelector(".dayHdr").addEventListener("click", ()=> openDayModal(day.dateISO));
        host.appendChild(dayEl);
      }
    }

    function renderMonth(){
      const grid = $("monthGrid");
      grid.innerHTML = "";

      const cp = partsInPR(state.monthCursor.getTime());
      const curUTC = new Date(Date.UTC(cp.y, cp.m-1, 1));
      $("monthName").textContent = curUTC.toLocaleDateString(undefined, { month:"long", year:"numeric", timeZone:"UTC" });

      const firstDow = curUTC.getUTCDay();
      const gridStartUTC = new Date(curUTC.getTime() - firstDow*MS);

      const summaries = monthSummary(state.filtered);

      for(let i=0;i<42;i++){
        const dUTC = new Date(gridStartUTC.getTime() + i*MS);
        const y = dUTC.getUTCFullYear();
        const m = dUTC.getUTCMonth()+1;
        const dd = dUTC.getUTCDate();

        const iso = `${y}-${pad2(m)}-${pad2(dd)}`;
        const inMonth = (m === cp.m);

        const cell = document.createElement("div");
        cell.className = "cell" + (inMonth ? "" : " out");

        const holidayName = getHolidayName(iso);
        if(holidayName) cell.classList.add("holiday");

        const sum = summaries.get(iso);
        const dots = [];
        if(sum){
          if(sum.kinds.has("seed")) dots.push(`<span class="miniDot seed" title="Seed"></span>`);
          if(sum.kinds.has("prop")) dots.push(`<span class="miniDot prop" title="Propagation Start"></span>`);
          if(sum.kinds.has("trans")) dots.push(`<span class="miniDot trans" title="Transplant"></span>`);
          if(sum.kinds.has("harv")) dots.push(`<span class="miniDot harv" title="Harvest"></span>`);
        }

        cell.innerHTML = `
          <div class="d"><span>${dd}</span><span class="dots">${dots.join("")}</span></div>
          <div class="lines"></div>
        `;

        const lines = cell.querySelector(".lines");

        if(holidayName){
          const hol = document.createElement("div");
          hol.className = "line";
          hol.style.borderColor = "rgba(239,68,68,.20)";
          hol.style.background = "rgba(239,68,68,.06)";
          hol.style.color = "#fecaca";
          hol.innerHTML = `<div style="display:flex; gap:8px; align-items:center; min-width:0;">
              <span class="bar" style="background:rgba(239,68,68,.9)"></span>
              <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Not onsite</strong> • ${escapeHtml(holidayName)}</span>
            </div><span>—</span>`;
          lines.appendChild(hol);
        }

        if(sum){
          const entries = Array.from(sum.groups.entries());
          const order = { seed:0, prop:1, trans:2, harv:3 };
          entries.sort((a,b)=>{
            const [ak] = a[0].split("||");
            const [bk] = b[0].split("||");
            const ap = a[0].split("||")[1] || "";
            const bp = b[0].split("||")[1] || "";
            return (order[ak]-order[bk]) || ap.localeCompare(bp);
          });

          const maxLines = 3;
          const shown = entries.slice(0, maxLines);
          const remaining = entries.length - shown.length;

          for(const [key, count] of shown){
            const [kind, pond] = key.split("||");
            const label = kindLabel(kind);
            const div = document.createElement("div");
            div.className = "line";
            div.innerHTML = `
              <div style="display:flex; gap:8px; align-items:center; min-width:0;">
                <span class="bar ${kindColorClass(kind)}"></span>
                <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>${escapeHtml(label)}</strong>${pond ? ` — Pond ${escapeHtml(pond)}` : ""}</span>
              </div>
              <span>${count}</span>
            `;
            lines.appendChild(div);
          }

          if(remaining > 0){
            const more = document.createElement("div");
            more.className = "line more";
            more.innerHTML = `<div style="display:flex; align-items:center; gap:8px;"><span>+${remaining} more</span></div><span>→</span>`;
            lines.appendChild(more);
          }
        }

        cell.addEventListener("click", ()=> openDayModal(iso));
        grid.appendChild(cell);
      }
    }

    // =========================================================
    // Sets for Gantt (merged)
    // =========================================================
    function setKeyFromRow(r){
      const s = r.seedDate ? toISO_PR(r.seedDate) : "";
      const p = r.propDate ? toISO_PR(r.propDate) : "";
      const t = r.transDate ? toISO_PR(r.transDate) : "";
      const h = r.harvestDate ? toISO_PR(r.harvestDate) : "";
      return `${s}||${p}||${t}||${h}`;
    }

    function buildSetsFromRows(rows){
      const today = getTodayPR();
      const map = new Map();

      for(const r of rows){
        if(!state.includeHarvested && !isRowActive(r, today)) continue;

        if(state.experiment!=="All" && r.experiment!==state.experiment) continue;
        if(state.media!=="All" && r.media!==state.media) continue;
        if(state.pond!=="All"){
          if(String(r.growPond||"") !== String(state.pond)) continue;
        }
        if(state.q.trim()){
          const hay = `${r.experiment} ${r.batch} ${r.variety} ${r.media} ${r.propPond} ${r.growPond} ${r.pos}`.toLowerCase();
          if(!hay.includes(state.q.trim().toLowerCase())) continue;
        }

        const key = setKeyFromRow(r);
        if(!map.has(key)){
          map.set(key, {
            key,
            seed: r.seedDate,
            prop: r.propDate,
            trans: r.transDate,
            harv: r.harvestDate,
            rows: [],
            propPonds: new Set(),
            growPonds: new Set(),
          });
        }
        const S = map.get(key);
        S.rows.push(r);
        if(r.propPond) S.propPonds.add(r.propPond);
        if(r.growPond) S.growPonds.add(r.growPond);
      }

      const sets = Array.from(map.values());
      sets.sort((a,b)=>{
        const ah = a.harv ? a.harv.getTime() : Infinity;
        const bh = b.harv ? b.harv.getTime() : Infinity;
        if(ah!==bh) return ah-bh;
        const at = a.trans ? a.trans.getTime() : Infinity;
        const bt = b.trans ? b.trans.getTime() : Infinity;
        if(at!==bt) return at-bt;
        const as = a.seed ? a.seed.getTime() : Infinity;
        const bs = b.seed ? b.seed.getTime() : Infinity;
        return as-bs;
      });

      return sets;
    }

    // =========================================================
    // Tooltip
    // =========================================================
    const tip = ()=> $("ganttTip");

    function showTipAt(ev, html){
      const el = tip();
      el.innerHTML = html;
      el.style.display = "block";
      el.setAttribute("aria-hidden","false");

      const pad = 14;
      const r = el.getBoundingClientRect();
      let x = ev.clientX + 14;
      let y = ev.clientY + 14;
      if(x + r.width + pad > window.innerWidth) x = ev.clientX - r.width - 14;
      if(y + r.height + pad > window.innerHeight) y = ev.clientY - r.height - 14;
      el.style.left = `${Math.max(pad, x)}px`;
      el.style.top  = `${Math.max(pad, y)}px`;
    }
    function hideTip(){
      const el = tip();
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
    }
    function attachTip(el, htmlFn){
      el.addEventListener("mouseenter", (ev)=> showTipAt(ev, htmlFn()));
      el.addEventListener("mousemove", (ev)=> showTipAt(ev, htmlFn()));
      el.addEventListener("mouseleave", hideTip);
    }

    // =========================================================
    // Render
    // =========================================================
    function render(){
      const { start, end } = applyFilters();

      $("agendaView").style.display = (state.view==="agenda") ? "flex" : "none";
      $("monthView").style.display  = (state.view==="month") ? "block" : "none";
      $("ganttView").style.display  = (state.view==="gantt") ? "block" : "none";

      if(state.view==="agenda") renderAgenda(start, end);
      if(state.view==="month") renderMonth();
      if(state.view==="gantt") renderGantt();
    }

    // =========================================================
    // Tag stacking (prevents overlap in header)
    // =========================================================
    function stackHeaderTags(tagLayer){
      const tags = Array.from(tagLayer.querySelectorAll(".lineTag"));
      if(!tags.length){
        const hdr = tagLayer.closest(".gHdr");
        if(hdr) hdr.style.paddingTop = "34px";
        tagLayer.style.height = "0px";
        return;
      }

      // reset
      for(const t of tags) t.style.top = "0px";

      const placed = [];
      const rowH = 26;

      // measure after the browser lays out text
      const measured = tags.map(el=>{
        const left = parseFloat(el.style.left || "0");
        const w = el.getBoundingClientRect().width || 120;
        return { el, left, w };
      }).sort((a,b)=> a.left - b.left);

      for(const item of measured){
        let row = 0;
        while(true){
          const x1 = item.left - item.w/2;
          const x2 = item.left + item.w/2;
          const collides = placed.some(p=>{
            if(p.row !== row) return false;
            return !(x2 < p.x1 + 10 || x1 > p.x2 - 10);
          });
          if(!collides) break;
          row++;
        }
        item.el.style.top = `${row * rowH}px`;
        placed.push({ row, x1: item.left - item.w/2, x2: item.left + item.w/2 });
      }

      const maxRow = placed.reduce((m,p)=> Math.max(m, p.row), 0);

      // increase header padding AND tag layer height so stacked rows don't clip
      const hdr = tagLayer.closest(".gHdr");
      const needed = (maxRow + 1) * rowH;
      if(hdr){
        hdr.style.paddingTop = `${34 + needed}px`;
      }
      tagLayer.style.height = `${needed + 10}px`;
    }

    // =========================================================
    // Gantt (PR timeline)
    // =========================================================
    function renderGantt(){
      const setsAll = buildSetsFromRows(state.rows);
      const sets = setsAll.filter(S => (S.seed || S.prop || S.trans || S.harv));

      $("ganttCount").textContent = `${sets.length} set${sets.length===1?"":"s"}`;

      const leftHost = $("ganttLeftBody");
      const rightScroll = $("ganttRightScroll");
      const rowsHost = $("ganttRows");
      const axis = $("ganttAxis");
      const timeline = $("ganttTimeline");

      leftHost.innerHTML = "";
      rowsHost.innerHTML = "";
      axis.innerHTML = "";
      timeline.querySelectorAll(".holidayBand,.todayLine,.holidayLine,.harvLine").forEach(n=>n.remove());

      const hdr = rightScroll.parentElement.querySelector(".gHdr");
      const tagLayer = (()=> {
        let layer = hdr.querySelector(".gHdrLineLayer");
        if(!layer){
          layer = document.createElement("div");
          layer.className = "gHdrLineLayer";
          hdr.appendChild(layer);
        }
        layer.innerHTML = "";
        layer.style.height = "0px";
        hdr.style.paddingTop = "34px";
        return layer;
      })();

      if(!sets.length){
        $("ganttSpan").textContent = "—";
        leftHost.innerHTML = `<div class="setRowLeft"><div class="setTitle">No sets match the current filters.</div></div>`;
        rowsHost.innerHTML = `<div class="setBarRow" style="height:60px;"><div class="segLabel" style="left:50%;top:50%;">No sets</div></div>`;
        return;
      }

      // Determine span
      let minT = Infinity;
      let maxT = -Infinity;
      for(const S of sets){
        const dates = [S.seed, S.prop, S.trans, S.harv].filter(Boolean);
        for(const d of dates){
          const t = d.getTime();
          if(t < minT) minT = t;
          if(t > maxT) maxT = t;
        }
      }

      const today = getTodayPR();
      if(today.getTime() > maxT) maxT = today.getTime();

      const PAD_DAYS = 3;
      const start = addDaysPR(startOfDayPRFromMs(minT), -PAD_DAYS);
      const endExclusive = addDaysPR(startOfDayPRFromMs(maxT), PAD_DAYS+1);
      const totalDays = Math.max(1, Math.round((endExclusive.getTime()-start.getTime())/MS));

      $("ganttSpan").textContent = `${toISO_PR(start)} → ${toISO_PR(addDaysPR(endExclusive, -1))}`;

      const style = getComputedStyle(timeline);
      const padL = parseFloat(style.paddingLeft) || 0;
      const padR = parseFloat(style.paddingRight) || 0;
      const hostW = rightScroll.clientWidth || timeline.clientWidth || 900;
      const pxPerDay = Math.max(6, (hostW - padL - padR) / totalDays);

      const timelineW = Math.max(1, Math.ceil(padL + padR + totalDays * pxPerDay));
      timeline.style.width = `${timelineW}px`;
      axis.style.width = `${timelineW}px`;
      rowsHost.style.width = `${timelineW}px`;

      function xOf(date){
        const off = (startOfDayPRFromMs(date.getTime()).getTime() - start.getTime())/MS;
        return padL + ((off + 0.5) * pxPerDay); // center-of-day
      }

      const tickByISO = new Map();
      for(let d=0; d<totalDays; d++){
        const dt = addDaysPR(start, d);
        const iso = toISO_PR(dt);
        const hol = getHolidayName(iso);

        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = `${Math.floor(padL + d*pxPerDay)}px`;
        tick.style.width = `${pxPerDay}px`;

        const p = partsInPR(dt.getTime());
        const u = new Date(Date.UTC(p.y, p.m-1, p.d));
        const dow = u.getUTCDay();
        const isMonday = dow === 1;
        const isFirst = p.d === 1;

        tick.innerHTML = (isMonday || isFirst)
          ? `<span class="dow">${u.toLocaleDateString(undefined,{weekday:"short", timeZone:"UTC"})}</span>
             <span class="d">${p.d}</span>
             <span class="m">${u.toLocaleDateString(undefined,{month:"short", timeZone:"UTC"})}</span>`
          : `<span class="dow">&nbsp;</span><span class="d">&nbsp;</span><span class="m">&nbsp;</span>`;

        attachTip(tick, ()=>{
          return `
            <div class="k">Timeline date</div>
            <div class="row">
              <span class="tag">${escapeHtml(fmtDowISO_PR(dt))}</span>
              ${hol ? `<span class="tag">Holiday: ${escapeHtml(hol)}</span>` : ``}
            </div>
          `;
        });

        axis.appendChild(tick);
        tickByISO.set(iso, tick);
      }

      // Holidays: band + thin line + tag
      for(let d=0; d<totalDays; d++){
        const dt = addDaysPR(start, d);
        const iso = toISO_PR(dt);
        const name = getHolidayName(iso);
        if(!name) continue;

        const xLeft   = padL + d*pxPerDay;
        const xCenter = xLeft + 0.5*pxPerDay;

        const band = document.createElement("div");
        band.className = "holidayBand";
        band.style.left = `${Math.floor(xLeft)}px`;
        band.style.width = `${pxPerDay}px`;
        timeline.appendChild(band);

        const hl = document.createElement("div");
        hl.className = "holidayLine";
        hl.style.left = `${Math.round(xCenter)}px`;
        timeline.appendChild(hl);

        const tag = document.createElement("div");
        tag.className = "lineTag holiday";
        tag.textContent = `${name} • ${fmtDowISO_PR(dt)}`;
        tag.style.left = `${Math.round(xCenter)}px`;
        tagLayer.appendChild(tag);

        const tick = tickByISO.get(iso);
        if(tick) tick.classList.add("lit","litHoliday");
      }

      // Today: thin line + tag
      const xToday = xOf(today);
      const tl = document.createElement("div");
      tl.className = "todayLine";
      tl.style.left = `${Math.round(xToday)}px`;
      timeline.appendChild(tl);

      const ttag = document.createElement("div");
      ttag.className = "lineTag today";
      ttag.textContent = `Today • ${fmtDowISO_PR(today)}`;
      ttag.style.left = `${Math.round(xToday)}px`;
      tagLayer.appendChild(ttag);

      const todayISO = toISO_PR(today);
      const tTick = tickByISO.get(todayISO);
      if(tTick) tTick.classList.add("lit");

      // Harvest full-height lines (ONE per unique harvest date)
      // No header tags for harvest (purple dates hidden, hover via tooltip only)
      const harvMap = new Map(); // iso -> { date, count }
      for(const S of sets){
        if(!S.harv) continue;
        const iso = toISO_PR(S.harv);
        if(!harvMap.has(iso)) harvMap.set(iso, { date: dateFromISO_PR(iso), count: 0 });
        harvMap.get(iso).count++;
      }

      const harvList = Array.from(harvMap.entries())
        .map(([iso, obj]) => ({ iso, date: obj.date, count: obj.count }))
        .filter(x => !!x.date)
        .sort((a,b)=> a.date - b.date);

      for(const h of harvList){
        const x = xOf(h.date); // SAME center-of-day math used by diamonds
        const line = document.createElement("div");
        line.className = "harvLine";
        line.style.left = `${Math.round(x)}px`;
        timeline.appendChild(line);

        const tick = tickByISO.get(h.iso);
        if(tick) tick.classList.add("lit");
      }

      function setHovered(key, on){
        const l = leftHost.querySelector(`.setRowLeft[data-key="${cssEscapeSafe(key)}"]`);
        const r = rowsHost.querySelector(`.setBarRow[data-key="${cssEscapeSafe(key)}"]`);
        if(l) l.classList.toggle("hovered", on);
        if(r) r.classList.toggle("hovered", on);
      }

      function tipHeader(S){
        const seedISO = S.seed ? toISO_PR(S.seed) : "—";
        const propISO = S.prop ? toISO_PR(S.prop) : "—";
        const transISO = S.trans ? toISO_PR(S.trans) : "—";
        const harvDowISO = S.harv ? fmtDowISO_PR(S.harv) : "TBD";
        const title = `Harvest ${S.harv ? toISO_PR(S.harv) : "TBD"} • ${S.rows.length} row${S.rows.length===1?"":"s"}`;
        return `
          <div class="k">${escapeHtml(title)}</div>
          <div class="row">
            <span class="tag">S: ${escapeHtml(seedISO)}</span>
            <span class="tag">P: ${escapeHtml(propISO)}</span>
            <span class="tag">T: ${escapeHtml(transISO)}</span>
            <span class="tag harv">H: ${escapeHtml(harvDowISO)}</span>
          </div>
        `;
      }

      const dom = { leftByKey:new Map(), rightByKey:new Map() };

      for(const S of sets){
        const seedISO = S.seed ? toISO_PR(S.seed) : "—";
        const propISO = S.prop ? toISO_PR(S.prop) : "—";
        const transISO = S.trans ? toISO_PR(S.trans) : "—";
        const harvDowISO = S.harv ? fmtDowISO_PR(S.harv) : "TBD";
        const title = `Harvest ${harvDowISO} • ${S.rows.length} row${S.rows.length===1?"":"s"}`;

        const lrow = document.createElement("div");
        lrow.className = "setRowLeft";
        lrow.dataset.key = S.key;

        const isOpen = state.openSetKeys.has(S.key);
        const isSelected = state.selectedSetKey === S.key;
        if(isOpen) lrow.classList.add("open");
        if(isSelected) lrow.classList.add("selected");

        const propPonds = Array.from(S.propPonds).sort().join(",") || "—";
        const growPonds = Array.from(S.growPonds).sort().join(",") || "—";

        const detailLines = S.rows
          .slice()
          .sort((a,b)=> (a.batch||"").localeCompare(b.batch||"") || (a.variety||"").localeCompare(b.variety||""))
          .map(r=>{
            const batch = r.batch ? `Batch ${r.batch}` : "Batch —";
            const variety = r.variety || "Variety —";
            const media = r.media || "Media —";
            const pp = r.propPond ? `Prop ${r.propPond}` : "Prop —";
            const gp = r.growPond ? `Grow ${r.growPond}` : "Grow —";
            const pos = (r.pos!=="" && r.pos!=null) ? `Pos ${r.pos}` : "Pos —";
            return `
              <div class="detailRow">
                <span class="detailKey">${escapeHtml(batch)}</span>
                <span class="detailKey">${escapeHtml(variety)}</span>
                <span class="detailKey">${escapeHtml(media)}</span>
                <span class="detailKey">${escapeHtml(pp)}</span>
                <span class="detailKey">${escapeHtml(gp)}</span>
                <span class="detailKey">${escapeHtml(pos)}</span>
              </div>
            `;
          }).join("");

        lrow.innerHTML = `
          <div class="setHeadLine">
            <div class="setTitle">${escapeHtml(title)}</div>
            <div class="chevMini">⌄</div>
          </div>
          <div class="setMeta">
            <span class="miniPill seed">Seed ${escapeHtml(seedISO)}</span>
            <span class="miniPill prop">Prop ${escapeHtml(propISO)}</span>
            <span class="miniPill trans">Trans ${escapeHtml(transISO)}</span>
            <span class="miniPill harv">Harv ${escapeHtml(harvDowISO)}</span>
            <span class="miniPill">Prop Pond: ${escapeHtml(propPonds)}</span>
            <span class="miniPill">Grow Pond: ${escapeHtml(growPonds)}</span>
          </div>
          <div class="setDetails">
            ${detailLines || `<div class="detailRow"><span class="detailKey">No row details</span></div>`}
          </div>
        `;

        lrow.addEventListener("mouseenter", ()=> setHovered(S.key, true));
        lrow.addEventListener("mouseleave", ()=> setHovered(S.key, false));

        leftHost.appendChild(lrow);
        dom.leftByKey.set(S.key, lrow);

        const rrow = document.createElement("div");
        rrow.className = "setBarRow";
        rrow.dataset.key = S.key;
        if(isSelected) rrow.classList.add("selected");

        rrow.addEventListener("mouseenter", ()=> setHovered(S.key, true));
        rrow.addEventListener("mouseleave", ()=> setHovered(S.key, false));

        function addSeg(kind, startDate, endDate, opacityIfMissingNext){
          if(!startDate || !endDate) return;
          const x1 = xOf(startDate);
          const x2 = xOf(endDate);

          const seg = document.createElement("div");
          seg.className = "seg " + kindColorClass(kind);
          seg.style.left = `${Math.min(x1,x2)}px`;
          seg.style.width = `${Math.max(4, Math.abs(x2-x1))}px`;
          if(opacityIfMissingNext) seg.style.opacity = "0.55";

          attachTip(seg, ()=> `
            ${tipHeader(S)}
            <div class="row">
              <span class="tag">${escapeHtml(kindLabel(kind))}</span>
              <span class="tag">${escapeHtml(toISO_PR(startDate))} → ${escapeHtml(toISO_PR(endDate))}</span>
            </div>
          `);

          rrow.appendChild(seg);
        }

        const endFallback = addDaysPR(endExclusive, -1);
        const end1 = S.prop || S.trans || S.harv || endFallback;
        const end2 = S.trans || S.harv || endFallback;
        const end3 = S.harv || endFallback;

        addSeg("seed", S.seed, end1, !S.prop);
        addSeg("prop", S.prop, end2, !S.trans);
        addSeg("trans", S.trans, end3, !S.harv);

        function addLabel(dateObj, label){
          if(!dateObj) return;
          const x = Math.round(xOf(dateObj));
          const t = document.createElement("div");
          t.className = "segLabel";
          t.style.left = `${x}px`;
          t.textContent = label;
          rrow.appendChild(t);
        }

        const seedEqProp = S.seed && S.prop && toISO_PR(S.seed) === toISO_PR(S.prop);
        if(S.seed && (!S.prop || !seedEqProp)) addLabel(S.seed, "S");
        if(S.prop) addLabel(S.prop, "P");
        if(S.trans) addLabel(S.trans, "T");
        if(S.harv) addLabel(S.harv, "H");

        // Harvest diamond: SAME xOf math as harvest line (center-of-day)
        if(S.harv){
          const x = Math.round(xOf(S.harv));
          const m = document.createElement("div");
          m.className = "harvMarker";
          m.style.left = `${x}px`;
          rrow.appendChild(m);
        }

        attachTip(rrow, ()=> tipHeader(S));

        rowsHost.appendChild(rrow);
        dom.rightByKey.set(S.key, rrow);

        lrow.addEventListener("click", ()=>{
          const keepRight = rightScroll.scrollLeft;

          state.selectedSetKey = S.key;
          if(state.openSetKeys.has(S.key)) state.openSetKeys.delete(S.key);
          else state.openSetKeys.add(S.key);

          for(const [k, el] of dom.leftByKey.entries()){
            el.classList.toggle("open", state.openSetKeys.has(k));
            el.classList.toggle("selected", state.selectedSetKey === k);
          }
          for(const [k, el] of dom.rightByKey.entries()){
            el.classList.toggle("selected", state.selectedSetKey === k);
          }

          requestAnimationFrame(()=>{
            syncGanttRowHeights(dom);
            rightScroll.scrollLeft = keepRight;
          });
        });
      }

      state._ganttDom = dom;
      requestAnimationFrame(()=>{
        stackHeaderTags(tagLayer);
        syncGanttRowHeights(dom);
      });
    }

    function syncGanttRowHeights(dom){
      if(!dom) return;
      for(const [key, lrow] of dom.leftByKey.entries()){
        const rrow = dom.rightByKey.get(key);
        if(!rrow) continue;
        const h = Math.max(44, lrow.offsetHeight);
        rrow.style.height = `${h}px`;
      }
    }

    function collapseAllSets(){
      state.openSetKeys.clear();
      state.selectedSetKey = null;
      const dom = state._ganttDom;
      if(dom){
        for(const el of dom.leftByKey.values()) el.classList.remove("open","selected");
        for(const el of dom.rightByKey.values()) el.classList.remove("selected");
        syncGanttRowHeights(dom);
      }
    }

    // =========================================================
    // Modal
    // =========================================================
    function openDayModal(dayISO){
      const items = state.filtered.filter(e=>e.dateISO===dayISO);
      const d = dateFromISO_PR(dayISO);
      const p = partsInPR(d.getTime());
      const u = new Date(Date.UTC(p.y, p.m-1, p.d));
      const nice = u.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric", timeZone:"UTC" });

      $("dayModalTitle").textContent = nice;

      const holidayName = getHolidayName(dayISO);
      const isHoliday = !!holidayName;

      $("dayModalSub").textContent =
        `${items.length} item${items.length===1?"":"s"}` +
        (isHoliday ? ` • Not onsite: ${holidayName}` : "") +
        (state.includeHarvested ? ` • History included` : ` • Active-only`) +
        ` • PR time`;

      const body = $("dayModalBody");
      body.innerHTML = "";

      if(isHoliday && items.length===0){
        body.innerHTML = `
          <div class="summary" style="border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08); color:#fecaca;">
            <b>Not onsite</b> • ${escapeHtml(holidayName)}<br/>
            No scheduled experiment events on this day.
          </div>`;
      }else if(items.length===0){
        body.innerHTML = `
          <div class="summary" style="border-color: rgba(148,163,184,.22); background: rgba(2,6,23,.35); color: var(--sub);">
            No events on this day (for the current filters).
          </div>`;
      }else{
        const list = items
          .slice()
          .sort((a,b)=> a.kind.localeCompare(b.kind) || (a.batch||"").localeCompare(b.batch||""))
          .map(e=>{
            const pondLabel =
              (e.kind==="prop") ? (e.propPond ? `Prop Pond ${e.propPond}` : "") :
              (e.kind==="trans"||e.kind==="harv") ? (e.growPond ? `Grow Pond ${e.growPond}` : "") :
              (e.propPond ? `Prop Pond ${e.propPond}` : "");
            return `
              <div class="item">
                <div class="meta">
                  <div class="name">${escapeHtml(kindLabel(e.kind))} • ${escapeHtml(e.batch ? ("Batch " + e.batch) : (e.variety || e.experiment || "Item"))}</div>
                  <div class="pills">
                    ${e.variety ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.variety)}</span>` : ""}
                    ${e.media ? `<span class="pill ${kindColorClass(e.kind)}">${escapeHtml(e.media)}</span>` : ""}
                    ${pondLabel ? `<span class="pill">${escapeHtml(pondLabel)}</span>` : ""}
                    ${e.experiment ? `<span class="pill">${escapeHtml(e.experiment)}</span>` : ""}
                  </div>
                </div>
                <button class="btn" onclick="document.getElementById('dayModalBack').classList.remove('open')">Close</button>
              </div>`;
          }).join("");
        body.innerHTML = `<div class="groups" style="padding:0;">${list}</div>`;
      }

      $("dayModalBack").classList.add("open");
    }

    function closeDayModal(){ $("dayModalBack").classList.remove("open"); }

    // =========================================================
    // Build / Refresh
    // =========================================================
    function rebuildFilterOptions(){
      const today = getTodayPR();
      const sourceRows = state.includeHarvested ? state.rows : state.rows.filter(r=>isRowActive(r,today));

      const exps = new Set();
      const medias = new Set();
      const ponds = new Set();

      for(const r of sourceRows){
        if(r.experiment) exps.add(r.experiment);
        if(r.media) medias.add(r.media);
        if(r.growPond) ponds.add(String(r.growPond).trim());
      }

      function fillSelect(sel, values, current){
        const s = $(sel);
        const arr = Array.from(values).sort((a,b)=> String(a).localeCompare(String(b)));
        const keep = current ?? "All";
        s.innerHTML = `<option>All</option>` + arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
        if(arr.includes(keep)) s.value = keep;
        else s.value = "All";
      }

      fillSelect("fExperiment", exps, state.experiment);
      fillSelect("fMedia", medias, state.media);
      fillSelect("fPond", ponds, state.pond);

      state.experiment = $("fExperiment").value;
      state.media = $("fMedia").value;
      state.pond = $("fPond").value;
    }

    function buildFromTSV(){
      const tsv = $("tsv").value || "";
      state.rawTSV = tsv;
      localStorage.setItem("expCal_tsv", tsv);

      const parsed = parseTSV(tsv);
      state.rows = parsed.rows;
      state.events = expandEvents(state.rows);

      rebuildFilterOptions();

      const eCount = state.events.length;
      const byKind = { seed:0, prop:0, trans:0, harv:0 };
      for(const e of state.events) byKind[e.kind]++;

      $("buildSummary").innerHTML =
        `Rows parsed: ${parsed.parsed}<br/>` +
        `Rows skipped: ${parsed.skipped}<br/>` +
        `Events created: ${eCount} (Seed ${byKind.seed}, Prop ${byKind.prop}, Trans ${byKind.trans}, Harvest ${byKind.harv})`;

      if(!state.selectedSetKey){
        const sets = buildSetsFromRows(state.rows);
        if(sets[0]) state.selectedSetKey = sets[0].key;
      }

      render();
    }

    // =========================================================
    // Wiring
    // =========================================================
    function setView(v){
      state.view = v;
      $("tabAgenda").classList.toggle("on", v==="agenda");
      $("tabMonth").classList.toggle("on", v==="month");
      $("tabGantt").classList.toggle("on", v==="gantt");
      render();
    }

    function toggleMilestone(k){
      state.milestoneOn[k] = !state.milestoneOn[k];
      document.querySelectorAll(`[data-k="${k}"]`).forEach(el=>{
        el.classList.toggle("on", state.milestoneOn[k]);
      });
      render();
    }

    function syncHistoryUI(){
      const btn = $("historyToggle");
      const lbl = $("historyToggleLabel");
      const on = !state.includeHarvested;
      btn.classList.toggle("on", on);
      lbl.textContent = state.includeHarvested ? "Include harvested" : "Active only";
      $("metaActiveMode").classList.toggle("on", on);
      $("metaActiveModeText").textContent = state.includeHarvested ? "History included" : "Active only";
    }

    function toggleHistory(){
      state.includeHarvested = !state.includeHarvested;
      syncHistoryUI();
      rebuildFilterOptions();
      render();
    }

    function setFiltersCollapsed(collapsed){
      state.filtersCollapsed = collapsed;
      const body = $("filtersBody");
      const btn = $("filtersToggle");
      if(body) body.style.display = collapsed ? "none" : "block";
      if(btn){
        btn.textContent = collapsed ? "Show filters" : "Hide filters";
        btn.setAttribute("aria-pressed", collapsed ? "false" : "true");
      }
    }

    function setTSVCollapsed(collapsed){
      state.tsvCollapsed = collapsed;
      const box = $("tsvBox");
      const btn = $("toggleTSV");
      if(box) box.style.display = collapsed ? "none" : "block";
      if(btn) btn.textContent = collapsed ? "Show TSV" : "Hide TSV";
    }

    function init(){
      $("tsv").value = "";
      state.rawTSV = "";

      const today = getTodayPR();
      state.startDate = today;
      $("startDate").value = toISO_PR(today);

      const tp = partsInPR(today.getTime());
      state.monthCursor = dateFromISO_PR(`${tp.y}-${pad2(tp.m)}-01`);

      $("fExperiment").innerHTML = `<option>All</option>`;
      $("fMedia").innerHTML = `<option>All</option>`;
      $("fPond").innerHTML = `<option>All</option>`;

      syncHistoryUI();

      loadData();
      setView("gantt");

      $("milestoneChips").addEventListener("click", (ev)=>{
        const chip = ev.target.closest(".chip");
        if(!chip) return;
        const k = chip.getAttribute("data-k");
        if(!k) return;
        toggleMilestone(k);
      });

      $("q").addEventListener("input", ()=>{ state.q = $("q").value; render(); });
      $("fExperiment").addEventListener("change", ()=>{ state.experiment = $("fExperiment").value; render(); });
      $("fMedia").addEventListener("change", ()=>{ state.media = $("fMedia").value; render(); });
      $("fPond").addEventListener("change", ()=>{ state.pond = $("fPond").value; render(); });
      $("fRange").addEventListener("change", ()=>{ state.rangeDays = Number($("fRange").value); render(); });

      $("startDate").addEventListener("change", ()=>{
        const d = dateFromISO_PR($("startDate").value);
        if(d){
          state.startDate = d;
          const p = partsInPR(d.getTime());
          state.monthCursor = dateFromISO_PR(`${p.y}-${pad2(p.m)}-01`);
          render();
        }
      });

      $("buildBtn").addEventListener("click", loadData);

      document.addEventListener("keydown", (e)=>{
        const isCmd = e.metaKey || e.ctrlKey;
        if(isCmd && e.key === "Enter"){ e.preventDefault(); buildFromTSV(); }
        if(e.key === "Escape"){ hideTip(); closeDayModal(); }
      });

      $("todayBtn").addEventListener("click", ()=>{
        const t = getTodayPR();
        state.startDate = t;
        $("startDate").value = toISO_PR(t);
        const p = partsInPR(t.getTime());
        state.monthCursor = dateFromISO_PR(`${p.y}-${pad2(p.m)}-01`);
        render();
      });

      $("tabAgenda").addEventListener("click", ()=> setView("agenda"));
      $("tabMonth").addEventListener("click", ()=> setView("month"));
      $("tabGantt").addEventListener("click", ()=> setView("gantt"));

      $("prevMonth").addEventListener("click", ()=>{
        const p = partsInPR(state.monthCursor.getTime());
        const prev = new Date(Date.UTC(p.y, p.m-2, 1));
        state.monthCursor = dateFromISO_PR(`${prev.getUTCFullYear()}-${pad2(prev.getUTCMonth()+1)}-01`);
        render();
      });
      $("nextMonth").addEventListener("click", ()=>{
        const p = partsInPR(state.monthCursor.getTime());
        const next = new Date(Date.UTC(p.y, p.m, 1));
        state.monthCursor = dateFromISO_PR(`${next.getUTCFullYear()}-${pad2(next.getUTCMonth()+1)}-01`);
        render();
      });
      $("thisMonth").addEventListener("click", ()=>{
        const t = getTodayPR();
        const p = partsInPR(t.getTime());
        state.monthCursor = dateFromISO_PR(`${p.y}-${pad2(p.m)}-01`);
        render();
      });

      $("dayModalClose").addEventListener("click", closeDayModal);
      $("dayModalBack").addEventListener("click", (ev)=>{ if(ev.target === $("dayModalBack")) closeDayModal(); });

      $("historyToggle").addEventListener("click", toggleHistory);
      $("metaActiveMode").addEventListener("click", toggleHistory);

      $("collapseSetsBtn").addEventListener("click", ()=>{
        collapseAllSets();
        renderGantt();
      });

      $("filtersToggle").addEventListener("click", ()=>{
        setFiltersCollapsed(!state.filtersCollapsed);
      });

      $("toggleTSV").addEventListener("click", ()=>{
        setTSVCollapsed(!state.tsvCollapsed);
      });

      window.addEventListener("resize", ()=>{
        if(state.view==="gantt") renderGantt();
      });

      setFiltersCollapsed(true);
      setTSVCollapsed(true);
    }

    init();
  </script>
</body>
</html>
