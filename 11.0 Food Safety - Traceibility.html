<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campo Caribe – Batch Trace (Auto-hydrated)</title>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --border: rgba(148,163,184,.18);
      --border2: rgba(148,163,184,.10);
      --text:#e5e7eb;
      --sub:#cbd5e1;
      --muted:#94a3b8;
      --accent:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, rgba(59,130,246,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }
    header{
      padding:24px 18px 12px;
      max-width:1200px;
      margin:0 auto;
    }
    .title{
      display:flex; gap:12px; align-items:baseline; flex-wrap:wrap;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .pill{
      font-size:12px;
      color:var(--sub);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(2,6,23,.55);
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 28px;
    }
    .panel{
      background: rgba(2,6,23,.55);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .inner{
      padding:16px;
      background: linear-gradient(180deg, rgba(15,23,42,.55), rgba(2,6,23,.55));
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    .upload{
      flex:1 1 340px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px;
      background: rgba(15,23,42,.55);
      border:1px solid var(--border);
      border-radius:14px;
    }
    .upload label{
      font-size:12px;
      color:var(--muted);
      min-width:86px;
    }
    .upload input[type="file"]{
      color:var(--sub);
      font-size:12px;
      max-width: 100%;
    }
    .filepill{
      font-size:11px;
      color:var(--sub);
      background: rgba(148,163,184,.10);
      border:1px solid var(--border2);
      padding:4px 8px;
      border-radius:999px;
      font-family: var(--mono);
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .search{
      flex: 1 1 420px;
      display:flex;
      background: rgba(15,23,42,.55);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    .search input{
      flex:1;
      padding:12px 12px;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-family: var(--mono);
    }
    .search button{
      padding:12px 14px;
      border:0;
      cursor:pointer;
      background: rgba(34,197,94,.16);
      color: var(--text);
      font-weight:700;
    }
    .search button:hover{ background: rgba(34,197,94,.24); }

    .smallbtn{
      border:1px solid var(--border2);
      background: rgba(148,163,184,.10);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
    }
    .smallbtn:hover{ background: rgba(148,163,184,.14); }

    .meta{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .meta code{
      font-family: var(--mono);
      color: var(--sub);
      background: rgba(15,23,42,.65);
      border:1px solid var(--border2);
      padding:2px 6px;
      border-radius:8px;
    }
    .status{
      margin-left:auto;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .kpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--border2);
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.25);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:950;
      color: var(--text);
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-family: var(--mono);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,.12);
    }
    .dot.ok{ background: var(--accent); box-shadow: 0 0 0 3px rgba(34,197,94,.12); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.12); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }

    .section{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(15,23,42,.35);
      overflow:hidden;
    }
    .section h2{
      margin:0;
      padding:12px 14px;
      font-size:13px;
      letter-spacing:.2px;
      color: var(--sub);
      border-bottom:1px solid var(--border2);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .count{
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .cards{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(2,6,23,.55);
      padding:12px;
    }
    .card .top{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .k{
      font-family: var(--mono);
      color: var(--text);
      font-size:13px;
      font-weight:800;
    }
    .tagrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .tag{
      font-size:11px;
      color: var(--sub);
      background: rgba(148,163,184,.10);
      border:1px solid var(--border2);
      padding:4px 8px;
      border-radius:999px;
      font-family: var(--mono);
    }
    .tag.hit{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.28);
      color: #d1fae5;
    }
    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:6px 10px;
      font-size:12px;
      color: var(--sub);
      border-top:1px dashed var(--border2);
      padding-top:10px;
      margin-top:10px;
    }
    .kv div:nth-child(odd){ color: var(--muted); }
    .mono{ font-family: var(--mono); }
    details summary{
      cursor:pointer;
      color: var(--sub);
      font-size:12px;
      user-select:none;
    }
    pre{
      margin:10px 0 0;
      padding:10px;
      border-radius:12px;
      background: rgba(15,23,42,.55);
      border:1px solid var(--border2);
      overflow:auto;
      font-size:11px;
      color: var(--sub);
    }
    .tableWrap{ padding:12px; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      color: var(--text);
    }
    thead th{
      text-align:left;
      font-weight:900;
      font-size:11px;
      letter-spacing:.2px;
      color: var(--sub);
      padding:10px 8px;
      border-bottom:1px solid var(--border2);
      position:sticky;
      top:0;
      background: rgba(2,6,23,.85);
      z-index:2;
    }
    tbody td{
      padding:8px 8px;
      border-bottom:1px solid var(--border2);
      vertical-align:top;
      color: var(--text);
    }
    tbody tr:nth-child(even){
      background: rgba(15,23,42,.25);
    }
    .tableEmpty{
      color: var(--sub);
      font-style:italic;
      padding:10px 8px;
    }
    .jsonToggle{
      cursor:pointer;
      color: var(--sub);
      font-size:11px;
      user-select:none;
    }
    .jsonBlock{
      display:none;
      white-space:pre-wrap;
      margin-top:6px;
      padding:8px;
      border-radius:10px;
      border:1px solid var(--border2);
      background: rgba(15,23,42,.55);
      color: var(--sub);
      font-size:11px;
    }
    tr.showJson .jsonBlock{ display:block; }
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>Batch Trace – Pack ⇄ Grow</h1>
    <span class="pill">Auto-hydrated from localStorage → search any code (Batch Run Code, W Batch Run Code, SKU, Invoice, Seed Batch)</span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="inner">


      <div class="row">
        <div class="search">
          <input id="q" placeholder="Search… e.g. COMBO-05OZ3582505" autocomplete="off" spellcheck="false" />
          <button id="go">Search</button>
        </div>
        <button class="smallbtn" id="example">Use example</button>
        <button class="smallbtn" id="clear">Clear</button>
      </div>

      <div class="meta">
        <span>Expected sheets:</span>
        <code>Master Pack</code>
        <code>Master Grow</code>
        <span class="status"><span class="dot" id="dot"></span><span id="statusText">Waiting for Master Pack + Master Grow</span></span>
      </div>
      <div class="kpis">
        <span class="kpi">Total cases packed <span id="packTotalCases">0</span></span>
        <span class="kpi">Total cases shipped <span id="packTotalShipped">0</span></span>
      </div>

      <div class="grid">
        <div class="section">
          <h2>Pack matches <span class="count" id="packCount">0</span></h2>
          <div class="tableWrap">
            <table id="packTable">
              <thead>
                <tr>
                  <th>Batch Run Code</th>
                  <th>Matched Seed Batch Code</th>
                  <th>SKU Packed</th>
                  <th>Batch Run Date</th>
                  <th>Cases Packed</th>
                </tr>
              </thead>
              <tbody id="packTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <h2>Shipping matches <span class="count" id="shipCount">0</span></h2>
          <div class="tableWrap">
            <table id="shipTable">
              <thead>
                <tr>
                  <th>Batch Run Code</th>
                  <th>Run Batch Shipped/Received</th>
                  <th>Shipping Date</th>
                  <th>Location Shipped</th>
                  <th># Cases Shipped</th>
                </tr>
              </thead>
              <tbody id="shipTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <h2>Grow matches <span class="count" id="growCount">0</span></h2>
          <div class="tableWrap">
            <table id="growTable">
              <thead>
                <tr>
                  <th>Matched Seed Batch Code</th>
                  <th>Seed Date</th>
                  <th>Transplant Date</th>
                  <th>Harvest Date</th>
                  <th>Transplant Pond</th>
                  <th>Harvest Pond</th>
                  <th>Boards Harvested</th>
                  <th>Peso Lechuga Cortada</th>
                  <th>Actual Boards Transplanted</th>
                  <th>Flats Seeded</th>
                </tr>
              </thead>
              <tbody id="growTbody"></tbody>
            </table>
          </div>
        </div>

      </div>

      <details style="margin-top:12px;">
        <summary>Debug (loaded metadata)</summary>
        <pre id="debug"></pre>
      </details>

    </div>
  </div>
</div>

<script>
// STORAGE CONTRACT (same as index.html)
const MASTER_GROW_KEY = "campo_master_grow_v1";
const MASTER_PACK_KEY = "campo_master_pack_v1";

const MASTER_GROW_PING_KEY = "campo_master_grow_push_ping_v1";
const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";

const GROW_SHEET_NAME = "Master Grow";
const PACK_SHEET_NAME = "Master Pack";

// Parent/index message types
const MSG_GROW = "MASTER_GROW_UPDATED";
const MSG_PACK = "MASTER_PACK_UPDATED";

// BroadcastChannel (same name as index/seeding)
const BC_NAME = "campo_master_bus_v1";
const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null;

let PACK_PAYLOAD = null;
let GROW_PAYLOAD = null;
let PACK_ROWS = [];
let GROW_ROWS = [];

const $ = (id) => document.getElementById(id);

function setStatus(kind, text){
  const dot = $("dot");
  dot.classList.remove("ok","bad");
  if(kind === "ok") dot.classList.add("ok");
  else if(kind === "bad") dot.classList.add("bad");
  $("statusText").textContent = text;
}

function safeStr(v){
  if(v === null || v === undefined) return "";
  return String(v);
}

function norm(s){
  return safeStr(s).trim().toUpperCase();
}

function loadJsonFromStorage(key){
  const raw = (localStorage.getItem(key) || "").trim();
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

function getSheet(payload, sheetName){
  return payload?.sheets?.[sheetName] || null;
}

function sheetToRowObjects(sheetObj){
  const headers = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
  const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
  const out = [];
  for(const r of rows){
    if(!Array.isArray(r)) continue;
    const obj = {};
    for(let i=0;i<headers.length;i++){
      const key = String(headers[i] ?? "").trim();
      if(!key) continue;
      obj[key] = (i < r.length) ? r[i] : "";
    }
    out.push(obj);
  }
  return out;
}

function loadMasterData(){
  const growPayload = loadJsonFromStorage(MASTER_GROW_KEY);
  const packPayload = loadJsonFromStorage(MASTER_PACK_KEY);

  const growSheet = getSheet(growPayload, GROW_SHEET_NAME);
  const packSheet = getSheet(packPayload, PACK_SHEET_NAME);

  return { growPayload, packPayload, growSheet, packSheet };
}

function getVal(obj, names){
  for(const n of names){
    const v = obj?.[n];
    if(v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}

function anyCellIncludesObj(obj, queryUpper){
  const hits = [];
  if(!obj) return hits;
  for(const [k,v] of Object.entries(obj)){
    const s = safeStr(v);
    if(!s) continue;
    if(s.toUpperCase().includes(queryUpper)) hits.push(k);
  }
  return hits;
}

function uniq(arr){
  return [...new Set(arr.filter(Boolean))];
}

function mkTag(text, hit=false){
  const span = document.createElement("span");
  span.className = "tag" + (hit ? " hit" : "");
  span.textContent = text;
  return span;
}

function mkKV(kvPairs){
  const kv = document.createElement("div");
  kv.className = "kv";
  kvPairs.forEach(([k,v])=>{
    const a = document.createElement("div");
    a.textContent = k;
    const b = document.createElement("div");
    b.className = "mono";
    b.textContent = safeStr(v) || "—";
    kv.appendChild(a);
    kv.appendChild(b);
  });
  return kv;
}

function mkCard(titleLeft, tags, kvPairs, rawObj){
  const card = document.createElement("div");
  card.className = "card";

  const top = document.createElement("div");
  top.className = "top";

  const k = document.createElement("div");
  k.className = "k";
  k.textContent = titleLeft;

  const tagrow = document.createElement("div");
  tagrow.className = "tagrow";
  tags.forEach(t=>tagrow.appendChild(t));

  top.appendChild(k);
  top.appendChild(tagrow);

  card.appendChild(top);
  card.appendChild(mkKV(kvPairs));

  if(rawObj){
    const det = document.createElement("details");
    det.style.marginTop = "10px";
    const sum = document.createElement("summary");
    sum.textContent = "Show full row JSON";
    const pre = document.createElement("pre");
    pre.textContent = JSON.stringify(rawObj, null, 2);
    det.appendChild(sum);
    det.appendChild(pre);
    card.appendChild(det);
  }

  return card;
}

function clearResults(){
  $("packTbody").innerHTML = "";
  $("growTbody").innerHTML = "";
  $("shipTbody").innerHTML = "";
  $("packCount").textContent = "0";
  $("growCount").textContent = "0";
  $("shipCount").textContent = "0";
  $("packTotalCases").textContent = "0";
  $("packTotalShipped").textContent = "0";
}

function renderEmpty(tbodyEl, msg, colspan){
  const tr = document.createElement("tr");
  const td = document.createElement("td");
  td.className = "tableEmpty";
  td.colSpan = colspan;
  td.textContent = msg;
  tr.appendChild(td);
  tbodyEl.appendChild(tr);
}

function jsonCell(obj){
  const td = document.createElement("td");
  const toggle = document.createElement("div");
  toggle.className = "jsonToggle";
  toggle.textContent = "Show JSON";
  const pre = document.createElement("pre");
  pre.className = "jsonBlock";
  pre.textContent = JSON.stringify(obj, null, 2);
  toggle.addEventListener("click", () => {
    const row = td.closest("tr");
    row.classList.toggle("showJson");
    toggle.textContent = row.classList.contains("showJson") ? "Hide JSON" : "Show JSON";
  });
  td.appendChild(toggle);
  td.appendChild(pre);
  return td;
}

function trace(query){
  clearResults();

  if(!PACK_ROWS.length || !GROW_ROWS.length){
    renderEmpty($("packTbody"), "Waiting for Pack + Grow data from localStorage.", 5);
    renderEmpty($("growTbody"), "Waiting for Pack + Grow data from localStorage.", 9);
    renderEmpty($("shipTbody"), "Waiting for Pack + Grow data from localStorage.", 5);
    return;
  }

  const q = norm(query);
  if(!q){
    renderEmpty($("packTbody"), "Type a code above to search.", 5);
    renderEmpty($("growTbody"), "Grow matches will appear here.", 9);
    renderEmpty($("shipTbody"), "Shipping matches will appear here.", 5);
    return;
  }

  const packMatches = [];
  const seedCodesFromPack = [];
  const exactBatchMatches = [];

  for(const row of PACK_ROWS){
    const batchRunCode = norm(row?.["Batch Run Code"]);
    if(batchRunCode && batchRunCode === q){
      exactBatchMatches.push(row);
    }
  }

  if(exactBatchMatches.length){
    const seedUniverseFromExact = new Set();
    for(const row of exactBatchMatches){
      ["Seed Batch Code 1","Seed Batch Code 2","Seed Batch Code 3"].forEach((c)=>{
        const v = norm(row?.[c]);
        if(v) seedUniverseFromExact.add(v);
      });
    }

    for(const row of PACK_ROWS){
      const rowSeeds = [
        norm(row?.["Seed Batch Code 1"]),
        norm(row?.["Seed Batch Code 2"]),
        norm(row?.["Seed Batch Code 3"])
      ].filter(Boolean);
      const matchedSeeds = rowSeeds.filter(v => seedUniverseFromExact.has(v));
      if(matchedSeeds.length){
        packMatches.push({obj: row, hits: ["Seed Batch Code"], matchedSeed: matchedSeeds.join(", ")});
        matchedSeeds.forEach(v => seedCodesFromPack.push(v));
      }
    }
  } else {
    for(const row of PACK_ROWS){
      const hits = anyCellIncludesObj(row, q);
      if(hits.length){
        const seedCandidates = [
          norm(row?.["Seed Batch Code 1"]),
          norm(row?.["Seed Batch Code 2"]),
          norm(row?.["Seed Batch Code 3"])
        ].filter(Boolean);
        const matchedSeed = seedCandidates.filter(v => v === q || v.includes(q)).join(", ");
        packMatches.push({obj: row, hits, matchedSeed});
        ["Seed Batch Code 1","Seed Batch Code 2","Seed Batch Code 3"].forEach((c)=>{
          const v = norm(row?.[c]);
          if(v) seedCodesFromPack.push(v);
        });
      }
    }
  }

  const seedUniverse = uniq([...seedCodesFromPack, q]);

  const growMatches = [];
  const wanted = new Set(seedUniverse);
  for(const row of GROW_ROWS){
    const bc = norm(getVal(row, ["Batch Code"]));
    if(bc && wanted.has(bc)){
      growMatches.push({obj: row, seedCode: bc});
    }
  }

  function shippingInfoForBatch(batchCode){
    if(!batchCode) return { casesShipped: "" };
    const rows = PACK_ROWS.filter(r => norm(r?.["Run Batch Shipped/Received"]) === norm(batchCode));
    if(!rows.length) return { casesShipped: "" };
    let sumCases = 0;
    for(const r of rows){
      const v = Number(String(r?.["# of Cases Shipped"] ?? "").replace(/,/g,"").trim());
      if(Number.isFinite(v)) sumCases += v;
    }
    return { casesShipped: sumCases ? String(sumCases) : "" };
  }

  // Render Pack
  $("packCount").textContent = String(packMatches.length);
  if(!packMatches.length){
    renderEmpty($("packTbody"), `No Pack matches for: ${q}`, 5);
  }else{
    let totalCasesPacked = 0;
    for(const m of packMatches){
      const r = m.obj;

      const batchRunCode = safeStr(r?.["Batch Run Code"]);
      const skuPacked = safeStr(r?.["SKU Packed"]);
      const packDate = safeStr(r?.["Batch Run Date"]);
      const qtyCasesPacked = safeStr(r?.["Quantity of Cases Packed"]);
      const lbsPacked = safeStr(r?.["Total Packed Weight"]);

      const seed1 = safeStr(r?.["Seed Batch Code 1"]);
      const seed2 = safeStr(r?.["Seed Batch Code 2"]);
      const seed3 = safeStr(r?.["Seed Batch Code 3"]);
      const seeds = uniq([norm(seed1), norm(seed2), norm(seed3)]).filter(Boolean);

      const tr = document.createElement("tr");
      const seedsCombined = uniq([seed1, seed2, seed3].filter(Boolean)).join(", ") || "—";
      const casesPackedNum = Number(String(qtyCasesPacked || "").replace(/,/g,"").trim());
      if(Number.isFinite(casesPackedNum)) totalCasesPacked += casesPackedNum;

      tr.innerHTML = `
        <td>${safeStr(batchRunCode) || "—"}</td>
        <td>${safeStr(m.matchedSeed || "") || "—"}</td>
        <td>${safeStr(skuPacked) || "—"}</td>
        <td>${safeStr(packDate) || "—"}</td>
        <td>${safeStr(qtyCasesPacked) || "—"}</td>
      `;
      // details column removed
      $("packTbody").appendChild(tr);
    }
    $("packTotalCases").textContent = String(totalCasesPacked);
    $("packTotalShipped").textContent = "0";
  }

  // Render Grow
  $("growCount").textContent = String(growMatches.length);
  if(!growMatches.length){
    renderEmpty($("growTbody"), `No Grow matches for Seed Batch Codes derived from: ${q}`, 9);
  }else{
    for(const m of growMatches){
      const r = m.obj;
      const batchCode = safeStr(getVal(r, ["Batch Code"]));
      const variety = safeStr(getVal(r, ["Variety","Veriaty"]));
      const seedDate = safeStr(getVal(r, ["Seed Date"]));
      const seedWeek = safeStr(getVal(r, ["Seed Week"]));
      const transDate = safeStr(getVal(r, ["Transplant Date"]));
      const transPond = safeStr(getVal(r, ["Transplant Pond"]));
      const harvDate = safeStr(getVal(r, ["Harvest Date"]));
      const harvPond = safeStr(getVal(r, ["Harvest Pond"]));
      const boardsHarvested = safeStr(getVal(r, ["Actual BRD HVT","Actual BRD HVT ","Actual Boards Harvested","Boards Harvested"]));
      const pesoLechuga = safeStr(getVal(r, ["Peso de la lechuga cortada","Peso Lechuga Cortada","Peso Lechuga"]));
      const boardsTransplanted = safeStr(getVal(r, ["Actual Boards Transplanted","Actual BRD Transplanted"]));
      const flatsSeeded = safeStr(getVal(r, ["Flats","Actual Flats","Bandejas"]));

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${safeStr(m.seedCode || "") || "—"}</td>
        <td>${safeStr(seedDate) || "—"}</td>
        <td>${safeStr(transDate) || "—"}</td>
        <td>${safeStr(harvDate) || "—"}</td>
        <td>${safeStr(transPond) || "—"}</td>
        <td>${safeStr(harvPond) || "—"}</td>
        <td>${safeStr(boardsHarvested) || "—"}</td>
        <td>${safeStr(pesoLechuga) || "—"}</td>
        <td>${safeStr(boardsTransplanted) || "—"}</td>
        <td>${safeStr(flatsSeeded) || "—"}</td>
      `;
      // details column removed
      $("growTbody").appendChild(tr);
    }
  }

  // Render Shipping
  const matchedBatchCodes = new Set(packMatches.map(m => norm(m.obj?.["Batch Run Code"])).filter(Boolean));
  const shippingRows = PACK_ROWS
    .filter(r => {
      if(!matchedBatchCodes.has(norm(r?.["Run Batch Shipped/Received"]))) return false;
      const status = norm(r?.["Shipped or Received"]);
      return status === "SHIPPED";
    })
    .sort((a,b)=> norm(a?.["Run Batch Shipped/Received"]).localeCompare(norm(b?.["Run Batch Shipped/Received"])));
  $("shipCount").textContent = String(shippingRows.length);

  if(!shippingRows.length){
    renderEmpty($("shipTbody"), `No Shipping matches for: ${q}`, 5);
    $("packTotalShipped").textContent = "0";
  }else{
    let totalCasesShipped = 0;
    for(const r of shippingRows){
      const runBatch = safeStr(r?.["Run Batch Shipped/Received"]);
      const batchRunCode = runBatch;
      const shipDate = safeStr(getVal(r, ["Shipping Date","Sales Ship Date"]));
      const locationShipped = safeStr(getVal(r, ["Location Shipped"]));
      const casesShipped = safeStr(getVal(r, ["# of Cases Shipped","Sales # of Cases"]));
      const casesShippedNum = Number(String(casesShipped || "").replace(/,/g,"").trim());
      if(Number.isFinite(casesShippedNum)) totalCasesShipped += casesShippedNum;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${safeStr(batchRunCode) || "—"}</td>
        <td>${safeStr(runBatch) || "—"}</td>
        <td>${safeStr(shipDate) || "—"}</td>
        <td>${safeStr(locationShipped) || "—"}</td>
        <td>${safeStr(casesShipped) || "—"}</td>
      `;
      $("shipTbody").appendChild(tr);
    }
    $("packTotalShipped").textContent = String(totalCasesShipped);
  }
}

function updateDebug(){
  const packSheet = getSheet(PACK_PAYLOAD, PACK_SHEET_NAME);
  const growSheet = getSheet(GROW_PAYLOAD, GROW_SHEET_NAME);

  const dbg = {
    pack: PACK_PAYLOAD ? {
      updatedAt: PACK_PAYLOAD.updatedAt,
      kind: PACK_PAYLOAD.kind,
      sourceLabel: PACK_PAYLOAD.sourceLabel,
      sheet: PACK_SHEET_NAME,
      headers: packSheet ? packSheet.headers.length : null,
      rows: packSheet ? packSheet.rows.length : null,
    } : null,
    grow: GROW_PAYLOAD ? {
      updatedAt: GROW_PAYLOAD.updatedAt,
      kind: GROW_PAYLOAD.kind,
      sourceLabel: GROW_PAYLOAD.sourceLabel,
      sheet: GROW_SHEET_NAME,
      headers: growSheet ? growSheet.headers.length : null,
      rows: growSheet ? growSheet.rows.length : null,
    } : null
  };
  $("debug").textContent = JSON.stringify(dbg, null, 2);
}

function rebuildUI(reason){
  const { growPayload, packPayload, growSheet, packSheet } = loadMasterData();
  GROW_PAYLOAD = growPayload;
  PACK_PAYLOAD = packPayload;

  if(!growSheet || !packSheet){
    PACK_ROWS = [];
    GROW_ROWS = [];
    setStatus("bad", "Waiting for Master Grow + Master Pack from localStorage");
    updateDebug();
    trace($("q").value);
    return;
  }

  PACK_ROWS = sheetToRowObjects(packSheet);
  GROW_ROWS = sheetToRowObjects(growSheet);
  setStatus("ok", "Ready (Pack + Grow loaded)");
  updateDebug();
  trace($("q").value);
}

let reloadTimer = null;
function reloadAll(reason){
  if(reloadTimer) clearTimeout(reloadTimer);
  reloadTimer = setTimeout(() => {
    reloadTimer = null;
    rebuildUI(reason);
  }, 60);
}

function setupLiveListeners(){
  window.addEventListener("storage", (e) => {
    if (!e) return;
    if (
      e.key === MASTER_GROW_KEY || e.key === MASTER_PACK_KEY ||
      e.key === MASTER_GROW_PING_KEY || e.key === MASTER_PACK_PING_KEY
    ) reloadAll("storage");
  });

  window.addEventListener("message", (event) => {
    const msg = event?.data;
    if (!msg || typeof msg !== "object") return;
    if (msg.type === MSG_GROW || msg.type === MSG_PACK) reloadAll("message");
  });

  window.addEventListener(MSG_GROW, () => reloadAll("customevent"));
  window.addEventListener(MSG_PACK, () => reloadAll("customevent"));

  if (bc){
    bc.onmessage = (ev) => {
      const msg = ev?.data;
      if (msg?.type === MSG_GROW || msg?.type === MSG_PACK) reloadAll("broadcast");
    };
  }

  let lastGrowLen = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
  let lastPackLen = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
  setInterval(() => {
    const gLen = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
    const pLen = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
    if (gLen !== lastGrowLen || pLen !== lastPackLen){
      lastGrowLen = gLen; lastPackLen = pLen;
      reloadAll("poll");
    }
  }, 1500);
}

$("go").addEventListener("click", ()=>trace($("q").value));
$("q").addEventListener("keydown", (e)=>{ if(e.key === "Enter") trace($("q").value); });

$("example").addEventListener("click", ()=>{
  $("q").value = "COMBO-05OZ3582505";
  trace($("q").value);
});
$("clear").addEventListener("click", ()=>{
  $("q").value = "";
  trace("");
});

document.addEventListener("DOMContentLoaded", () => {
  setupLiveListeners();
  reloadAll("init");
});
</script>
</body>
</html>
