<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>S&H Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --border: #1f2937;
      --border-subtle: #374151;
      --text: #e5e7eb;
      --sub: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #4ade80;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .page { min-height: 100vh; padding: 16px; display: flex; justify-content: center; }

    .container {
      width: 100%;
      max-width: 1320px;
      border-radius: 24px;
      padding: 20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.09), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
    }

    .header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    .title-block { flex: 1 1 200px; min-width: 0; }
    .title { display: flex; align-items: center; gap: 10px; margin: 0 0 4px; font-size: 1.3rem; letter-spacing: 0.02em; }
    .title-pill {
      width: 26px; height: 26px; border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #34d399, #22c55e 55%, #16a34a 100%);
      display: inline-flex; align-items: center; justify-content: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9), 0 12px 30px rgba(16, 185, 129, 0.6);
    }
    .title-pill span { font-size: 15px; font-weight: 700; color: #022c22; }
    .title-text { font-weight: 620; display: flex; align-items: baseline; gap: 8px; }
    .title-sub { font-size: 0.8rem; color: var(--sub); text-transform: uppercase; letter-spacing: 0.18em; }
    .subtitle { margin: 0; font-size: 0.85rem; color: var(--muted); }

    .header-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      border-radius: 999px; padding: 4px 9px; font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--sub);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 55%);
    }
    .chip-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35); }
    .chip-danger-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--danger); box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4); }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.6fr) minmax(0, 1.6fr);
      gap: 16px;
      align-items: stretch;
      margin-top: 10px;
    }
    @media (max-width: 960px) {
      .container { border-radius: 18px; padding: 14px 12px 14px; }
      .layout-main { grid-template-columns: minmax(0, 1fr); }
    }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; margin-bottom: 16px; margin-top: 6px; }
    @media (max-width: 960px) { .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .kpi-card {
      position: relative;
      border-radius: 16px;
      padding: 10px 12px 11px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(51, 65, 85, 0.9);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }
    .kpi-label { font-size: 0.74rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--sub); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .kpi-value { font-size: 1.15rem; font-weight: 650; display: flex; align-items: baseline; gap: 4px; }
    .kpi-unit { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; }
    .kpi-trend { margin-top: 2px; font-size: 0.7rem; color: var(--accent-strong); display: inline-flex; align-items: center; gap: 4px; }
    .kpi-trend.bad { color: #f97373; }
    .kpi-glow {
      position: absolute; inset: 0; opacity: 0.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34, 197, 94, 0.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.4), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(14px);
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .panel-title { font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.16em; color: var(--sub); display: flex; align-items: center; gap: 7px; }
    .panel-title-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.45); }
    .panel-subtitle { font-size: 0.75rem; color: var(--muted); }
    .panel-header-right { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--sub); flex-wrap: wrap; justify-content: flex-end; }

    .cards-view-toggle { display: inline-flex; align-items: center; border-radius: 999px; border: 1px solid rgba(55, 65, 81, 0.9); background: rgba(15, 23, 42, 0.95); padding: 1px; }
    .cards-view-toggle-btn { border: none; background: transparent; color: var(--sub); padding: 3px 8px; border-radius: 999px; cursor: pointer; font-size: 0.7rem; }
    .cards-view-toggle-btn.active { background: rgba(34, 197, 94, 0.18); color: #bbf7d0; }

    .badge-soft {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.55), rgba(15, 23, 42, 0.95));
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
    }
    .badge-soft span { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: rgba(226, 232, 240, 0.95); }
    .badge-dot { width: 7px; height: 7px; border-radius: 999px; background: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.48); }

    .view-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 2px 8px;
      font-size: 0.7rem;
      gap: 6px;
    }
    .view-toggle span { text-transform: uppercase; letter-spacing: 0.12em; font-size: 0.68rem; color: var(--sub); }
    .view-toggle select { background: transparent; border: none; color: var(--sub); font-size: 0.7rem; font-family: inherit; outline: none; }

    .sku-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 10px;
      margin-top: 4px;
      max-height: 420px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15, 23, 42, 0.2);
      padding-right: 3px;
    }
    .sku-grid::-webkit-scrollbar { width: 6px; }
    .sku-grid::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.8); }
    .sku-grid::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 999px; }

    .sku-card {
      position: relative;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease;
      border-radius: 14px;
      padding: 8px 10px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.9), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.85), 0 0 0 1px rgba(15, 23, 42, 0.95);
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sku-card:hover { transform: translateY(-2px); }
    .sku-card-header { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; }
    .sku-card-sku { font-weight: 620; font-size: 0.82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sku-card-tag { font-size: 0.68rem; padding: 2px 6px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.7); color: var(--sub); background: rgba(15, 23, 42, 0.95); white-space: nowrap; }
    .sku-card-main { display: flex; justify-content: space-between; gap: 6px; margin-top: 2px; }
    .sku-card-main-left { display: flex; flex-direction: column; gap: 2px; }
    .sku-card-metric { font-size: 0.75rem; color: var(--sub); }
    .sku-card-metric strong { color: #e5e7eb; font-weight: 600; }

    .sku-card-locations { margin-top: 4px; font-size: 0.72rem; color: var(--sub); display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
    .sku-card-locations .label { text-transform: uppercase; letter-spacing: 0.12em; font-size: 0.68rem; color: var(--muted); }
    .sku-card-locations-list { display: flex; flex-wrap: wrap; gap: 4px; }

    .location-pill { padding: 2px 6px; border-radius: 999px; border: 1px solid rgba(55,65,81,0.9); background: rgba(15,23,42,0.95); font-size: 0.7rem; }
    .location-pill-more { opacity: 0.8; font-style: italic; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); display: flex; align-items: flex-start; justify-content: center; z-index: 50; padding-top: 8vh; }
    .modal-panel {
      max-width: 900px;
      width: auto;
      max-height: 80vh;
      border-radius: 18px;
      padding: 12px 14px;
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.9), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.8rem; color: var(--sub); }
    .modal-title { text-transform: uppercase; letter-spacing: 0.14em; font-size: 0.72rem; }
    .modal-close-btn { border: none; background: rgba(15, 23, 42, 0.9); border-radius: 999px; padding: 3px 8px; font-size: 0.75rem; color: var(--sub); cursor: pointer; }
    .modal-body { flex: 1 1 auto; overflow-y: auto; overflow-x: auto; }
    .modal-subtitle { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }

    .modal-lot-table {
      table-layout: auto;
      border-collapse: collapse;
      width: auto !important;
      min-width: 0 !important;
      max-width: 100%;
      font-size: 0.68rem;
      margin: 0 auto;
    }
    .modal-lot-table th, .modal-lot-table td {
      padding: 3px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }
    .modal-lot-table th { text-transform: uppercase; letter-spacing: 0.12em; font-size: 0.66rem; color: var(--sub); }
    .modal-lot-table th:nth-child(1), .modal-lot-table td:nth-child(1) {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.64rem;
      min-width: 10ch;
      text-align: left;
    }
    .modal-lot-table th:nth-child(2), .modal-lot-table td:nth-child(2) { text-align: left; }
    .modal-lot-table th:nth-child(3), .modal-lot-table td:nth-child(3) { width: 1%; text-align: right; }
    .modal-lot-table th:nth-child(4), .modal-lot-table td:nth-child(4) { width: 1%; text-align: right; }

    .sku-card-bar { margin-top: 4px; height: 6px; border-radius: 999px; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(55, 65, 81, 0.9); overflow: hidden; }
    .sku-card-bar-inner { height: 100%; background: linear-gradient(to right, rgba(34, 197, 94, 0.9), rgba(59, 130, 246, 0.9)); width: 0%; transition: width 0.2s ease-out; }
    .sku-card-status { font-size: 0.7rem; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--sub); }

    .status-ok { border-color: rgba(34, 197, 94, 0.9); box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.5), 0 12px 24px rgba(22, 163, 74, 0.35); }
    .status-warn { border-color: rgba(245, 158, 11, 0.9); box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.5), 0 12px 24px rgba(245, 158, 11, 0.25); }
    .status-danger { border-color: rgba(239, 68, 68, 0.95); box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.7), 0 12px 26px rgba(239, 68, 68, 0.4); }

    .issues-section { font-size: 0.75rem; color: var(--sub); margin-top: 4px; display: flex; flex-direction: column; gap: 8px; }
    .issues-section h4 { margin: 4px 0 3px; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.14em; color: var(--sub); }
    .issues-section ul { list-style: none; padding-left: 0; margin: 0 0 4px; }
    .issues-section li { padding: 2px 0; font-size: 0.73rem; color: #cbd5f5; }
    .issues-section li span.label { color: var(--sub); }
    .issues-empty { font-size: 0.72rem; color: var(--muted); }

    .issues-pill {
      display: inline-flex; align-items: center; border-radius: 999px; padding: 2px 6px;
      font-size: 0.68rem; border: 1px solid rgba(55, 65, 81, 0.9); background: rgba(15, 23, 42, 0.95);
      margin-left: 4px;
    }
    .issues-pill.bad { border-color: rgba(239, 68, 68, 0.9); color: #fecaca; }
    .issues-pill.warn { border-color: rgba(245, 158, 11, 0.9); color: #fed7aa; }

    .table-wrapper {
      margin-top: 12px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background:
        linear-gradient(135deg, rgba(17, 24, 39, 0.96), rgba(15, 23, 42, 0.99)),
        radial-gradient(circle at top left, rgba(51, 65, 85, 0.65), rgba(15, 23, 42, 0.96));
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .table-scroll { max-height: 380px; overflow: auto; scrollbar-width: thin; scrollbar-color: #4b5563 rgba(15, 23, 42, 0.2); flex: 1 1 auto; }
    .table-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-scroll::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.8); }
    .table-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 999px; }

    table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    #inventory-table { min-width: 960px; }

    thead {
      position: sticky; top: 0; z-index: 2;
      background: linear-gradient(to bottom, #020617, #020617),
                  radial-gradient(circle at top left, rgba(55, 65, 81, 0.5), rgba(15, 23, 42, 0.95));
      box-shadow: 0 1px 0 rgba(31, 41, 55, 0.9);
    }

    th, td { text-align: right; padding: 6px 10px; border-bottom: 1px solid rgba(31, 41, 55, 0.85); white-space: nowrap; }
    th:first-child, td:first-child { text-align: left; padding-left: 14px; }
    th:last-child, td:last-child { padding-right: 12px; }
    th { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--sub); background: transparent; }

    tbody tr:nth-child(odd) td { background: rgba(15, 23, 42, 0.85); }
    tbody tr:nth-child(even) td { background: rgba(17, 24, 39, 0.92); }
    tbody tr:hover td { background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.08), rgba(15, 23, 42, 0.98)); }

    tfoot td {
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.12), rgba(15, 23, 42, 0.98));
      font-weight: 600;
      border-top: 1px solid rgba(55, 65, 81, 0.95);
      border-bottom: none;
    }

    .panel-footer-note {
      margin-top: 6px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel-footer-note span { display: inline-flex; align-items: center; gap: 4px; }

    .hint-empty {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>ðŸ“¦</span></div>
            <div class="title-text">
              <span>S&amp;H Inventory Dashboard</span>
              <span class="title-sub">LIVE FROM MASTER PACK</span>
            </div>
          </div>
          <p class="subtitle">Warehouse inventory snapshot by SKU and batch (inventory, reserved, available) sourced from Pack Data.</p>
        </div>

        <div class="header-tags">
          <div class="chip"><span class="chip-dot"></span><span id="chip-ok">Waiting for Master Packâ€¦</span></div>
          <div class="chip"><span class="chip-danger-dot"></span><span id="chip-warn">â€“</span></div>
        </div>
      </header>

      <section class="panel" style="margin-bottom: 10px;">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span>Daily snapshot</span></div>
            <div class="panel-subtitle" id="snapshot-subtitle">Select a day to see inventory for that date.</div>
          </div>
          <div class="panel-header-right">
            <div class="badge-soft"><span class="badge-dot"></span><span>Snapshot by warehouse date</span></div>
            <div class="view-toggle">
              <span>Date</span>
              <select id="snapshot-date"></select>
            </div>
          </div>
        </div>

        <section class="kpi-grid">
          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases in inventory</div>
            <div class="kpi-value"><span id="kpi-total-inventory">â€“</span></div>
            <div class="kpi-trend"><span id="kpi-inventory-label">For selected day</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases available</div>
            <div class="kpi-value"><span id="kpi-total-available">â€“</span><span class="kpi-unit">Cases</span></div>
            <div class="kpi-trend"><span id="kpi-reserved-note">Reserved: â€“ cases</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Unique SKUs in stock</div>
            <div class="kpi-value"><span id="kpi-unique-skus">â€“</span><span class="kpi-unit">SKUs</span></div>
            <div class="kpi-trend"><span id="kpi-location-note">Locations: â€“</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Average inventory age</div>
            <div class="kpi-value"><span id="kpi-avg-age">â€“</span><span class="kpi-unit">Days</span></div>
            <div class="kpi-trend"><span id="kpi-age-note">Oldest lot: â€“ days</span></div>
          </article>
        </section>
      </section>

      <section class="layout-main">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span id="cards-panel-title">Inventory by SKU (selected day)</span></div>
              <div class="panel-subtitle" id="cards-panel-subtitle">One card per SKU â€“ total cases, availability, and age distribution.</div>
            </div>
            <div class="panel-header-right">
              <span id="cards-summary-label">â€“ SKUs displayed</span>
              <div class="cards-view-toggle">
                <button type="button" id="cards-view-sku" class="cards-view-toggle-btn active">By SKU</button>
                <button type="button" id="cards-view-size" class="cards-view-toggle-btn">By Size</button>
              </div>
            </div>
          </div>
          <div class="sku-grid" id="sku-grid"></div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span>Top issues today</span></div>
              <div class="panel-subtitle">Oldest product, low / zero availability, and customer reservations for the selected day.</div>
            </div>
          </div>

          <div class="issues-section">
            <div>
              <h4>Oldest lots</h4>
              <ul id="issues-oldest"></ul>
              <div id="issues-oldest-empty" class="issues-empty"></div>
            </div>

            <div>
              <h4>Low / zero availability</h4>
              <ul id="issues-low"></ul>
              <div id="issues-low-empty" class="issues-empty"></div>
            </div>

            <div>
              <h4>Customer reservations</h4>
              <ul id="issues-customers"></ul>
              <div id="issues-customers-empty" class="issues-empty"></div>
            </div>
          </div>
        </section>
      </section>

      <section class="panel" style="margin-top: 12px;">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span>Raw inventory table</span></div>
            <div class="panel-subtitle">Full data set across all dates from Master Pack. Filter by date using selector above.</div>
          </div>
          <div class="panel-header-right">
            <span>Rows auto-update when Pack Data updates.</span>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="table-scroll">
            <table id="inventory-table">
              <thead>
                <tr>
                  <th>Warehouse Date</th>
                  <th>W-Batch Run Code</th>
                  <th>Warehouse Location</th>
                  <th>Cases in Inventory</th>
                  <th>Cases Reserved</th>
                  <th>Cases Available</th>
                  <th>Customer Reserved</th>
                  <th>Warehouse Observations</th>
                  <th>Warehouse Pack Date</th>
                  <th>Warehouse Age</th>
                  <th>Warehouse SKU</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>Totals (selected day)</td>
                  <td>â€“</td>
                  <td>â€“</td>
                  <td>0.0</td>
                  <td>0.0</td>
                  <td>0.0</td>
                  <td>â€“</td>
                  <td>â€“</td>
                  <td>â€“</td>
                  <td>0.0</td>
                  <td>â€“</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div id="empty-hint" class="hint-empty"></div>
        <div class="panel-footer-note"><span>Source: localStorage <code>campo_master_pack_v1</code> â†’ sheets["Master Pack"]</span></div>
      </section>
    </div>
  </div>

  <script>
    // =========================================================
    // STORAGE CONTRACT (same style as Seeding)
    // =========================================================
    const MASTER_PACK_KEY = "campo_master_pack_v1";
    const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";
    const MASTER_PACK_SHEET_NAME = "Master Pack";

    // Index/parent message types
    const MSG_PACK = "MASTER_PACK_UPDATED";

    // BroadcastChannel (same-origin)
    const BC_NAME = "campo_master_bus_v1";
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null;

    // =========================================================
    // INVENTORY CANONICAL FIELD NAMES
    // =========================================================
    const INV = Object.freeze({
      DATE: "Warehouse Date",
      BATCH: "W-Batch Run Code",
      LOCATION: "Warehouse Location",
      CASES_INV: "Cases in Inventory",
      CASES_RES: "Cases Reserved",
      CASES_AVAIL: "Cases Available",
      CUSTOMER: "Customer Reserved",
      OBS: "Warehouse Observations",
      PACK_DATE: "Warehouse Pack Date",
      AGE: "Warehouse Age",
      SKU: "Warehouse SKU",
    });

    // =========================================================
    // UI STATE
    // =========================================================
    let currentSnapshotDate = null;
    let cardsViewMode = "sku"; // "sku" or "size"

    // =========================================================
    // UI HELPERS
    // =========================================================
    function setEmpty(msg) {
      const el = document.getElementById("empty-hint");
      if (el) el.textContent = msg || "";
    }

    function setChip(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function chipWarn(msg) { setChip("chip-warn", msg || "â€“"); }

    // =========================================================
    // TOLERANT PARSERS
    // =========================================================
    function normHeader(s){
      return String(s ?? "").replace(/\s+/g, " ").trim().toLowerCase();
    }

    // Add/extend aliases here if your Pack sheet uses different names.
    const HEADER_ALIASES = new Map([
      // Date
      ["warehouse date", INV.DATE],
      ["date", INV.DATE],
      ["fecha", INV.DATE],
      ["fecha de warehouse", INV.DATE],
      ["fecha de almacen", INV.DATE],
      ["fecha almacÃ©n", INV.DATE],

      // Batch
      ["w-batch run code", INV.BATCH],
      ["w batch run code", INV.BATCH],
      ["batch", INV.BATCH],
      ["batch run code", INV.BATCH],
      ["lote", INV.BATCH],
      ["codigo de lote", INV.BATCH],

      // Location
      ["warehouse location", INV.LOCATION],
      ["location", INV.LOCATION],
      ["ubicacion", INV.LOCATION],
      ["ubicaciÃ³n", INV.LOCATION],

      // Inventory numbers
      ["cases in inventory", INV.CASES_INV],
      ["inventory", INV.CASES_INV],
      ["cases inventory", INV.CASES_INV],
      ["in inventory", INV.CASES_INV],
      ["inv", INV.CASES_INV],

      ["cases reserved", INV.CASES_RES],
      ["reserved", INV.CASES_RES],
      ["res", INV.CASES_RES],
      ["reservado", INV.CASES_RES],

      ["cases available", INV.CASES_AVAIL],
      ["available", INV.CASES_AVAIL],
      ["avail", INV.CASES_AVAIL],
      ["disponible", INV.CASES_AVAIL],

      // Customer
      ["customer reserved", INV.CUSTOMER],
      ["customer", INV.CUSTOMER],
      ["cliente", INV.CUSTOMER],

      // Observations
      ["warehouse observations", INV.OBS],
      ["observations", INV.OBS],
      ["obs", INV.OBS],
      ["observaciones", INV.OBS],

      // Pack date / age
      ["warehouse pack date", INV.PACK_DATE],
      ["pack date", INV.PACK_DATE],
      ["fecha de empaque", INV.PACK_DATE],
      ["fecha empaque", INV.PACK_DATE],

      ["warehouse age", INV.AGE],
      ["age", INV.AGE],
      ["edad", INV.AGE],

      // SKU
      ["warehouse sku", INV.SKU],
      ["sku", INV.SKU],
      ["producto", INV.SKU],
    ]);

    function canonicalizeHeaders(headersRaw){
      const canonHeaders = [];
      const canonIndexByName = new Map();

      headersRaw.forEach((h, idx) => {
        const raw = String(h ?? "");
        const key = normHeader(raw);
        const canon = HEADER_ALIASES.get(key) || raw.trim();
        canonHeaders[idx] = canon;
        if (canon && !canonIndexByName.has(canon)) canonIndexByName.set(canon, idx);
      });

      return { canonHeaders, canonIndexByName };
    }

    function parseNumber(v) {
      if (v === null || v === undefined) return 0;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      const s = String(v).trim();
      if (!s) return 0;
      if (/^#(VALUE|REF|NAME|DIV\/0|N\/A)!?$/i.test(s)) return 0;
      const cleaned = s.replace(/,/g, "");
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function parseAnyDate(v){
      if (v === null || v === undefined) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return v;

      // Excel serial
      if (typeof v === "number" && Number.isFinite(v) && v > 20000 && v < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + v * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      const s0 = String(v).trim();
      if (!s0) return null;

      // Excel serial string
      const n = Number(s0);
      if (Number.isFinite(n) && n > 20000 && n < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + n * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      // Strip weekday prefix: "Monday, Dec 22, 2025"
      let s = s0;
      const parts = s.split(",");
      if (parts.length >= 2 && /[a-z]/i.test(parts[0])) s = parts.slice(1).join(",").trim();

      // ISO
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }

      // US MM/DD/YYYY
      if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) {
        const [mm, dd, yy] = s.split("/").map(Number);
        const yyyy = yy < 100 ? 2000 + yy : yy;
        const d = new Date(yyyy, mm - 1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatDateMMDDYYYY(date) {
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      const yyyy = date.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    function daysBetween(a, b){
      const ms = 86400000;
      return Math.max(0, Math.round((a.getTime() - b.getTime()) / ms));
    }

    function fmt0(n) { return (n || 0).toLocaleString(undefined, { maximumFractionDigits: 0 }); }
    function fmt1(n) { return (n || 0).toLocaleString(undefined, { maximumFractionDigits: 1 }); }

    function getSizeKeyFromSku(sku) {
      if (!sku) return "(unknown)";
      const parts = String(sku).split("-");
      return parts[parts.length - 1];
    }

    function prettySizeLabel(sizeKey) {
      const m = String(sizeKey).match(/^0*([0-9]+)([A-Z]+)$/);
      if (!m) return sizeKey;
      return m[1] + " " + m[2].toUpperCase();
    }

    function isMeaningfulRow(r) {
      const hasDate = !!(r.date && String(r.date).trim());
      const hasOther =
        !!(r.batch && String(r.batch).trim()) ||
        !!(r.location && String(r.location).trim()) ||
        !!(r.sku && String(r.sku).trim()) ||
        (r.casesInventory || 0) > 0 ||
        (r.casesReserved || 0) > 0 ||
        (r.casesAvailable || 0) > 0 ||
        !!(r.customer && String(r.customer).trim()) ||
        !!(r.packDate && String(r.packDate).trim()) ||
        (r.age || 0) > 0 ||
        !!(r.observations && String(r.observations).trim());
      return hasDate && hasOther;
    }

    // =========================================================
    // LOAD MASTER PACK
    // =========================================================
    function loadMasterPackPayload() {
      const raw = (localStorage.getItem(MASTER_PACK_KEY) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToRowObjects(sheetObj) {
      const headersRaw = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];

      const { canonHeaders } = canonicalizeHeaders(headersRaw);

      const out = [];
      for (const r of rows) {
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i = 0; i < canonHeaders.length; i++) {
          const key = String(canonHeaders[i] ?? "").trim();
          if (!key) continue;
          obj[key] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    // =========================================================
    // BUILD TABLE FROM MASTER PACK
    // =========================================================
    function buildFromMasterPack() {
      const payload = loadMasterPackPayload();
      const sheet = payload?.sheets?.[MASTER_PACK_SHEET_NAME];

      const tbody = document.querySelector("#inventory-table tbody");
      if (tbody) tbody.innerHTML = "";

      if (!sheet) {
        setEmpty(
          "No Master Pack sheet found.\n\nFix: Upload Master Pack in Data Input.\nVerify Data Input writes sheets[\"Master Pack\"]."
        );
        setChip("chip-ok", "Master Pack missing");
        chipWarn("Upload Master Pack");
        return [];
      }

      const headersRaw = Array.isArray(sheet.headers) ? sheet.headers : [];
      const { canonHeaders } = canonicalizeHeaders(headersRaw);

      const rows = sheetToRowObjects(sheet);
      if (!rows.length) {
        setEmpty("Master Pack loaded, but the sheet has no rows.");
        setChip("chip-ok", "Master Pack loaded (0 rows)");
        chipWarn("No inventory rows found");
        return [];
      }

      // Require at least DATE + SKU OR DATE + (Inv/Avail/Res)
      const headerSet = new Set(canonHeaders.map(h => String(h || "").trim()).filter(Boolean));
      const missingDate = !headerSet.has(INV.DATE);
      const missingSku = !headerSet.has(INV.SKU);
      const missingAllQty = !headerSet.has(INV.CASES_INV) && !headerSet.has(INV.CASES_AVAIL) && !headerSet.has(INV.CASES_RES);

      if (missingDate || (missingSku && missingAllQty)) {
        setEmpty(
          "Master Pack loaded, but required inventory headers are missing.\n\n" +
          "Needs:\n- " + INV.DATE + "\n- plus either " + INV.SKU + " or quantity columns\n\n" +
          "Found headers (canonicalized):\n- " + Array.from(headerSet).slice(0, 80).join("\n- ") +
          (headerSet.size > 80 ? "\n- â€¦" : "")
        );
        setChip("chip-ok", "Master Pack loaded (missing headers)");
        chipWarn("Fix Pack headers or add alias mapping");
        return [];
      }

      let droppedBlank = 0;
      let droppedNoDate = 0;
      let kept = 0;

      const outRows = [];

      for (const r of rows) {
        if (!r || typeof r !== "object") continue;

        const dateRaw = r[INV.DATE];
        const dateObj = parseAnyDate(dateRaw);
        if (!dateObj) { droppedNoDate++; continue; }
        const dateStr = formatDateMMDDYYYY(dateObj);

        const batch = String(r[INV.BATCH] ?? "").trim();
        const location = String(r[INV.LOCATION] ?? "").trim();

        const invVal = parseNumber(r[INV.CASES_INV]);
        const resVal = parseNumber(r[INV.CASES_RES]);
        let availVal = parseNumber(r[INV.CASES_AVAIL]);

        // If available missing but inv/res present, compute
        if ((!r[INV.CASES_AVAIL] || String(r[INV.CASES_AVAIL]).trim() === "") && (invVal || resVal)) {
          availVal = Math.max(0, invVal - resVal);
        }

        const customer = String(r[INV.CUSTOMER] ?? "").trim();
        const obs = String(r[INV.OBS] ?? "").trim();

        const packDateRaw = r[INV.PACK_DATE];
        const packDateObj = parseAnyDate(packDateRaw);
        const packDateStr = packDateObj ? formatDateMMDDYYYY(packDateObj) : String(packDateRaw ?? "").trim();

        let ageVal = parseNumber(r[INV.AGE]);
        if ((!r[INV.AGE] || String(r[INV.AGE]).trim() === "") && packDateObj && dateObj) {
          ageVal = daysBetween(dateObj, packDateObj);
        }

        const sku = String(r[INV.SKU] ?? "").trim();

        const rowObj = {
          date: dateStr,
          batch,
          location,
          casesInventory: invVal,
          casesReserved: resVal,
          casesAvailable: availVal,
          customer,
          observations: obs,
          packDate: packDateStr,
          age: ageVal,
          sku
        };

        const allBlank =
          !dateStr && !batch && !location && !sku &&
          invVal === 0 && resVal === 0 && availVal === 0 &&
          !customer && !obs && !packDateStr && ageVal === 0;

        if (allBlank) { droppedBlank++; continue; }
        if (!isMeaningfulRow(rowObj)) { droppedBlank++; continue; }

        outRows.push(rowObj);
      }

      // Render table
      if (tbody) {
        outRows.forEach((d) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.date}</td>
            <td>${d.batch}</td>
            <td>${d.location}</td>
            <td>${d.casesInventory}</td>
            <td>${d.casesReserved}</td>
            <td>${d.casesAvailable}</td>
            <td>${d.customer}</td>
            <td>${d.observations}</td>
            <td>${d.packDate}</td>
            <td>${d.age}</td>
            <td>${d.sku}</td>
          `;
          tbody.appendChild(tr);
          kept++;
        });
      }

      setChip("chip-ok", `Master Pack loaded (${rows.length.toLocaleString()} rows)`);
      chipWarn(kept ? "â€“" : "No inventory rows built");

      if (!kept) {
        setEmpty(
          "No inventory rows were built.\n\n" +
          `Diagnostics:\n- Dropped blank/meaningless rows: ${droppedBlank}\n- Dropped rows w/ unparseable date: ${droppedNoDate}\n\n` +
          "Fix: ensure Pack Data contains a Warehouse Date and at least SKU or inventory quantities."
        );
      } else {
        setEmpty("");
      }

      return outRows;
    }

    // =========================================================
    // DASHBOARD COMPUTE (reads table like your original)
    // =========================================================
    function recomputeDashboard() {
      const tbodyRows = Array.from(document.querySelectorAll("#inventory-table tbody tr"));
      if (!tbodyRows.length) {
        document.getElementById("kpi-total-inventory").textContent = "â€“";
        document.getElementById("kpi-total-available").textContent = "â€“";
        document.getElementById("kpi-unique-skus").textContent = "â€“";
        document.getElementById("kpi-avg-age").textContent = "â€“";
        const snapshotSelect = document.getElementById("snapshot-date");
        if (snapshotSelect) snapshotSelect.innerHTML = "";
        document.getElementById("sku-grid").innerHTML = "";
        return;
      }

      const allData = tbodyRows.map((row) => {
        const cells = Array.from(row.querySelectorAll("td"));
        const dateStr = (cells[0]?.textContent || "").trim();
        const dateObj = parseAnyDate(dateStr);

        return {
          date: dateStr,
          dateObj,
          batch: (cells[1]?.textContent || "").trim(),
          batchCode: (cells[1]?.textContent || "").trim(),
          location: (cells[2]?.textContent || "").trim(),
          casesInventory: parseNumber(cells[3]?.textContent),
          casesReserved: parseNumber(cells[4]?.textContent),
          casesAvailable: parseNumber(cells[5]?.textContent),
          customer: (cells[6]?.textContent || "").trim(),
          observations: (cells[7]?.textContent || "").trim(),
          packDate: (cells[8]?.textContent || "").trim(),
          age: parseNumber(cells[9]?.textContent),
          sku: (cells[10]?.textContent || "").trim(),
        };
      });

      const dateMap = new Map();
      allData.forEach((d) => {
        if (!d.date) return;
        if (!dateMap.has(d.date)) dateMap.set(d.date, d.dateObj || null);
      });

      const sortedDates = Array.from(dateMap.entries())
        .sort((a, b) => {
          const da = a[1], db = b[1];
          if (da && db) return da - db;
          if (da && !db) return -1;
          if (!da && db) return 1;
          return String(a[0]).localeCompare(String(b[0]));
        })
        .map(([label]) => label);

      if (!sortedDates.length) return;

      if (!currentSnapshotDate || !sortedDates.includes(currentSnapshotDate)) {
        currentSnapshotDate = sortedDates[sortedDates.length - 1];
      }

      const snapshotSelect = document.getElementById("snapshot-date");
      if (snapshotSelect) {
        snapshotSelect.innerHTML = "";
        sortedDates.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          snapshotSelect.appendChild(opt);
        });
        snapshotSelect.value = currentSnapshotDate;
      }

      let dayData = allData.filter((d) => d.date === currentSnapshotDate);
      if (!dayData.length) dayData = allData;

      const totalInventory = dayData.reduce((sum, d) => sum + d.casesInventory, 0);
      const totalAvailable = dayData.reduce((sum, d) => sum + d.casesAvailable, 0);
      const totalReserved = dayData.reduce((sum, d) => sum + d.casesReserved, 0);

      const skuSet = new Set(dayData.map((d) => d.sku).filter(Boolean));
      const locSet = new Set(dayData.map((d) => d.location).filter(Boolean));

      const ageValues = dayData.map((d) => d.age).filter((a) => a > 0);
      const avgAge = ageValues.length ? (ageValues.reduce((sum, v) => sum + v, 0) / ageValues.length) : 0;
      const maxAge = ageValues.length ? ageValues.reduce((m, v) => (v > m ? v : m), ageValues[0]) : 0;

      document.getElementById("kpi-total-inventory").textContent = fmt0(totalInventory);
      document.getElementById("kpi-total-available").textContent = fmt0(totalAvailable);
      document.getElementById("kpi-unique-skus").textContent = skuSet.size.toString();
      document.getElementById("kpi-avg-age").textContent = fmt1(avgAge);

      document.getElementById("kpi-inventory-label").textContent = "For " + currentSnapshotDate;
      document.getElementById("kpi-reserved-note").textContent = "Reserved: " + fmt0(totalReserved) + " cases";
      document.getElementById("kpi-location-note").textContent = "Locations: " + (locSet.size || "â€“");
      document.getElementById("kpi-age-note").textContent = maxAge > 0 ? ("Oldest lot: " + fmt1(maxAge) + " days") : "Oldest lot: â€“";

      const snapshotSubtitle = document.getElementById("snapshot-subtitle");
      if (snapshotSubtitle) {
        snapshotSubtitle.textContent =
          "Inventory snapshot for " + currentSnapshotDate +
          " (" + skuSet.size + " SKUs, " + fmt0(totalInventory) + " cases in inventory).";
      }

      // Cards
      const skuMap = new Map();
      dayData.forEach((d) => {
        const key = d.sku || "(no SKU)";
        if (!skuMap.has(key)) {
          skuMap.set(key, {
            sku: key,
            label: key,
            totalInventory: 0,
            totalAvailable: 0,
            totalReserved: 0,
            ageSum: 0,
            ageCount: 0,
            locations: new Set(),
            skusCount: 0,
          });
        }
        const agg = skuMap.get(key);
        agg.totalInventory += d.casesInventory;
        agg.totalAvailable += d.casesAvailable;
        agg.totalReserved += d.casesReserved;
        if (d.age > 0) { agg.ageSum += d.age; agg.ageCount += 1; }
        if (d.location) agg.locations.add(d.location);
        agg.skusCount += 1;
      });

      const skuAgg = Array.from(skuMap.values()).sort((a, b) => a.sku.localeCompare(b.sku));
      skuAgg.forEach((s) => (s.avgAge = s.ageCount ? s.ageSum / s.ageCount : 0));

      const sizeMap = new Map();
      dayData.forEach((d) => {
        const size = getSizeKeyFromSku(d.sku);
        if (!sizeMap.has(size)) {
          sizeMap.set(size, {
            label: prettySizeLabel(size),
            sizeKey: size,
            totalInventory: 0,
            totalAvailable: 0,
            totalReserved: 0,
            ageSum: 0,
            ageCount: 0,
            skusCount: 0,
            locations: new Set(),
          });
        }
        const agg = sizeMap.get(size);
        agg.totalInventory += d.casesInventory;
        agg.totalAvailable += d.casesAvailable;
        agg.totalReserved += d.casesReserved;
        if (d.age > 0) { agg.ageSum += d.age; agg.ageCount++; }
        if (d.location) agg.locations.add(d.location);
        agg.skusCount++;
      });

      const sizeAgg = Array.from(sizeMap.values()).sort((a, b) => a.label.localeCompare(b.label));
      sizeAgg.forEach((s) => (s.avgAge = s.ageCount ? s.ageSum / s.ageCount : 0));

      const dataForCards = cardsViewMode === "size" ? sizeAgg : skuAgg;

      const cardsPanelTitle = document.getElementById("cards-panel-title");
      const cardsPanelSubtitle = document.getElementById("cards-panel-subtitle");
      const cardsSummaryLabel = document.getElementById("cards-summary-label");

      if (cardsPanelTitle && cardsPanelSubtitle && cardsSummaryLabel) {
        if (cardsViewMode === "size") {
          cardsPanelTitle.textContent = "Inventory by size (selected day)";
          cardsPanelSubtitle.textContent = "Aggregated size inventory for the day.";
          cardsSummaryLabel.textContent = dataForCards.length + " size groups displayed";
        } else {
          cardsPanelTitle.textContent = "Inventory by SKU (selected day)";
          cardsPanelSubtitle.textContent = "One card per SKU.";
          cardsSummaryLabel.textContent = dataForCards.length + " SKUs displayed";
        }
      }

      const skuGrid = document.getElementById("sku-grid");
      if (skuGrid) {
        skuGrid.innerHTML = "";
        dataForCards.forEach((s) => {
          const card = document.createElement("div");

          let statusClass = "status-ok";
          let statusLabel = "Healthy";
          if (s.totalAvailable <= 0 && s.totalInventory > 0) { statusClass = "status-danger"; statusLabel = "Zero available"; }
          else if (s.totalAvailable > 0 && s.totalAvailable < 10) { statusClass = "status-warn"; statusLabel = "Low"; }

          card.className = "sku-card " + statusClass;
          const displayLabel = cardsViewMode === "size" ? s.label : s.sku;

          let pctAvail = 0;
          if (s.totalInventory > 0) {
            pctAvail = (s.totalAvailable / s.totalInventory) * 100;
            if (pctAvail < 0) pctAvail = 0;
            if (pctAvail > 100) pctAvail = 100;
          }

          const locationsArray = Array.from(s.locations);
          const maxChips = 8;
          const chipItems = locationsArray.slice(0, maxChips).map((loc) => `<span class="location-pill">${loc}</span>`);
          const moreCount = Math.max(0, locationsArray.length - maxChips);
          if (moreCount > 0) chipItems.push(`<span class="location-pill location-pill-more">+${moreCount} more</span>`);
          const locationsChipsHtml = chipItems.length ? chipItems.join("") : `<span class="location-pill location-pill-more">No location data</span>`;

          const locationsLabel =
            s.locations.size === 0 ? "No location" :
            s.locations.size === 1 ? locationsArray[0] :
            s.locations.size + " locations";

          const cardTagLabel =
            cardsViewMode === "size" && s.skusCount
              ? locationsLabel + " Â· " + s.skusCount + " SKU rows"
              : locationsLabel;

          card.innerHTML = `
            <div class="sku-card-header">
              <div class="sku-card-sku">${displayLabel}</div>
              <div class="sku-card-tag">${cardTagLabel}</div>
            </div>
            <div class="sku-card-main">
              <div class="sku-card-main-left">
                <div class="sku-card-metric"><span class="label">Inventory:</span> <strong>${fmt1(s.totalInventory)}</strong></div>
                <div class="sku-card-metric">
                  <span class="label">Available:</span> <strong>${fmt1(s.totalAvailable)}</strong>
                  <span class="label">Â· Reserved:</span> <strong>${fmt1(s.totalReserved)}</strong>
                </div>
                <div class="sku-card-metric"><span class="label">Avg age:</span> <strong>${fmt1(s.avgAge)}</strong> <span class="label">days</span></div>
                <div class="sku-card-locations">
                  <span class="label">Locations:</span>
                  <div class="sku-card-locations-list">${locationsChipsHtml}</div>
                </div>
              </div>
            </div>
            <div class="sku-card-bar"><div class="sku-card-bar-inner" style="width:${pctAvail}%;"></div></div>
            <div class="sku-card-status">${statusLabel}</div>
          `;

          const rowsForCard = dayData.filter((d) => {
            if (cardsViewMode === "size") {
              if (!d.sku) return false;
              return getSizeKeyFromSku(d.sku) === s.sizeKey;
            }
            return d.sku === s.sku;
          });

          card.addEventListener("click", () => {
            const label = (cardsViewMode === "size") ? s.label : s.sku;
            openLotModal(label, rowsForCard);
          });

          skuGrid.appendChild(card);
        });
      }

      // Issues
      const oldestList = document.getElementById("issues-oldest");
      const oldestEmpty = document.getElementById("issues-oldest-empty");
      const lowList = document.getElementById("issues-low");
      const lowEmpty = document.getElementById("issues-low-empty");
      const custList = document.getElementById("issues-customers");
      const custEmpty = document.getElementById("issues-customers-empty");

      if (oldestList && oldestEmpty) {
        oldestList.innerHTML = "";
        const oldestLots = dayData.filter((d) => d.age > 0).sort((a, b) => b.age - a.age).slice(0, 5);
        if (!oldestLots.length) oldestEmpty.textContent = "No age data for this day.";
        else {
          oldestEmpty.textContent = "";
          oldestLots.forEach((d) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> â€“ ${fmt1(d.casesInventory)} cases Â· ${fmt1(d.age)} days Â· <span class="label">${d.batch || ""}</span>`;
            oldestList.appendChild(li);
          });
        }
      }

      if (lowList && lowEmpty) {
        lowList.innerHTML = "";
        const zeroAvail = dayData.filter((d) => d.casesInventory > 0 && d.casesAvailable <= 0);
        const lowAvail = dayData.filter((d) => d.casesAvailable > 0 && d.casesAvailable < 10);
        if (!zeroAvail.length && !lowAvail.length) lowEmpty.textContent = "No low or zero availability for this day.";
        else {
          lowEmpty.textContent = "";
          zeroAvail.slice(0, 5).forEach((d) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> â€“ ${fmt1(d.casesInventory)} cases Â· <span class="issues-pill bad">0 available</span>`;
            lowList.appendChild(li);
          });
          lowAvail.slice(0, 5).forEach((d) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> â€“ ${fmt1(d.casesAvailable)} available Â· ${fmt1(d.casesInventory)} in inventory <span class="issues-pill warn">Low</span>`;
            lowList.appendChild(li);
          });
        }
      }

      if (custList && custEmpty) {
        custList.innerHTML = "";
        const custMap = new Map();
        dayData.forEach((d) => {
          if (!d.customer) return;
          if (!custMap.has(d.customer)) custMap.set(d.customer, { customer: d.customer, reserved: 0 });
          custMap.get(d.customer).reserved += d.casesReserved || 0;
        });

        const custAgg = Array.from(custMap.values()).filter((c) => c.reserved > 0).sort((a, b) => b.reserved - a.reserved).slice(0, 5);
        if (!custAgg.length) custEmpty.textContent = "No customer reservations for this day.";
        else {
          custEmpty.textContent = "";
          custAgg.forEach((c) => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${c.customer}</strong> â€“ ${fmt1(c.reserved)} cases reserved`;
            custList.appendChild(li);
          });
        }
      }

      // Totals footer (selected day)
      const totalInvAll = dayData.reduce((sum, d) => sum + d.casesInventory, 0);
      const totalResAll = dayData.reduce((sum, d) => sum + d.casesReserved, 0);
      const totalAvailAll = dayData.reduce((sum, d) => sum + d.casesAvailable, 0);
      const ageAll = dayData.map((d) => d.age).filter((a) => a > 0);
      const avgAgeAll = ageAll.length ? ageAll.reduce((s, v) => s + v, 0) / ageAll.length : 0;

      const tfootRow = document.querySelector("#inventory-table tfoot tr");
      if (tfootRow) {
        const tds = tfootRow.querySelectorAll("td");
        if (tds.length >= 11) {
          tds[0].textContent = "Totals (selected day)";
          tds[3].textContent = fmt1(totalInvAll);
          tds[4].textContent = fmt1(totalResAll);
          tds[5].textContent = fmt1(totalAvailAll);
          tds[9].textContent = fmt1(avgAgeAll);
        }
      }
    }

    function openLotModal(label, rowsForCard) {
      const existing = document.getElementById("lot-modal-backdrop");
      if (existing) existing.remove();

      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop";
      backdrop.id = "lot-modal-backdrop";

      const panel = document.createElement("div");
      panel.className = "modal-panel";

      const header = document.createElement("div");
      header.className = "modal-header";

      const title = document.createElement("div");
      title.className = "modal-title";
      title.textContent = "Lot details Â· " + label;

      const closeBtn = document.createElement("button");
      closeBtn.className = "modal-close-btn";
      closeBtn.type = "button";
      closeBtn.textContent = "Close âœ•";
      closeBtn.addEventListener("click", () => backdrop.remove());

      header.appendChild(title);
      header.appendChild(closeBtn);

      const body = document.createElement("div");
      body.className = "modal-body";

      if (!rowsForCard || !rowsForCard.length) {
        const p = document.createElement("div");
        p.className = "modal-subtitle";
        p.textContent = "No lot records for this item on the selected date.";
        body.appendChild(p);
      } else {
        const subtitle = document.createElement("div");
        subtitle.className = "modal-subtitle";
        subtitle.textContent =
          rowsForCard.length + " row" + (rowsForCard.length > 1 ? "s" : "") +
          " Â· Batch / location / inventory / available";
        body.appendChild(subtitle);

        const table = document.createElement("table");
        table.className = "modal-lot-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Batch</th>
              <th>Location</th>
              <th>Cases inv.</th>
              <th>Cases avail.</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        rowsForCard.forEach((d) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.batchCode || ""}</td>
            <td>${d.location || ""}</td>
            <td>${fmt1(d.casesInventory || 0)}</td>
            <td>${fmt1(d.casesAvailable || 0)}</td>
          `;
          tbody.appendChild(tr);
        });

        body.appendChild(table);
      }

      panel.appendChild(header);
      panel.appendChild(body);
      backdrop.appendChild(panel);

      backdrop.addEventListener("click", (e) => { if (e.target === backdrop) backdrop.remove(); });
      document.body.appendChild(backdrop);
    }

    function setupSnapshotSelector() {
      const select = document.getElementById("snapshot-date");
      if (!select) return;
      select.addEventListener("change", () => {
        currentSnapshotDate = select.value;
        recomputeDashboard();
      });
    }

    function setupCardsViewToggle() {
      const btnSku = document.getElementById("cards-view-sku");
      const btnSize = document.getElementById("cards-view-size");

      btnSku.addEventListener("click", () => {
        cardsViewMode = "sku";
        btnSku.classList.add("active");
        btnSize.classList.remove("active");
        recomputeDashboard();
      });

      btnSize.addEventListener("click", () => {
        cardsViewMode = "size";
        btnSize.classList.add("active");
        btnSku.classList.remove("active");
        recomputeDashboard();
      });
    }

    // =========================================================
    // LIVE REFRESH (bulletproof, like Seeding)
    // =========================================================
    let reloadTimer = null;

    function reloadAll(reason){
      if (reloadTimer) clearTimeout(reloadTimer);
      reloadTimer = setTimeout(() => {
        reloadTimer = null;
        buildFromMasterPack();
        recomputeDashboard();
        // console.log("ðŸ”„ Reloaded S&H inventory:", reason || "");
      }, 60);
    }

    function setupLiveListeners() {
      // 1) storage events (cross-tab)
      window.addEventListener("storage", (e) => {
        if (!e) return;
        if (e.key === MASTER_PACK_KEY || e.key === MASTER_PACK_PING_KEY) reloadAll("storage");
      });

      // 2) postMessage from index/data-input
      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === MSG_PACK || msg.type === "MASTER_PACK_UPDATED") reloadAll("message");
      });

      // 3) CustomEvent (same frame)
      window.addEventListener(MSG_PACK, () => reloadAll("customevent"));

      // 4) BroadcastChannel
      if (bc) {
        bc.onmessage = (ev) => {
          const msg = ev?.data;
          if (msg?.type === MSG_PACK) reloadAll("broadcast");
        };
      }

      // 5) Safety poll
      let lastLen = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
      setInterval(() => {
        const curLen = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
        if (curLen !== lastLen) {
          lastLen = curLen;
          reloadAll("poll");
        }
      }, 1500);
    }

    // =========================================================
    // INIT
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      setupSnapshotSelector();
      setupCardsViewToggle();
      setupLiveListeners();
      reloadAll("init");
    });
  </script>
</body>
</html>
