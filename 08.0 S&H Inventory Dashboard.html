<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --bg-alt:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --card:#020617;
      --border:#1f2937;
      --border-subtle:#374151;
      --text:#e5e7eb;
      --sub:#9ca3af;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.15);
      --accent-strong:#4ade80;
      --danger:#ef4444;
      --danger-soft:rgba(239,68,68,.15);
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color:var(--text);
    }
    .page{min-height:100vh;padding:16px;display:flex;justify-content:center;}
    .container{
      width:100%;
      max-width:1320px;
      border-radius:24px;
      padding:20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.09), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 24px 80px rgba(0,0,0,.8),0 0 0 1px rgba(15,23,42,.8);
      backdrop-filter: blur(20px);
    }
    .header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:16px;}
    .title-block{flex:1 1 200px;min-width:0;}
    .title{display:flex;align-items:center;gap:10px;margin:0 0 4px;font-size:1.3rem;letter-spacing:.02em;}
    .title-pill{
      width:26px;height:26px;border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #34d399, #22c55e 55%, #16a34a 100%);
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 2px rgba(15,23,42,.9),0 12px 30px rgba(16,185,129,.6);
    }
    .title-pill span{font-size:15px;font-weight:700;color:#022c22;}
    .title-text{font-weight:620;display:flex;align-items:baseline;gap:8px;}
    .title-sub{font-size:.8rem;color:var(--sub);text-transform:uppercase;letter-spacing:.18em;}
    .subtitle{margin:0;font-size:.85rem;color:var(--muted);}
    .header-tags{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:999px;padding:4px 9px;font-size:.72rem;
      border:1px solid rgba(148,163,184,.5);
      color:var(--sub);
      background: radial-gradient(circle at top left, rgba(148,163,184,.18), transparent 55%);
    }
    .chip-dot{width:6px;height:6px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 3px rgba(34,197,94,.35);}
    .chip-danger-dot{width:6px;height:6px;border-radius:999px;background:var(--danger);box-shadow:0 0 0 3px rgba(248,113,113,.4);}

    .panel{
      border-radius:18px;
      padding:12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.9),0 0 0 1px rgba(15,23,42,.9);
      backdrop-filter: blur(14px);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panel-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;}
    .panel-title{
      font-size:.82rem;text-transform:uppercase;letter-spacing:.16em;
      color:var(--sub);display:flex;align-items:center;gap:7px;
    }
    .panel-title-dot{width:7px;height:7px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 3px rgba(34,197,94,.45);}
    .panel-subtitle{font-size:.75rem;color:var(--muted);}
    .panel-header-right{display:flex;align-items:center;gap:6px;font-size:.72rem;color:var(--sub);flex-wrap:wrap;justify-content:flex-end;}

    .btn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:5px 12px;
      font-size:.74rem;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      transition: background .12s ease, transform .05s ease, box-shadow .12s ease;
    }
    .btn-primary{
      background: radial-gradient(circle at 0 0, rgba(34,197,94,.3), rgba(22,163,74,.95));
      border-color: rgba(34,197,94,.9);
      box-shadow: 0 7px 20px rgba(16,185,129,.45);
    }
    .btn-primary:hover{
      background: radial-gradient(circle at 0 0, rgba(34,197,94,.4), rgba(21,128,61,1));
      transform: translateY(-.5px);
      box-shadow: 0 9px 26px rgba(16,185,129,.55);
    }
    .btn-ghost{background: rgba(15,23,42,.9);}
    .btn-ghost:hover{background: rgba(31,41,55,.95);}
    .btn-toggle{padding:4px 9px;font-size:.7rem;}
    .btn span.icon{font-size:.8rem;opacity:.9;}

    .input-panel-body{margin-top:6px;display:grid;grid-template-columns:minmax(0,3fr) minmax(0,2fr);gap:10px;}
    .input-panel-body.collapsed{display:none;}
    @media (max-width:900px){.input-panel-body{grid-template-columns:minmax(0,1fr);}}
    textarea{
      width:100%;
      min-height:90px;
      max-height:180px;
      resize:vertical;
      border-radius:10px;
      border:1px solid rgba(55,65,81,.9);
      background: rgba(15,23,42,.95);
      color: var(--text);
      font-size:.78rem;
      padding:8px 10px;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    textarea::placeholder{color: rgba(148,163,184,.8);}
    .input-panel-help{font-size:.74rem;color:var(--muted);line-height:1.35;}
    .input-panel-help ul{margin:6px 0 0;padding-left:16px;}
    .input-panel-help li{margin-bottom:3px;}

    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:10px 0 14px;}
    @media (max-width:960px){.kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .kpi-card{
      position:relative;border-radius:16px;padding:10px 12px 11px;
      background: radial-gradient(circle at top left, rgba(31,41,55,.85), rgba(15,23,42,.98));
      border:1px solid rgba(51,65,85,.9);
      box-shadow:0 14px 30px rgba(0,0,0,.9),0 0 0 1px rgba(15,23,42,.9);
      overflow:hidden;
    }
    .kpi-label{font-size:.74rem;text-transform:uppercase;letter-spacing:.14em;color:var(--sub);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .kpi-value{font-size:1.15rem;font-weight:650;display:flex;align-items:baseline;gap:4px;}
    .kpi-unit{font-size:.72rem;color:var(--muted);text-transform:uppercase;}
    .kpi-trend{margin-top:2px;font-size:.7rem;color:var(--accent-strong);display:inline-flex;align-items:center;gap:4px;}
    .kpi-glow{
      position:absolute;inset:0;opacity:.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34,197,94,.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59,130,246,.4), transparent 60%);
      pointer-events:none;mix-blend-mode:screen;
    }

    .layout-main{
      display:grid;
      grid-template-columns: minmax(0, 2.6fr) minmax(0, 1.6fr);
      gap:16px;
      align-items:stretch;
      margin-top:10px;
    }
    @media (max-width:960px){.layout-main{grid-template-columns:minmax(0,1fr);} }

    .badge-soft{
      border-radius:999px;padding:3px 8px;
      border:1px solid rgba(148,163,184,.45);
      background: radial-gradient(circle at top left, rgba(30,64,175,.55), rgba(15,23,42,.95));
      display:inline-flex;align-items:center;gap:6px;font-size:.72rem;
    }
    .badge-soft span{font-size:.7rem;text-transform:uppercase;letter-spacing:.12em;color:rgba(226,232,240,.95);}
    .badge-dot{width:7px;height:7px;border-radius:999px;background:#38bdf8;box-shadow:0 0 0 3px rgba(56,189,248,.48);}

    .view-toggle{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:999px;border:1px solid rgba(55,65,81,.9);
      background: rgba(15,23,42,.95);
      padding:2px 8px;font-size:.7rem;
    }
    .view-toggle span{text-transform:uppercase;letter-spacing:.12em;font-size:.68rem;color:var(--sub);}
    .view-toggle select{background:transparent;border:none;color:var(--sub);font-size:.7rem;font-family:inherit;outline:none;}

    .sku-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap:10px;
      margin-top:4px;
      max-height:420px;
      overflow:auto;
      scrollbar-width:thin;
      scrollbar-color:#4b5563 rgba(15,23,42,.2);
      padding-right:3px;
    }
    .sku-grid::-webkit-scrollbar{width:6px;}
    .sku-grid::-webkit-scrollbar-track{background: rgba(15,23,42,.8);}
    .sku-grid::-webkit-scrollbar-thumb{background-color:#4b5563;border-radius:999px;}

    .sku-card{
      position:relative;
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
      border-radius:14px;
      padding:8px 10px;
      background: radial-gradient(circle at top left, rgba(31,41,55,.9), rgba(15,23,42,.98));
      border:1px solid rgba(55,65,81,.95);
      box-shadow:0 12px 26px rgba(0,0,0,.85),0 0 0 1px rgba(15,23,42,.95);
      font-size:.78rem;
      display:flex;flex-direction:column;gap:4px;
    }
    .sku-card:hover{transform: translateY(-2px);}
    .sku-card-header{display:flex;justify-content:space-between;align-items:baseline;gap:6px;}
    .sku-card-sku{font-weight:620;font-size:.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .sku-card-tag{font-size:.68rem;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.7);color:var(--sub);background: rgba(15,23,42,.95);white-space:nowrap;}
    .sku-card-metric{font-size:.75rem;color:var(--sub);}
    .sku-card-metric strong{color:#e5e7eb;font-weight:600;}
    .sku-card-locations{margin-top:4px;font-size:.72rem;color:var(--sub);display:flex;flex-direction:column;align-items:flex-start;gap:4px;}
    .sku-card-locations .label{text-transform:uppercase;letter-spacing:.12em;font-size:.68rem;color:var(--muted);}
    .sku-card-locations-list{display:flex;flex-wrap:wrap;gap:4px;}
    .location-pill{padding:2px 6px;border-radius:999px;border:1px solid rgba(55,65,81,.9);background: rgba(15,23,42,.95);font-size:.7rem;}
    .location-pill-more{opacity:.8;font-style:italic;}

    .sku-card-bar{margin-top:4px;height:6px;border-radius:999px;background: rgba(15,23,42,.95);border:1px solid rgba(55,65,81,.9);overflow:hidden;}
    .sku-card-bar-inner{height:100%;background: linear-gradient(to right, rgba(34,197,94,.9), rgba(59,130,246,.9));width:0%;transition: width .2s ease-out;}
    .sku-card-status{font-size:.7rem;margin-top:2px;text-transform:uppercase;letter-spacing:.12em;color:var(--sub);}

    .status-ok{border-color: rgba(34,197,94,.9);box-shadow:0 0 0 1px rgba(22,163,74,.5),0 12px 24px rgba(22,163,74,.35);}
    .status-warn{border-color: rgba(245,158,11,.9);box-shadow:0 0 0 1px rgba(245,158,11,.5),0 12px 24px rgba(245,158,11,.25);}
    .status-danger{border-color: rgba(239,68,68,.95);box-shadow:0 0 0 1px rgba(239,68,68,.7),0 12px 26px rgba(239,68,68,.4);}

    .issues-section{font-size:.75rem;color:var(--sub);margin-top:4px;display:flex;flex-direction:column;gap:8px;}
    .issues-section h4{margin:4px 0 3px;font-size:.78rem;text-transform:uppercase;letter-spacing:.14em;color:var(--sub);}
    .issues-section ul{list-style:none;padding-left:0;margin:0 0 4px;}
    .issues-section li{padding:2px 0;font-size:.73rem;color:#cbd5f5;}
    .issues-empty{font-size:.72rem;color:var(--muted);}
    .issues-pill{
      display:inline-flex;align-items:center;border-radius:999px;padding:2px 6px;
      font-size:.68rem;border:1px solid rgba(55,65,81,.9);background: rgba(15,23,42,.95);margin-left:4px;
    }
    .issues-pill.bad{border-color: rgba(239,68,68,.9);color:#fecaca;}
    .issues-pill.warn{border-color: rgba(245,158,11,.9);color:#fed7aa;}

    .table-wrapper{
      margin-top:12px;border-radius:14px;border:1px solid rgba(55,65,81,.95);
      background:
        linear-gradient(135deg, rgba(17,24,39,.96), rgba(15,23,42,.99)),
        radial-gradient(circle at top left, rgba(51,65,85,.65), rgba(15,23,42,.96));
      overflow:hidden;display:flex;flex-direction:column;
    }
    .table-wrapper.collapsed{display:none;}
    .table-scroll{max-height:380px;overflow:auto;scrollbar-width:thin;scrollbar-color:#4b5563 rgba(15,23,42,.2);flex:1 1 auto;}
    .table-scroll::-webkit-scrollbar{width:6px;height:6px;}
    .table-scroll::-webkit-scrollbar-track{background: rgba(15,23,42,.8);}
    .table-scroll::-webkit-scrollbar-thumb{background-color:#4b5563;border-radius:999px;}

    table{width:100%;border-collapse:collapse;font-size:.78rem;}
    #inventory-table{min-width:960px;}
    thead{
      position:sticky;top:0;z-index:2;
      background: linear-gradient(to bottom, #020617, #020617),
                  radial-gradient(circle at top left, rgba(55,65,81,.5), rgba(15,23,42,.95));
      box-shadow:0 1px 0 rgba(31,41,55,.9);
    }
    th,td{text-align:right;padding:6px 10px;border-bottom:1px solid rgba(31,41,55,.85);white-space:nowrap;}
    th:first-child,td:first-child{text-align:left;padding-left:14px;}
    th:last-child,td:last-child{padding-right:12px;}
    th{font-size:.72rem;text-transform:uppercase;letter-spacing:.15em;color:var(--sub);background:transparent;}
    tbody tr:nth-child(odd) td{background: rgba(15,23,42,.85);}
    tbody tr:nth-child(even) td{background: rgba(17,24,39,.92);}
    tbody tr:hover td{background: radial-gradient(circle at 0 0, rgba(34,197,94,.08), rgba(15,23,42,.98));}
    tfoot td{
      background: radial-gradient(circle at 0 0, rgba(34,197,94,.12), rgba(15,23,42,.98));
      font-weight:600;border-top:1px solid rgba(55,65,81,.95);border-bottom:none;
    }

    .modal-backdrop{position:fixed;inset:0;background: rgba(15,23,42,.85);display:flex;align-items:flex-start;justify-content:center;z-index:50;padding-top:8vh;}
    .modal-panel{
      max-width:900px;width:auto;max-height:80vh;border-radius:18px;
      padding:12px 14px;background: radial-gradient(circle at top left, rgba(31,41,55,.9), rgba(15,23,42,.98));
      border:1px solid rgba(55,65,81,.9);box-shadow:0 30px 80px rgba(0,0,0,.9);
      display:flex;flex-direction:column;
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:.8rem;color:var(--sub);}
    .modal-title{text-transform:uppercase;letter-spacing:.14em;font-size:.72rem;}
    .modal-close-btn{border:none;background: rgba(15,23,42,.9);border-radius:999px;padding:3px 8px;font-size:.75rem;color:var(--sub);cursor:pointer;}
    .modal-body{flex:1 1 auto;overflow-y:auto;overflow-x:auto;}
    .modal-subtitle{font-size:.75rem;color:var(--muted);margin-bottom:4px;}
    .modal-lot-table{
      table-layout:auto;border-collapse:collapse;width:auto !important;min-width:0 !important;max-width:100%;
      font-size:.68rem;margin:0 auto;
    }
    .modal-lot-table th,.modal-lot-table td{padding:3px 10px;border-bottom:1px solid rgba(31,41,55,.9);white-space:nowrap;}
    .modal-lot-table th{text-transform:uppercase;letter-spacing:.12em;font-size:.66rem;color:var(--sub);}
    .modal-lot-table th:nth-child(1), .modal-lot-table td:nth-child(1){
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.64rem;min-width:10ch;text-align:left;
    }
    .modal-lot-table th:nth-child(2), .modal-lot-table td:nth-child(2){text-align:left;}
    .modal-lot-table th:nth-child(3), .modal-lot-table td:nth-child(3){width:1%;text-align:right;}
    .modal-lot-table th:nth-child(4), .modal-lot-table td:nth-child(4){width:1%;text-align:right;}

    .hint-empty{font-size:.75rem;color:var(--muted);margin-top:10px;white-space:pre-wrap;}
  </style>
</head>

<body>
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>i</span></div>
            <div class="title-text">
              <span>Inventory Dashboard</span>
              <span class="title-sub">LIVE FROM DATA INPUT</span>
            </div>
          </div>
          <p class="subtitle">Daily warehouse inventory snapshot by SKU and batch (cases in stock, reserved, and available).</p>
        </div>

        <div class="header-tags">
          <div class="chip"><span class="chip-dot"></span><span id="chip-ok">Waiting for Master Pack…</span></div>
          <div class="chip"><span class="chip-danger-dot"></span><span id="chip-warn">–</span></div>
        </div>
      </header>

      <!-- Optional paste input (fallback). Primary source is localStorage master payloads. -->
      <section class="panel" style="margin-bottom:10px;">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span>Data input (fallback)</span></div>
            <div class="panel-subtitle">Optional: paste rows if Master Pack/Grow is not available yet.</div>
          </div>
          <div class="panel-header-right">
            <span>Cols: Date · Batch · Location · Inv · Reserved · Avail · Customer · Obs · Pack Date · Age · SKU</span>
            <button class="btn btn-ghost btn-toggle" id="toggle-input-panel-btn" type="button">
              <span class="icon" id="toggle-input-icon">▸</span>
              <span id="toggle-input-label">Show</span>
            </button>
          </div>
        </div>

        <div class="input-panel-body collapsed" id="input-panel-body">
          <div>
            <textarea id="paste-area" placeholder="Paste tab-separated rows here (copied from Excel)…"></textarea>
            <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;">
              <button class="btn btn-primary" id="apply-data-btn" type="button"><span class="icon">⏵</span><span>Apply pasted data</span></button>
              <button class="btn btn-ghost" id="clear-data-btn" type="button"><span class="icon">✕</span><span>Clear paste</span></button>
            </div>
          </div>
          <div class="input-panel-help">
            <strong>Notes:</strong>
            <ul>
              <li>Main source = <code>campo_master_pack_v1</code> (or grow fallback) written by Data Input.</li>
              <li>Paste mode is only a fallback; it will not replace Master Pack unless Master Pack is missing.</li>
              <li>Blank “date-only” rows from Excel are ignored so the dashboard won’t break.</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="panel" style="margin-bottom:10px;">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span>Daily snapshot</span></div>
            <div class="panel-subtitle" id="snapshot-subtitle">Select a day to see inventory for that date.</div>
          </div>
          <div class="panel-header-right">
            <div class="badge-soft"><span class="badge-dot"></span><span>Snapshot by warehouse date</span></div>
            <div class="view-toggle">
              <span>Date</span>
              <select id="snapshot-date"></select>
            </div>
          </div>
        </div>

        <section class="kpi-grid">
          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases in inventory</div>
            <div class="kpi-value"><span id="kpi-total-inventory">–</span></div>
            <div class="kpi-trend"><span id="kpi-inventory-label">For selected day</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases available</div>
            <div class="kpi-value"><span id="kpi-total-available">–</span><span class="kpi-unit">Cases</span></div>
            <div class="kpi-trend"><span id="kpi-reserved-note">Reserved: – cases</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Unique SKUs in stock</div>
            <div class="kpi-value"><span id="kpi-unique-skus">–</span><span class="kpi-unit">SKUs</span></div>
            <div class="kpi-trend"><span id="kpi-location-note">Locations: –</span></div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Average inventory age</div>
            <div class="kpi-value"><span id="kpi-avg-age">–</span><span class="kpi-unit">Days</span></div>
            <div class="kpi-trend"><span id="kpi-age-note">Oldest lot: –</span></div>
          </article>
        </section>
      </section>

      <section class="layout-main">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span>Inventory by SKU (selected day)</span></div>
              <div class="panel-subtitle">One card per SKU – totals, availability, and locations. Click a card for lot details.</div>
            </div>
            <div class="panel-header-right">
              <span id="cards-summary-label">– SKUs displayed</span>
            </div>
          </div>
          <div class="sku-grid" id="sku-grid"></div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title"><span class="panel-title-dot"></span><span>Top issues today</span></div>
              <div class="panel-subtitle">Oldest product, low / zero availability, and customer reservations for the selected day.</div>
            </div>
          </div>

          <div class="issues-section">
            <div>
              <h4>Oldest lots</h4>
              <ul id="issues-oldest"></ul>
              <div id="issues-oldest-empty" class="issues-empty"></div>
            </div>

            <div>
              <h4>Low / zero availability</h4>
              <ul id="issues-low"></ul>
              <div id="issues-low-empty" class="issues-empty"></div>
            </div>

            <div>
              <h4>Customer reservations</h4>
              <ul id="issues-customers"></ul>
              <div id="issues-customers-empty" class="issues-empty"></div>
            </div>
          </div>
        </section>
      </section>

      <section class="panel" style="margin-top:12px;">
        <div class="panel-header">
          <div>
            <div class="panel-title"><span class="panel-title-dot"></span><span>Raw inventory table</span></div>
            <div class="panel-subtitle">Full data set across all dates. Defaults to selected day only.</div>
          </div>
          <div class="panel-header-right">
            <button class="btn btn-ghost btn-toggle" id="toggle-raw-view-btn" type="button">
              <span class="icon" id="toggle-raw-view-icon">◴</span>
              <span id="toggle-raw-view-label">Show all raw inventory</span>
            </button>
            <button class="btn btn-ghost btn-toggle" id="toggle-table-panel-btn" type="button">
              <span class="icon" id="toggle-table-icon">▸</span>
              <span id="toggle-table-label">Show</span>
            </button>
          </div>
        </div>

        <div class="table-wrapper collapsed" id="table-panel-body">
          <div class="table-scroll">
            <table id="inventory-table">
              <thead>
                <tr>
                  <th>Warehouse Date</th>
                  <th>W-Batch Run Code</th>
                  <th>Warehouse Location</th>
                  <th>Cases in Inventory</th>
                  <th>Cases Reserved</th>
                  <th>Cases Available</th>
                  <th>Customer Reserved</th>
                  <th>Warehouse Observations</th>
                  <th>Warehouse Pack Date</th>
                  <th>Warehouse Age</th>
                  <th>Warehouse SKU</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>Totals</td>
                  <td>–</td>
                  <td>–</td>
                  <td>0.0</td>
                  <td>0.0</td>
                  <td>0.0</td>
                  <td>–</td>
                  <td>–</td>
                  <td>–</td>
                  <td>0.0</td>
                  <td>–</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div id="empty-hint" class="hint-empty"></div>
      </section>

    </div>
  </div>

  <script>
    // =========================================================
    // STORAGE CONTRACT (match seeding style)
    // =========================================================
    const MASTER_GROW_KEY = "campo_master_grow_v1";
    const MASTER_GROW_PING_KEY = "campo_master_grow_push_ping_v1";
    const MASTER_GROW_SHEET_NAME = "Master Grow";

    const MASTER_PACK_KEY = "campo_master_pack_v1";
    const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";
    const MASTER_PACK_SHEET_NAME = "Master Pack";

    // Message types (from index/data-input)
    const MSG_GROW = "MASTER_GROW_UPDATED";
    const MSG_PACK = "MASTER_PACK_UPDATED";

    // BroadcastChannel bus (same-origin)
    const BC_NAME = "campo_master_bus_v1";
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(BC_NAME) : null;

    // Fallback paste storage (optional)
    const INVENTORY_PASTE_KEY = "campo_inventory_paste_v1";

    // =========================================================
    // CANONICAL INVENTORY COLUMN MEANINGS + ALIASES
    // (we map whatever the sheet calls it into these meanings)
    // =========================================================
    const INV = Object.freeze({
      DATE: "Warehouse Date",
      BATCH: "W-Batch Run Code",
      LOCATION: "Warehouse Location",
      CASES_INV: "Cases in Inventory",
      CASES_RES: "Cases Reserved",
      CASES_AVAIL: "Cases Available",
      CUSTOMER: "Customer Reserved",
      OBS: "Warehouse Observations",
      PACK_DATE: "Warehouse Pack Date",
      AGE: "Warehouse Age",
      SKU: "Warehouse SKU"
    });

    function normHeader(s){
      return String(s ?? "").replace(/\s+/g," ").trim().toLowerCase();
    }

    const HEADER_ALIASES = new Map([
      ["warehouse date", INV.DATE],
      ["date", INV.DATE],
      ["warehousedate", INV.DATE],

      ["w-batch run code", INV.BATCH],
      ["w batch run code", INV.BATCH],
      ["batch", INV.BATCH],
      ["batch runcode", INV.BATCH],
      ["wbatchruncode", INV.BATCH],

      ["warehouse location", INV.LOCATION],
      ["location", INV.LOCATION],
      ["warehouselocation", INV.LOCATION],

      ["cases in inventory", INV.CASES_INV],
      ["casesinventory", INV.CASES_INV],
      ["inventory", INV.CASES_INV],
      ["cases in stock", INV.CASES_INV],

      ["cases reserved", INV.CASES_RES],
      ["reserved", INV.CASES_RES],

      ["cases available", INV.CASES_AVAIL],
      ["available", INV.CASES_AVAIL],

      ["customer reserved", INV.CUSTOMER],
      ["cutomer reserved", INV.CUSTOMER], // common typo
      ["customer", INV.CUSTOMER],

      ["warehouse observations", INV.OBS],
      ["observations", INV.OBS],

      ["warehouse pack date", INV.PACK_DATE],
      ["pack date", INV.PACK_DATE],

      ["warehouse age", INV.AGE],
      ["age", INV.AGE],

      ["warehouse sku", INV.SKU],
      ["sku", INV.SKU],
      ["warehousesku", INV.SKU]
    ]);

    function canonicalizeHeaders(headersRaw){
      const canonHeaders = [];
      const canonIndexByName = new Map();
      headersRaw.forEach((h, idx) => {
        const raw = String(h ?? "");
        const key = normHeader(raw);
        const canon = HEADER_ALIASES.get(key) || raw.trim();
        canonHeaders[idx] = canon;
        if (canon && !canonIndexByName.has(canon)) canonIndexByName.set(canon, idx);
      });
      return { canonHeaders, canonIndexByName };
    }

    // =========================================================
    // PARSERS (bulletproof)
    // =========================================================
    function parseNumber(v){
      if (v === null || v === undefined) return 0;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const cleaned = s.replace(/,/g,"");
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function parseAnyDate(v){
      if (v === null || v === undefined) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return v;

      // Excel serial
      if (typeof v === "number" && Number.isFinite(v) && v > 20000 && v < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + v * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      const s0 = String(v).trim();
      if (!s0) return null;
      if (/^#(VALUE|REF|NAME|DIV\/0|N\/A)!?$/i.test(s0)) return null;

      const n = Number(s0);
      if (Number.isFinite(n) && n > 20000 && n < 60000) {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const d = new Date(excelEpoch.getTime() + n * 86400000);
        return isNaN(d.getTime()) ? null : d;
      }

      // Strip weekday prefix "Monday, December 22, 2025"
      let s = s0;
      const parts = s.split(",");
      if (parts.length >= 2 && /[a-z]/i.test(parts[0])) s = parts.slice(1).join(",").trim();

      // ISO
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }

      // US
      if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) {
        const [mm, dd, yy] = s.split("/").map(Number);
        const yyyy = yy < 100 ? 2000 + yy : yy;
        const d = new Date(yyyy, mm-1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatDateLongOrMMDD(v){
      // keep your "Monday, December 22, 2025" style if already given,
      // but for computed dates fall back to MM/DD/YYYY
      const d = parseAnyDate(v);
      if (!d) return String(v ?? "").trim();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    function daysBetween(a, b){
      const da = parseAnyDate(a);
      const db = parseAnyDate(b);
      if (!da || !db) return 0;
      const ms = da.getTime() - db.getTime();
      return Math.max(0, ms / 86400000);
    }

    function fmt0(n){ return (n || 0).toLocaleString(undefined, { maximumFractionDigits: 0 }); }
    function fmt1(n){ return (n || 0).toLocaleString(undefined, { maximumFractionDigits: 1 }); }

    // Ignore Excel filler rows like "Monday, Dec 22, 2025" with blanks everywhere else
    function isMeaningfulRow(r){
      const hasDate = !!(r.date && r.date.trim());
      const hasOther =
        !!(r.batch && r.batch.trim()) ||
        !!(r.location && r.location.trim()) ||
        !!(r.sku && r.sku.trim()) ||
        r.casesInventory > 0 ||
        r.casesReserved > 0 ||
        r.casesAvailable > 0 ||
        !!(r.customer && r.customer.trim()) ||
        !!(r.packDate && r.packDate.trim()) ||
        r.age > 0 ||
        !!(r.observations && r.observations.trim());
      return hasDate && hasOther;
    }

    // =========================================================
    // UI HELPERS (match seeding)
    // =========================================================
    function setEmpty(msg){
      const el = document.getElementById("empty-hint");
      if (el) el.textContent = msg || "";
    }
    function setChip(id, text){
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }
    function chipWarn(msg){ setChip("chip-warn", msg || "–"); }

    // =========================================================
    // SHEET LOADING
    // =========================================================
    function loadPayload(key){
      const raw = (localStorage.getItem(key) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function sheetToRowObjects(sheetObj){
      const headersRaw = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
      const { canonHeaders } = canonicalizeHeaders(headersRaw);

      const out = [];
      for (const r of rows){
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i=0;i<canonHeaders.length;i++){
          const key = String(canonHeaders[i] ?? "").trim();
          if (!key) continue;
          obj[key] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return out;
    }

    // Find the best sheet containing inventory headers (in Master Pack first, then Grow)
    function findInventorySheet(payload){
      const sheets = payload?.sheets;
      if (!sheets || typeof sheets !== "object") return null;

      const required = [INV.DATE, INV.CASES_INV, INV.SKU];
      let best = null;
      let bestScore = -1;

      for (const [name, sheet] of Object.entries(sheets)){
        const headersRaw = Array.isArray(sheet?.headers) ? sheet.headers : [];
        const { canonHeaders } = canonicalizeHeaders(headersRaw);
        const headerSet = new Set(canonHeaders.map(h => String(h||"").trim()).filter(Boolean));

        let score = 0;
        required.forEach(h => { if (headerSet.has(h)) score += 5; });
        // bonus points for more matches
        const allCanon = Object.values(INV);
        allCanon.forEach(h => { if (headerSet.has(h)) score += 1; });

        if (score > bestScore){
          bestScore = score;
          best = { name, sheet, headerSet };
        }
      }

      // needs at least required hits (15 points)
      if (!best || bestScore < 15) return null;
      return best;
    }

    // =========================================================
    // DATA BUILD
    // =========================================================
    let allInventoryRows = [];     // normalized objects
    let currentSnapshotDate = null;
    let rawTableShowAll = false;

    function normalizeInventoryRows(rows){
      const out = [];

      let droppedBlank = 0;
      let droppedNoDate = 0;
      let droppedNotMeaningful = 0;

      for (const r of rows){
        if (!r || typeof r !== "object") continue;

        const dateRaw = r[INV.DATE];
        const dateStr = String(dateRaw ?? "").trim();
        const dateObj = parseAnyDate(dateRaw);
        if (!dateObj) { droppedNoDate++; continue; }

        const batch = String(r[INV.BATCH] ?? "").trim();
        const location = String(r[INV.LOCATION] ?? "").trim();
        const sku = String(r[INV.SKU] ?? "").trim();
        const customer = String(r[INV.CUSTOMER] ?? "").trim();
        const observations = String(r[INV.OBS] ?? "").trim();

        const casesInv = parseNumber(r[INV.CASES_INV]);
        const casesRes = parseNumber(r[INV.CASES_RES]);
        const casesAvail = parseNumber(r[INV.CASES_AVAIL]);

        const packDate = String(r[INV.PACK_DATE] ?? "").trim();
        let age = parseNumber(r[INV.AGE]);

        // compute age if missing and dates exist
        if (!age && packDate) {
          age = daysBetween(dateObj, packDate);
        }

        const allBlank =
          !dateStr && !batch && !location && !sku &&
          casesInv === 0 && casesRes === 0 && casesAvail === 0 &&
          !customer && !observations && !packDate && age === 0;

        if (allBlank) { droppedBlank++; continue; }

        const norm = {
          date: dateStr || formatDateLongOrMMDD(dateObj),
          dateObj,
          batch,
          location,
          casesInventory: casesInv,
          casesReserved: casesRes,
          casesAvailable: casesAvail,
          customer,
          observations,
          packDate,
          age,
          sku
        };

        if (!isMeaningfulRow(norm)) { droppedNotMeaningful++; continue; }

        out.push(norm);
      }

      return {
        rows: out,
        diag: { droppedBlank, droppedNoDate, droppedNotMeaningful }
      };
    }

    function buildFromLocalStorage(){
      // 1) Try Master Pack first
      const pack = loadPayload(MASTER_PACK_KEY);
      const grow = loadPayload(MASTER_GROW_KEY);

      let source = null;
      let sheetInfo = null;

      if (pack) {
        sheetInfo = findInventorySheet(pack);
        if (sheetInfo) source = { type: "pack", payload: pack, sheetName: sheetInfo.name, sheet: sheetInfo.sheet };
      }
      if (!source && grow) {
        sheetInfo = findInventorySheet(grow);
        if (sheetInfo) source = { type: "grow", payload: grow, sheetName: sheetInfo.name, sheet: sheetInfo.sheet };
      }

      if (!source) {
        // Fallback: paste
        const rawPaste = (localStorage.getItem(INVENTORY_PASTE_KEY) || "").trim();
        if (rawPaste) {
          setChip("chip-ok", "Using pasted inventory (fallback)");
          chipWarn("Master Pack not found (fallback mode)");
          const parsed = parsePastedInventory(rawPaste);
          allInventoryRows = parsed.rows;
          setEmpty(parsed.rows.length ? "" :
            "Paste fallback is present but produced 0 rows.\n\nTip: Ensure you paste the table WITH the header row, and include Warehouse SKU + Cases in Inventory."
          );
          renderAll();
          return;
        }

        // Nothing available
        allInventoryRows = [];
        setChip("chip-ok", "Master Pack missing");
        chipWarn("Upload Master Pack in Data Input");
        setEmpty(
          "No master payload found.\n\nFix:\n- Upload Master Pack in Data Input (recommended)\n- Or paste inventory table into the fallback box.\n\nLooking for localStorage keys:\n- campo_master_pack_v1 (preferred)\n- campo_master_grow_v1 (fallback)"
        );
        renderAll();
        return;
      }

      // Sheet -> rows
      const rowObjs = sheetToRowObjects(source.sheet);
      const normalized = normalizeInventoryRows(rowObjs);
      allInventoryRows = normalized.rows;

      const payloadRows = Array.isArray(source.sheet?.rows) ? source.sheet.rows.length : 0;
      const srcLabel = source.type === "pack" ? "Master Pack" : "Master Grow";

      setChip("chip-ok", `${srcLabel} loaded (${payloadRows.toLocaleString()} rows)`);
      chipWarn(allInventoryRows.length ? "–" : "No inventory rows built");

      if (!allInventoryRows.length) {
        setEmpty(
          "Master loaded, but 0 inventory rows were built.\n\nDiagnostics:\n" +
          `- Dropped (blank): ${normalized.diag.droppedBlank}\n` +
          `- Dropped (bad date): ${normalized.diag.droppedNoDate}\n` +
          `- Dropped (date-only filler rows): ${normalized.diag.droppedNotMeaningful}\n\n` +
          "Fix: Ensure your inventory sheet includes at least:\n- Warehouse Date\n- Warehouse SKU\n- Cases in Inventory\n(plus any other fields)"
        );
      } else {
        setEmpty("");
      }

      renderAll();
    }

    // =========================================================
    // PASTE FALLBACK (same robust behavior you had)
    // =========================================================
    function buildHeaderIndex(headerCells){
      const idx = new Map();
      headerCells.forEach((h, i) => idx.set(normHeader(h), i));
      const pick = (aliases) => {
        for (const a of aliases){
          const k = normHeader(a);
          if (idx.has(k)) return idx.get(k);
        }
        return -1;
      };
      return {
        date: pick([INV.DATE, "Date"]),
        batch: pick([INV.BATCH, "Batch"]),
        location: pick([INV.LOCATION, "Location"]),
        inv: pick([INV.CASES_INV, "Inventory"]),
        res: pick([INV.CASES_RES, "Reserved"]),
        avail: pick([INV.CASES_AVAIL, "Available"]),
        customer: pick([INV.CUSTOMER, "Customer"]),
        obs: pick([INV.OBS, "Observations"]),
        packDate: pick([INV.PACK_DATE, "Pack Date"]),
        age: pick([INV.AGE, "Age"]),
        sku: pick([INV.SKU, "SKU"])
      };
    }

    function parsePastedInventory(text){
      const rawLines = text.replace(/\r/g,"").split("\n");
      const lines = rawLines.filter(l => l.replace(/\t/g,"").trim().length > 0);

      const out = [];
      if (!lines.length) return { rows: out };

      // header in first 2 lines
      let headerLineIndex = -1;
      for (let i=0;i<Math.min(2, lines.length);i++){
        const chk = lines[i].toLowerCase();
        if (chk.includes("warehouse date") && chk.includes("cases")) { headerLineIndex = i; break; }
      }

      let headerMap = null;
      let startIndex = 0;

      if (headerLineIndex >= 0){
        const headerCells = lines[headerLineIndex].split("\t");
        headerMap = buildHeaderIndex(headerCells);
        startIndex = headerLineIndex + 1;
      }

      const safeGet = (arr, i) => (i >= 0 && i < arr.length ? arr[i] : "");

      for (let i=startIndex;i<lines.length;i++){
        const line = lines[i];
        let parts = line.split("\t");
        if (parts.length < 3 && line.includes(",")) parts = line.split(",");

        let row = null;
        if (headerMap && headerMap.date >= 0){
          row = {
            dateStr: safeGet(parts, headerMap.date).trim(),
            batchStr: safeGet(parts, headerMap.batch).trim(),
            locStr: safeGet(parts, headerMap.location).trim(),
            invStr: safeGet(parts, headerMap.inv).trim(),
            resStr: safeGet(parts, headerMap.res).trim(),
            availStr: safeGet(parts, headerMap.avail).trim(),
            custStr: safeGet(parts, headerMap.customer).trim(),
            obsStr: safeGet(parts, headerMap.obs).trim(),
            packDateStr: safeGet(parts, headerMap.packDate).trim(),
            ageStr: safeGet(parts, headerMap.age).trim(),
            skuStr: safeGet(parts, headerMap.sku).trim(),
          };
        } else {
          while (parts.length < 11) parts.push("");
          const p = parts.slice(0,11).map(x => String(x ?? ""));
          row = {
            dateStr: p[0].trim(), batchStr: p[1].trim(), locStr: p[2].trim(),
            invStr: p[3].trim(), resStr: p[4].trim(), availStr: p[5].trim(),
            custStr: p[6].trim(), obsStr: p[7].trim(), packDateStr: p[8].trim(),
            ageStr: p[9].trim(), skuStr: p[10].trim(),
          };
        }

        if (!row.dateStr || /^#(VALUE|REF|NAME|DIV\/0|N\/A)!?$/i.test(row.dateStr)) continue;

        const dateObj = parseAnyDate(row.dateStr);
        if (!dateObj) continue;

        const norm = {
          date: row.dateStr,
          dateObj,
          batch: row.batchStr,
          location: row.locStr,
          casesInventory: parseNumber(row.invStr),
          casesReserved: parseNumber(row.resStr),
          casesAvailable: parseNumber(row.availStr),
          customer: row.custStr,
          observations: row.obsStr,
          packDate: row.packDateStr,
          age: parseNumber(row.ageStr) || (row.packDateStr ? daysBetween(dateObj, row.packDateStr) : 0),
          sku: row.skuStr
        };

        if (!isMeaningfulRow(norm)) continue;
        out.push(norm);
      }

      return { rows: out };
    }

    // =========================================================
    // RENDER
    // =========================================================
    function renderAll(){
      renderTable();
      renderSnapshot();
    }

    function renderTable(){
      const tbody = document.querySelector("#inventory-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      const rows = Array.isArray(allInventoryRows) ? allInventoryRows : [];
      if (!rows.length) {
        // clear KPIs + lists safely
        document.getElementById("kpi-total-inventory").textContent = "–";
        document.getElementById("kpi-total-available").textContent = "–";
        document.getElementById("kpi-unique-skus").textContent = "–";
        document.getElementById("kpi-avg-age").textContent = "–";
        document.getElementById("sku-grid").innerHTML = "";
        document.getElementById("snapshot-date").innerHTML = "";
        document.getElementById("cards-summary-label").textContent = "– SKUs displayed";
        return;
      }

      // Build rows into raw table
      const sorted = rows.slice().sort((a,b) => (a.dateObj - b.dateObj) || String(a.sku).localeCompare(String(b.sku)));

      for (const r of sorted){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.batch || ""}</td>
          <td>${r.location || ""}</td>
          <td>${fmt1(r.casesInventory)}</td>
          <td>${fmt1(r.casesReserved)}</td>
          <td>${fmt1(r.casesAvailable)}</td>
          <td>${r.customer || ""}</td>
          <td>${r.observations || ""}</td>
          <td>${r.packDate || ""}</td>
          <td>${fmt1(r.age)}</td>
          <td>${r.sku || ""}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderSnapshot(){
      const rows = Array.isArray(allInventoryRows) ? allInventoryRows : [];
      if (!rows.length) return;

      // dates list (use exact date string keys)
      const dateMap = new Map();
      rows.forEach(r => { if (r.date) dateMap.set(r.date, r.dateObj || null); });

      const sortedDates = Array.from(dateMap.entries())
        .sort((a,b) => {
          const da = a[1], db = b[1];
          if (da && db) return da - db;
          if (da && !db) return -1;
          if (!da && db) return 1;
          return String(a[0]).localeCompare(String(b[0]));
        })
        .map(([label]) => label);

      if (!sortedDates.length) return;

      if (!currentSnapshotDate || !sortedDates.includes(currentSnapshotDate)) {
        currentSnapshotDate = sortedDates[sortedDates.length - 1];
      }

      const snapshotSelect = document.getElementById("snapshot-date");
      snapshotSelect.innerHTML = "";
      sortedDates.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        snapshotSelect.appendChild(opt);
      });
      snapshotSelect.value = currentSnapshotDate;

      const dayData = rows.filter(r => r.date === currentSnapshotDate);
      const displayData = dayData.length ? dayData : rows;

      // Raw table show/hide per date
      const rawRows = document.querySelectorAll("#inventory-table tbody tr");
      rawRows.forEach((tr) => {
        const dateCell = tr.querySelector("td");
        const rowDate = (dateCell?.textContent || "").trim();
        tr.style.display = (rawTableShowAll || rowDate === currentSnapshotDate) ? "" : "none";
      });

      const totalInventory = displayData.reduce((s,d)=>s+d.casesInventory,0);
      const totalAvailable = displayData.reduce((s,d)=>s+d.casesAvailable,0);
      const totalReserved = displayData.reduce((s,d)=>s+d.casesReserved,0);

      const skuSet = new Set(displayData.map(d => d.sku).filter(Boolean));
      const locSet = new Set(displayData.map(d => d.location).filter(Boolean));

      const ageValues = displayData.map(d => d.age).filter(a => a > 0);
      const avgAge = ageValues.length ? (ageValues.reduce((s,v)=>s+v,0) / ageValues.length) : 0;
      const maxAge = ageValues.length ? ageValues.reduce((m,v)=>v>m?v:m, ageValues[0]) : 0;

      document.getElementById("kpi-total-inventory").textContent = fmt0(totalInventory);
      document.getElementById("kpi-total-available").textContent = fmt0(totalAvailable);
      document.getElementById("kpi-unique-skus").textContent = skuSet.size.toString();
      document.getElementById("kpi-avg-age").textContent = fmt1(avgAge);

      document.getElementById("kpi-inventory-label").textContent = "For " + currentSnapshotDate;
      document.getElementById("kpi-reserved-note").textContent = "Reserved: " + fmt0(totalReserved) + " cases";
      document.getElementById("kpi-location-note").textContent = "Locations: " + (locSet.size || "–");
      document.getElementById("kpi-age-note").textContent = maxAge > 0 ? ("Oldest lot: " + fmt1(maxAge) + " days") : "Oldest lot: –";

      const snapshotSubtitle = document.getElementById("snapshot-subtitle");
      snapshotSubtitle.textContent =
        "Inventory snapshot for " + currentSnapshotDate + " (" + skuSet.size + " SKUs, " + fmt0(totalInventory) + " cases in inventory).";

      // Cards aggregate by SKU
      const skuMap = new Map();
      displayData.forEach(d => {
        const key = d.sku || "(no SKU)";
        if (!skuMap.has(key)){
          skuMap.set(key, {
            sku: key,
            totalInventory: 0,
            totalAvailable: 0,
            totalReserved: 0,
            ageSum: 0,
            ageCount: 0,
            locations: new Set(),
          });
        }
        const a = skuMap.get(key);
        a.totalInventory += d.casesInventory;
        a.totalAvailable += d.casesAvailable;
        a.totalReserved += d.casesReserved;
        if (d.age > 0){ a.ageSum += d.age; a.ageCount += 1; }
        if (d.location) a.locations.add(d.location);
      });

      const skuAgg = Array.from(skuMap.values()).sort((a,b)=>a.sku.localeCompare(b.sku));
      skuAgg.forEach(s => s.avgAge = s.ageCount ? (s.ageSum / s.ageCount) : 0);

      document.getElementById("cards-summary-label").textContent = skuAgg.length + " SKUs displayed";

      const skuGrid = document.getElementById("sku-grid");
      skuGrid.innerHTML = "";
      skuAgg.forEach(s => {
        let statusClass = "status-ok";
        let statusLabel = "Healthy";
        if (s.totalAvailable <= 0 && s.totalInventory > 0) { statusClass = "status-danger"; statusLabel = "Zero available"; }
        else if (s.totalAvailable > 0 && s.totalAvailable < 10) { statusClass = "status-warn"; statusLabel = "Low"; }

        let pctAvail = 0;
        if (s.totalInventory > 0){
          pctAvail = (s.totalAvailable / s.totalInventory) * 100;
          if (pctAvail < 0) pctAvail = 0;
          if (pctAvail > 100) pctAvail = 100;
        }

        const locArr = Array.from(s.locations);
        const maxChips = 8;
        const chipItems = locArr.slice(0, maxChips).map(loc => `<span class="location-pill">${loc}</span>`);
        const moreCount = Math.max(0, locArr.length - maxChips);
        if (moreCount > 0) chipItems.push(`<span class="location-pill location-pill-more">+${moreCount} more</span>`);
        const locationsChipsHtml = chipItems.length ? chipItems.join("") : `<span class="location-pill location-pill-more">No location data</span>`;

        const tagLabel =
          s.locations.size === 0 ? "No location" :
          s.locations.size === 1 ? locArr[0] :
          s.locations.size + " locations";

        const card = document.createElement("div");
        card.className = "sku-card " + statusClass;
        card.innerHTML = `
          <div class="sku-card-header">
            <div class="sku-card-sku">${s.sku}</div>
            <div class="sku-card-tag">${tagLabel}</div>
          </div>
          <div class="sku-card-metric"><span class="label">Inventory:</span> <strong>${fmt1(s.totalInventory)}</strong></div>
          <div class="sku-card-metric"><span class="label">Available:</span> <strong>${fmt1(s.totalAvailable)}</strong> <span class="label">· Reserved:</span> <strong>${fmt1(s.totalReserved)}</strong></div>
          <div class="sku-card-metric"><span class="label">Avg age:</span> <strong>${fmt1(s.avgAge)}</strong> <span class="label">days</span></div>
          <div class="sku-card-locations">
            <span class="label">Locations:</span>
            <div class="sku-card-locations-list">${locationsChipsHtml}</div>
          </div>
          <div class="sku-card-bar"><div class="sku-card-bar-inner" style="width:${pctAvail}%;"></div></div>
          <div class="sku-card-status">${statusLabel}</div>
        `;

        const rowsForCard = displayData.filter(d => (d.sku || "(no SKU)") === s.sku);
        card.addEventListener("click", () => openLotModal(s.sku, rowsForCard));
        skuGrid.appendChild(card);
      });

      // Issues
      renderIssues(displayData);

      // Footer totals (respect raw show all toggle)
      const tfootRow = document.querySelector("#inventory-table tfoot tr");
      if (tfootRow){
        const visibleData = rawTableShowAll ? rows : rows.filter(r => r.date === currentSnapshotDate);
        const totalInvAll = visibleData.reduce((s,d)=>s+d.casesInventory,0);
        const totalResAll = visibleData.reduce((s,d)=>s+d.casesReserved,0);
        const totalAvailAll = visibleData.reduce((s,d)=>s+d.casesAvailable,0);
        const ageAll = visibleData.map(d=>d.age).filter(a=>a>0);
        const avgAgeAll = ageAll.length ? ageAll.reduce((s,v)=>s+v,0)/ageAll.length : 0;

        const tds = tfootRow.querySelectorAll("td");
        if (tds.length >= 11){
          tds[0].textContent = rawTableShowAll ? "Totals (all rows)" : "Totals (selected day)";
          tds[3].textContent = fmt1(totalInvAll);
          tds[4].textContent = fmt1(totalResAll);
          tds[5].textContent = fmt1(totalAvailAll);
          tds[9].textContent = fmt1(avgAgeAll);
        }
      }
    }

    function renderIssues(dayData){
      const oldestList = document.getElementById("issues-oldest");
      const oldestEmpty = document.getElementById("issues-oldest-empty");
      const lowList = document.getElementById("issues-low");
      const lowEmpty = document.getElementById("issues-low-empty");
      const custList = document.getElementById("issues-customers");
      const custEmpty = document.getElementById("issues-customers-empty");

      // Oldest
      oldestList.innerHTML = "";
      const oldestLots = dayData.filter(d=>d.age>0).sort((a,b)=>b.age-a.age).slice(0,5);
      if (!oldestLots.length){
        oldestEmpty.textContent = "No age data for this day.";
      } else {
        oldestEmpty.textContent = "";
        oldestLots.forEach(d=>{
          const li = document.createElement("li");
          li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> – ${fmt1(d.casesInventory)} cases · ${fmt1(d.age)} days · <span class="label">${d.batch || ""}</span>`;
          oldestList.appendChild(li);
        });
      }

      // Low/zero
      lowList.innerHTML = "";
      const zeroAvail = dayData.filter(d=>d.casesInventory>0 && d.casesAvailable<=0);
      const lowAvail = dayData.filter(d=>d.casesAvailable>0 && d.casesAvailable<10);
      if (!zeroAvail.length && !lowAvail.length){
        lowEmpty.textContent = "No low or zero availability for this day.";
      } else {
        lowEmpty.textContent = "";
        zeroAvail.slice(0,5).forEach(d=>{
          const li = document.createElement("li");
          li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> – ${fmt1(d.casesInventory)} cases · <span class="issues-pill bad">0 available</span>`;
          lowList.appendChild(li);
        });
        lowAvail.slice(0,5).forEach(d=>{
          const li = document.createElement("li");
          li.innerHTML = `<strong>${d.sku || "(no SKU)"}</strong> – ${fmt1(d.casesAvailable)} available · ${fmt1(d.casesInventory)} in inventory <span class="issues-pill warn">Low</span>`;
          lowList.appendChild(li);
        });
      }

      // Customers
      custList.innerHTML = "";
      const custMap = new Map();
      dayData.forEach(d=>{
        if (!d.customer) return;
        if (!custMap.has(d.customer)) custMap.set(d.customer, { customer: d.customer, reserved: 0 });
        custMap.get(d.customer).reserved += d.casesReserved || 0;
      });
      const custAgg = Array.from(custMap.values()).filter(c=>c.reserved>0).sort((a,b)=>b.reserved-a.reserved).slice(0,5);
      if (!custAgg.length){
        custEmpty.textContent = "No customer reservations for this day.";
      } else {
        custEmpty.textContent = "";
        custAgg.forEach(c=>{
          const li = document.createElement("li");
          li.innerHTML = `<strong>${c.customer}</strong> – ${fmt1(c.reserved)} cases reserved`;
          custList.appendChild(li);
        });
      }
    }

    function openLotModal(label, rowsForCard){
      const existing = document.getElementById("lot-modal-backdrop");
      if (existing) existing.remove();

      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop";
      backdrop.id = "lot-modal-backdrop";

      const panel = document.createElement("div");
      panel.className = "modal-panel";

      const header = document.createElement("div");
      header.className = "modal-header";

      const title = document.createElement("div");
      title.className = "modal-title";
      title.textContent = "Lot details · " + label;

      const closeBtn = document.createElement("button");
      closeBtn.className = "modal-close-btn";
      closeBtn.type = "button";
      closeBtn.textContent = "Close ✕";
      closeBtn.addEventListener("click", () => backdrop.remove());

      header.appendChild(title);
      header.appendChild(closeBtn);

      const body = document.createElement("div");
      body.className = "modal-body";

      if (!rowsForCard || !rowsForCard.length){
        const p = document.createElement("div");
        p.className = "modal-subtitle";
        p.textContent = "No lot records for this item on the selected date.";
        body.appendChild(p);
      } else {
        const subtitle = document.createElement("div");
        subtitle.className = "modal-subtitle";
        subtitle.textContent = rowsForCard.length + " row" + (rowsForCard.length>1 ? "s" : "") + " · Batch / location / inventory / available";
        body.appendChild(subtitle);

        const table = document.createElement("table");
        table.className = "modal-lot-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Batch</th>
              <th>Location</th>
              <th>Cases inv.</th>
              <th>Cases avail.</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        rowsForCard.forEach(d=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.batch || ""}</td>
            <td>${d.location || ""}</td>
            <td>${fmt1(d.casesInventory || 0)}</td>
            <td>${fmt1(d.casesAvailable || 0)}</td>
          `;
          tbody.appendChild(tr);
        });

        body.appendChild(table);
      }

      panel.appendChild(header);
      panel.appendChild(body);
      backdrop.appendChild(panel);

      backdrop.addEventListener("click", (e)=>{ if (e.target === backdrop) backdrop.remove(); });
      document.body.appendChild(backdrop);
    }

    // =========================================================
    // UI TOGGLES + EVENTS
    // =========================================================
    function setupInputPanelToggle(){
      const btn = document.getElementById("toggle-input-panel-btn");
      const body = document.getElementById("input-panel-body");
      const icon = document.getElementById("toggle-input-icon");
      const label = document.getElementById("toggle-input-label");
      if (!btn || !body) return;

      let collapsed = true;
      body.classList.add("collapsed");
      label.textContent = "Show";
      icon.textContent = "▸";

      btn.addEventListener("click", () => {
        collapsed = !collapsed;
        if (collapsed){ body.classList.add("collapsed"); label.textContent="Show"; icon.textContent="▸"; }
        else { body.classList.remove("collapsed"); label.textContent="Hide"; icon.textContent="▾"; }
      });
    }

    function setupSnapshotSelector(){
      const select = document.getElementById("snapshot-date");
      if (!select) return;
      select.addEventListener("change", () => {
        currentSnapshotDate = select.value;
        renderSnapshot();
      });
    }

    function setupTablePanelToggle(){
      const btn = document.getElementById("toggle-table-panel-btn");
      const body = document.getElementById("table-panel-body");
      const icon = document.getElementById("toggle-table-icon");
      const label = document.getElementById("toggle-table-label");
      if (!btn || !body || !icon || !label) return;

      let collapsed = true;
      body.classList.add("collapsed");
      label.textContent = "Show";
      icon.textContent = "▸";

      btn.addEventListener("click", () => {
        collapsed = !collapsed;
        if (collapsed){ body.classList.add("collapsed"); label.textContent="Show"; icon.textContent="▸"; }
        else { body.classList.remove("collapsed"); label.textContent="Hide"; icon.textContent="▾"; }
      });
    }

    function setupRawTableViewToggle(){
      const btn = document.getElementById("toggle-raw-view-btn");
      const label = document.getElementById("toggle-raw-view-label");
      if (!btn || !label) return;

      const updateLabel = () => { label.textContent = rawTableShowAll ? "Show selected day only" : "Show all raw inventory"; };
      updateLabel();

      btn.addEventListener("click", () => {
        rawTableShowAll = !rawTableShowAll;
        updateLabel();
        renderSnapshot();
      });
    }

    // =========================================================
    // PASTE FALLBACK ACTIONS
    // =========================================================
    function applyPastedData(){
      const ta = document.getElementById("paste-area");
      const text = (ta?.value || "");
      if (!text.trim()) return;

      try { localStorage.setItem(INVENTORY_PASTE_KEY, text); } catch(e){}

      // Only use paste immediately if Master Pack/Grow isn't providing a usable inventory sheet
      const pack = loadPayload(MASTER_PACK_KEY);
      const grow = loadPayload(MASTER_GROW_KEY);
      const hasSheet = (pack && findInventorySheet(pack)) || (grow && findInventorySheet(grow));

      if (hasSheet){
        chipWarn("Master payload present — paste saved (not used)");
        setEmpty("Paste saved, but Master Pack/Grow inventory is present so the dashboard is reading the master payload.\n\nIf you want paste mode, clear the master payload or remove the inventory sheet from it.");
        // keep current render
        renderAll();
        return;
      }

      const parsed = parsePastedInventory(text);
      allInventoryRows = parsed.rows;
      setChip("chip-ok", "Using pasted inventory (fallback)");
      chipWarn("Master Pack not found (fallback mode)");
      setEmpty(allInventoryRows.length ? "" : "Pasted data produced 0 rows. Paste with header row + include Warehouse SKU + Cases in Inventory.");
      renderAll();
    }

    function clearPastedData(){
      const ta = document.getElementById("paste-area");
      if (ta) ta.value = "";
      try { localStorage.removeItem(INVENTORY_PASTE_KEY); } catch(e){}
      // then reload from master
      buildFromLocalStorage();
    }

    // =========================================================
    // LIVE REFRESH (same pattern as seeding)
    // =========================================================
    let reloadTimer = null;
    function reloadAll(reason){
      if (reloadTimer) clearTimeout(reloadTimer);
      reloadTimer = setTimeout(() => {
        reloadTimer = null;
        buildFromLocalStorage();
        // console.log("🔄 Reloaded inventory dashboard", reason || "");
      }, 60);
    }

    function setupLiveListeners(){
      window.addEventListener("storage", (e) => {
        if (!e) return;
        if (e.key === MASTER_PACK_KEY || e.key === MASTER_PACK_PING_KEY ||
            e.key === MASTER_GROW_KEY || e.key === MASTER_GROW_PING_KEY) {
          reloadAll("storage");
        }
      });

      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === MSG_PACK || msg.type === "MASTER_PACK_UPDATED" ||
            msg.type === MSG_GROW || msg.type === "MASTER_GROW_UPDATED") {
          reloadAll("message");
        }
      });

      window.addEventListener(MSG_PACK, () => reloadAll("customevent-pack"));
      window.addEventListener(MSG_GROW, () => reloadAll("customevent-grow"));

      if (bc) {
        bc.onmessage = (ev) => {
          const msg = ev?.data;
          if (msg?.type === MSG_PACK || msg?.type === MSG_GROW) reloadAll("broadcast");
        };
      }

      // safety poll (covers iframe/safari weirdness)
      let lastLenPack = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
      let lastLenGrow = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
      setInterval(() => {
        const curPack = (localStorage.getItem(MASTER_PACK_KEY) || "").length;
        const curGrow = (localStorage.getItem(MASTER_GROW_KEY) || "").length;
        if (curPack !== lastLenPack || curGrow !== lastLenGrow) {
          lastLenPack = curPack;
          lastLenGrow = curGrow;
          reloadAll("poll");
        }
      }, 1500);
    }

    // =========================================================
    // INIT
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      setupInputPanelToggle();
      setupSnapshotSelector();
      setupTablePanelToggle();
      setupRawTableViewToggle();
      setupLiveListeners();

      document.getElementById("apply-data-btn")?.addEventListener("click", applyPastedData);
      document.getElementById("clear-data-btn")?.addEventListener("click", clearPastedData);

      // load paste text into textarea (if exists)
      try {
        const savedPaste = localStorage.getItem(INVENTORY_PASTE_KEY);
        if (savedPaste) {
          const ta = document.getElementById("paste-area");
          if (ta) ta.value = savedPaste;
        }
      } catch(e){}

      reloadAll("init");
    });
  </script>
</body>
</html>
