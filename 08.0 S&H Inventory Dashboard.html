<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>S&H Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --card:#020617;
      --border:#1f2937;
      --border-subtle:#374151;
      --text:#e5e7eb;
      --sub:#9ca3af;
      --muted:#6b7280;
      --accent:#22c55e;
      --accent-soft: rgba(34,197,94,.15);
      --blue: rgba(59,130,246,.85);
      --warn:#f59e0b;
      --warn-soft: rgba(245,158,11,.16);
      --danger:#ef4444;
      --danger-soft: rgba(239,68,68,.15);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
    }

    .page{
      min-height:100vh;
      padding: 16px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    /* ✅ Wider main container (uses wide space better) */
    .container{
      width:100%;
      max-width: 1760px; /* was 1320 */
      border-radius:24px;
      padding: 20px 20px 16px;
      background:
        radial-gradient(circle at top right, rgba(34,197,94,.08), transparent 60%),
        radial-gradient(circle at bottom left, rgba(59,130,246,.09), transparent 55%),
        linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.98));
      border: 1px solid rgba(148,163,184,.35);
      box-shadow: 0 24px 80px rgba(0,0,0,.8), 0 0 0 1px rgba(15,23,42,.8);
      backdrop-filter: blur(20px);
    }

    /* Header */
    .header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 12px;
      margin-bottom: 14px;
    }
    .title-block{ flex:1 1 240px; min-width:0; }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 4px;
      font-size:1.3rem;
      letter-spacing:.02em;
    }
    .title-pill{
      width:26px; height:26px; border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e 55%, #16a34a 100%);
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow: 0 0 0 2px rgba(15,23,42,.9), 0 12px 30px rgba(16,185,129,.6);
    }
    .title-pill span{ font-size:15px; font-weight:700; color:#022c22; }
    .title-text{ font-weight:620; display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; }
    .title-sub{
      font-size:.8rem; color:var(--sub);
      text-transform:uppercase; letter-spacing:.18em;
    }
    .subtitle{
      margin:0;
      font-size:.85rem;
      color: var(--muted);
      line-height: 1.35;
    }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:.95em;
      color: rgba(226,232,240,.95);
    }

    .header-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 9px;
      font-size:.72rem;
      border:1px solid rgba(148,163,184,.5);
      color: var(--sub);
      background: radial-gradient(circle at top left, rgba(148,163,184,.18), transparent 55%);
      white-space: nowrap;
    }
    .chip-dot, .chip-warn-dot, .chip-err-dot{
      width:6px; height:6px; border-radius:999px;
    }
    .chip-dot{ background: var(--accent); box-shadow: 0 0 0 3px rgba(34,197,94,.35); }
    .chip-warn-dot{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.35); }
    .chip-err-dot{ background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.28); }

    /* Panels */
    .panel{
      border-radius:18px;
      padding: 12px 12px 10px;
      background: radial-gradient(circle at top left, rgba(15,23,42,.97), rgba(15,23,42,.99));
      border: 1px solid rgba(55,65,81,.9);
      box-shadow: 0 18px 40px rgba(0,0,0,.9), 0 0 0 1px rgba(15,23,42,.9);
      backdrop-filter: blur(14px);
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap:wrap;
    }
    .panel-title{
      font-size:.82rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color: var(--sub);
      display:flex;
      align-items:center;
      gap: 7px;
    }
    .panel-title-dot{
      width:7px; height:7px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.45);
    }
    .panel-title-dot.blue{
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56,189,248,.48);
    }
    .panel-subtitle{
      font-size:.75rem;
      color: var(--muted);
    }
    .panel-header-right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      color: var(--sub);
      font-size:.72rem;
    }

    .btn{
      border-radius:999px;
      border: 1px solid rgba(55,65,81,.9);
      padding: 5px 12px;
      font-size:.74rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: rgba(15,23,42,.96);
      color: var(--text);
      transition: background .12s ease, transform .05s ease, box-shadow .12s ease;
      font-family: inherit;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn:hover{ background: rgba(31,41,55,.95); }
    .btn:active{ transform: scale(.99); }
    .btn-ghost{ background: rgba(15,23,42,.9); }
    .btn-danger{
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.08);
    }
    .btn-danger:hover{ background: rgba(239,68,68,.14); }

    .badge-soft{
      border-radius:999px;
      padding: 3px 8px;
      border: 1px solid rgba(148,163,184,.45);
      background: radial-gradient(circle at top left, rgba(30,64,175,.55), rgba(15,23,42,.95));
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.72rem;
    }
    .badge-dot{
      width:6px; height:6px; border-radius:999px;
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56,189,248,.28);
    }

    /* Layout */
    .layout-top{
      display:grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 14px;
      margin-top: 10px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .layout-top{ grid-template-columns: minmax(0,1fr); }
      .container{ border-radius:18px; padding: 14px 12px 14px; }
    }

    /* KPI cards */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    @media (max-width: 980px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .kpi-card{
      position:relative;
      border-radius:16px;
      padding: 10px 12px 11px;
      background: radial-gradient(circle at top left, rgba(31,41,55,.85), rgba(15,23,42,.98));
      border: 1px solid rgba(51,65,85,.9);
      box-shadow: 0 14px 30px rgba(0,0,0,.9), 0 0 0 1px rgba(15,23,42,.9);
      overflow:hidden;
    }
    .kpi-label{
      font-size:.74rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color: var(--sub);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .kpi-value{
      font-size: 1.15rem;
      font-weight:650;
      display:flex;
      align-items:baseline;
      gap:4px;
    }
    .kpi-unit{
      font-size:.72rem;
      color: var(--muted);
      text-transform:uppercase;
    }
    .kpi-meta{
      margin-top: 2px;
      font-size:.7rem;
      color: var(--muted);
    }
    .kpi-trend{
      margin-top:2px;
      font-size:.7rem;
      color: var(--accent);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .kpi-glow{
      position:absolute;
      inset:0;
      opacity:.18;
      background:
        radial-gradient(circle at 15% 0, rgba(34,197,94,.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(59,130,246,.4), transparent 60%);
      pointer-events:none;
      mix-blend-mode: screen;
    }

    /* SKU cards */
    .sku-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .select{
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,.9);
      background: rgba(15,23,42,.96);
      color: var(--text);
      padding: 6px 10px;
      font-size: .74rem;
      outline: none;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.74rem;
      color: var(--sub);
      user-select:none;
    }
    .toggle input{ margin:0; }

    .sku-cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .sku-cards{ grid-template-columns: minmax(0,1fr); }
    }
    .sku-card{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(55,65,81,.95);
      background:
        linear-gradient(135deg, rgba(17,24,39,.96), rgba(15,23,42,.99)),
        radial-gradient(circle at top left, rgba(51,65,85,.65), rgba(15,23,42,.96));
      box-shadow: 0 14px 30px rgba(0,0,0,.85), 0 0 0 1px rgba(15,23,42,.9);
      cursor: pointer;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .sku-card:hover{
      transform: translateY(-1px);
      border-color: rgba(34,197,94,.45);
      background:
        radial-gradient(circle at 0 0, rgba(34,197,94,.08), rgba(15,23,42,.98));
    }
    .sku-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .sku-name{
      font-weight: 650;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.7rem;
      color: var(--sub);
      border-radius:999px;
      padding: 3px 8px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.7);
      white-space: nowrap;
    }
    .pill.low{ border-color: rgba(245,158,11,.5); color: rgba(245,158,11,.95); background: rgba(245,158,11,.08); }
    .pill.zero{ border-color: rgba(239,68,68,.5); color: rgba(239,68,68,.95); background: rgba(239,68,68,.08); }
    .pill.ok{ border-color: rgba(34,197,94,.45); color: rgba(34,197,94,.95); background: rgba(34,197,94,.08); }

    .sku-stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .stat{
      border-radius: 12px;
      padding: 8px 9px;
      border: 1px solid rgba(55,65,81,.85);
      background: rgba(15,23,42,.75);
    }
    .stat .label{
      font-size: .68rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .14em;
      margin-bottom: 4px;
    }
    .stat .value{ font-weight: 650; }
    .stat .sub{
      font-size: .68rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Issues panel */
    .issues{
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,.95);
      background: rgba(15,23,42,.6);
      padding: 10px 12px;
    }
    .issues h4{
      margin:0 0 8px;
      font-size:.74rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color: var(--sub);
      display:flex;
      align-items:center;
      gap:7px;
    }
    .issues ul{
      margin:0;
      padding-left: 18px;
      color: rgba(148,163,184,.95);
      font-size:.78rem;
      line-height: 1.4;
    }
    .issues li{ margin: 4px 0; }

    /* Table */
    .table-wrapper{
      margin-top: 12px;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,.95);
      background:
        linear-gradient(135deg, rgba(17,24,39,.96), rgba(15,23,42,.99)),
        radial-gradient(circle at top left, rgba(51,65,85,.65), rgba(15,23,42,.96));
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .table-scroll{
      max-height: 520px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 rgba(15,23,42,.2);
      flex: 1 1 auto;
    }
    .table-scroll::-webkit-scrollbar{ width:6px; height:6px; }
    .table-scroll::-webkit-scrollbar-track{ background: rgba(15,23,42,.8); }
    .table-scroll::-webkit-scrollbar-thumb{ background-color: #4b5563; border-radius: 999px; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: .78rem;
      min-width: 1120px;
    }
    thead{
      position: sticky;
      top: 0;
      z-index: 2;
      background:
        linear-gradient(to bottom, #020617, #020617),
        radial-gradient(circle at top left, rgba(55,65,81,.5), rgba(15,23,42,.95));
      box-shadow: 0 1px 0 rgba(31,41,55,.9);
    }
    th, td{
      text-align:right;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(31,41,55,.85);
      white-space: nowrap;
    }
    th:first-child, td:first-child{ text-align:left; padding-left: 14px; }
    th:last-child, td:last-child{ padding-right: 12px; }
    th{
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .15em;
      color: var(--sub);
      background: transparent;
    }
    tbody tr:nth-child(odd) td{ background: rgba(15,23,42,.85); }
    tbody tr:nth-child(even) td{ background: rgba(17,24,39,.92); }
    tbody tr:hover td{
      background: radial-gradient(circle at 0 0, rgba(34,197,94,.08), rgba(15,23,42,.98));
    }

    .footer-note{
      margin-top: 8px;
      font-size: .7rem;
      color: var(--muted);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .footer-note span{ display:inline-flex; align-items:center; gap: 6px; }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }

    /* ✅ Taller + wider LOT DETAILS modal (always legible) */
    .modal{
      width: min(1500px, 98vw);
      height: 85vh;
      max-height: 85vh;
      min-height: 540px;
      border-radius: 18px;
      border: 1px solid rgba(55,65,81,.95);
      background: radial-gradient(circle at top left, rgba(17,24,39,.98), rgba(15,23,42,1));
      box-shadow: 0 30px 120px rgba(0,0,0,.85);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(31,41,55,.85);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex: 0 0 auto;
    }
    .modal-title{
      font-size:.78rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--sub);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .modal-title strong{
      color: var(--text);
      letter-spacing: .02em;
      text-transform:none;
      font-size: .85rem;
    }

    /* ✅ modal body owns vertical space; only inner scrolls */
    .modal-body{
      flex: 1 1 auto;
      padding: 10px 12px 12px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    .modal-body table{ min-width: 980px; width: 100%; }

    .modal-close{
      border-radius:999px;
      border: 1px solid rgba(55,65,81,.9);
      padding: 5px 10px;
      font-size:.72rem;
      cursor:pointer;
      background: rgba(15,23,42,.96);
      color: var(--text);
    }
    .modal-close:hover{ background: rgba(31,41,55,.95); }

    .banner{
      border-radius:16px;
      border: 1px solid rgba(245,158,11,.55);
      background: radial-gradient(circle at top left, rgba(245,158,11,.16), rgba(15,23,42,.98));
      padding: 10px 12px;
      margin-bottom: 12px;
      color: rgba(226,232,240,.92);
      font-size: .8rem;
      display:none;
    }
    .banner strong{ color:#fff; }
    .banner ul{ margin: 6px 0 0; padding-left: 18px; color: rgba(148,163,184,.95); }
  </style>
</head>

<body>
  <div class="page">
    <div class="container">

      <header class="header">
        <div class="title-block">
          <div class="title">
            <div class="title-pill"><span>⇄</span></div>
            <div class="title-text">
              <span>S&amp;H Inventory Dashboard</span>
              <span class="title-sub">LIVE • PACK DATA</span>
            </div>
          </div>
          <p class="subtitle">
            Reads Pack Data from <code>localStorage["campo_master_pack_v1"]</code> (JSON payload from Data Input).
            Updates automatically on <code>MASTER_PACK_UPDATED</code> and storage changes.
            SKU separation uses <strong>Warehouse SKU</strong>.
          </p>
        </div>

        <div class="header-tags">
          <div class="chip" id="chip-data-status">
            <span class="chip-warn-dot"></span>
            <span id="chip-data-text">Waiting for data…</span>
          </div>
          <div class="chip" id="chip-last-updated">
            <span class="chip-dot"></span>
            <span id="chip-updated-text">Updated: –</span>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            <span>Blanks/#VALUE removed • Zero rows ignored</span>
          </div>
        </div>
      </header>

      <div class="banner" id="status-banner"></div>

      <!-- Controls -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span>
              <span>Data filters</span>
            </div>
            <div class="panel-subtitle">
              Daily snapshot by <strong>Warehouse Date</strong> (defaults to latest date).
            </div>
          </div>
          <div class="panel-header-right">
            <span class="badge-soft"><span class="badge-dot"></span><span>Live from Master Pack</span></span>
            <button class="btn btn-ghost" id="btn-reload" type="button">Reload</button>
            <button class="btn btn-danger" id="btn-clear-selection" type="button">Clear SKU</button>
          </div>
        </div>

        <div class="sku-toolbar">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <label class="toggle">
              <input type="checkbox" id="toggle-show-all-dates" />
              <span>Show all dates (raw inventory)</span>
            </label>

            <label class="toggle" style="gap:8px;">
              <span style="color:var(--sub);">Warehouse date:</span>
              <select class="select" id="date-select"></select>
            </label>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <label class="toggle" style="gap:8px;">
              <span style="color:var(--sub);">SKU:</span>
              <select class="select" id="sku-select" style="max-width: 520px;"></select>
            </label>

            <label class="toggle">
              <input type="checkbox" id="toggle-hide-zero" checked />
              <span>Hide zero-available SKUs</span>
            </label>
          </div>
        </div>

        <section class="kpi-grid" aria-label="KPIs">
          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases in inventory</div>
            <div class="kpi-value">
              <span id="kpi-total-inv">–</span>
              <span class="kpi-unit">cases</span>
            </div>
            <div class="kpi-trend" id="kpi-date-label">–</div>
            <div class="kpi-meta">Sum of cases in inventory for selection.</div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Total cases available</div>
            <div class="kpi-value">
              <span id="kpi-total-avail">–</span>
              <span class="kpi-unit">cases</span>
            </div>
            <div class="kpi-trend" id="kpi-skus">–</div>
            <div class="kpi-meta">Available column (or inventory − reserved fallback).</div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Unique SKUs in stock</div>
            <div class="kpi-value">
              <span id="kpi-unique-skus">–</span>
            </div>
            <div class="kpi-trend" id="kpi-locations">–</div>
            <div class="kpi-meta">Count of Warehouse SKU with > 0 inventory.</div>
          </article>

          <article class="kpi-card">
            <div class="kpi-glow"></div>
            <div class="kpi-label">Average inventory age</div>
            <div class="kpi-value">
              <span id="kpi-avg-age">–</span>
              <span class="kpi-unit">days</span>
            </div>
            <div class="kpi-trend" id="kpi-oldest">–</div>
            <div class="kpi-meta">Uses Warehouse Age. Weighted by Cases in Inventory.</div>
          </article>
        </section>
      </section>

      <section class="layout-top">
        <!-- Left: Inventory by SKU -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot"></span>
                <span>Inventory by SKU</span>
              </div>
              <div class="panel-subtitle">
                Click a SKU card to see lot details (W Batch Run Code + Warehouse Location).
              </div>
            </div>
            <div class="panel-header-right">
              <span id="sku-cards-note">–</span>
            </div>
          </div>

          <div class="sku-cards" id="sku-cards"></div>

          <div class="footer-note">
            <span>SKU separation: <strong>Warehouse SKU</strong></span>
            <span id="filtered-note">–</span>
          </div>
        </section>

        <!-- Right: Issues / Reservations -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot blue"></span>
                <span>Top issues today</span>
              </div>
              <div class="panel-subtitle">
                Oldest lots and low / zero availability.
              </div>
            </div>
          </div>

          <div class="issues">
            <h4><span class="panel-title-dot blue" style="box-shadow:none;"></span>Oldest lots</h4>
            <ul id="list-oldest">
              <li>–</li>
            </ul>
          </div>

          <div class="issues" style="margin-top:10px;">
            <h4><span class="panel-title-dot" style="box-shadow:none;"></span>Low / zero availability</h4>
            <ul id="list-low">
              <li>–</li>
            </ul>
          </div>

          <div class="issues" style="margin-top:10px;">
            <h4><span class="panel-title-dot" style="box-shadow:none;"></span>Customer reservations</h4>
            <ul id="list-res">
              <li>–</li>
            </ul>
          </div>
        </section>
      </section>

      <!-- Raw table -->
      <section class="panel" style="margin-top:14px;">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot blue"></span>
              <span>Raw inventory table</span>
            </div>
            <div class="panel-subtitle">
              Source: Pack Data sheet in Master Pack payload. Rows follow your filters.
            </div>
          </div>
          <div class="panel-header-right">
            <label class="toggle" style="gap:8px;">
              <input type="checkbox" id="toggle-show-selected-day-only" checked />
              <span>Show selected day only</span>
            </label>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <!-- ✅ Reordered to match your preference + moved Location to end -->
                  <th>Warehouse SKU</th>
                  <th>Warehouse Date</th>
                  <th>W Batch Run Code</th>
                  <th>Cases Available</th>
                  <th>Cases in Inventory</th>
                  <th>Warehouse Age</th>
                  <th>Cutomer Reserved</th>
                  <th>Warehouse Pack Date</th>
                  <th>Warehouse Location</th>
                  <th>Cases Reserved</th>
                  <th>Warehouse Observations</th>
                </tr>
              </thead>
              <tbody id="raw-body"></tbody>
            </table>
          </div>
        </div>

        <div class="footer-note" id="raw-footer">–</div>
      </section>

    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">
          LOT DETAILS · <strong id="modal-sku">(no SKU)</strong>
        </div>
        <button class="modal-close" id="modal-close" type="button">Close ✕</button>
      </div>
      <div class="modal-body">
        <div style="color:var(--muted);font-size:.75rem;margin-bottom:8px;" id="modal-sub">–</div>
        <div class="table-wrapper" style="margin-top:0;">
          <div class="table-scroll" style="max-height: none;">
            <table>
              <thead>
                <tr>
                  <!-- ✅ Your requested order + Location at end -->
                  <th>W Batch Run Code</th>
                  <th>Cases Avail.</th>
                  <th>Cases in Inv.</th>
                  <th>Warehouse Age</th>
                  <th>Cutomer Reserved</th>
                  <th>Warehouse Pack Date</th>
                  <th>Warehouse Location</th>
                </tr>
              </thead>
              <tbody id="modal-body-rows"></tbody>
            </table>
          </div>
        </div>
        <div class="footer-note" id="modal-footer" style="margin-top:10px;">–</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // DATA SOURCE (MUST MATCH PACK DASHBOARD)
    // ============================================================
    const MASTER_PACK_KEY = "campo_master_pack_v1";
    const MASTER_PACK_PING_KEY = "campo_master_pack_push_ping_v1";
    const UPDATE_EVENT_TYPE = "MASTER_PACK_UPDATED";

    // Pack sheet candidates (same payload; pick first that exists)
    const MASTER_PACK_SHEET_NAME = "Master Pack"; // fallback only
    const PACK_SHEET_CANDIDATES = ["Pack Data", "PACK DATA", "PackData", "Packing Data", MASTER_PACK_SHEET_NAME];

    // ============================================================
    // EXACT HEADERS YOU PROVIDED (primary)
    // Warehouse Date | W Batch Run Code | Warehouse Location | Cases in Inventory | Cases Reserved |
    // Cases Available | Cutomer Reserved | Warehouse Observations | Warehouse Pack Date |
    // Warehouse Age | Warehouse SKU
    // ============================================================
    const HEADER_ALIASES = {
      "Warehouse Date": ["Warehouse Date"],
      "W Batch Run Code": ["W Batch Run Code", "W-Batch Run Code", "W- Batch Run Code", "W- Batch Run Code "],
      "Warehouse Location": ["Warehouse Location"],
      "Cases in Inventory": ["Cases in Inventory"],
      "Cases Reserved": ["Cases Reserved"],
      "Cases Available": ["Cases Available"],
      "Cutomer Reserved": ["Cutomer Reserved", "Customer Reserved", "Customer", "Cutomer"],
      "Warehouse Observations": ["Warehouse Observations", "Obs", "Observations"],
      "Warehouse Pack Date": ["Warehouse Pack Date", "Pack Date"],
      "Warehouse Age": ["Warehouse Age", "Age"],
      "Warehouse SKU": ["Warehouse SKU", "SKU"]
    };

    const REQUIRED_CANONICAL = [
      "Warehouse SKU",
      "Warehouse Date",
      "W Batch Run Code",
      "Warehouse Location",
      "Cases in Inventory"
    ];

    // ============================================================
    // State
    // ============================================================
    let allRows = [];
    let filteredOutCount = 0;
    let currentDateKey = "";
    let currentSku = "";
    let selectedSheetName = "";
    let lastParsedHeaders = [];

    // ============================================================
    // Utilities
    // ============================================================
    function parseNumber(v){
      if (v == null) return 0;
      const s = String(v).trim();
      if (!s) return 0;
      if (s.toUpperCase().includes("#VALUE")) return 0;
      const clean = s.replace(/,/g, "");
      const n = parseFloat(clean);
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(n, d=0){
      return Number(n || 0).toLocaleString("en-US", { minimumFractionDigits:d, maximumFractionDigits:d });
    }

    function fmtTs(ts){
      if (!ts) return "–";
      const d = new Date(Number(ts));
      if (isNaN(d.getTime())) return "–";
      return d.toLocaleString();
    }

    function setUpdatedChip(){
      let ping = null;
      try { ping = localStorage.getItem(MASTER_PACK_PING_KEY); } catch(e){}
      document.getElementById("chip-updated-text").textContent = `Updated: ${fmtTs(ping)}`;
    }

    function setStatus(kind, text){
      const chip = document.getElementById("chip-data-status");
      const oldDot = chip.querySelector("span");
      const label = document.getElementById("chip-data-text");

      const dot = document.createElement("span");
      dot.className = kind === "ok" ? "chip-dot" : (kind === "warn" ? "chip-warn-dot" : "chip-err-dot");

      chip.replaceChild(dot, oldDot);
      label.textContent = text || "";
    }

    function showBanner(htmlOrNull){
      const b = document.getElementById("status-banner");
      if (!htmlOrNull){
        b.style.display = "none";
        b.innerHTML = "";
        return;
      }
      b.style.display = "block";
      b.innerHTML = htmlOrNull;
    }

    function safeStr(v){
      const s = String(v ?? "").trim();
      if (!s) return "";
      if (s.toUpperCase().includes("#VALUE")) return "";
      return s;
    }

    function isAllZeroRow(r){
      const inv = r.casesInv || 0;
      const res = r.casesRes || 0;
      const av  = r.casesAvail || 0;
      return !(inv > 0 || res > 0 || av > 0);
    }

    function dateKeyFromWarehouseDate(raw){
      const s = safeStr(raw);
      if (!s) return "";
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function prettyDate(key){
      if (!key) return "–";
      if (/^\d{4}-\d{2}-\d{2}$/.test(key)){
        const d = new Date(key + "T00:00:00");
        return d.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
      }
      return key;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ============================================================
    // Load + parse payload
    // ============================================================
    function loadPayload(){
      const raw = (localStorage.getItem(MASTER_PACK_KEY) || "").trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function getFirstExistingSheet(payload){
      const sheets = payload?.sheets || {};
      for (const name of PACK_SHEET_CANDIDATES){
        if (sheets[name]) return name;
      }
      return "";
    }

    function sheetToRowObjects(sheetObj){
      const headers = Array.isArray(sheetObj?.headers) ? sheetObj.headers : [];
      const rows = Array.isArray(sheetObj?.rows) ? sheetObj.rows : [];
      const out = [];
      for (const r of rows){
        if (!Array.isArray(r)) continue;
        const obj = {};
        for (let i=0;i<headers.length;i++){
          const h = String(headers[i] ?? "").trim();
          if (!h) continue;
          obj[h] = (i < r.length) ? r[i] : "";
        }
        out.push(obj);
      }
      return { headers: headers.map(h => String(h ?? "")), rowObjs: out };
    }

    function findHeader(headers, aliases){
      const set = new Set(headers);
      for (const a of aliases){
        if (set.has(a)) return a;
      }
      const lowerMap = new Map(headers.map(h => [String(h).toLowerCase(), h]));
      for (const a of aliases){
        const hit = lowerMap.get(String(a).toLowerCase());
        if (hit) return hit;
      }
      return "";
    }

    function resolveHeaders(headers){
      const resolved = {};
      for (const canon of Object.keys(HEADER_ALIASES)){
        resolved[canon] = findHeader(headers, HEADER_ALIASES[canon] || [canon]);
      }
      return resolved;
    }

    function parseRows(payload){
      filteredOutCount = 0;
      lastParsedHeaders = [];

      if (!payload?.sheets){
        return { rows: [], missing: REQUIRED_CANONICAL.slice(), headers: [] };
      }

      selectedSheetName = getFirstExistingSheet(payload);
      if (!selectedSheetName){
        return { rows: [], missing: REQUIRED_CANONICAL.slice(), headers: [] };
      }

      const sheet = payload.sheets[selectedSheetName];
      const { headers, rowObjs } = sheetToRowObjects(sheet);
      lastParsedHeaders = headers;

      const H = resolveHeaders(headers);

      const missing = REQUIRED_CANONICAL.filter(c => !H[c]);
      if (missing.length){
        return { rows: [], missing, headers };
      }

      const out = [];
      for (const r of rowObjs){
        const sku = safeStr(r[H["Warehouse SKU"]]);
        const whDateRaw = safeStr(r[H["Warehouse Date"]]);
        const whDateKey = dateKeyFromWarehouseDate(whDateRaw);

        const batch = safeStr(r[H["W Batch Run Code"]]);
        const loc = safeStr(r[H["Warehouse Location"]]);

        const inv = parseNumber(r[H["Cases in Inventory"]]);
        const res = H["Cases Reserved"] ? parseNumber(r[H["Cases Reserved"]]) : 0;
        const availFromCol = H["Cases Available"] ? parseNumber(r[H["Cases Available"]]) : 0;

        const avail = (availFromCol > 0) ? availFromCol : Math.max(0, inv - res);

        const cust = H["Cutomer Reserved"] ? safeStr(r[H["Cutomer Reserved"]]) : "";
        const obs = H["Warehouse Observations"] ? safeStr(r[H["Warehouse Observations"]]) : "";
        const packDate = H["Warehouse Pack Date"] ? safeStr(r[H["Warehouse Pack Date"]]) : "";
        const age = H["Warehouse Age"] ? parseNumber(r[H["Warehouse Age"]]) : 0;

        if (!sku && !whDateRaw && !batch && !loc && !(inv||res||avail)) continue;

        // Keep consistent behavior: require sku + date
        if (!sku || !whDateKey){
          filteredOutCount++;
          continue;
        }

        const row = {
          sku,
          whDateRaw,
          whDateKey,
          batch,
          loc,
          casesInv: inv,
          casesRes: res,
          casesAvail: avail,
          customer: cust,
          obs,
          packDate,
          age
        };

        if (isAllZeroRow(row)){
          filteredOutCount++;
          continue;
        }

        out.push(row);
      }

      return { rows: out, missing: [], headers };
    }

    // ============================================================
    // Filters + derived views
    // ============================================================
    function getDateKeys(){
      const keys = Array.from(new Set(allRows.map(r => r.whDateKey).filter(Boolean)));
      keys.sort((a,b) => {
        if (/^\d{4}-\d{2}-\d{2}$/.test(a) && /^\d{4}-\d{2}-\d{2}$/.test(b)){
          return b.localeCompare(a);
        }
        return String(b).localeCompare(String(a));
      });
      return keys;
    }

    function getFilteredRows(){
      const showAllDates = document.getElementById("toggle-show-all-dates").checked;
      const selectedDayOnly = document.getElementById("toggle-show-selected-day-only").checked;

      let rows = allRows.slice();

      if (!showAllDates && selectedDayOnly && currentDateKey){
        rows = rows.filter(r => r.whDateKey === currentDateKey);
      }

      if (currentSku){
        rows = rows.filter(r => r.sku === currentSku);
      }

      return rows;
    }

    function getSnapshotRowsForCards(){
      const showAllDates = document.getElementById("toggle-show-all-dates").checked;
      if (showAllDates) return allRows.slice();
      if (currentDateKey) return allRows.filter(r => r.whDateKey === currentDateKey);
      return allRows.slice();
    }

    // ============================================================
    // Render: selectors
    // ============================================================
    function renderDateSelect(){
      const sel = document.getElementById("date-select");
      sel.innerHTML = "";
      const keys = getDateKeys();

      const optLatest = document.createElement("option");
      optLatest.value = "";
      optLatest.textContent = "Latest";
      sel.appendChild(optLatest);

      keys.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = prettyDate(k);
        sel.appendChild(opt);
      });

      if (!currentDateKey && keys.length){
        currentDateKey = keys[0];
        sel.value = "";
      } else {
        sel.value = currentDateKey || "";
      }
    }

    function normalizeCurrentDateFromSelect(){
      const sel = document.getElementById("date-select");
      const keys = getDateKeys();
      if (!keys.length){
        currentDateKey = "";
        return;
      }
      const v = sel.value;
      currentDateKey = v ? v : keys[0];
    }

    function renderSkuSelect(){
      const sel = document.getElementById("sku-select");
      const baseRows = getSnapshotRowsForCards();
      const hideZero = document.getElementById("toggle-hide-zero").checked;

      const bySku = new Map();
      for (const r of baseRows){
        if (!bySku.has(r.sku)) bySku.set(r.sku, { avail:0, inv:0, res:0 });
        const a = bySku.get(r.sku);
        a.avail += r.casesAvail || 0;
        a.inv += r.casesInv || 0;
        a.res += r.casesRes || 0;
      }

      let skus = Array.from(bySku.keys()).sort();
      if (hideZero){
        skus = skus.filter(s => (bySku.get(s).avail || 0) > 0);
      }

      sel.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "All SKUs";
      sel.appendChild(optAll);

      for (const sku of skus){
        const a = bySku.get(sku);
        const opt = document.createElement("option");
        opt.value = sku;
        opt.textContent = `${sku}  •  avail ${fmt(a.avail,1)}  •  inv ${fmt(a.inv,1)}`;
        sel.appendChild(opt);
      }

      if (!skus.includes(currentSku)) currentSku = "";
      sel.value = currentSku;
    }

    // ============================================================
    // Render: KPIs + cards + issues + table
    // ============================================================
    function renderKpis(){
      const snapRows = getSnapshotRowsForCards();

      const dateLabel = document.getElementById("toggle-show-all-dates").checked
        ? "All dates"
        : `For ${prettyDate(currentDateKey)}`;

      let totalInv=0, totalAvail=0, totalRes=0;
      const skuSet = new Set();
      const locSet = new Set();

      let ageWeightedSum = 0;
      let ageWeight = 0;

      let oldest = { age: -1, sku:"", batch:"", loc:"" };

      for (const r of snapRows){
        totalInv += r.casesInv || 0;
        totalRes += r.casesRes || 0;
        totalAvail += r.casesAvail || 0;

        if ((r.casesInv || 0) > 0) skuSet.add(r.sku);
        if (r.loc) locSet.add(r.loc);

        if ((r.age || 0) > 0 && (r.casesInv || 0) > 0){
          ageWeightedSum += (r.age || 0) * (r.casesInv || 0);
          ageWeight += (r.casesInv || 0);
        }

        if ((r.age || 0) > oldest.age){
          oldest = { age: r.age || 0, sku: r.sku, batch: r.batch, loc: r.loc };
        }
      }

      const avgAge = ageWeight ? (ageWeightedSum / ageWeight) : 0;

      document.getElementById("kpi-total-inv").textContent = fmt(totalInv, 0);
      document.getElementById("kpi-total-avail").textContent = fmt(totalAvail, 0);
      document.getElementById("kpi-unique-skus").textContent = fmt(skuSet.size, 0);
      document.getElementById("kpi-avg-age").textContent = avgAge ? fmt(avgAge, 1) : "0";

      document.getElementById("kpi-date-label").textContent =
        `${dateLabel} • Sheet: ${selectedSheetName || "–"}`;

      document.getElementById("kpi-skus").textContent =
        currentSku ? `SKU filter: ${currentSku}` : `Reserved: ${fmt(totalRes,0)} cases`;

      document.getElementById("kpi-locations").textContent =
        `Locations: ${fmt(locSet.size,0)}`;

      document.getElementById("kpi-oldest").textContent =
        oldest.age > 0 ? `Oldest: ${fmt(oldest.age,0)} days • ${oldest.sku || "(no SKU)"}` : "Oldest: –";
    }

    function classifyAvailability(avail){
      if (!(avail > 0)) return "zero";
      if (avail <= 3) return "low";
      return "ok";
    }

    function renderSkuCards(){
      const wrap = document.getElementById("sku-cards");
      const note = document.getElementById("sku-cards-note");
      const filteredNote = document.getElementById("filtered-note");
      wrap.innerHTML = "";

      const rows = getSnapshotRowsForCards();
      const hideZero = document.getElementById("toggle-hide-zero").checked;

      const bySku = new Map();
      for (const r of rows){
        if (!bySku.has(r.sku)){
          bySku.set(r.sku, { sku: r.sku, inv: 0, res: 0, avail: 0, oldestAge: -1, locations: new Set() });
        }
        const a = bySku.get(r.sku);
        a.inv += r.casesInv || 0;
        a.res += r.casesRes || 0;
        a.avail += r.casesAvail || 0;
        if ((r.age || 0) > a.oldestAge) a.oldestAge = r.age || 0;
        if (r.loc) a.locations.add(r.loc);
      }

      let skus = Array.from(bySku.values())
        .sort((a,b) => (b.avail - a.avail) || a.sku.localeCompare(b.sku));

      if (hideZero) skus = skus.filter(a => a.avail > 0);
      if (currentSku) skus = skus.filter(a => a.sku === currentSku);

      note.textContent = `${fmt(skus.length,0)} SKU(s) displayed`;
      filteredNote.textContent = `Rows filtered out: ${filteredOutCount.toLocaleString()} removed`;

      if (!skus.length){
        wrap.innerHTML = `<div style="color:var(--muted);font-size:.78rem;padding:10px 4px;">No SKUs for this selection.</div>`;
        return;
      }

      for (const a of skus){
        const cls = classifyAvailability(a.avail);
        const pillClass = cls === "zero" ? "zero" : (cls === "low" ? "low" : "ok");
        const pillText = cls === "zero" ? "0 available" : (cls === "low" ? "Low" : "Healthy");

        const card = document.createElement("div");
        card.className = "sku-card";
        card.dataset.sku = a.sku;
        card.innerHTML = `
          <div class="sku-title">
            <div class="sku-name">${escapeHtml(a.sku)}</div>
            <div class="pill ${pillClass}">${pillText}</div>
          </div>
          <div style="color:var(--muted);font-size:.74rem;">
            Locations: ${fmt(a.locations.size,0)} • Oldest lot: ${a.oldestAge > 0 ? fmt(a.oldestAge,0) : "–"} days
          </div>

          <div class="sku-stats">
            <div class="stat">
              <div class="label">In inventory</div>
              <div class="value">${fmt(a.inv,1)}</div>
              <div class="sub">cases</div>
            </div>
            <div class="stat">
              <div class="label">Reserved</div>
              <div class="value">${fmt(a.res,1)}</div>
              <div class="sub">cases</div>
            </div>
            <div class="stat">
              <div class="label">Available</div>
              <div class="value">${fmt(a.avail,1)}</div>
              <div class="sub">cases</div>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      }
    }

    function renderIssues(){
      const rows = getSnapshotRowsForCards();

      const oldest = rows
        .filter(r => (r.age || 0) > 0 && (r.casesInv || 0) > 0)
        .slice()
        .sort((a,b) => (b.age - a.age))
        .slice(0, 8);

      const ulOld = document.getElementById("list-oldest");
      ulOld.innerHTML = "";
      if (!oldest.length){
        ulOld.innerHTML = "<li>No age data for this selection.</li>";
      } else {
        for (const r of oldest){
          ulOld.innerHTML += `<li><code>${escapeHtml(r.sku)}</code> — ${fmt(r.age,0)} days • ${escapeHtml(r.batch || "–")} • ${escapeHtml(r.loc || "–")}</li>`;
        }
      }

      const bySku = new Map();
      for (const r of rows){
        if (!bySku.has(r.sku)) bySku.set(r.sku, { sku:r.sku, avail:0, inv:0 });
        const a = bySku.get(r.sku);
        a.avail += r.casesAvail || 0;
        a.inv += r.casesInv || 0;
      }
      const low = Array.from(bySku.values())
        .filter(a => a.inv > 0)
        .sort((a,b) => (a.avail - b.avail))
        .slice(0, 10);

      const ulLow = document.getElementById("list-low");
      ulLow.innerHTML = "";
      if (!low.length){
        ulLow.innerHTML = "<li>–</li>";
      } else {
        for (const a of low){
          const cls = classifyAvailability(a.avail);
          const tag = cls === "zero" ? `<span class="pill zero">0 available</span>` :
                      (cls === "low" ? `<span class="pill low">Low</span>` :
                                       `<span class="pill ok">Healthy</span>`);
          ulLow.innerHTML += `<li><code>${escapeHtml(a.sku)}</code> — avail ${fmt(a.avail,1)} / inv ${fmt(a.inv,1)} ${tag}</li>`;
        }
      }

      const byCust = new Map();
      for (const r of rows){
        const cust = (r.customer || "").trim();
        if (!cust) continue;
        const res = r.casesRes || 0;
        if (!(res > 0)) continue;
        if (!byCust.has(cust)) byCust.set(cust, 0);
        byCust.set(cust, byCust.get(cust) + res);
      }
      const resList = Array.from(byCust.entries()).sort((a,b) => b[1]-a[1]).slice(0, 10);

      const ulRes = document.getElementById("list-res");
      ulRes.innerHTML = "";
      if (!resList.length){
        ulRes.innerHTML = "<li>No customer reservations found.</li>";
      } else {
        for (const [cust, qty] of resList){
          ulRes.innerHTML += `<li>${escapeHtml(cust)} — <strong>${fmt(qty,0)}</strong> cases reserved</li>`;
        }
      }
    }

    function renderRawTable(){
      const tbody = document.getElementById("raw-body");
      const footer = document.getElementById("raw-footer");
      tbody.innerHTML = "";

      const rows = getFilteredRows();

      rows.sort((a,b) =>
        a.sku.localeCompare(b.sku) ||
        String(a.whDateKey).localeCompare(String(b.whDateKey)) ||
        String(a.batch).localeCompare(String(b.batch)) ||
        String(a.loc).localeCompare(String(b.loc))
      );

      let inv=0, res=0, avail=0;
      for (const r of rows){
        inv += r.casesInv || 0;
        res += r.casesRes || 0;
        avail += r.casesAvail || 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.sku)}</td>
          <td>${escapeHtml(prettyDate(r.whDateKey))}</td>
          <td>${escapeHtml(r.batch || "")}</td>
          <td>${fmt(r.casesAvail,1)}</td>
          <td>${fmt(r.casesInv,1)}</td>
          <td>${r.age ? fmt(r.age,0) : "0"}</td>
          <td>${escapeHtml(r.customer || "")}</td>
          <td>${escapeHtml(r.packDate || "")}</td>
          <td>${escapeHtml(r.loc || "")}</td>
          <td>${fmt(r.casesRes,1)}</td>
          <td>${escapeHtml(r.obs || "")}</td>
        `;
        tbody.appendChild(tr);
      }

      const showAllDates = document.getElementById("toggle-show-all-dates").checked;
      const dayOnly = document.getElementById("toggle-show-selected-day-only").checked;
      const dateScope = showAllDates ? "All dates" : (dayOnly ? `Selected day: ${prettyDate(currentDateKey)}` : "All dates (table)");

      footer.innerHTML = `
        <span>${dateScope}</span>
        <span>Rows: <strong>${rows.length.toLocaleString()}</strong></span>
        <span>Inv: <strong>${fmt(inv,0)}</strong></span>
        <span>Reserved: <strong>${fmt(res,0)}</strong></span>
        <span>Avail: <strong>${fmt(avail,0)}</strong></span>
        <span>Sheet: <strong>${escapeHtml(selectedSheetName || "–")}</strong></span>
      `;
    }

    // ============================================================
    // Modal (lot details) — by SKU
    // ============================================================
    function openModalForSku(sku){
      const backdrop = document.getElementById("modal-backdrop");
      const skuEl = document.getElementById("modal-sku");
      const sub = document.getElementById("modal-sub");
      const body = document.getElementById("modal-body-rows");
      const footer = document.getElementById("modal-footer");

      const baseRows = getSnapshotRowsForCards().filter(r => r.sku === sku);
      const showAllDates = document.getElementById("toggle-show-all-dates").checked;

      skuEl.textContent = sku || "(no SKU)";
      sub.textContent = showAllDates
        ? `All dates • ${baseRows.length} row(s) • grouped by W Batch Run Code + Warehouse Location`
        : `${prettyDate(currentDateKey)} • ${baseRows.length} row(s) • grouped by W Batch Run Code + Warehouse Location`;

      const key = (r) => `${r.batch || ""}|||${r.loc || ""}`;
      const map = new Map();
      for (const r of baseRows){
        const k = key(r);
        if (!map.has(k)){
          map.set(k, {
            batch: r.batch || "",
            loc: r.loc || "",
            inv: 0,
            avail: 0,
            cust: "",
            packDate: "",
            oldest: 0
          });
        }
        const a = map.get(k);
        a.inv += r.casesInv || 0;
        a.avail += r.casesAvail || 0;
        if (r.customer && !a.cust) a.cust = r.customer;
        if (r.packDate && !a.packDate) a.packDate = r.packDate;
        if ((r.age || 0) > (a.oldest || 0)) a.oldest = r.age || 0;
      }

      const lots = Array.from(map.values()).sort((a,b) => (b.oldest - a.oldest) || (b.avail - a.avail));

      body.innerHTML = "";
      let inv=0, avail=0;
      for (const l of lots){
        inv += l.inv;
        avail += l.avail;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(l.batch)}</td>
          <td>${fmt(l.avail,1)}</td>
          <td>${fmt(l.inv,1)}</td>
          <td>${l.oldest ? fmt(l.oldest,0) : "0"}</td>
          <td>${escapeHtml(l.cust || "")}</td>
          <td>${escapeHtml(l.packDate || "")}</td>
          <td>${escapeHtml(l.loc)}</td>
        `;
        body.appendChild(tr);
      }

      footer.innerHTML = `
        <span>Lots: <strong>${lots.length}</strong></span>
        <span>Total inv: <strong>${fmt(inv,0)}</strong></span>
        <span>Total avail: <strong>${fmt(avail,0)}</strong></span>
      `;

      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      const backdrop = document.getElementById("modal-backdrop");
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    }

    // ============================================================
    // Main reload/render pipeline
    // ============================================================
    function reloadAll(){
      setUpdatedChip();

      const payload = loadPayload();
      const parsed = parseRows(payload);

      if (parsed.missing.length){
        allRows = [];
        setStatus(payload ? "warn" : "warn", payload ? "Missing required columns" : "Master Pack not loaded");

        const missingList = parsed.missing.map(h => `<li><code>${escapeHtml(h)}</code></li>`).join("");
        const sheetKeys = payload?.sheets ? Object.keys(payload.sheets) : [];
        const sheetList = sheetKeys.length
          ? `<div style="margin-top:6px;color:rgba(148,163,184,.95);">Sheets found: <code>${sheetKeys.map(escapeHtml).join("</code>, <code>")}</code></div>`
          : "";

        showBanner(`
          <strong>S&amp;H dashboard is not ready.</strong>
          <div style="margin-top:6px;color:rgba(148,163,184,.95);">
            Missing required headers (expects your exact names):
          </div>
          <ul>${missingList}</ul>
          ${sheetList}
          <div style="margin-top:6px;color:rgba(148,163,184,.95);">
            This dashboard separates SKUs by <code>Warehouse SKU</code>.
          </div>
        `);

        document.getElementById("sku-cards").innerHTML = "";
        document.getElementById("raw-body").innerHTML = "";
        document.getElementById("raw-footer").textContent = "–";
        document.getElementById("list-oldest").innerHTML = "<li>–</li>";
        document.getElementById("list-low").innerHTML = "<li>–</li>";
        document.getElementById("list-res").innerHTML = "<li>–</li>";
        document.getElementById("sku-cards-note").textContent = "–";
        document.getElementById("filtered-note").textContent = "–";

        document.getElementById("kpi-total-inv").textContent = "–";
        document.getElementById("kpi-total-avail").textContent = "–";
        document.getElementById("kpi-unique-skus").textContent = "–";
        document.getElementById("kpi-avg-age").textContent = "–";
        document.getElementById("kpi-date-label").textContent = "–";
        document.getElementById("kpi-skus").textContent = "–";
        document.getElementById("kpi-locations").textContent = "–";
        document.getElementById("kpi-oldest").textContent = "–";
        return;
      }

      showBanner(null);
      allRows = parsed.rows;

      if (!allRows.length){
        setStatus("warn", `Loaded 0 valid rows (removed ${filteredOutCount})`);
      } else {
        setStatus("ok", `Loaded ${allRows.length} rows (removed ${filteredOutCount})`);
      }

      renderDateSelect();
      normalizeCurrentDateFromSelect();

      renderSkuSelect();
      renderKpis();
      renderSkuCards();
      renderIssues();
      renderRawTable();
    }

    // ============================================================
    // Init + live refresh
    // ============================================================
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-reload").addEventListener("click", reloadAll);

      document.getElementById("btn-clear-selection").addEventListener("click", () => {
        currentSku = "";
        document.getElementById("sku-select").value = "";
        renderKpis(); renderSkuCards(); renderIssues(); renderRawTable();
      });

      document.getElementById("toggle-show-all-dates").addEventListener("change", () => {
        renderSkuSelect();
        renderKpis(); renderSkuCards(); renderIssues(); renderRawTable();
      });

      document.getElementById("toggle-hide-zero").addEventListener("change", () => {
        renderSkuSelect();
        renderSkuCards();
      });

      document.getElementById("toggle-show-selected-day-only").addEventListener("change", () => {
        renderRawTable();
      });

      document.getElementById("date-select").addEventListener("change", () => {
        normalizeCurrentDateFromSelect();
        renderSkuSelect();
        renderKpis(); renderSkuCards(); renderIssues(); renderRawTable();
      });

      document.getElementById("sku-select").addEventListener("change", (e) => {
        currentSku = e.target.value || "";
        renderKpis(); renderSkuCards(); renderIssues(); renderRawTable();
      });

      document.getElementById("sku-cards").addEventListener("click", (e) => {
        const card = e.target.closest(".sku-card");
        if (!card) return;
        const sku = card.dataset.sku || "";
        if (!sku) return;
        openModalForSku(sku);
      });

      document.getElementById("modal-close").addEventListener("click", closeModal);
      document.getElementById("modal-backdrop").addEventListener("click", (e) => {
        if (e.target.id === "modal-backdrop") closeModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      reloadAll();

      window.addEventListener("message", (event) => {
        const msg = event?.data;
        if (!msg || typeof msg !== "object") return;
        if (msg.type === UPDATE_EVENT_TYPE) reloadAll();
      });

      window.addEventListener("storage", (e) => {
        if (e.key === MASTER_PACK_KEY || e.key === MASTER_PACK_PING_KEY) reloadAll();
      });
    });
  </script>
</body>
</html>
